# Полная инструкция по настройке Telegram Stars оплаты

## Что было реализовано

Система оплаты через Telegram Stars полностью интегрирована с следующими компонентами:

1. **Обработчик предоплаты** (`pre_checkout_handler`) - проверяет возможность оплаты
2. **Обработчик успешной оплаты** (`successful_payment_handler`) - добавляет коины пользователю
3. **Функция отправки invoice** (`send_stars_invoice`) - создает и отправляет invoice
4. **Интеграция в веб-приложение** - кнопка "Купить валюту" открывает бота с invoice

## Как это работает

### Пользователь нажимает "Купить" в веб-приложении
1. Веб-приложение открывает ссылку: `https://t.me/QuantumNexusGameBot?start=buy_stars_1`
2. Бот получает команду `/start buy_stars_1`
3. Бот отправляет invoice с оплатой в Stars

### Пользователь оплачивает invoice
1. Telegram отправляет `pre_checkout_query`
2. Бот проверяет пользователя и подтверждает
3. Telegram обрабатывает платеж
4. Telegram отправляет `successful_payment` message
5. Бот добавляет коины пользователю

## Важно! Что нужно настроить

### 1. В BotFather нужно включить Stars

1. Откройте @BotFather в Telegram
2. Отправьте `/mybots`
3. Выберите вашего бота
4. Нажмите на "Settings" или "⚙️ Настройки"
5. Найдите **"Payment"** или **"Платежи"**
6. Включите "Telegram Stars"
7. Если опции "Payment" нет, сделайте:
   - Отправьте `/setcommands`
   - Выберите бота
   - Отправьте что-нибудь вроде:
     ```
     start - Начать
     ```

### 2. Проверьте имя бота

В файле `web_app.html` на строке 2518 убедитесь, что username бота правильный:

```javascript
const tgLink = `https://t.me/QuantumNexusGameBot?start=buy_stars_${productId}`;
```

**Замените `QuantumNexusGameBot` на реальное имя вашего бота** (без @)

### 3. Проверьте token в config.py

Убедитесь, что в `config.py` указан правильный токен:

```python
BOT_TOKEN = "ваш_токен_здесь"
```

## Товары

Текущие товары настроены в `handlers.py`:

- **Товар 1**: 10 Stars → 1,000,000 коинов
- **Товар 2**: 40 Stars → 5,000,000 коинов

Чтобы изменить, отредактируйте словарь `products` в функции `send_stars_invoice`.

## Развертывание

После всех настроек выполните:

```bash
cd quantum-nexus
# Обновите бота
ssh root@your-server
cd /root/quantum-nexus
git pull
pm2 restart quantum-nexus-bot

# Обновите веб-сервер
cd /root/quantum-nexus
# Веб-сервер перезапустится автоматически при обновлении
```

## Тестирование

1. Откройте веб-приложение
2. Нажмите "Купить валюту"
3. Выберите товар
4. Нажмите "Купить"
5. В Telegram откроется invoice
6. Оплатите Stars
7. Коины должны добавиться в игру

## Если invoice не отправляется

1. Проверьте, что Stars включены в BotFather
2. Проверьте, что пользователь может получать Stars
3. Проверьте логи бота: `pm2 logs quantum-nexus-bot`
4. Убедитесь, что токен бота правильный

## Структура платежа

```
Пользователь → Веб-приложение → Бот → Invoice → Telegram → Stars
                                                           ↓
Пользователь ← Веб-приложение ← Бот ← successful_payment ←
```

## Код обработки платежа

Когда пользователь оплачивает:

1. `pre_checkout_handler` - проверяет, что пользователь существует
2. `successful_payment_handler` - добавляет коины по product_id
3. Отправляется сообщение о успешной покупке

Все это происходит автоматически через Telegram API.


