<!DOCTYPE html>
<!-- Quantum Nexus v6.7.58 - Fixed all daily tasks issues: return timer, cards progress, channel subscription penalty -->
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quantum Nexus v2.0</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #0a0e27;
            color: #fff;
            min-height: 100vh;
            padding: 20px;
            position: relative;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent !important;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }
        
        * {
            -webkit-tap-highlight-color: transparent !important;
            -webkit-focus-ring-color: transparent !important;
            -webkit-touch-callout: none !important;
        }
        
        button:focus,
        button:active {
            outline: none !important;
            box-shadow: none !important;
            border: none !important;
        }
        
        .tap-button:focus,
        .tap-button:active,
        .tap-button:focus-visible {
            outline: none !important;
            box-shadow: none !important;
            border: none !important;
        }
        
        /* Prevent all visual selection highlights */
        .tap-button,
        .tap-button * {
            -webkit-tap-highlight-color: transparent !important;
            -webkit-touch-callout: none !important;
            user-select: none !important;
            -webkit-user-select: none !important;
            -ms-user-select: none !important;
            -moz-user-select: none !important;
            -webkit-focus-ring-color: transparent !important;
        }
        
        /* Remove all possible focus states */
        button.tap-button:hover,
        button.tap-button:active,
        button.tap-button:focus,
        button.tap-button:focus-visible,
        button.tap-button:focus-within,
        button.tap-button:visited {
            outline: none !important;
            border: none !important;
            box-shadow: none !important;
            -webkit-tap-highlight-color: transparent !important;
            -webkit-touch-callout: none !important;
        }
        
        /* Extra protection for Telegram WebView */
        html, body {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent !important;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                linear-gradient(45deg, transparent 30%, rgba(102, 126, 234, 0.05) 50%, transparent 70%),
                radial-gradient(circle at 20% 50%, rgba(102, 126, 234, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(118, 75, 162, 0.1) 0%, transparent 50%);
            pointer-events: none;
            animation: drift 20s linear infinite;
        }

        @keyframes drift {
            0%, 100% { transform: translateX(0); }
            50% { transform: translateX(-20px); }
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            position: relative;
        }

        .header::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 60%;
            height: 2px;
            background: linear-gradient(90deg, transparent, #667eea, transparent);
        }

        .header h1 {
            font-size: 28px;
            font-weight: 900;
            margin-bottom: 10px;
            text-shadow: 0 0 30px rgba(102, 126, 234, 0.5);
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: glow 3s ease-in-out infinite;
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        @keyframes glow {
            0%, 100% { filter: drop-shadow(0 0 10px rgba(102, 126, 234, 0.5)); }
            50% { filter: drop-shadow(0 0 20px rgba(118, 75, 162, 0.8)); }
        }
        
        /* VIP Styles */
        .vip-container {
            position: relative;
        }
        
        .vip-particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1000;
        }
        
        @keyframes vip-float {
            0% { transform: translateY(0) rotate(0deg); opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { transform: translateY(-100vh) rotate(360deg); opacity: 0; }
        }
        
        .vip-golden-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, 
                rgba(255, 215, 0, 0.12) 0%,
                rgba(255, 255, 255, 0.05) 25%,
                rgba(255, 215, 0, 0.10) 50%,
                rgba(255, 255, 255, 0.07) 75%,
                rgba(255, 215, 0, 0.12) 100%
            );
            background-size: 400% 400%;
            animation: vip-gradient 15s ease infinite;
            pointer-events: none;
            z-index: 0;
        }
        
        .vip-premium-shine {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 20%, rgba(255, 215, 0, 0.08) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(255, 215, 0, 0.08) 0%, transparent 50%),
                radial-gradient(circle at 40% 60%, rgba(255, 255, 255, 0.03) 0%, transparent 50%);
            animation: vip-premium-shine 8s ease-in-out infinite;
            pointer-events: none;
            z-index: 0;
        }
        
        @keyframes vip-premium-shine {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }
        
        .vip-top-leaders {
            position: fixed;
            top: 10px;
            left: 10px;
            width: 140px;
            background: rgba(0, 0, 0, 0.65);
            backdrop-filter: blur(12px);
            border: 2px solid rgba(255, 215, 0, 0.35);
            border-radius: 12px;
            padding: 12px;
            z-index: 1000;
            box-shadow: 0 4px 20px rgba(255, 215, 0, 0.25);
        }
        
        .vip-profile-icon {
            position: relative;
            width: 45px;
            height: 45px;
            background: linear-gradient(135deg, #a78bfa, #c084fc, #d946ef);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            border: 3px solid rgba(255, 255, 255, 0.4);
            cursor: pointer;
            z-index: 10;
            box-shadow: 0 0 20px rgba(167, 139, 250, 0.6), 0 4px 15px rgba(167, 139, 250, 0.5);
            transition: all 0.3s ease;
            overflow: hidden;
            animation: vip-icon-glow 2s ease-in-out infinite;
        }
        
        @keyframes vip-icon-glow {
            0%, 100% { box-shadow: 0 0 20px rgba(167, 139, 250, 0.6), 0 4px 15px rgba(167, 139, 250, 0.5); }
            50% { box-shadow: 0 0 30px rgba(167, 139, 250, 0.9), 0 6px 20px rgba(167, 139, 250, 0.8); }
        }
        
        .vip-profile-icon img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .vip-profile-icon:hover {
            transform: scale(1.12);
            box-shadow: 0 0 35px rgba(217, 70, 239, 0.8), 0 8px 25px rgba(217, 70, 239, 0.7);
        }
        
        .vip-top-button {
            position: relative;
            width: 45px;
            height: 45px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            cursor: pointer;
            z-index: 10;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.5);
            transition: all 0.3s ease;
        }
        
        .vip-top-button:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.7);
        }
        
        @keyframes vip-gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        .vip-aura {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 300px;
            height: 300px;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(255,215,0,0.3), transparent);
            animation: vip-aura-pulse 3s ease-in-out infinite;
            pointer-events: none;
            z-index: 0;
        }
        
        @keyframes vip-aura-pulse {
            0%, 100% { transform: translate(-50%, -50%) scale(1); opacity: 0.5; }
            50% { transform: translate(-50%, -50%) scale(1.5); opacity: 0.2; }
        }
        
        .vip-rainbow-border {
            border: 3px solid;
            border-image: linear-gradient(45deg, #ff0000, #ff7f00, #ffff00, #00ff00, #0000ff, #4b0082, #9400d3) 1;
            animation: vip-rainbow 3s linear infinite;
        }
        
        @keyframes vip-rainbow {
            0% { filter: hue-rotate(0deg); }
            100% { filter: hue-rotate(360deg); }
        }
        
        .vip-shine-effect {
            position: relative;
            overflow: hidden;
        }
        
        .vip-shine-effect::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.8), transparent);
            animation: vip-shine 3s ease-in-out infinite;
        }
        
        @keyframes vip-shine {
            0% { left: -100%; }
            100% { left: 100%; }
        }
        
        .vip-glow-box {
            box-shadow: 0 0 30px rgba(255,215,0,0.8), 
                        0 0 60px rgba(255,215,0,0.5),
                        0 0 90px rgba(255,215,0,0.3);
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.05); }
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-3px); }
            20%, 40%, 60%, 80% { transform: translateX(3px); }
        }
        
        @keyframes shine-btn {
            0% { left: -100%; }
            100% { left: 100%; }
        }
        
        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        @keyframes premium-pulse {
            0%, 100% { transform: scale(1); box-shadow: 0 0 30px rgba(255, 215, 0, 0.6), 0 0 60px rgba(255, 140, 0, 0.4); }
            50% { transform: scale(1.03); box-shadow: 0 0 40px rgba(255, 215, 0, 0.8), 0 0 80px rgba(255, 140, 0, 0.6); }
        }

        .stats {
            background: linear-gradient(135deg, rgba(15, 23, 42, 0.9) 0%, rgba(26, 29, 46, 0.9) 100%);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 12px;
            margin-bottom: 16px;
            border: 1px solid rgba(102, 126, 234, 0.3);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.5);
            position: relative;
            overflow: hidden;
        }

        .stats::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(102, 126, 234, 0.1), transparent);
            animation: shine 3s infinite;
        }

        @keyframes shine {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid rgba(102, 126, 234, 0.2);
            position: relative;
            z-index: 1;
        }

        .stat-row:last-child {
            border-bottom: none;
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .stat-value {
            font-size: 18px;
            font-weight: bold;
            color: #f093fb;
            text-shadow: 0 0 10px rgba(240, 147, 251, 0.3);
        }

        .stat-compact-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 6px;
        }

        .stat-item-compact {
            background: linear-gradient(135deg, rgba(0,0,0,0.4), rgba(15,23,42,0.3));
            border-radius: 10px;
            padding: 8px;
            text-align: center;
            border: 2px solid rgba(102, 126, 234, 0.4);
            box-shadow: 0 3px 8px rgba(0,0,0,0.3), inset 0 0 15px rgba(102,126,234,0.1);
            transition: all 0.3s;
        }
        
        .stat-item-compact:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 12px rgba(0,0,0,0.4), inset 0 0 20px rgba(102,126,234,0.15);
            border-color: rgba(102, 126, 234, 0.6);
        }

        .stat-main-value {
            font-size: 18px;
            font-weight: 900;
            color: #fff;
            margin-bottom: 2px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
            letter-spacing: 0.3px;
        }

        .stat-passive-value {
            font-size: 10px;
            color: #4ade80;
            margin-bottom: 2px;
            font-weight: 700;
            text-shadow: 0 0 8px rgba(74,222,128,0.6);
        }

        .stat-label-small {
            font-size: 10px;
            color: #94a3b8;
            font-weight: 600;
        }

        .energy-bar-container {
            padding-top: 6px;
        }

        .energy-bar {
            width: 100%;
            height: 10px;
            background: rgba(255,255,255,0.1);
            border-radius: 5px;
            overflow: hidden;
            margin-top: 5px;
            position: relative;
        }

        .energy-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2, #f093fb);
            transition: width 0.5s ease;
            position: relative;
            overflow: hidden;
        }

        .energy-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: energyFlow 2s infinite;
        }

        @keyframes energyFlow {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        .energy-regen {
            font-size: 12px;
            color: #4ade80;
            margin-top: 5px;
            text-align: center;
        }

        .buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .btn {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.2) 0%, rgba(118, 75, 162, 0.2) 100%);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(102, 126, 234, 0.4);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 16px;
            font-weight: 600;
            color: white;
            text-decoration: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn:hover {
            transform: translateY(-3px);
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.3) 0%, rgba(118, 75, 162, 0.3) 100%);
            border-color: rgba(102, 126, 234, 0.6);
            box-shadow: 0 8px 32px rgba(102, 126, 234, 0.4);
        }

        .btn-emoji {
            font-size: 32px;
            filter: drop-shadow(0 0 10px rgba(102, 126, 234, 0.3));
        }

        .tap-button {
            width: 280px;
            height: 280px;
            margin: 30px auto;
            border-radius: 50%;
            position: relative;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.8) 0%, rgba(118, 75, 162, 0.8) 100%);
            border: 4px solid transparent;
            cursor: pointer;
            box-shadow: 0 15px 50px rgba(102, 126, 234, 0.3);
            transition: all 0.08s cubic-bezier(0.25, 1.8, 0.75, 0.5);
            user-select: none;
            -webkit-tap-highlight-color: transparent !important;
            -webkit-touch-callout: none;
            animation: pulse 2s ease-in-out infinite;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            outline: none !important;
            -webkit-focus-ring-color: transparent !important;
        }

        .tap-button svg {
            width: 100%;
            height: 100%;
            filter: drop-shadow(0 0 20px rgba(255, 192, 203, 0.6));
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 15px 50px rgba(102, 126, 234, 0.5), 0 0 0 0 rgba(102, 126, 234, 0.4);
                border-color: rgba(102, 126, 234, 0.6);
            }
            50% {
                transform: scale(1.05);
                box-shadow: 0 20px 60px rgba(102, 126, 234, 0.7), 0 0 40px 20px rgba(102, 126, 234, 0.3);
                border-color: rgba(240, 147, 251, 0.8);
            }
        }
        
        @keyframes tapPress {
            0% { 
                transform: scale(1);
                filter: brightness(1);
            }
            15% {
                transform: scale(0.92);
                filter: brightness(1.1);
            }
            30% {
                transform: scale(1.03);
                filter: brightness(1.08);
            }
            50% {
                transform: scale(0.99);
                filter: brightness(1.05);
            }
            70% {
                transform: scale(1.02);
                filter: brightness(1.04);
            }
            100% {
                transform: scale(1);
                filter: brightness(1);
            }
        }
        
        @keyframes neonBurst {
            0% {
                box-shadow: 0 0 0 0 rgba(240, 147, 251, 0);
            }
            50% {
                box-shadow: 0 0 0 20px rgba(240, 147, 251, 0), 0 0 0 40px rgba(102, 126, 234, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(240, 147, 251, 0), 0 0 0 0 rgba(102, 126, 234, 0);
            }
        }
        
        .tap-button.tap-pressed {
            animation: tapPress 0.3s cubic-bezier(0.25, 1, 0.5, 1);
        }

        .tap-button::before {
            content: '';
            position: absolute;
            inset: -10px;
            border-radius: 50%;
            background: linear-gradient(45deg, rgba(102, 126, 234, 0.6), rgba(118, 75, 162, 0.6));
            filter: blur(20px);
            opacity: 0;
            animation: neonPulse 2s ease-in-out infinite;
        }
        
        .tap-button::after {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 50%;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.3), rgba(118, 75, 162, 0.3));
            filter: blur(15px);
            opacity: 0;
            animation: neonPulse 2s ease-in-out infinite 0.3s;
        }
        
        @keyframes neonPulse {
            0%, 100% { opacity: 0.3; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.05); }
        }

        /* Offline Income Notice */
        .offline-notice {
            background: linear-gradient(135deg, rgba(76, 222, 128, 0.2) 0%, rgba(34, 197, 94, 0.2) 100%);
            border: 1px solid rgba(76, 222, 128, 0.5);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
            animation: slideDown 0.5s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* Withdraw Section */
        .withdraw-section {
            background: linear-gradient(135deg, rgba(15, 23, 42, 0.9) 0%, rgba(26, 29, 46, 0.9) 100%);
            border: 1px solid rgba(102, 126, 234, 0.3);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .withdraw-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #f093fb;
        }

        .withdraw-info {
            font-size: 14px;
            opacity: 0.8;
            margin-bottom: 10px;
        }

        .input-group {
            margin-bottom: 10px;
        }

        .input-group input {
            width: 100%;
            padding: 12px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(102, 126, 234, 0.3);
            border-radius: 10px;
            color: white;
            font-size: 14px;
        }

        .input-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .action-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 10px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(102, 126, 234, 0.4);
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            overflow-y: auto;
            padding: 20px;
            backdrop-filter: blur(8px);
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: linear-gradient(135deg, #0a0e27 0%, #1a1d2e 100%);
            border: 1px solid rgba(102, 126, 234, 0.5);
            border-radius: 20px;
            padding: 20px;
            max-width: 400px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.8);
            position: relative;
        }

        /* .modal-content::before - Removed to fix double border issue */

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 24px;
            font-weight: bold;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .close-btn {
            background: linear-gradient(135deg, rgba(100,100,100,0.3), rgba(80,80,80,0.3)) !important;
            border: 2px solid rgba(100,100,100,0.5) !important;
            border-radius: 50% !important;
            width: 42px !important;
            height: 42px !important;
            cursor: pointer !important;
            color: #fff !important;
            font-size: 22px !important;
            font-weight: 900 !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1) !important;
            position: absolute !important;
            top: 15px !important;
            right: 15px !important;
            z-index: 1000 !important;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3), inset 0 0 20px rgba(100,100,100,0.2) !important;
            text-shadow: 0 0 10px rgba(255,255,255,0.5) !important;
        }

        .close-btn:hover {
            background: linear-gradient(135deg, rgba(120,120,120,0.5), rgba(100,100,100,0.5)) !important;
            transform: scale(1.15) rotate(90deg) !important;
            box-shadow: 0 6px 25px rgba(0,0,0,0.4), inset 0 0 30px rgba(100,100,100,0.3) !important;
        }
        
        .close-btn:active {
            transform: scale(0.95) rotate(90deg) !important;
        }


        /* –°—Ç–∏–ª—å–Ω–∞—è –∫–Ω–æ–ø–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π */
        .category-close-btn {
            width: 100%;
            padding: 16px 24px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: #fff;
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 16px;
            cursor: pointer;
            font-weight: 800;
            font-size: 16px;
            margin-top: 20px;
            transition: all 0.3s ease;
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
            text-shadow: 0 1px 3px rgba(0,0,0,0.3);
            position: relative;
            overflow: hidden;
        }

        .category-close-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.6);
            background: linear-gradient(135deg, #5a67d8, #6b46c1);
            border-color: rgba(255,255,255,0.3);
        }

        .category-close-btn:active {
            transform: translateY(-1px);
        }

        /* VIP —Å—Ç–∏–ª—å–Ω–∞—è –∫–Ω–æ–ø–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è */
        .vip-close-btn {
            width: 100%;
            padding: 14px 20px;
            background: linear-gradient(135deg, #ffd700, #ffed4e, #ffd700);
            color: #000;
            border: 2px solid #ffd700;
            border-radius: 14px;
            cursor: pointer;
            font-weight: 800;
            font-size: 16px;
            margin-top: 20px;
            transition: all 0.3s ease;
            box-shadow: 0 6px 20px rgba(255, 215, 0, 0.4);
            position: relative;
            overflow: hidden;
            text-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }

        .vip-close-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 35px rgba(255, 215, 0, 0.7);
            background: linear-gradient(135deg, #ffed4e, #ffd700, #ffed4e);
        }

        .vip-close-btn:active {
            transform: translateY(-1px);
        }

        .vip-close-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.6), transparent);
            transition: left 0.6s;
        }

        .vip-close-btn:hover::before {
            left: 100%;
        }

        /* –ê–Ω–∏–º–∞—Ü–∏—è –ø—É–ª—å—Å–∞—Ü–∏–∏ –¥–ª—è VIP –∑–≤–µ–∑–¥—ã */
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        .shop-category {
            margin-bottom: 20px;
        }

        .category-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #f093fb;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .item {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(102, 126, 234, 0.3);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(102, 126, 234, 0.2), transparent);
            transition: left 0.5s;
        }

        .item:hover::before {
            left: 100%;
        }

        .item:hover {
            background: rgba(102, 126, 234, 0.2);
            border-color: rgba(102, 126, 234, 0.6);
            transform: translateX(5px);
        }

        .item-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .item-emoji {
            font-size: 24px;
        }

        .item-details {
            flex: 1;
        }

        .item-name {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .item-desc {
            font-size: 12px;
            opacity: 0.7;
            margin-bottom: 5px;
        }

        .item-price {
            font-size: 14px;
            color: #f093fb;
            font-weight: bold;
        }

        .mining-machine {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(102, 126, 234, 0.3);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 10px;
            position: relative;
            overflow: hidden;
        }

        .machine-tag {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 4px 10px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: bold;
        }

        .machine-tag.free {
            background: rgba(76, 222, 128, 0.2);
            color: #4ade80;
            border: 1px solid #4ade80;
        }

        .machine-tag.premium {
            background: rgba(240, 147, 251, 0.2);
            color: #f093fb;
            border: 1px solid #f093fb;
        }

        .machine-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .machine-name {
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .machine-level {
            font-size: 14px;
            opacity: 0.8;
        }

        .machine-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            font-size: 14px;
        }

        .stat-item {
            background: rgba(102, 126, 234, 0.1);
            padding: 8px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-label {
            font-size: 11px;
            opacity: 0.7;
            margin-bottom: 4px;
        }

        .stat-value {
            font-weight: bold;
            color: #f093fb;
        }

        .card-item {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(102, 126, 234, 0.3);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 10px;
            position: relative;
            overflow: hidden;
        }

        .card-glow {
            position: absolute;
            inset: -2px;
            border-radius: 15px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .card-item:hover .card-glow {
            opacity: 1;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .card-name {
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .card-level {
            font-size: 14px;
            opacity: 0.8;
        }

        .card-stats {
            display: flex;
            gap: 15px;
            font-size: 14px;
        }

        .stats-window {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(102, 126, 234, 0.3);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 10px;
        }

        .stats-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid rgba(102, 126, 234, 0.1);
        }

        .stats-row:last-child {
            border-bottom: none;
        }

        .stats-label {
            opacity: 0.8;
        }

        .stats-value {
            font-weight: bold;
            color: #f093fb;
        }

        .referral-link {
            background: rgba(102, 126, 234, 0.1);
            border: 1px solid rgba(102, 126, 234, 0.3);
            border-radius: 10px;
            padding: 12px;
            margin: 10px 0;
            font-family: monospace;
            word-break: break-all;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .referral-benefits {
            background: rgba(76, 222, 128, 0.1);
            border: 1px solid rgba(76, 222, 128, 0.3);
            border-radius: 10px;
            padding: 12px;
            margin: 10px 0;
        }

        .benefit-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 8px 0;
            font-size: 14px;
        }

        @keyframes coinFloat {
            0% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
            100% {
                opacity: 0;
                transform: translateY(-50px) scale(0.5);
            }
        }

        .coin-animation {
            position: fixed;
            font-size: 32px;
            font-weight: 900;
            pointer-events: none;
            animation: coinFloat 2s ease-out forwards;
            z-index: 9999;
            color: #ffd700;
            text-shadow: 
                0 0 10px rgba(255, 215, 0, 1),
                0 0 20px rgba(255, 215, 0, 0.8),
                0 0 30px rgba(255, 215, 0, 0.6),
                0 0 40px rgba(255, 215, 0, 0.4),
                0 0 50px rgba(255, 215, 0, 0.2);
            filter: drop-shadow(0 0 10px rgba(255, 215, 0, 1));
            will-change: transform, opacity, filter;
        }

        @keyframes coinFloat {
            0% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(0.5) rotate(0deg);
                filter: blur(0px) brightness(1);
            }
            10% {
                opacity: 1;
                transform: translate(-50%, -80%) scale(0.7) rotate(90deg);
                filter: blur(0px) brightness(1.2);
            }
            20% {
                opacity: 1;
                transform: translate(-50%, -120%) scale(0.9) rotate(180deg);
                filter: blur(0px) brightness(1.3);
            }
            30% {
                opacity: 1;
                transform: translate(-50%, -170%) scale(1.1) rotate(270deg);
                filter: blur(1px) brightness(1.2);
            }
            40% {
                opacity: 1;
                transform: translate(-50%, -230%) scale(1.3) rotate(360deg);
                filter: blur(1px) brightness(1.1);
            }
            50% {
                opacity: 1;
                transform: translate(-50%, -300%) scale(1.5) rotate(450deg);
                filter: blur(2px) brightness(1);
            }
            60% {
                opacity: 0.9;
                transform: translate(-50%, -380%) scale(1.7) rotate(540deg);
                filter: blur(2px) brightness(0.9);
            }
            70% {
                opacity: 0.7;
                transform: translate(-50%, -470%) scale(1.9) rotate(630deg);
                filter: blur(3px) brightness(0.7);
            }
            80% {
                opacity: 0.5;
                transform: translate(-50%, -570%) scale(2.1) rotate(720deg);
                filter: blur(4px) brightness(0.5);
            }
            90% {
                opacity: 0.3;
                transform: translate(-50%, -680%) scale(2.3) rotate(810deg);
                filter: blur(5px) brightness(0.3);
            }
            100% {
                opacity: 0;
                transform: translate(-50%, -800%) scale(2.5) rotate(900deg);
                filter: blur(6px) brightness(0);
            }
        }

        .loading {
            text-align: center;
            padding: 40px;
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header" style="position: relative;">
            <div style="display: flex; align-items: center; justify-content: center; gap: 20px; margin-bottom: 20px;">
                <div class="vip-top-button" style="width: 45px; height: 45px; background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 24px; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.5); transition: all 0.3s; flex-shrink: 0;" onclick="openVIPTopLeaders();" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">üèÜ</div>
                
                <h1 id="mainTitle" style="margin: 0; text-align: center; font-size: 26px; white-space: nowrap;">Quantum Nexus</h1>
                
                <div class="vip-profile-icon" style="width: 45px; height: 45px; background: linear-gradient(135deg, #a78bfa, #c084fc); border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 24px; box-shadow: 0 4px 15px rgba(167, 139, 250, 0.5); transition: all 0.3s; flex-shrink: 0;" onclick="openVIPProfileModal();" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">üë§</div>
            </div>
            
            <div id="vipPrivileges" style="display:none;margin-top:5px;font-size:11px;color:#94a3b8;"></div>
        </div>

        <!-- Offline Income Popup -->
        <div id="offlinePopup" class="modal">
            <div class="modal-content" style="max-width: 350px;">
                <div class="modal-header">
                    <div class="modal-title">üí∞ –û—Ñ—Ñ–ª–∞–π–Ω –¥–æ—Ö–æ–¥</div>
                    <button class="close-btn" onclick="closeModal('offlinePopup')">‚úï</button>
                </div>
                <div id="offlineContent"></div>
            </div>
        </div>

        <div class="stats">
            <!-- Compact unified info panel -->
            <div style="background: linear-gradient(135deg, rgba(15,15,30,0.95), rgba(20,20,35,0.98)); border: 2px solid rgba(167,139,250,0.4); border-radius: 14px; padding: 10px 12px; box-shadow: 0 4px 20px rgba(167,139,250,0.25), 0 2px 8px rgba(0,0,0,0.5); margin-bottom: 8px;">
                <!-- Top row: Coins and QuanHash with passive income -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 10px;">
                    <div style="background: rgba(255,255,255,0.05); border-radius: 10px; padding: 8px; border: 1px solid rgba(255,255,255,0.1);">
                        <div style="font-size: 9px; color: #94a3b8; font-weight: 700; margin-bottom: 3px; letter-spacing: 0.3px;">üí∞ –ö–û–ò–ù–´</div>
                        <div style="font-size: 18px; font-weight: 900; color: #ffd700; text-shadow: 0 0 12px rgba(255,215,0,0.6); font-variant-numeric: tabular-nums; margin-bottom: 2px;" id="coins">0</div>
                        <div style="font-size: 9px; color: #4ade80; font-weight: 700; text-shadow: 0 0 6px rgba(74,222,128,0.6);" id="passiveCoins">+0/—á</div>
                    </div>
                    <div style="background: rgba(255,255,255,0.05); border-radius: 10px; padding: 8px; border: 1px solid rgba(255,255,255,0.1);">
                        <div style="font-size: 9px; color: #94a3b8; font-weight: 700; margin-bottom: 3px; letter-spacing: 0.3px;">üíé QUANHASH</div>
                        <div style="font-size: 18px; font-weight: 900; color: #a78bfa; text-shadow: 0 0 12px rgba(167,139,250,0.6); font-variant-numeric: tabular-nums; margin-bottom: 2px;" id="quanhash">0</div>
                        <div style="font-size: 9px; color: #4ade80; font-weight: 700; text-shadow: 0 0 6px rgba(74,222,128,0.6);" id="passiveHash">+0/—á</div>
                    </div>
                </div>
                
                <!-- Compact energy bar -->
                <div style="background: rgba(0,0,0,0.3); border-radius: 10px; padding: 8px 10px; margin-bottom: 8px; border: 1px solid rgba(118,75,162,0.3);">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 6px;">
                        <div style="font-size: 10px; font-weight: 700; color: #a78bfa; text-shadow: 0 0 8px rgba(167,139,250,0.5); letter-spacing: 0.3px;">‚ö° –≠–ù–ï–†–ì–ò–Ø</div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div id="energy-text" style="font-size: 12px; font-weight: 800; color: #fff; text-shadow: 0 1px 3px rgba(0,0,0,0.9); font-variant-numeric: tabular-nums;">0/1000</div>
                            <div id="energy-percent" style="font-size: 11px; font-weight: 700; color: #86efac; text-shadow: 0 0 8px rgba(134,239,172,0.6); min-width: 35px; text-align: right;">0%</div>
                        </div>
                    </div>
                    <!-- Compact progress bar -->
                    <div style="width: 100%; height: 8px; background: rgba(0,0,0,0.5); border-radius: 6px; overflow: hidden; position: relative; box-shadow: inset 0 1px 6px rgba(0,0,0,0.8);">
                        <div class="energy-fill" id="energy-bar-fill" style="width: 0%; height: 100%; background: linear-gradient(90deg, #667eea 0%, #764ba2 50%, #8b5cf6 100%); box-shadow: 0 0 20px rgba(102,126,234,0.5), inset 0 0 15px rgba(118,75,162,0.3); position: absolute; top: 0; left: 0; transition: width 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94); border-radius: 6px;">
                            <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(90deg, transparent 0%, rgba(255,255,255,0.3) 50%, transparent 100%); animation: softShine 3s infinite; border-radius: 6px;"></div>
                        </div>
                    </div>
                    <div class="energy-regen" id="energy-regen-text" style="text-align: center; margin-top: 5px; font-size: 9px; color: #86efac; font-weight: 700; text-shadow: 0 0 6px rgba(134,239,172,0.6); letter-spacing: 0.2px;">+1/—Å–µ–∫</div>
                </div>
                
                <!-- Level and Rating in one row -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                    <div style="background: rgba(255,215,0,0.1); border-radius: 8px; padding: 6px; border: 1px solid rgba(255,215,0,0.3); text-align: center;">
                        <div style="font-size: 9px; font-weight: 700; color: #94a3b8; margin-bottom: 2px; letter-spacing: 0.2px;">‚≠ê –£–†–û–í–ï–ù–¨</div>
                        <div style="font-size: 16px; font-weight: 900; color: #ffd700; text-shadow: 0 0 10px rgba(255,215,0,0.6); font-variant-numeric: tabular-nums;" id="user-level">1</div>
                    </div>
                    <div style="background: rgba(255,215,0,0.1); border-radius: 8px; padding: 6px; border: 1px solid rgba(255,215,0,0.3); text-align: center;">
                        <div style="font-size: 9px; font-weight: 700; color: #94a3b8; margin-bottom: 2px; letter-spacing: 0.2px;">üèÜ –†–ï–ô–¢–ò–ù–ì</div>
                        <div style="font-size: 16px; font-weight: 900; color: #ffd700; text-shadow: 0 0 10px rgba(255,215,0,0.6); font-variant-numeric: tabular-nums;" id="user-rating">0</div>
                    </div>
                </div>
            </div>
            
            <style>
                @keyframes softShine {
                    0% { transform: translateX(-150%); opacity: 0; }
                    20% { opacity: 0.4; }
                    80% { opacity: 0.4; }
                    100% { transform: translateX(350%); opacity: 0; }
                }
            </style>
            
            <!-- Autobot status display (no toggle button) -->
            <div id="autobotStatusSection" style="display: none; margin-top: 10px; opacity: 1; transition: opacity 0.3s ease;">
                <div id="autobotStatusBtn" style="width: 100%; padding: 12px 16px; background: linear-gradient(135deg, #10b981, #059669); color: #fff; border: none; border-radius: 10px; font-size: 13px; font-weight: 700; box-shadow: 0 4px 12px rgba(16,185,129,0.4); min-height: 44px; text-align: center;">
                    ü§ñ –ê–≤—Ç–æ–±–æ—Ç –∞–∫—Ç–∏–≤–µ–Ω
                </div>
            </div>
        </div>

        <button class="tap-button" onclick="tap(); return false;" type="button" style="outline:none!important;box-shadow:none!important;-webkit-tap-highlight-color:transparent!important;">
            <svg width="220" height="220" viewBox="0 0 220 220" style="width:100%;height:100%;">
                <defs>
                    <radialGradient id="tapGrad" cx="50%" cy="50%">
                        <stop offset="0%" style="stop-color:#667eea;stop-opacity:1" />
                        <stop offset="100%" style="stop-color:#764ba2;stop-opacity:0.9" />
                    </radialGradient>
                    <filter id="glow">
                        <feGaussianBlur stdDeviation="4" result="coloredBlur"/>
                        <feMerge>
                            <feMergeNode in="coloredBlur"/>
                            <feMergeNode in="SourceGraphic"/>
                        </feMerge>
                    </filter>
                </defs>
                <circle cx="110" cy="110" r="100" fill="url(#tapGrad)" filter="url(#glow)" opacity="0.9"/>
                <circle cx="110" cy="110" r="90" fill="none" stroke="#f093fb" stroke-width="2" opacity="0.6"/>
                <text x="110" y="150" font-size="100" text-anchor="middle" fill="#fff" font-weight="bold" style="filter: drop-shadow(0 0 15px rgba(255, 192, 203, 0.8));">üí∞</text>
            </svg>
        </button>
        <div class="buttons">
            <a href="#" class="btn" onclick="openShop(event)">
                <div class="btn-emoji">üõí</div>
                <div>–ú–∞–≥–∞–∑–∏–Ω</div>
            </a>
            <a href="#" class="btn" onclick="openMining(event)">
                <div class="btn-emoji">üè≠</div>
                <div>–ú–∞–π–Ω–∏–Ω–≥</div>
            </a>
            <a href="#" class="btn" onclick="openCards(event)">
                <div class="btn-emoji">üí≥</div>
                <div>–ö–∞—Ä—Ç–æ—á–∫–∏</div>
            </a>
            <a href="#" class="btn" onclick="openSupport(event)" id="supportBtn" style="position:relative;">
                <div class="btn-emoji">üí¨</div>
                <div>–ü–æ–¥–¥–µ—Ä–∂–∫–∞</div>
                <span id="supportBadge" style="display:none;position:absolute;top:5px;right:5px;background:linear-gradient(135deg,#ef4444,#dc2626);color:#fff;padding:3px 7px;border-radius:10px;font-size:11px;font-weight:700;box-shadow:0 2px 8px rgba(239,68,68,0.5);animation:pulse 2s ease-in-out infinite;">0</span>
            </a>
            <a href="#" class="btn" onclick="openReferrals(event)">
                <div class="btn-emoji">üë•</div>
                <div>–†–µ—Ñ–µ—Ä–∞–ª—ã</div>
            </a>
            <a href="#" class="btn" onclick="openWithdrawModal(event)">
                <div class="btn-emoji">üí∏</div>
                <div>–í—ã–≤–æ–¥</div>
            </a>
            <a href="#" class="btn" onclick="openDailyBonus(event)">
                <div class="btn-emoji">üéÅ</div>
                <div>–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è</div>
            </a>
            <a href="#" class="btn" onclick="openBuyCurrency(event)" style="background:linear-gradient(135deg,rgba(255,215,0,0.3),rgba(255,140,0,0.3));border:2px solid rgba(255,215,0,0.6);box-shadow:0 4px 15px rgba(255,215,0,0.3);">
                <div class="btn-emoji">‚≠ê</div>
                <div style="font-weight:700;">–ö—É–ø–∏—Ç—å –≤–∞–ª—é—Ç—É</div>
            </a>
        </div>
    </div>

    <!-- Stats Modal -->
    <div id="statsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
                <button class="close-btn" onclick="closeModal('statsModal')">‚úï</button>
            </div>
            <div class="stats-window" id="statsContent"></div>
            
            <!-- –°—Ç–∏–ª—å–Ω–∞—è –∫–Ω–æ–ø–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è -->
            <button class="category-close-btn" onclick="closeModal('statsModal')">
                ‚úï –ó–∞–∫—Ä—ã—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            </button>
        </div>
    </div>

    <!-- Shop Modal -->
    <div id="shopModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">üí∞ –ú–∞–≥–∞–∑–∏–Ω</div>
                <button class="close-btn" onclick="closeModal('shopModal')">‚úï</button>
            </div>
            <div class="shop-category">
                <div class="category-title">‚ö° –ë—É—Å—Ç—ã</div>
                <div id="boostsList"></div>
            </div>
            <div class="shop-category">
                <div class="category-title">ü§ñ –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è</div>
                <div id="automationList"></div>
            </div>
            <div class="shop-category">
                <div class="category-title">‚ö° –≠–Ω–µ—Ä–≥–∏—è</div>
                <div id="energyList"></div>
            </div>
            <div class="shop-category">
                <div class="category-title">üí≥ –ö–∞—Ä—Ç–æ—á–∫–∏</div>
                <div id="cardsList"></div>
            </div>
            
            <!-- –°—Ç–∏–ª—å–Ω–∞—è –∫–Ω–æ–ø–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è –¥–ª—è —Å—Ç–∞—Ä–æ–≥–æ –º–∞–≥–∞–∑–∏–Ω–∞ -->
            <button class="category-close-btn" onclick="closeModal('shopModal')">
                ‚úï –ó–∞–∫—Ä—ã—Ç—å –º–∞–≥–∞–∑–∏–Ω
            </button>
        </div>
    </div>

    <!-- Mining Modal -->
    <div id="miningModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">üè≠ –ú–∞–π–Ω–∏–Ω–≥</div>
                <button class="close-btn" onclick="closeModal('miningModal')">‚úï</button>
            </div>
            <div id="machinesList"></div>
            <button class="btn" onclick="closeModal('miningModal'); openShop(event)">‚ûï –ö—É–ø–∏—Ç—å –º–∞—à–∏–Ω—É</button>
            
            <!-- –°—Ç–∏–ª—å–Ω–∞—è –∫–Ω–æ–ø–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è -->
            <button class="category-close-btn" onclick="closeModal('miningModal')" style="margin-top: 15px;">
                ‚úï –ó–∞–∫—Ä—ã—Ç—å –º–∞–π–Ω–∏–Ω–≥
            </button>
        </div>
    </div>

    <!-- Cards Modal -->
    <div id="cardsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">üí≥ –ú–æ–∏ –ö–∞—Ä—Ç–æ—á–∫–∏</div>
                <button class="close-btn" onclick="closeModal('cardsModal')">‚úï</button>
            </div>
            <div id="myCardsList"></div>
            
            <!-- –°—Ç–∏–ª—å–Ω–∞—è –∫–Ω–æ–ø–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è -->
            <button class="category-close-btn" onclick="closeModal('cardsModal')">
                ‚úï –ó–∞–∫—Ä—ã—Ç—å –∫–∞—Ä—Ç–æ—á–∫–∏
            </button>
        </div>
    </div>

    <!-- Withdraw Modal -->
    <div id="withdrawModal" class="modal">
        <div class="modal-content" style="max-height: 80vh; overflow-y: auto;">
            <div class="modal-header">
                <div class="modal-title">üí∏ –í—ã–≤–æ–¥ —Å—Ä–µ–¥—Å—Ç–≤</div>
                <button class="close-btn" onclick="closeModal('withdrawModal')">‚úï</button>
            </div>
            <div id="withdrawContent"></div>
            
            <!-- –°—Ç–∏–ª—å–Ω–∞—è –∫–Ω–æ–ø–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è -->
            <button class="category-close-btn" onclick="closeModal('withdrawModal')">
                ‚úï –ó–∞–∫—Ä—ã—Ç—å –≤—ã–≤–æ–¥
            </button>
        </div>
    </div>

    <!-- Referrals Modal -->
    <div id="referralsModal" class="modal">
        <div class="modal-content" style="max-width: 500px; width: 95vw; max-height: 90vh; overflow: hidden; background: linear-gradient(135deg, rgba(0,0,0,0.95), rgba(20,20,30,0.98)); border-radius: 24px; backdrop-filter: blur(20px); padding: 0; border: 2px solid rgba(255,215,0,0.3);">
            <!-- VIP Style Header with Layered Effect -->
            <div style="background: linear-gradient(135deg, #ffd700, #ffed4e, #ffd700); padding: 24px 50px 24px 24px; border-radius: 20px 20px 0 0; position: relative; box-shadow: 0 8px 30px rgba(255,215,0,0.4); overflow: hidden;">
                <!-- Background Window Effect -->
                <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(135deg, rgba(255,215,0,0.3) 0%, rgba(255,200,0,0.2) 50%, rgba(255,215,0,0.3) 100%); border-radius: 20px 20px 0 0; opacity: 0.5; pointer-events: none; filter: blur(20px);"></div>
                <div style="position: absolute; bottom: -30%; left: -20%; right: -20%; height: 80%; background: radial-gradient(circle, rgba(255,255,255,0.15) 0%, transparent 70%); border-radius: 50%; pointer-events: none;"></div>
                
                <div style="display: flex; align-items: center; justify-content: center; gap: 12px; position: relative; z-index: 1;">
                    <div style="font-size: 38px; text-shadow: 0 4px 15px rgba(0,0,0,0.4); filter: drop-shadow(0 0 10px rgba(255,215,0,0.9)); animation: pulse 2s infinite;">üë•</div>
                    <div style="flex: 1; min-width: 0;">
                        <h2 style="font-size: 22px; color: #000; margin: 0; font-weight: 900; text-shadow: 0 3px 8px rgba(0,0,0,0.3); line-height: 1.2;">–†–ï–§–ï–†–ê–õ–¨–ù–ê–Ø –°–ò–°–¢–ï–ú–ê</h2>
                        <div style="font-size: 13px; color: rgba(0,0,0,0.75); margin-top: 4px; font-weight: 700;">–ü—Ä–∏–≥–ª–∞—à–∞–π—Ç–µ –¥—Ä—É–∑–µ–π!</div>
                    </div>
                </div>
                <button class="close-btn" onclick="closeModal('referralsModal')" style="position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.3); color: #000; border: 2px solid rgba(0,0,0,0.2); width: 34px; height: 34px; border-radius: 50%; cursor: pointer; font-size: 20px; font-weight: bold; transition: all 0.3s; z-index: 3; flex-shrink: 0;">‚úï</button>
            </div>
            
            <div style="padding: 20px; overflow-y: auto; max-height: calc(90vh - 180px);">
                <!-- Referral Link Section - PROMINENT -->
                <div style="margin-bottom: 20px;">
                    <div style="font-size: 16px; font-weight: 900; color: #ffd700; margin-bottom: 12px; text-align: center; text-shadow: 0 2px 10px rgba(255,215,0,0.6);">üìé –í–∞—à–∞ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞</div>
                    <div id="refLink" style="background: linear-gradient(135deg, rgba(255,215,0,0.25), rgba(255,200,0,0.2)); border: 2px solid rgba(255,215,0,0.6); border-radius: 18px; padding: 20px; font-size: 13px; color: #ffd700; word-break: break-all; font-weight: 800; margin-bottom: 18px; text-align: center; box-shadow: 0 6px 20px rgba(255,215,0,0.4); width: 100%; box-sizing: border-box;">-</div>
                    <button onclick="copyRefLink()" style="width: 100%; padding: 20px; font-size: 18px; font-weight: 900; background: linear-gradient(135deg, #ffd700, #ffed4e, #ffd700); color: #000; border: 2px solid #ffd700; border-radius: 18px; cursor: pointer; transition: all 0.3s; box-shadow: 0 8px 25px rgba(255,215,0,0.6); text-shadow: 0 2px 4px rgba(0,0,0,0.1);" onmouseover="this.style.transform='scale(1.02)'; this.style.boxShadow='0 10px 30px rgba(255,215,0,0.8)'" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 8px 25px rgba(255,215,0,0.6)'">
                        üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É
                    </button>
                </div>

                <!-- System of Bonuses -->
                <div style="margin-bottom: 20px;">
                    <div style="font-size: 17px; font-weight: 900; color: #10b981; margin-bottom: 14px; text-align: center; text-shadow: 0 2px 10px rgba(16,185,129,0.6);">üí∞ –°–∏—Å—Ç–µ–º–∞ –±–æ–Ω—É—Å–æ–≤</div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 14px;">
                        <!-- Regular User -->
                        <div style="text-align: center; padding: 18px 12px; background: linear-gradient(135deg, rgba(102, 126, 234, 0.25), rgba(102, 126, 234, 0.15)); border: 2px solid rgba(102, 126, 234, 0.6); border-radius: 16px; backdrop-filter: blur(10px); box-shadow: 0 6px 20px rgba(102,126,234,0.4); width: 100%; box-sizing: border-box; min-height: 170px; display: flex; flex-direction: column; justify-content: center;">
                            <div style="font-size: 42px; margin-bottom: 8px; filter: drop-shadow(0 3px 6px rgba(102,126,234,0.6)); flex-shrink: 0;">‚úÖ</div>
                            <div style="font-size: 14px; font-weight: 900; color: #a5b4fc; margin-bottom: 6px; flex-shrink: 0;">–û–±—ã—á–Ω—ã–π</div>
                            <div style="font-size: 20px; font-weight: 900; color: #667eea; margin-bottom: 4px; text-shadow: 0 2px 10px rgba(102,126,234,0.5); flex-shrink: 0;">500 ü™ô</div>
                            <div style="font-size: 12px; font-weight: 800; color: rgba(255,255,255,0.95); margin-bottom: 4px; flex-shrink: 0;">–ö–∞–∂–¥—ã–π</div>
                            <div style="font-size: 11px; font-weight: 700; color: #10b981; flex-shrink: 0;">+ 5%</div>
                        </div>
                        
                        <!-- Premium User -->
                        <div style="text-align: center; padding: 18px 12px; background: linear-gradient(135deg, rgba(255,215,0,0.35), rgba(255,200,0,0.25)); border: 2px solid rgba(255,215,0,0.8); border-radius: 16px; backdrop-filter: blur(10px); box-shadow: 0 6px 25px rgba(255,215,0,0.5); width: 100%; box-sizing: border-box; min-height: 170px; display: flex; flex-direction: column; justify-content: center;">
                            <div style="font-size: 42px; margin-bottom: 8px; filter: drop-shadow(0 3px 8px rgba(255,215,0,0.7)); flex-shrink: 0;">‚≠ê</div>
                            <div style="font-size: 14px; font-weight: 900; color: #ffd700; margin-bottom: 6px; flex-shrink: 0;">Premium</div>
                            <div style="font-size: 20px; font-weight: 900; color: #ffd700; margin-bottom: 4px; text-shadow: 0 2px 10px rgba(255,215,0,0.5); flex-shrink: 0;">2000 ü™ô</div>
                            <div style="font-size: 12px; font-weight: 800; color: rgba(255,255,255,0.98); margin-bottom: 4px; flex-shrink: 0;">–ö–∞–∂–¥—ã–π</div>
                            <div style="font-size: 11px; font-weight: 700; color: #ffd700; flex-shrink: 0;">+ 10%</div>
                        </div>
                    </div>
                    
                    <div style="padding: 14px; background: rgba(255,215,0,0.15); border: 2px solid rgba(255,215,0,0.4); border-radius: 12px; width: 100%; box-sizing: border-box;">
                        <div style="font-size: 12px; color: #ffd700; line-height: 1.5; text-align: center; font-weight: 800;">
                            üéÅ –û–±–∞ –ø–æ–ª—É—á–∞—é—Ç –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π –±–æ–Ω—É—Å!
                        </div>
                    </div>
                </div>

                <!-- Main Stats -->
                <div style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.2), rgba(118, 75, 162, 0.15)); border: 2px solid rgba(102, 126, 234, 0.5); border-radius: 16px; padding: 18px; margin-bottom: 20px; box-shadow: 0 6px 25px rgba(102,126,234,0.3); width: 100%; box-sizing: border-box;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <span style="font-size: 15px; font-weight: 800; color: rgba(255,255,255,0.98);">–í—Å–µ–≥–æ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤</span>
                        <span id="refCount" style="font-size: 20px; font-weight: 900; color: #667eea; text-shadow: 0 2px 10px rgba(102,126,234,0.5);">0</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <span style="font-size: 15px; font-weight: 800; color: rgba(255,255,255,0.98);">‚≠ê Premium:</span>
                        <span id="refPremiumCount" style="font-size: 18px; font-weight: 900; color: #ffd700; text-shadow: 0 2px 10px rgba(255,215,0,0.5);">0</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <span style="font-size: 15px; font-weight: 800; color: rgba(255,255,255,0.98);">‚úÖ –û–±—ã—á–Ω—ã—Ö:</span>
                        <span id="refRegularCount" style="font-size: 18px; font-weight: 900; color: #10b981; text-shadow: 0 2px 10px rgba(16,185,129,0.5);">0</span>
                    </div>
                    <div style="border-top: 2px solid rgba(102,126,234,0.5); padding-top: 14px; margin-top: 8px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-size: 16px; font-weight: 900; color: #fff; text-shadow: 0 2px 8px rgba(0,0,0,0.6);">üí∞ –û–±—â–∏–π –¥–æ—Ö–æ–¥</span>
                            <span id="refIncome" style="font-size: 22px; font-weight: 900; color: #10b981; text-shadow: 0 2px 15px rgba(16,185,129,0.7);">0 ü™ô</span>
                        </div>
                    </div>
                </div>

                <!-- Referrals List -->
                <div style="margin-bottom: 20px;">
                    <div style="font-size: 16px; font-weight: 900; color: #fff; margin-bottom: 14px; display: flex; align-items: center; gap: 10px; text-shadow: 0 2px 6px rgba(0,0,0,0.6);">
                        üìä <span>–í–∞—à–∏ —Ä–µ—Ñ–µ—Ä–∞–ª—ã</span>
                    </div>
                    <div id="referralsList" style="max-height: 260px; overflow-y: auto; background: rgba(0,0,0,0.35); border-radius: 14px; padding: 14px; width: 100%; box-sizing: border-box;">
                        <div style="text-align: center; padding: 35px; color: rgba(255,255,255,0.5); font-size: 15px; font-weight: 700;">–ü–æ–∫–∞ –Ω–µ—Ç —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Toast Notification for Copy -->
    <div id="copyToast" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0); background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 20px 40px; border-radius: 50px; box-shadow: 0 8px 24px rgba(16,185,129,0.5); font-size: 18px; font-weight: 800; z-index: 10000; pointer-events: none; transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55); text-align: center;">
        ‚úÖ –°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!
    </div>

    <script>
        // Declare audio variables FIRST before any code that uses them
        let audioContext = null;
        const sounds = {};
        let useHTML5Audio = false;
        let audioInitialized = false;
        
        // Detect if we're in Telegram WebApp (mobile or desktop)
        function isTelegramWebApp() {
            return window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.platform;
        }
        
        // Detect if we're on mobile
        function isMobile() {
            const userAgent = navigator.userAgent || navigator.vendor || window.opera;
            return /android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/i.test(userAgent.toLowerCase());
        }
        
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();

        // Initialize sound enabled by default
        if (localStorage.getItem('soundEnabled') === null) {
            localStorage.setItem('soundEnabled', 'true');
        }

        // Make user globally available
        window.user = tg.initDataUnsafe?.user;
        if (window.user) {
            const usernameEl = document.getElementById('username');
            if (usernameEl) {
                usernameEl.textContent = window.user.first_name || '–ú–∞–π–Ω–µ—Ä';
            }
        }

        let energyRegenInterval;
        
        // Pre-initialize audio system for better mobile and Telegram compatibility
        // For Telegram WebApp, force HTML5 Audio immediately
        if (window.Telegram && window.Telegram.WebApp) {
            useHTML5Audio = true;
            audioInitialized = true;
            console.log('Telegram WebApp detected on load, HTML5 Audio will be used');
        } else {
            setTimeout(() => {
                initAudio();
            }, 100);
        }
        

        // VIP Status Management
        function loadVIPStatus(userData) {
            const vipLevel = userData.vip_level || 0;
            const vipBadge = userData.vip_badge || '';
            const hasPremium = userData.has_premium_support || false;
            const hasGolden = userData.has_golden_profile || false;
            const hasTop = userData.has_top_place || false;
            const hasUnique = userData.has_unique_design || false;
            
            // Buttons are now in the header, no need to add them dynamically
            
            if (vipLevel > 0) {
                const badgeEl = document.getElementById('vipBadge');
                const privEl = document.getElementById('vipPrivileges');
                
                // VIP badge display
                const badges = {
                    'bronze_vip': 'ü•â BRONZE VIP',
                    'silver_vip': 'ü•à SILVER VIP',
                    'gold_vip': 'ü•á GOLD VIP',
                    'platinum_vip': 'üíé PLATINUM VIP',
                    'diamond_vip': 'üí† DIAMOND VIP',
                    'absolute_vip': 'üëë ABSOLUTE VIP'
                };
                
                if (badgeEl && vipBadge && vipLevel > 0) {
                    badgeEl.innerHTML = '<span style="background:linear-gradient(135deg,#ffd700,#ffed4e);color:#000;padding:4px 10px;border-radius:8px;font-size:10px;font-weight:700;">' + (badges[vipBadge] || 'VIP') + '</span>';
                    badgeEl.style.display = 'inline';
                } else if (badgeEl) {
                    badgeEl.style.display = 'none';
                }
                
                // VIP privileges display
                if (privEl) {
                    const privs = [];
                    if (hasPremium && vipLevel > 0) privs.push('‚≠ê Premium Support');
                    if (hasGolden && vipLevel > 0) privs.push('üåü Golden Profile');
                    if (hasTop && vipLevel > 0) privs.push('üèÜ Top Place');
                    if (hasUnique && vipLevel > 0) privs.push('‚ú® Unique Design');
                    
                    if (privs.length > 0) {
                        privEl.textContent = privs.join(' ‚Ä¢ ');
                        privEl.style.display = 'block';
                    } else {
                        privEl.style.display = 'none';
                    }
                }
                
                // Apply VIP styling to header
                if (hasGolden && document.getElementById('mainTitle')) {
                    document.getElementById('mainTitle').style.background = 'linear-gradient(135deg, #ffd700, #ffed4e)';
                    document.getElementById('mainTitle').style.webkitBackgroundClip = 'text';
                    document.getElementById('mainTitle').style.webkitTextFillColor = 'transparent';
                    document.getElementById('mainTitle').style.filter = 'drop-shadow(0 0 20px rgba(255,215,0,0.5))';
                }
                
                // Add VIP premium background effect
                if (vipLevel >= 3) {
                    let bgExists = document.querySelector('.vip-golden-bg');
                    if (!bgExists) {
                        const goldenBg = document.createElement('div');
                        goldenBg.className = 'vip-golden-bg';
                        document.body.appendChild(goldenBg);
                        
                        // Add premium shine effect
                        const premiumShine = document.createElement('div');
                        premiumShine.className = 'vip-premium-shine';
                        document.body.appendChild(premiumShine);
                    }
                }
                
                // Add VIP particle effects
                if (vipLevel >= 4) {
                    startVIPParticles();
                }
                
                // Add Aura effect for VIP level 6
                if (vipLevel >= 6) {
                    addVIPAura();
                    addRainbowEffects();
                }
                
                // Apply VIP glow to all clickable elements
                if (vipLevel >= 3) {
                    document.querySelectorAll('.btn, .tap-button').forEach(el => {
                        el.classList.add('vip-glow-box');
                    });
                }
                
                // Show VIP sections if user has appropriate level
                if (vipLevel >= 5) {
                    showVIPMiningSection();
                }
                
                if (vipLevel >= 4) {
                    showVIPEventsSection();
                }
            }
        }
        
        function showVIPMiningSection() {
            // This will be called when VIP user opens mining modal
            const miningModal = document.getElementById('miningModal2');
            if (miningModal && !miningModal.querySelector('#vipMiningSection')) {
                const vipSection = document.createElement('div');
                vipSection.innerHTML = document.getElementById('vipMiningSection')?.innerHTML || '';
                if (miningModal.querySelector('.machinesList')) {
                    miningModal.querySelector('.machinesList').appendChild(vipSection);
                }
            }
        }
        
        function showVIPEventsSection() {
            // VIP events accessible from menu
            // Will be integrated into main interface
        }
        function openVIPProfileModal() {
            fetch('/api/user_data', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({user_id: window.user?.id})
            })
            .then(res => res.json())
            .then(userData => {
                const vipLevel = userData.vip_level || 0;
                const badges = {
                    'bronze_vip': 'ü•â BRONZE VIP',
                    'silver_vip': 'ü•à SILVER VIP',
                    'gold_vip': 'ü•á GOLD VIP',
                    'platinum_vip': 'üíé PLATINUM VIP',
                    'diamond_vip': 'üí† DIAMOND VIP',
                    'absolute_vip': 'üëë ABSOLUTE VIP'
                };
                
                const savedPhoto = localStorage.getItem('vip_profile_photo') || '';
                const photoPlaceholder = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTIwIiBoZWlnaHQ9IjEyMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZGVmcz48bGluZWFyR3JhZGllbnQgaWQ9ImciIHgxPSIwJSIgeTE9IjAlIiB4Mj0iMTAwJSIgeTI9IjEwMCUiPjxzdG9wIG9mZnNldD0iMCUiIHN0b3AtY29sb3I9IiM2NjdFZUEiLz48c3RvcCBvZmZzZXQ9IjEwMCUiIHN0b3AtY29sb3I9IiM3NjRCRUEiLz48L2xpbmVhckdyYWRpZW50PjwvZGVmcz48cmVjdCB3aWR0aD0iMTIwIiBoZWlnaHQ9IjEyMCIgZmlsbD0idXJsKCNnKSIgcng9IjUwJSIvPjx0ZXh0IHg9IjYwIiB5PSI2NSIgZm9udC1zaXplPSI1MCIgZmlsbD0iI2ZmZiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iIGZvbnQtZmFtaWx5PSJBcmlhbCI+4piCPC90ZXh0Pjwvc3ZnPg==';
                
                const modal = document.createElement('div');
                modal.className = 'modal active';
                modal.style.zIndex = '10000';
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 400px; max-height: 90vh; overflow-y: auto;background: linear-gradient(135deg, rgba(10, 14, 39, 0.98), rgba(15, 23, 42, 0.98));border-radius: 24px;border: 2px solid rgba(167,139,250,0.4);box-shadow: 0 10px 40px rgba(167,139,250,0.3);">
                        <div style="background:linear-gradient(135deg,#a78bfa,#c084fc,#d946ef);padding:24px;border-radius:22px 22px 0 0;text-align:center;position:relative;">
                            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;">
                                <h2 style="font-size: 24px; color: #fff; margin: 0; font-weight: 900;">üëë ${userData.username || '–ú–∞–π–Ω–µ—Ä'}</h2>
                                <button class="close-btn" onclick="this.closest('.modal').remove()">‚úï</button>
                            </div>
                            
                            <div style="position:relative;width:110px;height:110px;margin:0 auto 18px;border-radius:50%;background:linear-gradient(135deg,#a78bfa,#c084fc,#d946ef);padding:4px;cursor:pointer;transition:all 0.3s ease;" onclick="document.getElementById('photoInput').click()" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                                <img id="profilePhoto" src="${savedPhoto || photoPlaceholder}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;border:3px solid rgba(255,255,255,0.3);">
                                <div style="position:absolute;bottom:0;right:0;width:36px;height:36px;background:#000;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:18px;border:3px solid #fff;box-shadow:0 2px 10px rgba(0,0,0,0.3);">üì∑</div>
                            </div>
                            <input type="file" id="photoInput" accept="image/*" style="display:none;" onchange="handlePhotoUpload(event)">
                            
                            <div style="background:rgba(0,0,0,0.3);padding:12px;border-radius:12px;color:#fff;margin-bottom:10px;">
                                <div style="font-size:18px;font-weight:900;color:#fff;">${vipLevel > 0 ? (badges[userData.vip_badge || ''] || 'VIP') + ' (–£—Ä–æ–≤–µ–Ω—å ' + vipLevel + ')' : '–û–±—ã—á–Ω—ã–π –∏–≥—Ä–æ–∫'}</div>
                                <div style="font-size:13px;margin-top:5px;opacity:0.8;color:#fff;">${userData.username || '–ú–∞–π–Ω–µ—Ä'}</div>
                            </div>
                        </div>
                        
                        <div style="padding:20px;">
                            ${vipLevel >= 3 ? `
                            <div style="background:linear-gradient(135deg,rgba(255,215,0,0.1),rgba(255,255,255,0.05));padding:12px;border-radius:12px;border:1px solid rgba(255,215,0,0.2);margin-bottom:12px;">
                                <div style="font-size:13px;font-weight:700;margin-bottom:8px;color:#ffd700;">‚ú® VIP –ü–†–ò–í–ò–õ–ï–ì–ò–ò</div>
                                <div style="font-size:11px;color:#fff;line-height:1.8;">
                                    ${userData.has_premium_support ? '‚≠ê Premium Support ' : ''}
                                    ${userData.has_golden_profile ? 'üåü Golden Profile ' : ''}
                                    ${userData.has_top_place ? 'üèÜ Top Place ' : ''}
                                    ${userData.has_unique_design ? '‚ú® Unique Design' : ''}
                                </div>
                            </div>
                            ` : `
                            <button onclick="openBuyVIPModal(); this.closest('.modal').remove();" style="width:100%;padding:14px;background:linear-gradient(135deg,#ffd700,#ffed4e);color:#000;border:none;border-radius:12px;cursor:pointer;font-weight:800;font-size:15px;margin-bottom:15px;box-shadow:0 4px 15px rgba(255,215,0,0.5);">üëë –ö—É–ø–∏—Ç—å VIP</button>
                            `}
                            
                            <div style="background:rgba(0,0,0,0.2);padding:15px;border-radius:12px;margin-bottom:15px;border:1px solid rgba(255,255,255,0.2);">
                                <div style="font-size:14px;font-weight:700;margin-bottom:12px;color:#fff;text-align:center;">üìä –°–¢–ê–¢–ò–°–¢–ò–ö–ê</div>
                                <div style="font-size:12px;line-height:1.9;">
                                    <div style="display:flex;justify-content:space-between;padding:10px;border-bottom:1px solid rgba(255,255,255,0.1);">
                                        <span style="color:#94a3b8;">üí∞ –ö–æ–∏–Ω—ã:</span>
                                        <span data-stat="coins" style="font-weight:700;color:#fff;">${Math.floor(userData.coins || 0)}</span>
                                    </div>
                                    <div style="display:flex;justify-content:space-between;padding:10px;border-bottom:1px solid rgba(255,255,255,0.1);">
                                        <span style="color:#94a3b8;">üíé QuanHash:</span>
                                        <span data-stat="quanhash" style="font-weight:700;color:#fff;">${Math.floor(userData.quanhash || 0)}</span>
                                    </div>
                                    <div style="display:flex;justify-content:space-between;padding:10px;border-bottom:1px solid rgba(255,255,255,0.1);">
                                        <span style="color:#94a3b8;">‚ö° –≠–Ω–µ—Ä–≥–∏—è:</span>
                                        <span data-stat="energy" style="font-weight:700;color:#fff;">${Math.floor(userData.energy || 0)}/${userData.max_energy || 1000}</span>
                                    </div>
                                    <div style="display:flex;justify-content:space-between;padding:10px;border-bottom:1px solid rgba(255,255,255,0.1);">
                                        <span style="color:#94a3b8;">üëÜ –í—Å–µ–≥–æ —Ç–∞–ø–æ–≤:</span>
                                        <span data-stat="total_taps" style="font-weight:700;color:#fff;">${Math.floor(userData.total_taps || 0)}</span>
                                    </div>
                                    ${userData.active_multiplier > 1 ? `
                                    <div style="display:flex;justify-content:space-between;padding:10px;border-bottom:1px solid rgba(255,255,255,0.1);">
                                        <span style="color:#94a3b8;">‚ö° –£—Å–∏–ª–∏—Ç–µ–ª—å —Ç–∞–ø–∞:</span>
                                        <span style="font-weight:700;color:#fbbf24;">+${userData.active_multiplier - 1} —Ç–∞–ø–æ–≤</span>
                                    </div>
                                    ` : ''}
                                    <div style="display:flex;justify-content:space-between;padding:10px;">
                                        <span style="color:#94a3b8;">üíµ –û–±—â–∏–π –¥–æ—Ö–æ–¥:</span>
                                        <span data-stat="total_earned" style="font-weight:700;color:#10b981;">${Math.floor(userData.total_earned || 0)}</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-bottom:15px;">
                                <!-- My Purchases Button -->
                                <div id="myPurchasesBtn" style="cursor:pointer;padding:14px;background:linear-gradient(135deg,#10b981,#059669);border-radius:12px;text-align:center;font-weight:800;font-size:13px;color:#fff;transition:all 0.3s;box-shadow:0 4px 12px rgba(16,185,129,0.3);" onmouseover="this.style.transform='scale(1.05)';this.style.boxShadow='0 6px 16px rgba(16,185,129,0.4)'" onmouseout="this.style.transform='scale(1)';this.style.boxShadow='0 4px 12px rgba(16,185,129,0.3)'">
                                    üõçÔ∏è –ú–æ–∏ –ø–æ–∫—É–ø–∫–∏
                                </div>
                                
                                <!-- Achievements Button -->
                                <div onclick="openAchievements(); this.closest('.modal').remove();" style="cursor:pointer;padding:14px;background:linear-gradient(135deg,#667eea,#764ba2);border-radius:12px;text-align:center;font-weight:800;font-size:13px;color:#fff;transition:all 0.3s;box-shadow:0 4px 12px rgba(102,126,234,0.3);" onmouseover="this.style.transform='scale(1.05)';this.style.boxShadow='0 6px 16px rgba(102,126,234,0.4)'" onmouseout="this.style.transform='scale(1)';this.style.boxShadow='0 4px 12px rgba(102,126,234,0.3)'">
                                    üèÜ –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è
                                </div>
                            </div>
                            
                            <!-- Settings Button -->
                            <div onclick="openSettingsModal(); this.closest('.modal').remove();" style="cursor:pointer;padding:14px;background:linear-gradient(135deg,#4b5563,#374151);border-radius:12px;text-align:center;font-weight:800;font-size:14px;color:#fff;transition:all 0.3s;box-shadow:0 4px 12px rgba(75,85,99,0.3);margin-bottom:15px;" onmouseover="this.style.transform='scale(1.02)';this.style.boxShadow='0 6px 16px rgba(75,85,99,0.4)'" onmouseout="this.style.transform='scale(1)';this.style.boxShadow='0 4px 12px rgba(75,85,99,0.3)'">
                                ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏
                            </div>
                            
                            <button onclick="this.closest('.modal').remove()" style="width:100%;padding:14px;background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border:none;border-radius:12px;cursor:pointer;font-weight:700;font-size:15px;margin-top:10px;">–ó–∞–∫—Ä—ã—Ç—å</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                modal.onclick = (e) => {if(e.target === modal) modal.remove();};
                
                // Add click handler for My Purchases button
                const purchasesBtn = document.getElementById('myPurchasesBtn');
                if (purchasesBtn) {
                    purchasesBtn.addEventListener('click', () => {
                        openMyPurchases(userData);
                    });
                }
            });
        }
        
        function openMyPurchases(userData) {
            // Close profile modal first
            document.querySelectorAll('.modal.active').forEach(m => m.remove());
            
            // Fetch detailed purchase data
            fetch('/api/user_data', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({user_id: window.user?.id})
            })
            .then(res => res.json())
            .then(data => {
                const modal = document.createElement('div');
                modal.className = 'modal active';
                modal.style.zIndex = '10001';
                
                // Get current time for time remaining calculations
                const now = new Date();
                
                let purchasesContent = `
                    <div style="background:linear-gradient(135deg,rgba(10,14,39,0.98),rgba(15,23,42,0.98));border-radius:24px;border:2px solid rgba(167,139,250,0.4);box-shadow:0 10px 40px rgba(167,139,250,0.3);max-width:450px;max-height:85vh;overflow-y:auto;">
                        <div style="background:linear-gradient(135deg,#10b981,#059669);padding:20px;border-radius:22px 22px 0 0;text-align:center;position:relative;">
                            <h2 style="font-size:22px;color:#fff;margin:0;font-weight:900;">üõçÔ∏è –ú–û–ò –ü–û–ö–£–ü–ö–ò</h2>
                            <button class="close-btn" onclick="this.closest('.modal').remove()">‚úï</button>
                        </div>
                        <div style="padding:20px;">
                `;
                
                // Shop purchases: Tap Boost Amplifiers - Show total only
                if (data.active_multiplier > 1 || (data.tap_boost_levels && Object.keys(data.tap_boost_levels).some(k => data.tap_boost_levels[k] > 0))) {
                    purchasesContent += `
                        <div style="margin-bottom:16px;">
                            <div style="font-size:15px;font-weight:800;color:#fff;margin-bottom:10px;padding:8px;background:rgba(251,191,36,0.2);border-radius:8px;">‚ö° –£–°–ò–õ–ò–¢–ï–õ–¨ –¢–ê–ü–ê</div>
                    `;
                    
                    // Show total combined effect
                    const totalTapsFromActiveMultiplier = data.active_multiplier > 1 ? (data.active_multiplier - 1) : 0;
                    purchasesContent += `
                        <div style="background:rgba(251,191,36,0.3);padding:12px;border-radius:10px;margin-bottom:8px;border:1px solid rgba(251,191,36,0.5);">
                            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:5px;">
                                <span style="color:#fff;font-weight:700;font-size:13px;">–û–±—â–∏–π —É—Å–∏–ª–∏—Ç–µ–ª—å —Ç–∞–ø–∞</span>
                                <span style="color:#4ade80;font-weight:700;font-size:13px;">+${totalTapsFromActiveMultiplier} —Ç–∞–ø–æ–≤</span>
                            </div>
                            <div style="color:#86efac;font-size:11px;font-weight:600;">‚ú® –ù–∞–≤—Å–µ–≥–¥–∞</div>
                        </div>
                    `;
                    
                    purchasesContent += `</div>`;
                }
                
                // Shop purchases: Energy Buy (Energy per second recovery) - Show total only
                if (data.energy_regen_rate > 1 || (data.energy_buy_levels && Object.keys(data.energy_buy_levels).some(k => data.energy_buy_levels[k] > 0))) {
                    purchasesContent += `
                        <div style="margin-bottom:16px;">
                            <div style="font-size:15px;font-weight:800;color:#fff;margin-bottom:10px;padding:8px;background:rgba(16,185,129,0.2);border-radius:8px;">‚ö° –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–ï –≠–ù–ï–†–ì–ò–ò</div>
                    `;
                    
                    // Show total regen rate (includes base 1.0 + upgrades)
                    const totalRegen = data.energy_regen_rate || 1.0;
                    const bonusRegen = (totalRegen - 1.0).toFixed(2);
                    if (bonusRegen > 0) {
                        purchasesContent += `
                            <div style="background:rgba(16,185,129,0.3);padding:12px;border-radius:10px;margin-bottom:8px;border:1px solid rgba(16,185,129,0.5);">
                                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:5px;">
                                    <span style="color:#fff;font-weight:700;font-size:13px;">–û–±—â–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è</span>
                                    <span style="color:#4ade80;font-weight:700;font-size:13px;">+${bonusRegen}/—Å–µ–∫</span>
                                </div>
                                <div style="color:#86efac;font-size:11px;font-weight:600;">‚ú® –ù–∞–≤—Å–µ–≥–¥–∞</div>
                            </div>
                        `;
                    }
                    
                    purchasesContent += `</div>`;
                }
                
                // Shop purchases: Energy Expand (Max Energy) - Show total only
                if (data.max_energy > 1000 || (data.energy_expand_levels && Object.keys(data.energy_expand_levels).some(k => data.energy_expand_levels[k] > 0))) {
                    purchasesContent += `
                        <div style="margin-bottom:16px;">
                            <div style="font-size:15px;font-weight:800;color:#fff;margin-bottom:10px;padding:8px;background:rgba(59,130,246,0.2);border-radius:8px;">‚ö° –†–ê–°–®–ò–†–ï–ù–ò–ï –≠–ù–ï–†–ì–ò–ò</div>
                    `;
                    
                    // Show total max energy (includes base 1000 + upgrades)
                    const totalMaxEnergy = data.max_energy || 1000;
                    const bonusEnergy = totalMaxEnergy - 1000;
                    if (bonusEnergy > 0) {
                        purchasesContent += `
                            <div style="background:rgba(59,130,246,0.3);padding:12px;border-radius:10px;margin-bottom:8px;border:1px solid rgba(59,130,246,0.5);">
                                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:5px;">
                                    <span style="color:#fff;font-weight:700;font-size:13px;">–û–±—â–∞—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —ç–Ω–µ—Ä–≥–∏—è</span>
                                    <span style="color:#4ade80;font-weight:700;font-size:13px;">+${bonusEnergy} —ç–Ω–µ—Ä–≥–∏–∏</span>
                                </div>
                                <div style="color:#86efac;font-size:11px;font-weight:600;">‚ú® –ù–∞–≤—Å–µ–≥–¥–∞</div>
                            </div>
                        `;
                    }
                    
                    purchasesContent += `</div>`;
                }
                
                // Autobot status
                if (data.auto_tap_level > 0 && data.auto_tap_expires_at) {
                    const expiresAt = new Date(data.auto_tap_expires_at);
                    if (expiresAt > now) {
                        const remaining = Math.max(0, Math.floor((expiresAt - now) / 1000));
                        const days = Math.floor(remaining / 86400);
                        const hours = Math.floor((remaining % 86400) / 3600);
                        const minutes = Math.floor((remaining % 3600) / 60);
                        
                        purchasesContent += `
                            <div style="margin-bottom:16px;">
                                <div style="font-size:15px;font-weight:800;color:#fff;margin-bottom:10px;padding:8px;background:rgba(16,185,129,0.2);border-radius:8px;">ü§ñ –ê–í–¢–û–ë–û–¢</div>
                                <div style="background:rgba(16,185,129,0.3);padding:12px;border-radius:10px;border:1px solid rgba(16,185,129,0.5);">
                                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:5px;">
                                        <span style="color:#fff;font-weight:700;font-size:13px;">–£—Ä–æ–≤–µ–Ω—å ${data.auto_tap_level} | –°–∫–æ—Ä–æ—Å—Ç—å ${data.auto_tap_speed}/—Å–µ–∫</span>
                                        <span style="color:#4ade80;font-weight:700;font-size:13px;">${data.auto_tap_enabled ? 'üü¢ –ê–∫—Ç–∏–≤–µ–Ω' : '‚ö™ –û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω'}</span>
                                    </div>
                                    <div style="color:#94a3b8;font-size:11px;font-weight:600;">‚è±Ô∏è –û—Å—Ç–∞–ª–æ—Å—å: ${days}–¥ ${String(hours).padStart(2,'0')}:${String(minutes).padStart(2,'0')}</div>
                                </div>
                            </div>
                        `;
                    }
                }
                
                // Group and display purchased cards
                if (data.cards && data.cards.length > 0) {
                    const cardGroups = {};
                    data.cards.forEach(card => {
                        if (!cardGroups[card.name]) {
                            cardGroups[card.name] = { count: 0, totalIncome: 0 };
                        }
                        cardGroups[card.name].count++;
                        cardGroups[card.name].totalIncome += (card.income || 0);
                    });
                    
                    const cardsList = Object.entries(cardGroups);
                    if (cardsList.length > 0) {
                        purchasesContent += `
                            <div style="margin-bottom:16px;">
                                <div style="font-size:15px;font-weight:800;color:#fff;margin-bottom:10px;padding:8px;background:rgba(59,130,246,0.2);border-radius:8px;">üí≥ –ú–û–ò –ö–ê–†–¢–û–ß–ö–ò</div>
                        `;
                        
                        cardsList.forEach(([name, info]) => {
                            // Convert per minute income to per hour
                            const incomePerHour = Math.floor(info.totalIncome * 60);
                            purchasesContent += `
                                <div style="background:rgba(59,130,246,0.3);padding:12px;border-radius:10px;margin-bottom:8px;border:1px solid rgba(59,130,246,0.5);">
                                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:5px;">
                                        <span style="color:#fff;font-weight:700;font-size:13px;">${name} ${info.count > 1 ? `x${info.count}` : ''}</span>
                                        <span style="color:#4ade80;font-weight:700;font-size:13px;">+${incomePerHour}/—á–∞—Å</span>
                                    </div>
                                    <div style="color:#86efac;font-size:11px;font-weight:600;">‚ú® –ü–æ—Å—Ç–æ—è–Ω–Ω–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞</div>
                                </div>
                            `;
                        });
                        
                        purchasesContent += `</div>`;
                    }
                }
                
                // Group and display purchased machines
                if (data.machines && data.machines.length > 0) {
                    const machineGroups = {};
                    data.machines.forEach(machine => {
                        if (!machineGroups[machine.name]) {
                            machineGroups[machine.name] = { count: 0, totalHashRate: 0 };
                        }
                        machineGroups[machine.name].count++;
                        machineGroups[machine.name].totalHashRate += (machine.hash_rate || 0);
                    });
                    
                    const machinesList = Object.entries(machineGroups);
                    if (machinesList.length > 0) {
                        purchasesContent += `
                            <div style="margin-bottom:16px;">
                                <div style="font-size:15px;font-weight:800;color:#fff;margin-bottom:10px;padding:8px;background:rgba(168,85,247,0.2);border-radius:8px;">üè≠ –ú–û–ò –ú–ê–ô–ù–ò–ù–ì–ò</div>
                        `;
                        
                        machinesList.forEach(([name, info]) => {
                            purchasesContent += `
                                <div style="background:rgba(168,85,247,0.3);padding:12px;border-radius:10px;margin-bottom:8px;border:1px solid rgba(168,85,247,0.5);">
                                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:5px;">
                                        <span style="color:#fff;font-weight:700;font-size:13px;">${name} ${info.count > 1 ? `x${info.count}` : ''}</span>
                                        <span style="color:#4ade80;font-weight:700;font-size:13px;">+${(info.totalHashRate * 3600).toFixed(2)}/—á–∞—Å</span>
                                    </div>
                                    <div style="color:#86efac;font-size:11px;font-weight:600;">‚ú® –ü–æ—Å—Ç–æ—è–Ω–Ω–∞—è –º–∞–π–Ω–∏–Ω–≥-—Ñ–µ—Ä–º–∞</div>
                                </div>
                            `;
                        });
                        
                        purchasesContent += `</div>`;
                    }
                }
                
                purchasesContent += `
                        </div>
                    </div>
                `;
                
                modal.innerHTML = purchasesContent;
                document.body.appendChild(modal);
                modal.onclick = (e) => {if(e.target === modal) modal.remove();};
            })
            .catch(err => {
                console.error('Error loading purchases:', err);
                tg.showAlert('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–∫—É–ø–æ–∫');
            });
        }
        
        function handlePhotoUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const photoUrl = e.target.result;
                    localStorage.setItem('vip_profile_photo', photoUrl);
                    document.getElementById('profilePhoto').src = photoUrl;
                    const icon = document.querySelector('.vip-profile-icon');
                    if (icon) {
                        icon.innerHTML = '';
                        const img = document.createElement('img');
                        img.src = photoUrl;
                        icon.appendChild(img);
                    }
                };
                reader.readAsDataURL(file);
            }
        }
        function openVIPTopLeaders() {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.style.zIndex = '10000';
            
            function loadTopData() {
                fetch('/api/top_users', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({limit: 999, user_id: window.user?.id})
                })
                .then(res => {
                    console.log('[TOP_LEADERS] Response status:', res.status);
                    return res.json();
                })
                .then(topData => {
                    console.log('[TOP_LEADERS] Received data:', topData);
                    const topUsers = topData.users || [];
                    console.log('[TOP_LEADERS] Users count:', topUsers.length);
                    
                    // Store current user info globally
                    window.currentUserInTop = topData.current_user || null;
                    window.currentUserPosition = topData.current_user_position || null;
                    
                    // Sort: VIPs first, then by rating descending (backend already does this, but keep for consistency)
                    const sortedUsers = [...topUsers].sort((a, b) => {
                        const aVip = a.vip_level || 0;
                        const bVip = b.vip_level || 0;
                        if (aVip !== bVip) return bVip - aVip; // VIPs first
                        return (b.rating || 0) - (a.rating || 0); // Then by rating
                    });
                    
                    let topHTML = sortedUsers.map((u, idx) => {
                        const medal = idx === 0 ? 'ü•á' : idx === 1 ? 'ü•à' : idx === 2 ? 'ü•â' : '';
                        const rankColor = idx === 0 ? '#ffd700' : idx === 1 ? '#c0c0c0' : idx === 2 ? '#cd7f32' : '#94a3b8';
                        const isVIP = u.vip_level && u.vip_level > 0;
                        const vipBadge = isVIP ? `<span style="background:linear-gradient(135deg,#ffd700,#ffed4e);color:#000;padding:2px 8px;border-radius:8px;font-size:10px;font-weight:800;">üëë VIP ${u.vip_level}</span>` : '';
                        
                        const vipNames = {1: 'Bronze', 2: 'Silver', 3: 'Gold', 4: 'Platinum', 5: 'Diamond', 6: 'Absolute'};
                        const vipName = vipNames[u.vip_level] || '';
                        const vipInfo = isVIP ? `<div style="font-size:10px;color:#ffd700;margin-top:2px;">${vipName} VIP</div>` : '';
                        
                        const passiveIncome = (u.passive_income || 0).toLocaleString();
                        const totalEarned = (u.total_earned || 0).toLocaleString();
                        const totalTaps = (u.total_taps || 0).toLocaleString();
                        const quanhash = (u.quanhash || 0).toLocaleString();
                        
                        return `<div style="padding:14px;background:${isVIP ? 'linear-gradient(135deg,rgba(255,215,0,0.15),rgba(255,255,255,0.08))' : 'rgba(0,0,0,0.25)'};border-radius:12px;margin-bottom:12px;border:2px solid ${isVIP ? 'rgba(255,215,0,0.4)' : 'rgba(255,255,255,0.1)'};">
                            <div style="display:flex;align-items:center;gap:14px;margin-bottom:10px;">
                                <div style="width:50px;height:50px;background:linear-gradient(135deg,#667eea,#764ba2);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:24px;font-weight:900;color:${rankColor};${idx < 3 ? 'box-shadow:0 0 15px rgba(255,215,0,0.5);' : ''}">${medal || (idx + 1)}</div>
                                <div style="flex:1;">
                                    <div style="font-size:16px;font-weight:800;color:#fff;margin-bottom:3px;">${u.username}</div>
                                    <div style="font-size:11px;color:#94a3b8;">–£—Ä–æ–≤–µ–Ω—å ${u.level || 1}</div>
                                    ${vipInfo}
                                    ${vipBadge}
                                </div>
                            </div>
                            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:10px;padding-top:10px;border-top:1px solid rgba(255,255,255,0.1);">
                                <div style="background:rgba(0,0,0,0.3);padding:8px;border-radius:8px;">
                                    <div style="font-size:10px;color:#94a3b8;margin-bottom:3px;">üí∞ –ö–æ–∏–Ω—ã</div>
                                    <div style="font-size:14px;font-weight:800;color:#ffd700;">${u.coins ? (u.coins).toLocaleString() : 0}</div>
                                </div>
                                <div style="background:rgba(0,0,0,0.3);padding:8px;border-radius:8px;">
                                    <div style="font-size:10px;color:#94a3b8;margin-bottom:3px;">üíé QuanHash</div>
                                    <div style="font-size:14px;font-weight:800;color:#10b981;">${quanhash}</div>
                                </div>
                                <div style="padding:8px;border-radius:8px;">
                                    <div style="font-size:10px;color:#94a3b8;margin-bottom:3px;">üìà –ü–∞—Å—Å–∏–≤–Ω—ã–π –¥–æ—Ö–æ–¥</div>
                                    <div style="font-size:14px;font-weight:800;color:#f093fb;">+${passiveIncome}/—á–∞—Å</div>
                                </div>
                                <div style="background:rgba(0,0,0,0.3);padding:8px;border-radius:8px;">
                                    <div style="font-size:10px;color:#94a3b8;margin-bottom:3px;">üíµ –í—Å–µ–≥–æ –∑–∞—Ä–∞–±–æ—Ç–∞–Ω–æ</div>
                                    <div style="font-size:14px;font-weight:800;color:#10b981;">${totalEarned}</div>
                                </div>
                                <div style="background:rgba(0,0,0,0.3);padding:8px;border-radius:8px;">
                                    <div style="font-size:10px;color:#94a3b8;margin-bottom:3px;">üëÜ –í—Å–µ–≥–æ —Ç–∞–ø–æ–≤</div>
                                    <div style="font-size:14px;font-weight:800;color:#94a3b8;">${totalTaps}</div>
                                </div>
                                <div style="background:rgba(0,0,0,0.3);padding:8px;border-radius:8px;">
                                    <div style="font-size:10px;color:#94a3b8;margin-bottom:3px;">üèÜ –†–µ–π—Ç–∏–Ω–≥</div>
                                    <div style="font-size:14px;font-weight:800;color:#667eea;">${u.rating ? Math.round(u.rating).toLocaleString() : 0}</div>
                                </div>
                            </div>
                        </div>`;
                    }).join('');
                    
                    const contentDiv = modal.querySelector('#topLeadersContent');
                    if (contentDiv) {
                        contentDiv.innerHTML = topUsers.length > 0 ? topHTML : '<div style="text-align:center;color:#94a3b8;padding:40px;font-size:14px;">–†–µ–π—Ç–∏–Ω–≥ –ø—É—Å—Ç</div>';
                    }
                    
                    // Auto-update current user position display
                    const positionDiv = modal.querySelector('#currentUserPosition');
                    const infoDiv = modal.querySelector('#currentUserInfo');
                    if (positionDiv && infoDiv) {
                        const currentUserPos = window.currentUserPosition;
                        const currentUser = window.currentUserInTop;
                        
                        if (currentUser && currentUserPos) {
                            positionDiv.style.display = 'block';
                            const level = currentUser.level || 1;
                            const rating = currentUser.rating || 0;
                            const vipBadge = currentUser.vip_level && currentUser.vip_level > 0 ? `üëë VIP ${currentUser.vip_level}` : '';
                            infoDiv.innerHTML = `<div style="font-size:16px;font-weight:900;color:#ffd700;margin-bottom:5px;">${currentUser.username}</div><div style="font-size:13px;color:#fff;">–ú–µ—Å—Ç–æ #${currentUserPos} ‚Ä¢ –£—Ä–æ–≤–µ–Ω—å ${level} ‚Ä¢ –†–µ–π—Ç–∏–Ω–≥ ${Math.round(rating).toLocaleString()} ${vipBadge}</div>`;
                        } else if (currentUserPos === null) {
                            // Position is null means user not in top, but hide block initially
                            // Only show if user manually clicks "Find Yourself" button
                            positionDiv.style.display = 'none';
                        }
                    }
                })
                .catch(err => {
                    console.error('[TOP_LEADERS] Error loading top users:', err);
                    const contentDiv = modal.querySelector('#topLeadersContent');
                    if (contentDiv) {
                        contentDiv.innerHTML = '<div style="text-align:center;color:#ef4444;padding:40px;font-size:14px;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ–π—Ç–∏–Ω–≥–∞</div>';
                    }
                });
            }
            
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 450px; max-height: 90vh; overflow-y: auto;background: linear-gradient(135deg, rgba(10, 14, 39, 0.98), rgba(15, 23, 42, 0.98));border-radius: 20px;border: 2px solid rgba(102,126,234,0.4);">
                    <div style="background:linear-gradient(135deg,#667eea,#764ba2);padding:20px;border-radius:18px 18px 0 0;text-align:center;position:relative;">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                            <h2 style="font-size: 24px; color: #fff; margin: 0; font-weight: 900;">üèÜ –¢–û–ü –õ–ò–î–ï–†–´</h2>
                            <button class="close-btn" onclick="const modal = this.closest('.modal'); modal.remove(); if(window.topLeadersInterval) clearInterval(window.topLeadersInterval); if(window.tournamentInterval) clearInterval(window.tournamentInterval);">‚úï</button>
                        </div>
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:10px;">
                            <div style="font-size:13px;color:rgba(255,255,255,0.8);">üîÑ –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ</div>
                            <button id="tournamentBtn" onclick="openTournamentModal();" style="margin-right:50px;padding:10px 20px;background:linear-gradient(135deg,rgba(16,185,129,0.4),rgba(5,150,105,0.4));color:#fff;border:2px solid rgba(16,185,129,0.6);border-radius:12px;cursor:pointer;font-weight:800;font-size:14px;transition:all 0.3s;box-shadow:0 4px 12px rgba(16,185,129,0.3);" onmouseover="this.style.background='linear-gradient(135deg,rgba(16,185,129,0.6),rgba(5,150,105,0.6))';this.style.transform='scale(1.05)';this.style.boxShadow='0 6px 16px rgba(16,185,129,0.5)'" onmouseout="this.style.background='linear-gradient(135deg,rgba(16,185,129,0.4),rgba(5,150,105,0.4))';this.style.transform='scale(1)';this.style.boxShadow='0 4px 12px rgba(16,185,129,0.3)'">üèÜ –¢—É—Ä–Ω–∏—Ä</button>
                        </div>
                    </div>
                    
                    <div style="padding:20px;">
                        <div id="currentUserPosition" style="display:none;margin-bottom:15px;padding:12px;background:linear-gradient(135deg,rgba(255,215,0,0.15),rgba(255,255,255,0.08));border:2px solid rgba(255,215,0,0.4);border-radius:12px;text-align:center;">
                            <div style="font-size:14px;font-weight:800;color:#ffd700;margin-bottom:5px;">üìç –í–∞—à–∞ –ø–æ–∑–∏—Ü–∏—è –≤ –¢–û–ü</div>
                            <div style="font-size:11px;color:#94a3b8;" id="currentUserInfo">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                        </div>
                        <div id="tournamentInfo" style="display:none;margin-bottom:15px;padding:12px;background:linear-gradient(135deg,rgba(16,185,129,0.15),rgba(255,255,255,0.08));border:2px solid rgba(16,185,129,0.4);border-radius:12px;">
                            <div style="font-size:14px;font-weight:800;color:#10b981;margin-bottom:8px;">‚è∞ –ù–µ–¥–µ–ª—å–Ω—ã–π –¢—É—Ä–Ω–∏—Ä –¢–û–ü-20</div>
                            <div style="font-size:12px;color:#fff;margin-bottom:6px;">–î–æ –∫–æ–Ω—Ü–∞ —Ç—É—Ä–Ω–∏—Ä–∞: <span id="tournamentTimer">--:--:--</span></div>
                            <div style="font-size:11px;color:#86efac;">üí∞ –ë–æ–Ω—É—Å—ã –¥–ª—è –¢–û–ü-20 –≤ –∫–æ–Ω—Ü–µ –Ω–µ–¥–µ–ª–∏!</div>
                        </div>
                        <div id="topLeadersContent" style="max-height:550px;overflow-y:auto;">
                            <div style="text-align:center;color:#94a3b8;padding:40px;font-size:14px;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                        </div>
                        
                        <button onclick="const modal = this.closest('.modal'); modal.remove(); if(window.topLeadersInterval) clearInterval(window.topLeadersInterval); if(window.tournamentInterval) clearInterval(window.tournamentInterval);" style="width:100%;margin-top:15px;padding:14px;background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border:none;border-radius:12px;cursor:pointer;font-weight:700;font-size:15px;">–ó–∞–∫—Ä—ã—Ç—å</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            modal.onclick = (e) => {if(e.target === modal) { modal.remove(); if(window.topLeadersInterval) clearInterval(window.topLeadersInterval); if(window.tournamentInterval) clearInterval(window.tournamentInterval); }};
            
            // Tournament timer function
            function updateTournamentTimer() {
                const tournamentInfo = modal.querySelector('#tournamentInfo');
                const timerEl = modal.querySelector('#tournamentTimer');
                
                if (!tournamentInfo || !timerEl) return;
                
                // Calculate time until next Monday 00:00
                const now = new Date();
                const dayOfWeek = now.getDay(); // 0 = Sunday, 1 = Monday, etc.
                const daysUntilMonday = dayOfWeek === 0 ? 1 : (8 - dayOfWeek) % 7 || 7;
                const nextMonday = new Date(now);
                nextMonday.setDate(now.getDate() + daysUntilMonday);
                nextMonday.setHours(0, 0, 0, 0);
                
                const timeLeft = nextMonday - now;
                
                if (timeLeft > 0) {
                    const days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
                    const hours = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
                    const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
                    
                    timerEl.textContent = `${days}–¥ ${String(hours).padStart(2,'0')}:${String(minutes).padStart(2,'0')}:${String(seconds).padStart(2,'0')}`;
                    tournamentInfo.style.display = 'block';
                } else {
                    tournamentInfo.style.display = 'none';
                }
            }
            
            // Update tournament info periodically
            window.tournamentInterval = setInterval(updateTournamentTimer, 1000);
            
            // Load data immediately
            loadTopData();
            updateTournamentTimer();
            
            // Auto-refresh every 2.5 seconds
            window.topLeadersInterval = setInterval(loadTopData, 2500);
        }
        
        function addVIPAura() {
            let aura = document.querySelector('.vip-aura');
            if (!aura) {
                aura = document.createElement('div');
                aura.className = 'vip-aura';
                document.body.appendChild(aura);
            }
        }
        
        function openTournamentModal() {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.style.zIndex = '10001';
            
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 500px; max-height: 90vh; overflow-y: auto;background: linear-gradient(135deg, rgba(10, 14, 39, 0.98), rgba(15, 23, 42, 0.98));border-radius: 20px;border: 2px solid rgba(16,185,129,0.4);">
                    <div style="background:linear-gradient(135deg,#10b981,#059669);padding:20px;border-radius:18px 18px 0 0;text-align:center;position:relative;">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                            <h2 style="font-size: 20px; color: #fff; margin: 0; font-weight: 900;">üèÜ –¢—É—Ä–Ω–∏—Ä –¢–û–ü-20</h2>
                            <button class="close-btn" onclick="this.closest('.modal').remove(); if(window.tournamentModalInterval) clearInterval(window.tournamentModalInterval);">‚úï</button>
                        </div>
                        <div style="font-size:14px;color:rgba(255,255,255,0.9);margin-top:10px;">
                            ‚è∞ –î–æ –∫–æ–Ω—Ü–∞ —Ç—É—Ä–Ω–∏—Ä–∞: <span id="tournamentModalTimer" style="font-weight:900;font-size:16px;">--:--:--</span>
                        </div>
                    </div>
                    
                    <div style="padding:20px;">
                        <div style="background:linear-gradient(135deg,rgba(16,185,129,0.15),rgba(255,255,255,0.08));padding:16px;border-radius:12px;border:2px solid rgba(16,185,129,0.3);margin-bottom:20px;">
                            <div style="font-size:16px;font-weight:800;color:#10b981;margin-bottom:10px;">üí∞ –ù–∞–≥—Ä–∞–¥—ã –∑–∞ –¢–û–ü-20</div>
                            <div style="font-size:13px;color:#fff;line-height:1.8;">
                                <div>ü•á 1 –º–µ—Å—Ç–æ: <span style="color:#ffd700;font-weight:800;">10,000,000 üí∞</span> + <span style="color:#10b981;font-weight:800;">50,000 üíé</span></div>
                                <div>ü•à 2 –º–µ—Å—Ç–æ: <span style="color:#c0c0c0;font-weight:800;">7,500,000 üí∞</span> + <span style="color:#10b981;font-weight:800;">37,500 üíé</span></div>
                                <div>ü•â 3 –º–µ—Å—Ç–æ: <span style="color:#cd7f32;font-weight:800;">5,000,000 üí∞</span> + <span style="color:#10b981;font-weight:800;">25,000 üíé</span></div>
                                <div>4-10 –º–µ—Å—Ç–∞: <span style="color:#86efac;font-weight:800;">2,500,000 üí∞</span> + <span style="color:#10b981;font-weight:800;">12,500 üíé</span></div>
                                <div>11-20 –º–µ—Å—Ç–∞: <span style="color:#86efac;font-weight:800;">1,000,000 üí∞</span> + <span style="color:#10b981;font-weight:800;">5,000 üíé</span></div>
                            </div>
                        </div>
                        
                        <div style="background:rgba(16,185,129,0.1);padding:14px;border-radius:12px;border:2px solid rgba(16,185,129,0.2);margin-bottom:20px;">
                            <div style="font-size:14px;font-weight:800;color:#10b981;margin-bottom:8px;">üìã –ü—Ä–∞–≤–∏–ª–∞ —Ç—É—Ä–Ω–∏—Ä–∞</div>
                            <div style="font-size:12px;color:#86efac;line-height:1.6;">
                                ‚Ä¢ –¢—É—Ä–Ω–∏—Ä –ø—Ä–æ–≤–æ–¥–∏—Ç—Å—è –∫–∞–∂–¥—É—é –Ω–µ–¥–µ–ª—é<br>
                                ‚Ä¢ –ü–æ–¥—Å—á—ë—Ç –ø–æ —Ä–µ–π—Ç–∏–Ω–≥—É –¢–û–ü-20 –∏–≥—Ä–æ–∫–æ–≤<br>
                                ‚Ä¢ –ù–∞–≥—Ä–∞–¥—ã —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è—é—Ç—Å—è –≤ –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ 00:00<br>
                                ‚Ä¢ –ù–æ–≤—ã–π —Ç—É—Ä–Ω–∏—Ä –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –∫–∞–∂–¥—É—é –Ω–µ–¥–µ–ª—é<br>
                                ‚Ä¢ –ë–æ–Ω—É—Å—ã –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
                            </div>
                        </div>
                        
                        <div style="background:linear-gradient(135deg,rgba(255,215,0,0.15),rgba(255,255,255,0.08));padding:14px;border-radius:12px;border:2px solid rgba(255,215,0,0.3);margin-bottom:20px;">
                            <div style="font-size:14px;font-weight:800;color:#ffd700;margin-bottom:8px;">üåü –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –±–æ–Ω—É—Å—ã</div>
                            <div style="font-size:12px;color:#fff;line-height:1.6;">
                                ‚Ä¢ VIP –∏–≥—Ä–æ–∫–∏ –ø–æ–ª—É—á–∞—é—Ç x2 –±–æ–Ω—É—Å—ã<br>
                                ‚Ä¢ –ü—Ä–∏–∑–æ–≤–æ–π —Ñ–æ–Ω–¥ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ<br>
                                ‚Ä¢ –ù–∞–≥—Ä–∞–¥—ã –Ω–∞—á–∏—Å–ª—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏<br>
                                ‚Ä¢ –í—Å–µ —É—á–∞—Å—Ç–Ω–∏–∫–∏ –¢–û–ü-100 –≤–∏–¥—è—Ç —Å–≤–æ–π –ø—Ä–æ–≥—Ä–µ—Å—Å
                            </div>
                        </div>
                        
                        <button onclick="this.closest('.modal').remove(); if(window.tournamentModalInterval) clearInterval(window.tournamentModalInterval);" style="width:100%;padding:14px;background:linear-gradient(135deg,#10b981,#059669);color:#fff;border:none;border-radius:12px;cursor:pointer;font-weight:700;font-size:15px;">–ü–æ–Ω—è—Ç–Ω–æ</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            modal.onclick = (e) => {if(e.target === modal) { modal.remove(); if(window.tournamentModalInterval) clearInterval(window.tournamentModalInterval); }};
            
            // Tournament timer in modal
            function updateTournamentModalTimer() {
                const timerEl = modal.querySelector('#tournamentModalTimer');
                if (!timerEl) return;
                
                const now = new Date();
                const dayOfWeek = now.getDay();
                const daysUntilMonday = dayOfWeek === 0 ? 1 : (8 - dayOfWeek) % 7 || 7;
                const nextMonday = new Date(now);
                nextMonday.setDate(now.getDate() + daysUntilMonday);
                nextMonday.setHours(0, 0, 0, 0);
                
                const timeLeft = nextMonday - now;
                
                if (timeLeft > 0) {
                    const days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
                    const hours = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
                    const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
                    
                    timerEl.textContent = `${days}–¥ ${String(hours).padStart(2,'0')}:${String(minutes).padStart(2,'0')}:${String(seconds).padStart(2,'0')}`;
                }
            }
            
            window.tournamentModalInterval = setInterval(updateTournamentModalTimer, 1000);
            updateTournamentModalTimer();
        }
        
        function openBuyVIPModal() {
            const vipPackages = [
                {level: 1, name: 'Bronze VIP', stars: 300, color: '#cd7f32', badge: 'ü•â', benefits: ['‚≠ê Premium Support', '‚ú® –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –º–∞—Ä–∫–µ—Ä', '‚ûï 20% –∫ —Ç–∞–ø—É'], productId: 51},
                {level: 2, name: 'Silver VIP', stars: 600, color: '#c0c0c0', badge: 'ü•à', benefits: ['‚≠ê Premium Support', '‚ú® –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –º–∞—Ä–∫–µ—Ä', 'üèÜ Top Place', '‚ûï 50% –∫ —Ç–∞–ø—É'], productId: 52},
                {level: 3, name: 'Gold VIP', stars: 1000, color: '#ffd700', badge: 'ü•á', benefits: ['‚≠ê Premium Support', 'üåü Golden Profile', 'üèÜ Top Place', '‚ú® Unique Design', '‚ûï 100% –∫ —Ç–∞–ø—É', '‚ö° 50% —ç–Ω–µ—Ä–≥–∏–∏'], productId: 53},
                {level: 4, name: 'Platinum VIP', stars: 1500, color: '#e5e4e2', badge: 'üíé', benefits: ['–í—Å–µ –∏–∑ Gold VIP', 'üéâ VIP –¢—É—Ä–Ω–∏—Ä—ã', '‚ú® –ß–∞—Å—Ç–∏—Ü—ã', '‚ûï 150% –∫ —Ç–∞–ø—É'], productId: 54},
                {level: 5, name: 'Diamond VIP', stars: 2000, color: '#b9f2ff', badge: 'üí†', benefits: ['–í—Å–µ –∏–∑ Platinum VIP', 'üëë –ö–æ—Ä–æ–Ω–∞', 'üí∞ 0% –∫–æ–º–∏—Å—Å–∏—è', '‚ûï 250% –∫ —Ç–∞–ø—É', 'üíé VIP Boost 50x'], productId: 55},
                {level: 6, name: 'Absolute VIP', stars: 3000, color: '#ff69b4', badge: 'üëë', benefits: ['–í—Å–µ –∏–∑ Diamond VIP', '‚ú® –ê—É—Ä–∞', 'üåà –†–∞–¥—É–≥–∞', '‚ûï 450% –∫ —Ç–∞–ø—É', 'üåê VIP –ú–∞—à–∏–Ω—ã'], productId: 56}
            ];
            
            let vipHTML = vipPackages.map(pkg => `
                <div style="background:linear-gradient(135deg,${pkg.color},rgba(255,255,255,0.1));padding:14px;border-radius:12px;margin-bottom:12px;border:2px solid ${pkg.color};box-shadow:0 4px 15px ${pkg.color}40;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                        <div style="display:flex;align-items:center;gap:10px;">
                            <span style="font-size:28px;">${pkg.badge}</span>
                            <div>
                                <div style="font-size:16px;font-weight:900;color:#000;">${pkg.name}</div>
                                <div style="font-size:12px;color:rgba(0,0,0,0.7);">–£—Ä–æ–≤–µ–Ω—å ${pkg.level}</div>
                            </div>
                        </div>
                        <div style="text-align:right;">
                            <div style="font-size:20px;font-weight:900;color:#000;">${pkg.stars}</div>
                            <div style="font-size:11px;color:rgba(0,0,0,0.7);">‚≠ê –∑–≤–µ–∑–¥</div>
                        </div>
                    </div>
                    <div style="background:rgba(0,0,0,0.2);padding:10px;border-radius:8px;margin-bottom:10px;">
                        <div style="font-size:11px;color:rgba(0,0,0,0.8);line-height:1.8;">
                            ${pkg.benefits.map(b => `<div>‚úì ${b}</div>`).join('')}
                        </div>
                    </div>
                    <button onclick="window.open('https://t.me/qanexus_bot?start=buy_stars_${pkg.productId}')" style="width:100%;padding:10px;background:#000;color:${pkg.color};border:none;border-radius:8px;font-weight:900;font-size:13px;cursor:pointer;">–ö—É–ø–∏—Ç—å VIP –∑–∞ ${pkg.stars} ‚≠ê</button>
                </div>
            `).join('');
            
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.style.zIndex = '10000';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 420px; max-height: 90vh; overflow-y: auto;background: linear-gradient(135deg, rgba(10, 14, 39, 0.98), rgba(15, 23, 42, 0.98));border-radius: 24px;border: 2px solid rgba(255,215,0,0.4);box-shadow: 0 10px 40px rgba(255,215,0,0.3);">
                    <div style="background:linear-gradient(135deg,#ffd700,#ffed4e);padding:24px;border-radius:22px 22px 0 0;text-align:center;position:relative;">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                            <h2 style="font-size: 26px; color: #000; margin: 0; font-weight: 900;">üëë VIP –°–¢–ê–¢–£–°–´</h2>
                            <button class="close-btn" onclick="this.closest('.modal').remove()">‚úï</button>
                        </div>
                        <div style="font-size:14px;color:rgba(0,0,0,0.7);">–í—ã–±–µ—Ä–∏—Ç–µ VIP –ø–∞–∫–µ—Ç</div>
                    </div>
                    
                    <div style="padding:20px;">
                        ${vipHTML}
                        
                        <button onclick="this.closest('.modal').remove()" style="width:100%;padding:14px;background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border:none;border-radius:12px;cursor:pointer;font-weight:700;font-size:15px;margin-top:10px;">–ó–∞–∫—Ä—ã—Ç—å</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            modal.onclick = (e) => {if(e.target === modal) modal.remove();};
        }
        
        function addRainbowEffects() {
            // Apply rainbow border to key elements
            const elements = document.querySelectorAll('.stat-item-compact, .btn');
            elements.forEach(el => {
                el.style.border = '3px solid #ffd700';
                el.style.animation = 'vip-rainbow 3s linear infinite';
            });
        }
        
        function startVIPParticles() {
            // Remove existing particles
            const existing = document.querySelector('.vip-particles');
            if (existing) existing.remove();
            
            const particles = document.createElement('div');
            particles.className = 'vip-particles';
            
            for (let i = 0; i < 15; i++) {
                setTimeout(() => {
                    if (!particles.parentNode) return;
                    const particle = document.createElement('div');
                    particle.style.position = 'absolute';
                    particle.style.width = Math.random() * 6 + 2 + 'px';
                    particle.style.height = particle.style.width;
                    particle.style.background = '#ffd700';
                    particle.style.borderRadius = '50%';
                    particle.style.left = Math.random() * 100 + '%';
                    particle.style.top = '100%';
                    particle.style.boxShadow = '0 0 10px #ffd700, 0 0 20px #ffed4e';
                    particle.style.animation = `vip-float ${10 + Math.random() * 10}s linear infinite`;
                    particles.appendChild(particle);
                }, i * 200);
            }
            
            document.body.appendChild(particles);
        }
        
        const shopItems = {
            boosts: [
                {name: "2x –ú–Ω–æ–∂–∏—Ç–µ–ª—å", emoji: "‚ö°", price: 1000, desc: "–£—Å–∏–ª–∏–≤–∞–µ—Ç –≤–∞—à–∏ —Ç–∞–ø—ã –∏ —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–ª–∏–∫–æ–≤", type: "multiplier_2x"},
                {name: "5x –ú–Ω–æ–∂–∏—Ç–µ–ª—å", emoji: "üî•", price: 5000, desc: "–ú–æ—â–Ω–æ —É—Å–∏–ª–∏–≤–∞–µ—Ç –≤–∞—à–∏ —Ç–∞–ø—ã –∏ —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–ª–∏–∫–æ–≤", type: "multiplier_5x"},
                {name: "10x –ú–Ω–æ–∂–∏—Ç–µ–ª—å", emoji: "üí•", price: 20000, desc: "–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ —É—Å–∏–ª–∏–≤–∞–µ—Ç –≤–∞—à–∏ —Ç–∞–ø—ã –∏ —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–ª–∏–∫–æ–≤", type: "multiplier_10x"},
            ],
            automation: [
                {name: "ü§ñ –ê–≤—Ç–æ-–±–æ—Ç —Ç–∞–ø–æ–≤", emoji: "ü§ñ", price: 50000, desc: "–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ç–∞–ø–∞–µ—Ç –∑–∞ –≤–∞—Å", type: "auto_bot"},
                {name: "‚ö° –î–≤–æ–π–Ω–∞—è —ç–Ω–µ—Ä–≥–∏—è", emoji: "‚ö°", price: 30000, desc: "–£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –∑–∞–ø–∞—Å –≤–∞—à–µ–π —ç–Ω–µ—Ä–≥–∏–∏", type: "double_energy"},
                {name: "üîÑ –£—Å–∫–æ—Ä–µ–Ω–∏–µ —Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏", emoji: "üîÑ", price: 40000, desc: "–£—Å–∫–æ—Ä—è–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –≤–∞—à–µ–π —ç–Ω–µ—Ä–≥–∏–∏", type: "regen_boost"},
            ],
            energy: [
                {name: "–≠–Ω–µ—Ä–≥–∏—è +50", emoji: "‚ö°", price: 1000, amount: 50},
                {name: "–≠–Ω–µ—Ä–≥–∏—è +200", emoji: "‚ö°‚ö°", price: 3500, amount: 200},
                {name: "–≠–Ω–µ—Ä–≥–∏—è +500", emoji: "‚ö°‚ö°‚ö°", price: 8000, amount: 500},
            ],
            cards: [
                {name: "–û–±—ã—á–Ω–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞", emoji: "üü¢", price: 500, desc: "–ü–∞—Å—Å–∏–≤–Ω—ã–π –¥–æ—Ö–æ–¥: 0.5 ü™ô/–º–∏–Ω", type: "common"},
                {name: "–†–µ–¥–∫–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞", emoji: "üîµ", price: 2000, desc: "–ü–∞—Å—Å–∏–≤–Ω—ã–π –¥–æ—Ö–æ–¥: 2 ü™ô/–º–∏–Ω", type: "rare"},
                {name: "–≠–ø–∏—á–µ—Å–∫–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞", emoji: "üü£", price: 10000, desc: "–ü–∞—Å—Å–∏–≤–Ω—ã–π –¥–æ—Ö–æ–¥: 10 ü™ô/–º–∏–Ω", type: "epic"},
                {name: "–õ–µ–≥–µ–Ω–¥–∞—Ä–Ω–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞", emoji: "üü†", price: 50000, desc: "–ü–∞—Å—Å–∏–≤–Ω—ã–π –¥–æ—Ö–æ–¥: 50 ü™ô/–º–∏–Ω", type: "legendary"},
            ]
        };

        function loadData() {
            fetch('/api/user_data', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({user_id: window.user?.id})
            })
            .then(res => res.json())
            .then(data => {
                // Save user data globally for shop calculations
                window.userData = data;
                
                const coins = Math.floor(data.coins || 0);
                const quanhash = Math.floor(data.quanhash || 0);
                const energy = parseInt(data.energy || 0);
                const maxEnergy = parseInt(data.max_energy || 1000);
                const energyRegenRate = parseFloat(data.energy_regen_rate || 1.0);
                const passiveCoins = Math.floor(data.passive_coins_per_hour || 0);
                const passiveHash = Math.floor(data.passive_hash_per_hour || 0);
                
                document.getElementById('coins').textContent = coins.toLocaleString();
                document.getElementById('quanhash').textContent = quanhash.toLocaleString();
                document.getElementById('energy-text').textContent = `${energy}/${maxEnergy}`;
                document.getElementById('passiveCoins').textContent = `+${passiveCoins.toLocaleString()}/—á–∞—Å`;
                document.getElementById('passiveHash').textContent = `+${passiveHash.toLocaleString()}/—á–∞—Å`;
                
                // Update username from database or localStorage or Telegram
                const savedUsername = localStorage.getItem('username');
                const dbUsername = data.username || null;
                const usernameEl = document.getElementById('username');
                
                if (usernameEl) {
                    if (dbUsername) {
                        // Database username takes priority
                        usernameEl.textContent = dbUsername;
                        // Sync to localStorage
                        if (!savedUsername || savedUsername !== dbUsername) {
                            localStorage.setItem('username', dbUsername);
                        }
                    } else if (savedUsername) {
                        // Fallback to localStorage
                        usernameEl.textContent = savedUsername;
                    } else if (window.user) {
                        // Fallback to Telegram name
                        usernameEl.textContent = window.user.first_name || '–ú–∞–π–Ω–µ—Ä';
                    } else {
                        usernameEl.textContent = '–ú–∞–π–Ω–µ—Ä';
                    }
                }
                
                const energyPercent = Math.min(100, Math.max(0, (energy / maxEnergy) * 100));
                const fillBar = document.getElementById('energy-bar-fill');
                const percentText = document.getElementById('energy-percent');
                if (fillBar) {
                    fillBar.style.width = energyPercent + '%';
                }
                if (percentText) {
                    percentText.textContent = Math.round(energyPercent) + '%';
                }

                // Update energy regeneration rate display
                const energyRegenText = document.getElementById('energy-regen-text');
                if (energyRegenText) {
                    energyRegenText.textContent = `–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ: +${energyRegenRate.toFixed(1)}/—Å–µ–∫`;
                }
                
                // Update energy regeneration rate in the running interval
                if (window.energyRegenRate !== undefined) {
                    window.energyRegenRate = energyRegenRate;
                }

                // Update user level and rating
                const level = data.level || 1;
                const experience = data.experience || 0;
                const rating = data.rating || 0;
                
                // Calculate experience needed for current and next level
                const currentLevelExp = (level - 1) ** 2 * 100;
                const nextLevelExp = (level ** 2) * 100;
                const expProgress = experience - currentLevelExp;
                const expNeeded = nextLevelExp - currentLevelExp;
                const levelPercent = Math.min(100, Math.max(0, (expProgress / expNeeded) * 100));
                
                // Update level display
                const levelEl = document.getElementById('user-level');
                const expEl = document.getElementById('user-experience');
                const nextExpEl = document.getElementById('user-next-level-exp');
                const ratingEl = document.getElementById('user-rating');
                const levelProgressFill = document.getElementById('level-progress-fill');
                const levelProgressPercent = document.getElementById('level-progress-percent');
                
                if (levelEl) levelEl.textContent = level;
                if (expEl) expEl.textContent = Math.round(expProgress).toLocaleString();
                if (nextExpEl) nextExpEl.textContent = Math.round(expNeeded).toLocaleString();
                if (ratingEl) ratingEl.textContent = Math.round(rating).toLocaleString();
                if (levelProgressFill) levelProgressFill.style.width = levelPercent + '%';
                if (levelProgressPercent) levelProgressPercent.textContent = Math.round(levelPercent) + '%';
                
                // Load VIP status and display it
                loadVIPStatus(data);
                
                // Update autobot toggle button
                updateAutobotToggle(data);
                
                // DON'T update autobot shop buttons from loadData() - causes blinking
                // They are updated only when category is loaded via loadShopCategory()

                // Show withdraw button if user has 500k+ quanhash
                
                // Load shop levels after user data is loaded
                loadShopLevels();
                
                // Force refresh of current shop category if it's open (but NEVER autobot to avoid blinking)
                setTimeout(() => {
                    const activeBtn = document.querySelector('.shop-cat-btn[style*="linear-gradient"]');
                    if (activeBtn && activeBtn.dataset.category) {
                        const category = activeBtn.dataset.category;
                        // Never reload autobot category automatically (causes blinking)
                        if (category !== 'autobot' && category !== 'autobot_vip') {
                            loadShopCategory(category);
                        }
                        // Do nothing for autobot - buttons are updated only on initial category load
                    }
                }, 100);
            })
            .catch(err => console.error('Error:', err));
        }
        function updateAutobotToggle(data) {
            const autobotStatusSection = document.getElementById('autobotStatusSection');
            const autobotStatusBtn = document.getElementById('autobotStatusBtn');
            
            if (!autobotStatusSection || !autobotStatusBtn) return;
            
            const autobotLevel = data.auto_tap_level || 0;
            const autobotSpeed = data.auto_tap_speed || 2.0;
            const autobotExpiresAt = data.auto_tap_expires_at || 0;
            
            // Show status if user has autobot (level > 0 and not expired)
            if (autobotLevel > 0 && autobotExpiresAt > Date.now()) {
                autobotStatusSection.style.display = 'block';
                
                // Store current state globally
                window.autobotExpiresAt = autobotExpiresAt;
                
                // Calculate remaining time
                const remainingMs = autobotExpiresAt - Date.now();
                const hours = Math.floor(remainingMs / 3600000);
                const minutes = Math.floor((remainingMs % 3600000) / 60000);
                const seconds = Math.floor((remainingMs % 60000) / 1000);
                const timeText = `${String(hours).padStart(2,'0')}:${String(minutes).padStart(2,'0')}:${String(seconds).padStart(2,'0')}`;
                
                // Update status text
                autobotStatusBtn.innerHTML = `ü§ñ –ê–≤—Ç–æ–±–æ—Ç –∞–∫—Ç–∏–≤–µ–Ω | –£—Ä–æ–≤–µ–Ω—å ${autobotLevel} | –°–∫–æ—Ä–æ—Å—Ç—å ${autobotSpeed}/—Å–µ–∫ | ‚è±Ô∏è –û—Å—Ç–∞–ª–æ—Å—å: ${timeText}`;
                
                // Update countdown
                if (window.autobotInterval) clearInterval(window.autobotInterval);
                window.autobotInterval = setInterval(() => {
                    const now = Date.now();
                    const remainingMs = window.autobotExpiresAt - now;
                    
                    if (remainingMs <= 0) {
                        clearInterval(window.autobotInterval);
                        autobotStatusSection.style.display = 'none';
                        return;
                    }
                    
                    const hours = Math.floor(remainingMs / 3600000);
                    const minutes = Math.floor((remainingMs % 3600000) / 60000);
                    const seconds = Math.floor((remainingMs % 60000) / 1000);
                    const timeText = `${String(hours).padStart(2,'0')}:${String(minutes).padStart(2,'0')}:${String(seconds).padStart(2,'0')}`;
                    
                    autobotStatusBtn.innerHTML = `ü§ñ –ê–≤—Ç–æ–±–æ—Ç –∞–∫—Ç–∏–≤–µ–Ω | –£—Ä–æ–≤–µ–Ω—å ${autobotLevel} | –°–∫–æ—Ä–æ—Å—Ç—å ${autobotSpeed}/—Å–µ–∫ | ‚è±Ô∏è –û—Å—Ç–∞–ª–æ—Å—å: ${timeText}`;
                }, 1000);
            } else {
                autobotStatusSection.style.display = 'none';
                if (window.autobotInterval) clearInterval(window.autobotInterval);
            }
        }
        
        function updateAutobotShopButtons(data) {
            const autobotExpiresAt = data.auto_tap_expires_at || 0;
            const autobotLevel = data.auto_tap_level || 0;
            const currentTime = Date.now();
            
            // Clear any existing interval
            if (window.autobotShopInterval) {
                clearInterval(window.autobotShopInterval);
                window.autobotShopInterval = null;
            }
            
            // Find all autobot buttons (they have data-autobot-level attribute)
            const allAutobotButtons = document.querySelectorAll('[data-autobot-level]');
            
            if (allAutobotButtons.length === 0) {
                return; // Buttons not rendered yet
            }
            
            // Check if autobot is active
            if (autobotExpiresAt > currentTime && autobotLevel > 0) {
                // Block ALL autobot buttons immediately - set state once, no updates after
                allAutobotButtons.forEach(btn => {
                    const btnLevel = parseInt(btn.getAttribute('data-autobot-level')) || 0;
                    const isPurchased = btnLevel === autobotLevel;
                    
                    // Always block button - disabled
                    btn.disabled = true;
                    btn.style.cursor = 'not-allowed';
                    
                    const mainText = btn.querySelector('.autobot-btn-main-text');
                    const countdownSpan = btn.querySelector('.autobot-countdown');
                    
                    if (isPurchased) {
                        // Purchased button: show active state with countdown ONLY
                        btn.style.background = 'rgba(16,185,129,0.6)';
                        if (mainText) mainText.textContent = 'ü§ñ –ê–≤—Ç–æ–±–æ—Ç –∞–∫—Ç–∏–≤–µ–Ω';
                        if (countdownSpan) {
                            countdownSpan.style.display = 'block';
                            // Initial countdown update
                            const remainingMs = autobotExpiresAt - currentTime;
                            const hours = Math.floor(remainingMs / 3600000);
                            const minutes = Math.floor((remainingMs % 3600000) / 60000);
                            const seconds = Math.floor((remainingMs % 60000) / 1000);
                            countdownSpan.textContent = `‚è±Ô∏è –û—Å—Ç–∞–ª–æ—Å—å: ${String(hours).padStart(2,'0')}:${String(minutes).padStart(2,'0')}:${String(seconds).padStart(2,'0')}`;
                        }
                    } else {
                        // Other buttons: show blocked state - NEVER show price
                        btn.style.background = 'rgba(148,163,184,0.3)';
                        if (mainText) mainText.textContent = 'üîí –ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ';
                        if (countdownSpan) countdownSpan.style.display = 'none';
                    }
                });
                
                // Set up interval to update ONLY the countdown text (not the button, not the main text)
                window.autobotShopInterval = setInterval(() => {
                    const now = Date.now();
                    const remainingMs = autobotExpiresAt - now;
                    
                    if (remainingMs <= 0) {
                        clearInterval(window.autobotShopInterval);
                        window.autobotShopInterval = null;
                        // Reload data to refresh button states (autobot expired)
                        if (window.userData) {
                            window.userData.auto_tap_expires_at = 0;
                            window.userData.auto_tap_level = 0;
                        }
                        // Update buttons once to unblock them
                        updateAutobotShopButtons(window.userData || data);
                        return;
                    }
                    
                    // Update ONLY the countdown text in the purchased button (span textContent only)
                    const purchasedBtn = document.querySelector(`[data-autobot-level="${autobotLevel}"]`);
                    if (purchasedBtn) {
                        const countdownSpan = purchasedBtn.querySelector('.autobot-countdown');
                        if (countdownSpan) {
                            const hours = Math.floor(remainingMs / 3600000);
                            const minutes = Math.floor((remainingMs % 3600000) / 60000);
                            const seconds = Math.floor((remainingMs % 60000) / 1000);
                            // Update ONLY textContent, nothing else
                            countdownSpan.textContent = `‚è±Ô∏è –û—Å—Ç–∞–ª–æ—Å—å: ${String(hours).padStart(2,'0')}:${String(minutes).padStart(2,'0')}:${String(seconds).padStart(2,'0')}`;
                        }
                    }
                }, 1000);
            } else {
                // Unblock all buttons (autobot not active)
                allAutobotButtons.forEach(btn => {
                    btn.disabled = false;
                    btn.style.cursor = 'pointer';
                    btn.style.background = 'linear-gradient(135deg,#667eea,#764ba2)';
                    
                    const mainText = btn.querySelector('.autobot-btn-main-text');
                    const countdownSpan = btn.querySelector('.autobot-countdown');
                    
                    // Restore original button text (need to get price from shopData)
                    const btnLevel = parseInt(btn.getAttribute('data-autobot-level')) || 0;
                    if (mainText) {
                        // Find price from shopData
                        const autobotItems = window.shopData?.autobot?.items || [];
                        const item = autobotItems.find(it => it.level === btnLevel);
                        if (item) {
                            if (item.currency === 'stars') {
                                mainText.textContent = `–ö—É–ø–∏—Ç—å –∑–∞ ${item.basePrice || item.price} ‚≠ê Stars`;
                            } else {
                                mainText.textContent = `–ö—É–ø–∏—Ç—å –∑–∞ ${(item.price || 0).toLocaleString()} ü™ô`;
                            }
                        }
                    }
                    if (countdownSpan) countdownSpan.style.display = 'none';
                });
            }
        }

        function checkOfflineIncome() {
            fetch('/api/offline_income', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({user_id: window.user?.id})
            })
            .then(res => res.json())
            .then(data => {
                if (data.offline_time > 0 && data.offline_income > 0) {
                    const hours = Math.floor(data.offline_time / 3600);
                    const minutes = Math.floor((data.offline_time % 3600) / 60);
                    
                    // Check for offline QuanHash income too
                    const offlineHash = data.offline_hash || 0;
                    
                    const offlineContent = `
                        <div style="text-align: center; padding: 25px 15px;">
                            <div style="margin-bottom: 16px;">
                                <div style="font-size: 50px; filter: drop-shadow(0 0 15px rgba(74,222,128,0.6)); margin-bottom: 10px;">üí∞</div>
                                <div style="font-size: 16px; font-weight: 700; color: #4ade80; margin-bottom: 8px;">–ü—Ä–∏–≤–µ—Ç, —Å –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ–º!</div>
                                <div style="font-size: 11px; color: rgba(255,255,255,0.6); padding: 5px 12px; background: rgba(102,126,234,0.12); border-radius: 12px; display: inline-block;">‚è±Ô∏è ${hours}—á ${minutes}–º</div>
                            </div>
                            
                            <div style="display: grid; gap: 10px; margin-bottom: 12px;">
                                ${data.offline_income > 0 ? `
                                <div style="background: linear-gradient(135deg, rgba(102,126,234,0.2), rgba(118,75,162,0.2)); border: 1px solid rgba(102,126,234,0.5); border-radius: 14px; padding: 12px 16px; backdrop-filter: blur(10px);">
                                    <div style="font-size: 12px; color: rgba(255,255,255,0.7); margin-bottom: 4px; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 4px;">
                                        <span>ü™ô</span> <span>–ö–û–ò–ù–´</span>
                                    </div>
                                    <div style="font-size: 32px; font-weight: 900; color: #4ade80; letter-spacing: -1px;">+${Math.floor(data.offline_income).toLocaleString()}</div>
                                </div>
                                ` : ''}
                                
                                ${offlineHash > 0 ? `
                                <div style="background: linear-gradient(135deg, rgba(118,75,162,0.2), rgba(240,147,251,0.2)); border: 1px solid rgba(118,75,162,0.5); border-radius: 14px; padding: 12px 16px; backdrop-filter: blur(10px);">
                                    <div style="font-size: 12px; color: rgba(255,255,255,0.7); margin-bottom: 4px; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 4px;">
                                        <span>üíé</span> <span>QUANHASH</span>
                                    </div>
                                    <div style="font-size: 32px; font-weight: 900; color: #f093fb; letter-spacing: -1px;">+${Math.floor(offlineHash).toLocaleString()}</div>
                                </div>
                                ` : ''}
                            </div>
                            
                            <div style="font-size: 10px; opacity: 0.4; font-style: italic; margin-top: 12px;">‚ú® –î–æ–±–∞–≤–ª–µ–Ω–æ –Ω–∞ –±–∞–ª–∞–Ω—Å</div>
                        </div>
                    `;
                    document.getElementById('offlineContent').innerHTML = offlineContent;
                    document.getElementById('offlinePopup').classList.add('active');
                    
                    // Update user data
                    fetch('/api/user_data', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({user_id: window.user?.id})
                    })
                    .then(res => res.json())
                    .then(data => {
                        const coins = Math.floor(data.coins || 0);
                        document.getElementById('coins').textContent = coins;
                    });
                }
            });
        }

        // Sound and audio management - optimized for Telegram WebApp mobile
        // (Variables declared at the top of the script)
        
        // Initialize audio system - try Web Audio API first, fallback to HTML5 Audio
        function initAudio() {
            if (audioInitialized) return;
            
            // For ALL Telegram WebApp (mobile and desktop), prefer HTML5 Audio
            if (isTelegramWebApp()) {
                console.log('Telegram WebApp detected, using HTML5 Audio');
                useHTML5Audio = true;
                audioInitialized = true;
                return;
            }
            
            // Also use HTML5 Audio for mobile browsers
            if (isMobile()) {
                console.log('Mobile browser detected, using HTML5 Audio');
                useHTML5Audio = true;
                audioInitialized = true;
                return;
            }
            
            // Try Web Audio API for desktop
            if (!audioContext) {
                try {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    console.log('AudioContext created, state:', audioContext.state);
                    useHTML5Audio = false;
                    audioInitialized = true;
                    
                    // Resume AudioContext if suspended (required by modern browsers)
                    if (audioContext.state === 'suspended') {
                        console.log('AudioContext suspended, attempting to resume...');
                        audioContext.resume().then(() => {
                            console.log('AudioContext resumed successfully, state:', audioContext.state);
                        }).catch(e => {
                            console.log('Audio resume failed, falling back to HTML5 Audio:', e);
                            useHTML5Audio = true;
                        });
                    }
                } catch(e) {
                    console.log('Web Audio API not supported, using HTML5 Audio:', e);
                    useHTML5Audio = true;
                    audioInitialized = true;
                }
            }
        }
        
        // Generate a simple tone as WAV data URI
        // Enhanced WAV generator with harmonics, chords, and varied waveforms
        function generateToneWAV(config) {
            const sampleRate = 44100;
            const duration = config.duration || 0.1;
            const volume = config.volume || 0.15;
            const baseFreq = config.freq || 440;
            const harmonics = config.harmonics || []; // Array of {freq: multiplier, volume: 0-1}
            const waveform = config.waveform || 'sine'; // 'sine', 'triangle', 'sine2' (two sine waves)
            const freqMod = config.freqMod || null; // {type: 'ramp'|'vibrato', to: freq, speed: rate}
            
            const numSamples = Math.floor(sampleRate * duration);
            const buffer = new ArrayBuffer(44 + numSamples * 2);
            const view = new DataView(buffer);
            
            // WAV header
            const writeString = (offset, string) => {
                for (let i = 0; i < string.length; i++) {
                    view.setUint8(offset + i, string.charCodeAt(i));
                }
            };
            
            writeString(0, 'RIFF');
            view.setUint32(4, 36 + numSamples * 2, true);
            writeString(8, 'WAVE');
            writeString(12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true);
            view.setUint16(22, 1, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * 2, true);
            view.setUint16(32, 2, true);
            view.setUint16(34, 16, true);
            writeString(36, 'data');
            view.setUint32(40, numSamples * 2, true);
            
            // Generate rich, musical tones
            for (let i = 0; i < numSamples; i++) {
                const t = i / sampleRate;
                const progress = t / duration;
                
                // Exponential fade out for smooth sound
                const fadeOut = Math.pow(1 - progress, 1.5);
                
                let sample = 0;
                
                // Base frequency with optional modulation
                let currentFreq = baseFreq;
                if (freqMod) {
                    if (freqMod.type === 'ramp') {
                        currentFreq = baseFreq + (freqMod.to - baseFreq) * progress;
                    } else if (freqMod.type === 'vibrato') {
                        const vibratoAmount = (freqMod.to - baseFreq) * 0.1;
                        currentFreq = baseFreq + Math.sin(2 * Math.PI * freqMod.speed * t) * vibratoAmount;
                    }
                }
                
                // Generate base waveform
                if (waveform === 'sine') {
                    sample = Math.sin(2 * Math.PI * currentFreq * t) * volume;
                } else if (waveform === 'triangle') {
                    const phase = (2 * Math.PI * currentFreq * t) % (2 * Math.PI);
                    sample = (2 * Math.abs(2 * phase / Math.PI - 1) - 1) * volume;
                } else if (waveform === 'sine2') {
                    // Two sine waves with slight detuning for richness
                    sample = (Math.sin(2 * Math.PI * currentFreq * t) * 0.6 + 
                              Math.sin(2 * Math.PI * currentFreq * 1.005 * t) * 0.4) * volume;
                } else if (waveform === 'bell') {
                    // Bell-like sound with harmonics
                    sample = Math.sin(2 * Math.PI * currentFreq * t) * 0.5 +
                             Math.sin(2 * Math.PI * currentFreq * 2 * t) * 0.25 +
                             Math.sin(2 * Math.PI * currentFreq * 3 * t) * 0.15 +
                             Math.sin(2 * Math.PI * currentFreq * 4 * t) * 0.1;
                    sample *= volume;
                } else if (waveform === 'chord') {
                    // Major chord (1:1.25:1.5 frequency ratios for major triad)
                    sample = Math.sin(2 * Math.PI * currentFreq * t) * 0.4 +
                             Math.sin(2 * Math.PI * currentFreq * 1.25 * t) * 0.35 +
                             Math.sin(2 * Math.PI * currentFreq * 1.5 * t) * 0.25;
                    sample *= volume;
                } else {
                    sample = Math.sin(2 * Math.PI * currentFreq * t) * volume;
                }
                
                // Add harmonics
                for (const harm of harmonics) {
                    const harmFreq = baseFreq * harm.freq;
                    sample += Math.sin(2 * Math.PI * harmFreq * t) * volume * harm.volume * 0.3;
                }
                
                // Apply fade out
                sample *= fadeOut;
                
                // Soft clipping for warmth
                sample = Math.tanh(sample * 0.8) * 1.2;
                
                const intSample = Math.max(-32768, Math.min(32767, Math.floor(sample * 32768)));
                view.setInt16(44 + i * 2, intSample, true);
            }
            
            const blob = new Blob([buffer], { type: 'audio/wav' });
            return URL.createObjectURL(blob);
        }
        
        // Play sound using HTML5 Audio with rich, varied, musical sounds
        function playSoundHTML5(type) {
            try {
                // Generate slight variation for taps to avoid monotony
                const tapVariation = Math.random() * 0.1 - 0.05; // ¬±5% variation
                
                const soundConfigs = {
                    'tap': {
                        freq: 330 + tapVariation * 330,
                        duration: 0.08,
                        volume: 0.2,
                        waveform: 'sine2',
                        harmonics: [{freq: 2, volume: 0.15}],
                        freqMod: {type: 'ramp', to: 380}
                    },
                    'coin': {
                        freq: 440,
                        duration: 0.12,
                        volume: 0.22,
                        waveform: 'bell',
                        freqMod: {type: 'ramp', to: 523}
                    },
                    'levelup': {
                        freq: 262,
                        duration: 0.35,
                        volume: 0.25,
                        waveform: 'chord',
                        freqMod: {type: 'ramp', to: 523}
                    },
                    'error': {
                        freq: 165,
                        duration: 0.18,
                        volume: 0.18,
                        waveform: 'triangle',
                        freqMod: {type: 'ramp', to: 110}
                    },
                    'success': {
                        freq: 330,
                        duration: 0.2,
                        volume: 0.22,
                        waveform: 'sine2',
                        freqMod: {type: 'ramp', to: 523}
                    },
                    'purchase': {
                        freq: 392,
                        duration: 0.25,
                        volume: 0.25,
                        waveform: 'bell',
                        freqMod: {type: 'ramp', to: 523}
                    },
                    'mining': {
                        freq: 220,
                        duration: 0.15,
                        volume: 0.2,
                        waveform: 'sine2',
                        harmonics: [{freq: 1.5, volume: 0.2}],
                        freqMod: {type: 'vibrato', to: 262, speed: 5}
                    },
                    'card': {
                        freq: 440,
                        duration: 0.18,
                        volume: 0.22,
                        waveform: 'triangle',
                        freqMod: {type: 'ramp', to: 330}
                    },
                    'energy_regen': {
                        freq: 330,
                        duration: 0.15,
                        volume: 0.2,
                        waveform: 'sine2',
                        freqMod: {type: 'ramp', to: 523}
                    },
                    'achievement': {
                        freq: 262,
                        duration: 0.5,
                        volume: 0.28,
                        waveform: 'chord',
                        harmonics: [{freq: 2, volume: 0.3}, {freq: 3, volume: 0.2}],
                        freqMod: {type: 'ramp', to: 523}
                    },
                    'click_boost': {
                        freq: 440,
                        duration: 0.12,
                        volume: 0.22,
                        waveform: 'sine2',
                        freqMod: {type: 'ramp', to: 880}
                    },
                    'vip_levelup': {
                        freq: 262,
                        duration: 0.6,
                        volume: 0.3,
                        waveform: 'chord',
                        harmonics: [{freq: 2, volume: 0.25}, {freq: 3, volume: 0.15}],
                        freqMod: {type: 'ramp', to: 523}
                    },
                    'collection': {
                        freq: 392,
                        duration: 0.18,
                        volume: 0.22,
                        waveform: 'bell',
                        freqMod: {type: 'ramp', to: 523}
                    },
                    'bonus': {
                        freq: 262,
                        duration: 0.4,
                        volume: 0.25,
                        waveform: 'chord',
                        freqMod: {type: 'ramp', to: 523}
                    },
                    'crypto_tap': {
                        freq: 440,
                        duration: 0.15,
                        volume: 0.22,
                        waveform: 'sine2',
                        harmonics: [{freq: 1.5, volume: 0.15}],
                        freqMod: {type: 'vibrato', to: 554, speed: 8}
                    },
                    'big_coin': {
                        freq: 262,
                        duration: 0.35,
                        volume: 0.28,
                        waveform: 'bell',
                        harmonics: [{freq: 2, volume: 0.25}],
                        freqMod: {type: 'ramp', to: 523}
                    },
                    'stars_collect': {
                        freq: 523,
                        duration: 0.3,
                        volume: 0.25,
                        waveform: 'bell',
                        harmonics: [{freq: 2, volume: 0.2}, {freq: 3, volume: 0.15}],
                        freqMod: {type: 'ramp', to: 659}
                    },
                    'machine_working': {
                        freq: 110,
                        duration: 0.35,
                        volume: 0.18,
                        waveform: 'sine2',
                        harmonics: [{freq: 2, volume: 0.15}],
                        freqMod: {type: 'vibrato', to: 131, speed: 3}
                    },
                    'rebirth': {
                        freq: 110,
                        duration: 1.0,
                        volume: 0.3,
                        waveform: 'chord',
                        harmonics: [{freq: 2, volume: 0.2}, {freq: 3, volume: 0.15}],
                        freqMod: {type: 'ramp', to: 523}
                    },
                    'powerup': {
                        freq: 330,
                        duration: 0.25,
                        volume: 0.25,
                        waveform: 'sine2',
                        freqMod: {type: 'ramp', to: 880}
                    },
                    'critical_hit': {
                        freq: 110,
                        duration: 0.15,
                        volume: 0.25,
                        waveform: 'triangle',
                        harmonics: [{freq: 2, volume: 0.3}],
                        freqMod: {type: 'ramp', to: 165}
                    },
                    'level_milestone': {
                        freq: 262,
                        duration: 0.6,
                        volume: 0.3,
                        waveform: 'chord',
                        harmonics: [{freq: 2, volume: 0.25}, {freq: 3, volume: 0.2}],
                        freqMod: {type: 'ramp', to: 523}
                    },
                    'combo': {
                        freq: 262,
                        duration: 0.35,
                        volume: 0.25,
                        waveform: 'chord',
                        freqMod: {type: 'ramp', to: 523}
                    },
                    'daily_bonus': {
                        freq: 262,
                        duration: 0.7,
                        volume: 0.3,
                        waveform: 'chord',
                        harmonics: [{freq: 2, volume: 0.25}, {freq: 3, volume: 0.2}],
                        freqMod: {type: 'ramp', to: 523}
                    },
                    'shop_hover': {
                        freq: 554,
                        duration: 0.06,
                        volume: 0.15,
                        waveform: 'sine'
                    },
                    'scroll': {
                        freq: 330,
                        duration: 0.1,
                        volume: 0.15,
                        waveform: 'sine2',
                        freqMod: {type: 'ramp', to: 392}
                    },
                    'notification': {
                        freq: 392,
                        duration: 0.15,
                        volume: 0.22,
                        waveform: 'bell',
                        freqMod: {type: 'ramp', to: 523}
                    },
                    'wrong_action': {
                        freq: 100,
                        duration: 0.15,
                        volume: 0.15,
                        waveform: 'triangle',
                        freqMod: {type: 'ramp', to: 80}
                    },
                    'open_menu': {
                        freq: 220,
                        duration: 0.15,
                        volume: 0.18,
                        waveform: 'sine2',
                        freqMod: {type: 'ramp', to: 165}
                    },
                    'close_menu': {
                        freq: 165,
                        duration: 0.15,
                        volume: 0.18,
                        waveform: 'sine2',
                        freqMod: {type: 'ramp', to: 220}
                    },
                    'click': {
                        freq: 220 + Math.random() * 40,
                        duration: 0.04,
                        volume: 0.15,
                        waveform: 'sine'
                    }
                };
                
                const config = soundConfigs[type] || {
                    freq: 220,
                    duration: 0.1,
                    volume: 0.2,
                    waveform: 'sine'
                };
                
                // Always create a new audio element for each play (better for mobile and Telegram)
                const audioUrl = generateToneWAV(config);
                const audio = new Audio(audioUrl);
                // Higher volume for Telegram WebApp and mobile
                const isTelegram = isTelegramWebApp();
                audio.volume = isTelegram ? 0.85 : 0.75;
                
                // Try to play immediately
                const playPromise = audio.play();
                
                if (playPromise !== undefined) {
                    playPromise.then(() => {
                        console.log('HTML5 Audio playing successfully:', type);
                    }).catch(error => {
                        console.log('HTML5 Audio play failed, trying again:', error);
                        // Try again after a short delay
                        setTimeout(() => {
                            audio.play().catch(e => {
                                console.log('HTML5 Audio retry failed:', e);
                            });
                        }, 100);
                    });
                }
                
            } catch(e) {
                console.log('HTML5 Audio error:', e);
            }
        }
        
        function playSound(type) {
            try {
                // Initialize sound enabled by default if not set
                let soundSetting = localStorage.getItem('soundEnabled');
                if (soundSetting === null) {
                    soundSetting = 'true'; // Enable by default
                    localStorage.setItem('soundEnabled', 'true');
                }
                
                // Must be explicitly 'true' to play sound
                const soundEnabled = soundSetting === 'true';
                if (!soundEnabled) {
                    console.log('Sound disabled, setting:', soundSetting);
                    return;
                }
                
                console.log('Playing sound:', type);
                initAudio();
                
                // Force HTML5 Audio for Telegram WebApp
                if (isTelegramWebApp()) {
                    useHTML5Audio = true;
                    playSoundHTML5(type);
                    return;
                }
                
                // Use HTML5 Audio for mobile or if Web Audio API is not available
                if (useHTML5Audio || !audioContext) {
                    playSoundHTML5(type);
                    return;
                }
                
                console.log('AudioContext state:', audioContext.state);
                // Ensure AudioContext is running - resume if suspended
                if (audioContext.state === 'suspended') {
                    console.log('Resuming AudioContext...');
                    audioContext.resume().then(() => {
                        // Context is now running, retry playing sound
                        console.log('AudioContext resumed, retrying sound');
                        playSound(type);
                    }).catch(e => {
                        console.log('Audio resume failed, using HTML5 Audio:', e);
                        useHTML5Audio = true;
                        playSoundHTML5(type);
                    });
                    return; // Exit and wait for resume to complete
                }
                
                console.log('Creating oscillator for sound:', type, 'AudioContext:', audioContext);
                
                // Helper function to create multi-oscillator sounds (chords, harmonics)
                const createRichSound = (freqs, types, volumes, duration, gainRamp = true) => {
                    const gainNode = audioContext.createGain();
                    const oscs = [];
                    
                    for (let i = 0; i < freqs.length; i++) {
                        const osc = audioContext.createOscillator();
                        osc.type = types[i] || 'sine';
                        osc.frequency.value = freqs[i];
                        const oscGain = audioContext.createGain();
                        oscGain.gain.value = volumes[i] || 0.15;
                        osc.connect(oscGain);
                        oscGain.connect(gainNode);
                        osc.start(audioContext.currentTime);
                        osc.stop(audioContext.currentTime + duration);
                        oscs.push(osc);
                    }
                    
                    gainNode.connect(audioContext.destination);
                    if (gainRamp) {
                        gainNode.gain.setValueAtTime(0.15, audioContext.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
                    } else {
                        gainNode.gain.setValueAtTime(0.15, audioContext.currentTime);
                    }
                    
                    return {oscs, gainNode};
                };
                
                // Tap variation for less monotony
                const tapVariation = Math.random() * 0.15 - 0.075; // ¬±7.5% variation
                
                switch(type) {
                    case 'tap':
                        // Rich tap sound with slight variation and harmonics
                        const tapFreq = 330 + tapVariation * 330;
                        createRichSound(
                            [tapFreq, tapFreq * 2],
                            ['sine', 'sine'],
                            [0.2, 0.1],
                            0.08
                        );
                        // Add frequency sweep for richness
                        const osc1 = audioContext.createOscillator();
                        const gain1 = audioContext.createGain();
                        osc1.type = 'sine';
                        osc1.frequency.value = tapFreq;
                        osc1.frequency.exponentialRampToValueAtTime(tapFreq * 1.15, audioContext.currentTime + 0.08);
                        osc1.connect(gain1);
                        gain1.gain.setValueAtTime(0.15, audioContext.currentTime);
                        gain1.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.08);
                        gain1.connect(audioContext.destination);
                        osc1.start(audioContext.currentTime);
                        osc1.stop(audioContext.currentTime + 0.08);
                        break;
                    case 'coin':
                        // Bell-like coin sound with harmonics
                        createRichSound(
                            [440, 880, 1320],
                            ['sine', 'sine', 'sine'],
                            [0.25, 0.15, 0.1],
                            0.15
                        );
                        const coinOsc = audioContext.createOscillator();
                        const coinGain = audioContext.createGain();
                        coinOsc.type = 'sine';
                        coinOsc.frequency.value = 440;
                        coinOsc.frequency.exponentialRampToValueAtTime(523, audioContext.currentTime + 0.15);
                        coinOsc.connect(coinGain);
                        coinGain.gain.setValueAtTime(0.2, audioContext.currentTime);
                        coinGain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.15);
                        coinGain.connect(audioContext.destination);
                        coinOsc.start(audioContext.currentTime);
                        coinOsc.stop(audioContext.currentTime + 0.15);
                        break;
                    case 'levelup':
                        // Majestic level up with chord progression
                        const levelupChord = createRichSound(
                            [262, 330, 392, 523],
                            ['sine', 'sine', 'sine', 'sine'],
                            [0.25, 0.2, 0.18, 0.22],
                            0.5
                        );
                        // Frequency sweeps for each note
                        levelupChord.oscs[0].frequency.exponentialRampToValueAtTime(523, audioContext.currentTime + 0.5);
                        levelupChord.oscs[1].frequency.exponentialRampToValueAtTime(659, audioContext.currentTime + 0.5);
                        levelupChord.oscs[2].frequency.exponentialRampToValueAtTime(784, audioContext.currentTime + 0.5);
                        levelupChord.oscs[3].frequency.setValueAtTime(523, audioContext.currentTime);
                        break;
                    case 'error':
                        // Soft error with downward sweep
                        const errorOsc = audioContext.createOscillator();
                        const errorGain = audioContext.createGain();
                        errorOsc.type = 'triangle';
                        errorOsc.frequency.value = 165;
                        errorOsc.frequency.exponentialRampToValueAtTime(110, audioContext.currentTime + 0.2);
                        errorOsc.connect(errorGain);
                        errorGain.gain.setValueAtTime(0.18, audioContext.currentTime);
                        errorGain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
                        errorGain.connect(audioContext.destination);
                        errorOsc.start(audioContext.currentTime);
                        errorOsc.stop(audioContext.currentTime + 0.2);
                        break;
                    case 'success':
                        // Success with ascending chord
                        createRichSound(
                            [330, 392, 523],
                            ['sine', 'sine', 'sine'],
                            [0.2, 0.18, 0.22],
                            0.25
                        );
                        break;
                    case 'purchase':
                        // Rich purchase bell with harmonics
                        const purchaseChord = createRichSound(
                            [392, 523, 659],
                            ['sine', 'sine', 'sine'],
                            [0.25, 0.22, 0.15],
                            0.3
                        );
                        // Frequency sweep
                        purchaseChord.oscs[0].frequency.exponentialRampToValueAtTime(523, audioContext.currentTime + 0.3);
                        purchaseChord.oscs[1].frequency.exponentialRampToValueAtTime(659, audioContext.currentTime + 0.3);
                        purchaseChord.oscs[2].frequency.exponentialRampToValueAtTime(784, audioContext.currentTime + 0.3);
                        break;
                    case 'mining':
                        // Rich mining sound with vibrato
                        const miningOsc = audioContext.createOscillator();
                        const miningGain = audioContext.createGain();
                        miningOsc.type = 'sine';
                        miningOsc.frequency.value = 220;
                        miningOsc.frequency.setValueAtTime(220, audioContext.currentTime);
                        miningOsc.frequency.setValueAtTime(262, audioContext.currentTime + 0.05);
                        miningOsc.frequency.setValueAtTime(220, audioContext.currentTime + 0.1);
                        miningOsc.connect(miningGain);
                        miningGain.gain.setValueAtTime(0.18, audioContext.currentTime);
                        miningGain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.18);
                        miningGain.connect(audioContext.destination);
                        miningOsc.start(audioContext.currentTime);
                        miningOsc.stop(audioContext.currentTime + 0.18);
                        break;
                    case 'card':
                        // Rich card flip with harmonics
                        createRichSound(
                            [440, 660],
                            ['triangle', 'sine'],
                            [0.2, 0.15],
                            0.2
                        );
                        break;
                    case 'energy_regen':
                        // Energy regen with ascending shimmer
                        createRichSound(
                            [330, 523, 659],
                            ['sine', 'sine', 'sine'],
                            [0.18, 0.15, 0.12],
                            0.18
                        );
                        break;
                    case 'achievement':
                        // Majestic achievement with full chord progression
                        const achievementChord = createRichSound(
                            [262, 330, 392, 523, 659],
                            ['sine', 'sine', 'sine', 'sine', 'sine'],
                            [0.25, 0.2, 0.18, 0.22, 0.15],
                            0.6
                        );
                        // Frequency sweeps for epic sound
                        achievementChord.oscs[0].frequency.exponentialRampToValueAtTime(523, audioContext.currentTime + 0.6);
                        achievementChord.oscs[1].frequency.exponentialRampToValueAtTime(659, audioContext.currentTime + 0.6);
                        achievementChord.oscs[2].frequency.exponentialRampToValueAtTime(784, audioContext.currentTime + 0.6);
                        achievementChord.oscs[3].frequency.setValueAtTime(523, audioContext.currentTime);
                        achievementChord.oscs[4].frequency.exponentialRampToValueAtTime(1047, audioContext.currentTime + 0.6);
                        break;
                    case 'click_boost':
                        // Rich click boost with ascending harmonic
                        createRichSound(
                            [440, 880],
                            ['sine', 'sine'],
                            [0.22, 0.18],
                            0.15
                        );
                        break;
                    case 'vip_levelup':
                        // Epic VIP level up with full chord
                        const vipChord = createRichSound(
                            [262, 330, 392, 523, 659],
                            ['sine', 'sine', 'sine', 'sine', 'sine'],
                            [0.28, 0.22, 0.2, 0.25, 0.18],
                            0.7
                        );
                        // Epic frequency progression
                        vipChord.oscs[0].frequency.exponentialRampToValueAtTime(523, audioContext.currentTime + 0.7);
                        vipChord.oscs[1].frequency.exponentialRampToValueAtTime(659, audioContext.currentTime + 0.7);
                        vipChord.oscs[2].frequency.exponentialRampToValueAtTime(784, audioContext.currentTime + 0.7);
                        vipChord.oscs[3].frequency.setValueAtTime(523, audioContext.currentTime);
                        vipChord.oscs[4].frequency.exponentialRampToValueAtTime(1047, audioContext.currentTime + 0.7);
                        break;
                    case 'collection':
                        // Rich collection with bell-like harmonics
                        createRichSound(
                            [392, 523, 784],
                            ['sine', 'sine', 'sine'],
                            [0.22, 0.18, 0.12],
                            0.2
                        );
                        break;
                    case 'bonus':
                        // Rich bonus with ascending chord
                        const bonusChord = createRichSound(
                            [262, 392, 523],
                            ['sine', 'sine', 'sine'],
                            [0.25, 0.2, 0.22],
                            0.4
                        );
                        bonusChord.oscs[0].frequency.exponentialRampToValueAtTime(523, audioContext.currentTime + 0.4);
                        bonusChord.oscs[1].frequency.exponentialRampToValueAtTime(659, audioContext.currentTime + 0.4);
                        bonusChord.oscs[2].frequency.setValueAtTime(523, audioContext.currentTime);
                        break;
                    case 'crypto_tap':
                        // Rich crypto tap with vibrato and harmonics
                        createRichSound(
                            [440, 659],
                            ['sine', 'sine'],
                            [0.22, 0.15],
                            0.18
                        );
                        break;
                    case 'big_coin':
                        // Epic big coin with full bell chord
                        const bigCoinChord = createRichSound(
                            [262, 392, 523, 659, 1047],
                            ['sine', 'sine', 'sine', 'sine', 'sine'],
                            [0.28, 0.22, 0.2, 0.15, 0.1],
                            0.4
                        );
                        bigCoinChord.oscs[0].frequency.exponentialRampToValueAtTime(523, audioContext.currentTime + 0.4);
                        bigCoinChord.oscs[1].frequency.exponentialRampToValueAtTime(659, audioContext.currentTime + 0.4);
                        bigCoinChord.oscs[2].frequency.setValueAtTime(523, audioContext.currentTime);
                        bigCoinChord.oscs[3].frequency.exponentialRampToValueAtTime(1047, audioContext.currentTime + 0.4);
                        break;
                    case 'stars_collect':
                        // Sparkling stars with ascending harmonics
                        const starsChord = createRichSound(
                            [523, 659, 784, 1047, 1319],
                            ['sine', 'sine', 'sine', 'sine', 'sine'],
                            [0.25, 0.2, 0.18, 0.15, 0.1],
                            0.35
                        );
                        starsChord.oscs[0].frequency.exponentialRampToValueAtTime(659, audioContext.currentTime + 0.35);
                        starsChord.oscs[1].frequency.exponentialRampToValueAtTime(784, audioContext.currentTime + 0.35);
                        starsChord.oscs[2].frequency.exponentialRampToValueAtTime(1047, audioContext.currentTime + 0.35);
                        starsChord.oscs[3].frequency.setValueAtTime(1047, audioContext.currentTime);
                        break;
                    case 'machine_working':
                        // Rich machine working with harmonics and vibrato
                        const machineChord = createRichSound(
                            [110, 220],
                            ['sine', 'sine'],
                            [0.18, 0.12],
                            0.4
                        );
                        machineChord.oscs[0].frequency.setValueAtTime(110, audioContext.currentTime);
                        machineChord.oscs[0].frequency.setValueAtTime(131, audioContext.currentTime + 0.2);
                        machineChord.oscs[0].frequency.setValueAtTime(110, audioContext.currentTime + 0.4);
                        break;
                    case 'rebirth':
                        // Epic rebirth transformation with full progression
                        const rebirthChord = createRichSound(
                            [110, 220, 330, 523],
                            ['sine', 'sine', 'sine', 'sine'],
                            [0.25, 0.2, 0.18, 0.22],
                            1.1
                        );
                        rebirthChord.oscs[0].frequency.exponentialRampToValueAtTime(523, audioContext.currentTime + 1.1);
                        rebirthChord.oscs[1].frequency.exponentialRampToValueAtTime(659, audioContext.currentTime + 1.1);
                        rebirthChord.oscs[2].frequency.exponentialRampToValueAtTime(784, audioContext.currentTime + 1.1);
                        rebirthChord.oscs[3].frequency.setValueAtTime(523, audioContext.currentTime);
                        break;
                    case 'powerup':
                        // Rich powerup surge with harmonics
                        createRichSound(
                            [330, 660, 880],
                            ['sine', 'sine', 'sine'],
                            [0.25, 0.2, 0.15],
                            0.3
                        );
                        break;
                    case 'critical_hit':
                        // Epic critical hit with powerful harmonics
                        createRichSound(
                            [110, 220],
                            ['triangle', 'triangle'],
                            [0.25, 0.2],
                            0.2
                        );
                        break;
                    case 'level_milestone':
                        // Epic level milestone with full fanfare chord
                        const milestoneChord = createRichSound(
                            [262, 330, 392, 523, 659],
                            ['sine', 'sine', 'sine', 'sine', 'sine'],
                            [0.3, 0.25, 0.22, 0.28, 0.2],
                            0.65
                        );
                        milestoneChord.oscs[0].frequency.exponentialRampToValueAtTime(523, audioContext.currentTime + 0.65);
                        milestoneChord.oscs[1].frequency.exponentialRampToValueAtTime(659, audioContext.currentTime + 0.65);
                        milestoneChord.oscs[2].frequency.exponentialRampToValueAtTime(784, audioContext.currentTime + 0.65);
                        milestoneChord.oscs[3].frequency.setValueAtTime(523, audioContext.currentTime);
                        milestoneChord.oscs[4].frequency.exponentialRampToValueAtTime(1047, audioContext.currentTime + 0.65);
                        break;
                    case 'combo':
                        // Rich combo with ascending chord
                        createRichSound(
                            [262, 330, 392, 523],
                            ['sine', 'sine', 'sine', 'sine'],
                            [0.25, 0.2, 0.18, 0.22],
                            0.35
                        );
                        break;
                    case 'daily_bonus':
                        // Epic daily bonus celebration
                        const dailyBonusChord = createRichSound(
                            [262, 330, 392, 523, 659],
                            ['sine', 'sine', 'sine', 'sine', 'sine'],
                            [0.3, 0.25, 0.22, 0.28, 0.2],
                            0.75
                        );
                        dailyBonusChord.oscs[0].frequency.exponentialRampToValueAtTime(523, audioContext.currentTime + 0.75);
                        dailyBonusChord.oscs[1].frequency.exponentialRampToValueAtTime(659, audioContext.currentTime + 0.75);
                        dailyBonusChord.oscs[2].frequency.exponentialRampToValueAtTime(784, audioContext.currentTime + 0.75);
                        dailyBonusChord.oscs[3].frequency.setValueAtTime(523, audioContext.currentTime);
                        dailyBonusChord.oscs[4].frequency.exponentialRampToValueAtTime(1047, audioContext.currentTime + 0.75);
                        break;
                    case 'shop_hover':
                        // Quick tick
                        const hoverOsc = audioContext.createOscillator();
                        const hoverGain = audioContext.createGain();
                        hoverOsc.type = 'sine';
                        hoverOsc.frequency.value = 554;
                        hoverOsc.connect(hoverGain);
                        hoverGain.gain.setValueAtTime(0.12, audioContext.currentTime);
                        hoverGain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.06);
                        hoverGain.connect(audioContext.destination);
                        hoverOsc.start(audioContext.currentTime);
                        hoverOsc.stop(audioContext.currentTime + 0.06);
                        break;
                    case 'scroll':
                        // Smooth scroll
                        createRichSound(
                            [330, 392],
                            ['sine', 'sine'],
                            [0.12, 0.1],
                            0.12
                        );
                        break;
                    case 'notification':
                        // Rich notification bell
                        createRichSound(
                            [392, 523, 784],
                            ['sine', 'sine', 'sine'],
                            [0.22, 0.18, 0.12],
                            0.18
                        );
                        break;
                    case 'wrong_action':
                        // Soft wrong action
                        const wrongOsc = audioContext.createOscillator();
                        const wrongGain = audioContext.createGain();
                        wrongOsc.type = 'triangle';
                        wrongOsc.frequency.value = 100;
                        wrongOsc.frequency.exponentialRampToValueAtTime(80, audioContext.currentTime + 0.18);
                        wrongOsc.connect(wrongGain);
                        wrongGain.gain.setValueAtTime(0.15, audioContext.currentTime);
                        wrongGain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.18);
                        wrongGain.connect(audioContext.destination);
                        wrongOsc.start(audioContext.currentTime);
                        wrongOsc.stop(audioContext.currentTime + 0.18);
                        break;
                    case 'open_menu':
                        // Smooth menu open
                        createRichSound(
                            [220, 165],
                            ['sine', 'sine'],
                            [0.18, 0.15],
                            0.18
                        );
                        break;
                    case 'close_menu':
                        // Smooth menu close
                        createRichSound(
                            [165, 220],
                            ['sine', 'sine'],
                            [0.18, 0.15],
                            0.18
                        );
                        break;
                    case 'click':
                        // Quick click with variation
                        const clickFreq = 220 + Math.random() * 40;
                        const clickOsc = audioContext.createOscillator();
                        const clickGain = audioContext.createGain();
                        clickOsc.type = 'sine';
                        clickOsc.frequency.value = clickFreq;
                        clickOsc.connect(clickGain);
                        clickGain.gain.setValueAtTime(0.12, audioContext.currentTime);
                        clickGain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.04);
                        clickGain.connect(audioContext.destination);
                        clickOsc.start(audioContext.currentTime);
                        clickOsc.stop(audioContext.currentTime + 0.04);
                        break;
                    default:
                        // Default rich sound
                        const defaultOsc = audioContext.createOscillator();
                        const defaultGain = audioContext.createGain();
                        defaultOsc.type = 'sine';
                        defaultOsc.frequency.value = 220;
                        defaultOsc.connect(defaultGain);
                        defaultGain.gain.setValueAtTime(0.15, audioContext.currentTime);
                        defaultGain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
                        defaultGain.connect(audioContext.destination);
                        defaultOsc.start(audioContext.currentTime);
                        defaultOsc.stop(audioContext.currentTime + 0.2);
                }
                
                console.log('Sound started successfully:', type);
            } catch(e) {
                console.log('Audio error:', e);
            }
        }
        
        function startEnergyRegen() {
            if (energyRegenInterval) clearInterval(energyRegenInterval);
            
            let lastEnergy = 0;
            window.energyRegenRate = 1.0; // Default rate, stored globally
            let energyAccumulator = 0; // For fractional energy regeneration
            let lastUpdateTime = Date.now();
            
            // Get current regeneration rate from the display
            const regenText = document.getElementById('energy-regen-text');
            if (regenText) {
                const match = regenText.textContent.match(/\+(\d+\.?\d*)\/—Å–µ–∫/);
                if (match) {
                    window.energyRegenRate = parseFloat(match[1]);
                }
            }
            
            energyRegenInterval = setInterval(() => {
                const energyText = document.getElementById('energy-text').textContent;
                const [energy, maxEnergy] = energyText.split('/').map(e => parseInt(e));
                
                if (energy < maxEnergy) {
                    const now = Date.now();
                    const deltaTime = (now - lastUpdateTime) / 1000; // Convert to seconds
                    lastUpdateTime = now;
                    
                    // Accumulate energy based on time passed
                    energyAccumulator += window.energyRegenRate * deltaTime;
                    
                    // Only update when we have at least 1 energy to add
                    if (energyAccumulator >= 1) {
                        const energyToAdd = Math.floor(energyAccumulator);
                        energyAccumulator -= energyToAdd; // Keep the remainder
                        
                        const newEnergy = Math.min(energy + energyToAdd, maxEnergy);
                        if (newEnergy !== lastEnergy) {
                            lastEnergy = newEnergy;
                            document.getElementById('energy-text').textContent = `${newEnergy}/${maxEnergy}`;
                            const energyPercent = Math.min(100, Math.max(0, (newEnergy / maxEnergy) * 100));
                            const fillBar = document.getElementById('energy-bar-fill');
                            const percentText = document.getElementById('energy-percent');
                            if (fillBar) {
                                fillBar.style.width = energyPercent + '%';
                            }
                            if (percentText) {
                                percentText.textContent = Math.round(energyPercent) + '%';
                            }
                            
                            // Update server only when energy actually changes
                            fetch('/api/update_energy', {
                                method: 'POST',
                                headers: {'Content-Type': 'application/json'},
                                body: JSON.stringify({user_id: user?.id, energy: newEnergy})
                            });
                        }
                    }
                }
            }, 100); // Update every 100ms for smoother animation
        }

        function tap() {
            // Initialize audio on first user interaction (required for mobile and Telegram)
            if (!audioInitialized) {
                initAudio();
                // Force HTML5 Audio for Telegram WebApp
                if (isTelegramWebApp()) {
                    useHTML5Audio = true;
                }
            }
            
            // Sound effect
            const soundEnabled = localStorage.getItem('soundEnabled') === 'true';
            if (soundEnabled) {
                playSound('tap');
            }
            
            // Haptic feedback
            const hapticsEnabled = localStorage.getItem('hapticsEnabled') === 'true';
            if (hapticsEnabled && tg?.HapticFeedback) {
                tg.HapticFeedback.impactOccurred('light');
            }
            
            const button = document.querySelector('.tap-button');
            if(button){
                button.classList.add('tap-pressed');
                setTimeout(()=>{if(button)button.classList.remove('tap-pressed');},300);
            }
            
            const energy = parseInt(document.getElementById('energy-text').textContent.split('/')[0]);
            if (energy < 1) {
                const soundEnabled = localStorage.getItem('soundEnabled') === 'true';
                if (soundEnabled) playSound('error');
                tg.showAlert('‚ö†Ô∏è –ù–µ—Ç —ç–Ω–µ—Ä–≥–∏–∏!');
                return;
            }
            
            fetch('/api/tap', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({user_id: window.user?.id})
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    // Only show animation if no modal is open
                    const hasOpenModal = document.querySelector('.modal.active');
                    if (!hasOpenModal) {
                        const button = document.querySelector('.tap-button');
                        if(button){
                            const rect = button.getBoundingClientRect();
                            const centerX = rect.left + rect.width / 2;
                            const centerY = rect.top + rect.height / 2;
                            
                            const coinAnimation = document.createElement('div');
                            coinAnimation.className = 'coin-animation';
                            coinAnimation.textContent = '+' + data.reward;
                            // Position from center of button
                            coinAnimation.style.left = centerX + 'px';
                            coinAnimation.style.top = centerY + 'px';
                            coinAnimation.style.transform = 'translate(-50%, -50%)';
                            coinAnimation.style.zIndex = '1000'; // Lower than modals
                            document.body.appendChild(coinAnimation);
                            setTimeout(() => { 
                                if(document.body.contains(coinAnimation)) {
                                    document.body.removeChild(coinAnimation); 
                                }
                            }, 2000);
                        }
                    }
                    loadData();
                }
            });
        }

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ —Ü–µ–Ω—ã –∏ —ç—Ñ—Ñ–µ–∫—Ç–∞ –ø–æ —É—Ä–æ–≤–Ω—è–º (1-50)
        function calculateTapBoostEffect(level) {
            return Math.floor(level * Math.pow(1.2, level));
        }
        
        function calculateTapBoostPrice(level) {
            return Math.floor(1000 * Math.pow(1.5, level));
        }
        
        function calculateEnergyEffect(level) {
            return Math.round(level * 0.2 * Math.pow(1.15, level) * 100) / 100;
        }
        
        function calculateEnergyPrice(level) {
            return Math.floor(1000 * Math.pow(1.4, level));
        }
        
        function calculateExpandEffect(level) {
            return Math.floor(level * 50 * Math.pow(1.25, level));
        }
        
        function calculateExpandPrice(level) {
            return Math.floor(2000 * Math.pow(1.6, level));
        }
        
        // Name generation functions - simple names
        function generateTapBoostName(level) {
            return 'üí™ –£—Å–∏–ª–∏—Ç–µ–ª—å –¢–∞–ø–∞';
        }
        
        function generateEnergyName(level) {
            return '‚ö° –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≠–Ω–µ—Ä–≥–∏–∏';
        }
        
        function generateExpandName(level) {
            return 'üìà –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ –≠–Ω–µ—Ä–≥–∏–∏';
        }
        function openShop(e) {
            e.preventDefault();
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.id = 'shopModal2';
            
            // Multilevel shop system - EACH item starts at level 0 and grows to 50
            const shopData = {
                'tap_boost': {
                    name: 'üí™ –£—Å–∏–ª–∏—Ç–µ–ª—å –¢–∞–ø–∞',
                    emoji: 'üí™',
                    items: [
                        {level: 0, name: 'üîã –ë–∞–∑–æ–≤—ã–π –ö—Ä–∏–ø—Ç–æ-–ë—É—Å—Ç–µ—Ä', desc: '–£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–∏–Ω–æ–≤ –∑–∞ —Ç–∞–ø. –ü—Ä–æ—Å—Ç–∞—è, –Ω–æ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–∞—è —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è –¥–ª—è –Ω–∞—á–∏–Ω–∞—é—â–∏—Ö –∫—Ä–∏–ø—Ç–æ-—ç–Ω—Ç—É–∑–∏–∞—Å—Ç–æ–≤.', currency: 'coins', locked: false, basePrice: 1000, baseEffect: 1},
                        {level: 0, name: '‚ö° –¢—É—Ä–±–æ-–ê–∫—Å–µ–ª–µ—Ä–∞—Ç–æ—Ä', desc: '–£—Å–∫–æ—Ä—è–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å –¥–æ–±—ã—á–∏ –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç—ã. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –ø–µ—Ä–µ–¥–æ–≤—ã–µ –∞–ª–≥–æ—Ä–∏—Ç–º—ã –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏.', currency: 'coins', locked: false, basePrice: 2500, baseEffect: 3},
                        {level: 0, name: 'üöÄ –ö–≤–∞–Ω—Ç–æ–≤—ã–π –£—Å–∫–æ—Ä–∏—Ç–µ–ª—å', desc: '–ú–æ—â–Ω—ã–π –±—É—Å—Ç–µ—Ä, —É–≤–µ–ª–∏—á–∏–≤–∞—é—â–∏–π —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –º–∞–π–Ω–∏–Ω–≥–∞. –†–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –ø—Ä–∏–Ω—Ü–∏–ø–∞—Ö –∫–≤–∞–Ω—Ç–æ–≤–æ–π –º–µ—Ö–∞–Ω–∏–∫–∏.', currency: 'coins', locked: false, basePrice: 5000, baseEffect: 6},
                        {level: 0, name: 'üíé –ê–ª–º–∞–∑–Ω—ã–π –ü—Ä–æ—Ü–µ—Å—Å–æ—Ä', desc: '–≠–ª–∏—Ç–Ω—ã–π —á–∏–ø –¥–ª—è –º–∞–π–Ω–∏–Ω–≥–∞. –°–æ–∑–¥–∞–Ω –∏–∑ –Ω–∞–Ω–æ-–∞–ª–º–∞–∑–æ–≤ –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏.', currency: 'coins', locked: false, basePrice: 10000, baseEffect: 12},
                        {level: 0, name: 'üî• –ü–ª–∞–∑–º–µ–Ω–Ω—ã–π –†–µ–∞–∫—Ç–æ—Ä', desc: '–ò–Ω–Ω–æ–≤–∞—Ü–∏–æ–Ω–Ω–∞—è —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è, —É–≤–µ–ª–∏—á–∏–≤–∞—é—â–∞—è –¥–æ–±—ã—á—É. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —ç–Ω–µ—Ä–≥–∏—é –ø–ª–∞–∑–º—ã –¥–ª—è —Å–≤–µ—Ä—Ö–±—ã—Å—Ç—Ä–æ–≥–æ –º–∞–π–Ω–∏–Ω–≥–∞.', currency: 'coins', locked: false, basePrice: 20000, baseEffect: 25},
                        {level: 0, name: 'üåü –ó–≤–µ–∑–¥–Ω—ã–π –î–≤–∏–≥–∞—Ç–µ–ª—å', desc: '–õ–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π –±—É—Å—Ç–µ—Ä –∫–æ—Å–º–∏—á–µ—Å–∫–æ–≥–æ —É—Ä–æ–≤–Ω—è. –ü–∏—Ç–∞–µ—Ç—Å—è —ç–Ω–µ—Ä–≥–∏–µ–π –¥–∞–ª–µ–∫–∏—Ö –∑–≤–µ–∑–¥.', currency: 'coins', locked: false, basePrice: 40000, baseEffect: 50},
                        {level: 0, name: 'üåå –ì–∞–ª–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –£—Å–∏–ª–∏—Ç–µ–ª—å', desc: '–ú–∏—Ñ–∏—á–µ—Å–∫–∞—è —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è, —É–≤–µ–ª–∏—á–∏–≤–∞—é—â–∞—è –º–∞–π–Ω–∏–Ω–≥. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–∏–ª—É —Ü–µ–ª—ã—Ö –≥–∞–ª–∞–∫—Ç–∏–∫.', currency: 'coins', locked: false, basePrice: 80000, baseEffect: 100},
                        {level: 0, name: '‚öõÔ∏è –ê—Ç–æ–º–Ω—ã–π –°–∏–Ω—Ç–µ–∑–∞—Ç–æ—Ä', desc: '–ë–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–∞—è —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è —Å–∏–Ω—Ç–µ–∑–∞. –†–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –ø—Ä–∏–Ω—Ü–∏–ø–∞—Ö —è–¥–µ—Ä–Ω–æ–≥–æ —Å–∏–Ω—Ç–µ–∑–∞.', currency: 'coins', locked: false, basePrice: 150000, baseEffect: 200},
                        {level: 0, name: 'üå† –ö–æ—Å–º–∏—á–µ—Å–∫–∞—è –°—Ç–∞–Ω—Ü–∏—è', desc: '–û—Ä–±–∏—Ç–∞–ª—å–Ω–∞—è –º–∞–π–Ω–∏–Ω–≥-—Å—Ç–∞–Ω—Ü–∏—è, —É–≤–µ–ª–∏—á–∏–≤–∞—é—â–∞—è –¥–æ–±—ã—á—É. –î–æ–±—ã–≤–∞–µ—Ç –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç—É –≤ –∫–æ—Å–º–æ—Å–µ.', currency: 'coins', locked: false, basePrice: 300000, baseEffect: 400},
                        {level: 0, name: 'üîÆ –ö–≤–∞–Ω—Ç–æ–≤—ã–π –ü–æ—Ä—Ç–∞–ª', desc: '–ü–æ—Ä—Ç–∞–ª –≤ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –∏–∑–º–µ—Ä–µ–Ω–∏—è. –ú–∞–π–Ω–∏—Ç –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç—É –∏–∑ –¥—Ä—É–≥–∏—Ö –≤—Å–µ–ª–µ–Ω–Ω—ã—Ö.', currency: 'coins', locked: false, basePrice: 600000, baseEffect: 800}
                    ]
                },
                'energy_buy': {
                    name: '‚ö° –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –≠–Ω–µ—Ä–≥–∏–∏',
                    emoji: '‚ö°',
                    items: [
                        {level: 0, name: 'üîã –°–æ–ª–Ω–µ—á–Ω–∞—è –ü–∞–Ω–µ–ª—å', desc: '–ë–∞–∑–æ–≤—ã–π –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä —ç–Ω–µ—Ä–≥–∏–∏. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–æ–ª–Ω–µ—á–Ω—ã–π —Å–≤–µ—Ç –¥–ª—è –ø–æ–¥–∑–∞—Ä—è–¥–∫–∏.', currency: 'coins', locked: false, basePrice: 1500, baseEffect: 0.5},
                        {level: 0, name: '‚ö° –í–µ—Ç—Ä—è–Ω–∞—è –¢—É—Ä–±–∏–Ω–∞', desc: '–£–ª—É—á—à–µ–Ω–Ω—ã–π –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä. –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç –∫–∏–Ω–µ—Ç–∏—á–µ—Å–∫—É—é —ç–Ω–µ—Ä–≥–∏—é –≤ —ç–ª–µ–∫—Ç—Ä–∏—á–µ—Å–∫—É—é.', currency: 'coins', locked: false, basePrice: 3500, baseEffect: 1.2},
                        {level: 0, name: 'üî• –ì–µ–æ—Ç–µ—Ä–º–∞–ª—å–Ω–∞—è –°—Ç–∞–Ω—Ü–∏—è', desc: '–ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç–µ–ø–ª–æ –∑–µ–º–Ω—ã—Ö –Ω–µ–¥—Ä.', currency: 'coins', locked: false, basePrice: 7000, baseEffect: 2.5},
                        {level: 0, name: 'üíé –ö—Ä–∏—Å—Ç–∞–ª—å–Ω—ã–π –†–µ–∞–∫—Ç–æ—Ä', desc: '–≠–ª–∏—Ç–Ω—ã–π –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä. –†–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –∫—Ä–∏—Å—Ç–∞–ª–ª–∞—Ö —Å –≤—ã—Å–æ–∫–æ–π —ç–Ω–µ—Ä–≥–æ–µ–º–∫–æ—Å—Ç—å—é.', currency: 'coins', locked: false, basePrice: 14000, baseEffect: 5.0},
                        {level: 0, name: 'üåü –ó–≤–µ–∑–¥–Ω—ã–π –ö–æ–ª–ª–µ–∫—Ç–æ—Ä', desc: '–ú–∞—Å—Ç–µ—Ä-–≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä. –°–æ–±–∏—Ä–∞–µ—Ç —ç–Ω–µ—Ä–≥–∏—é –¥–∞–ª–µ–∫–∏—Ö –∑–≤–µ–∑–¥.', currency: 'coins', locked: false, basePrice: 28000, baseEffect: 10.0},
                        {level: 0, name: 'üåå –ì–∞–ª–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –£—Å–∫–æ—Ä–∏—Ç–µ–ª—å', desc: '–õ–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–∏–ª—É –≤—Ä–∞—â–µ–Ω–∏—è –≥–∞–ª–∞–∫—Ç–∏–∫.', currency: 'coins', locked: false, basePrice: 55000, baseEffect: 20.0},
                        {level: 0, name: '‚öõÔ∏è –ê—Ç–æ–º–Ω—ã–π –°–∏–Ω—Ç–µ–∑–∞—Ç–æ—Ä', desc: '–ú–∏—Ñ–∏—á–µ—Å–∫–∏–π –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä. –†–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –ø—Ä–∏–Ω—Ü–∏–ø–∞—Ö —Ç–µ—Ä–º–æ—è–¥–µ—Ä–Ω–æ–≥–æ —Å–∏–Ω—Ç–µ–∑–∞.', currency: 'coins', locked: false, basePrice: 110000, baseEffect: 40.0},
                        {level: 0, name: 'üå† –ö–æ—Å–º–∏—á–µ—Å–∫–∞—è –°—Ç–∞–Ω—Ü–∏—è', desc: '–ë–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä. –û—Ä–±–∏—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞–Ω—Ü–∏—è —Å –Ω–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–º–∏ —Ä–µ—Å—É—Ä—Å–∞–º–∏.', currency: 'coins', locked: false, basePrice: 220000, baseEffect: 80.0},
                        {level: 0, name: 'üîÆ –ö–≤–∞–Ω—Ç–æ–≤—ã–π –ö–æ–Ω–¥–µ–Ω—Å–∞—Ç–æ—Ä', desc: '–ö–æ—Å–º–∏—á–µ—Å–∫–∏–π –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –∫–≤–∞–Ω—Ç–æ–≤—ã–µ —Ñ–ª—É–∫—Ç—É–∞—Ü–∏–∏ –≤–∞–∫—É—É–º–∞.', currency: 'coins', locked: false, basePrice: 440000, baseEffect: 160.0},
                        {level: 0, name: 'üåå –¢–µ–º–Ω–∞—è –ú–∞—Ç–µ—Ä–∏—è', desc: '–ö–≤–∞–Ω—Ç–æ–≤—ã–π –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä. –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç —Ç–µ–º–Ω—É—é –º–∞—Ç–µ—Ä–∏—é –≤ —á–∏—Å—Ç—É—é —ç–Ω–µ—Ä–≥–∏—é.', currency: 'coins', locked: false, basePrice: 880000, baseEffect: 320.0}
                    ]
                },
                'energy_expand': {
                    name: 'üìà –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ –≠–Ω–µ—Ä–≥–∏–∏',
                    emoji: 'üìà',
                    items: [
                        {level: 0, name: 'üîã –õ–∏—Ç–∏–π-–ò–æ–Ω–Ω–∞—è –ë–∞—Ç–∞—Ä–µ—è', desc: '–ë–∞–∑–æ–≤—ã–π –∞–∫–∫—É–º—É–ª—è—Ç–æ—Ä, —É–≤–µ–ª–∏—á–∏–≤–∞—é—â–∏–π –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é —ç–Ω–µ—Ä–≥–∏—é. –°–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ–≥–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è —ç–Ω–µ—Ä–≥–∏–∏.', currency: 'coins', locked: false, basePrice: 2000, baseEffect: 50},
                        {level: 0, name: '‚ö° –°—É–ø–µ—Ä–∫–æ–Ω–¥–µ–Ω—Å–∞—Ç–æ—Ä', desc: '–£–ª—É—á—à–µ–Ω–Ω—ã–π –Ω–∞–∫–æ–ø–∏—Ç–µ–ª—å, —Ä–∞—Å—à–∏—Ä—è—é—â–∏–π —ç–Ω–µ—Ä–≥–æ–µ–º–∫–æ—Å—Ç—å. –ú–≥–Ω–æ–≤–µ–Ω–Ω–∞—è –∑–∞—Ä—è–¥–∫–∞ –∏ —Ä–∞–∑—Ä—è–¥–∫–∞ —Å –≤—ã—Å–æ–∫–æ–π —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å—é.', currency: 'coins', locked: false, basePrice: 5000, baseEffect: 120},
                        {level: 0, name: 'üî• –¢–µ—Ä–º–æ—è–¥–µ—Ä–Ω–∞—è –ë–∞—Ç–∞—Ä–µ—è', desc: '–ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π –Ω–∞–∫–æ–ø–∏—Ç–µ–ª—å, —É–≤–µ–ª–∏—á–∏–≤–∞—é—â–∏–π –º–∞–∫—Å–∏–º—É–º —ç–Ω–µ—Ä–≥–∏–∏. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —ç–Ω–µ—Ä–≥–∏—é —Ç–µ—Ä–º–æ—è–¥–µ—Ä–Ω–æ–≥–æ —Å–∏–Ω—Ç–µ–∑–∞.', currency: 'coins', locked: false, basePrice: 10000, baseEffect: 250},
                        {level: 0, name: 'üíé –ö—Ä–∏—Å—Ç–∞–ª—å–Ω–∞—è –ú–∞—Ç—Ä–∏—Ü–∞', desc: '–≠–ª–∏—Ç–Ω—ã–π –Ω–∞–∫–æ–ø–∏—Ç–µ–ª—å, —Ä–∞—Å—à–∏—Ä—è—é—â–∏–π —ç–Ω–µ—Ä–≥–æ–µ–º–∫–æ—Å—Ç—å. –ú–∞—Ç—Ä–∏—Ü–∞ –∏–∑ –∫—Ä–∏—Å—Ç–∞–ª–ª–æ–≤ —Å –Ω–µ–≤–µ—Ä–æ—è—Ç–Ω–æ–π —ç–Ω–µ—Ä–≥–æ–µ–º–∫–æ—Å—Ç—å—é.', currency: 'coins', locked: false, basePrice: 20000, baseEffect: 500},
                        {level: 0, name: 'üåü –ó–≤–µ–∑–¥–Ω–æ–µ –Ø–¥—Ä–æ', desc: '–ú–∞—Å—Ç–µ—Ä-–Ω–∞–∫–æ–ø–∏—Ç–µ–ª—å, —É–≤–µ–ª–∏—á–∏–≤–∞—é—â–∏–π –º–∞–∫—Å–∏–º—É–º —ç–Ω–µ—Ä–≥–∏–∏. –°–æ–¥–µ—Ä–∂–∏—Ç —Å–∂–∞—Ç—É—é —ç–Ω–µ—Ä–≥–∏—é –∑–≤–µ–∑–¥—ã.', currency: 'coins', locked: false, basePrice: 40000, baseEffect: 1000},
                        {level: 0, name: 'üåå –ì–∞–ª–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –†–µ–∑–µ—Ä–≤—É–∞—Ä', desc: '–õ–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π –Ω–∞–∫–æ–ø–∏—Ç–µ–ª—å, —Ä–∞—Å—à–∏—Ä—è—é—â–∏–π —ç–Ω–µ—Ä–≥–æ–µ–º–∫–æ—Å—Ç—å. –•—Ä–∞–Ω–∏—Ç —ç–Ω–µ—Ä–≥–∏—é —Ü–µ–ª–æ–π –≥–∞–ª–∞–∫—Ç–∏–∫–∏.', currency: 'coins', locked: false, basePrice: 80000, baseEffect: 2000},
                        {level: 0, name: '‚öõÔ∏è –ö–≤–∞–Ω—Ç–æ–≤–∞—è –°—É–ø–µ—Ä–ø–æ–∑–∏—Ü–∏—è', desc: '–ú–∏—Ñ–∏—á–µ—Å–∫–∏–π –Ω–∞–∫–æ–ø–∏—Ç–µ–ª—å, —É–≤–µ–ª–∏—á–∏–≤–∞—é—â–∏–π –º–∞–∫—Å–∏–º—É–º —ç–Ω–µ—Ä–≥–∏–∏. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –∫–≤–∞–Ω—Ç–æ–≤—É—é —Å—É–ø–µ—Ä–ø–æ–∑–∏—Ü–∏—é –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è.', currency: 'coins', locked: false, basePrice: 160000, baseEffect: 4000},
                        {level: 0, name: 'üå† –ö–æ—Å–º–∏—á–µ—Å–∫–∏–π –ü–æ—Ä—Ç–∞–ª', desc: '–ë–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –Ω–∞–∫–æ–ø–∏—Ç–µ–ª—å, —Ä–∞—Å—à–∏—Ä—è—é—â–∏–π —ç–Ω–µ—Ä–≥–æ–µ–º–∫–æ—Å—Ç—å. –ü–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ —ç–Ω–µ—Ä–≥–µ—Ç–∏—á–µ—Å–∫–∏–º –ø–æ—Ä—Ç–∞–ª–∞–º –≤—Å–µ–ª–µ–Ω–Ω–æ–π.', currency: 'coins', locked: false, basePrice: 320000, baseEffect: 8000},
                        {level: 0, name: 'üîÆ –¢–µ–º–Ω–∞—è –≠–Ω–µ—Ä–≥–∏—è', desc: '–ö–æ—Å–º–∏—á–µ—Å–∫–∏–π –Ω–∞–∫–æ–ø–∏—Ç–µ–ª—å, —É–≤–µ–ª–∏—á–∏–≤–∞—é—â–∏–π –º–∞–∫—Å–∏–º—É–º —ç–Ω–µ—Ä–≥–∏–∏. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –∑–∞–≥–∞–¥–æ—á–Ω—É—é —Ç–µ–º–Ω—É—é —ç–Ω–µ—Ä–≥–∏—é.', currency: 'coins', locked: false, basePrice: 640000, baseEffect: 16000},
                        {level: 0, name: 'üåå –ú—É–ª—å—Ç–∏–≤—Å–µ–ª–µ–Ω–Ω–∞—è', desc: '–ö–≤–∞–Ω—Ç–æ–≤—ã–π –Ω–∞–∫–æ–ø–∏—Ç–µ–ª—å, —Ä–∞—Å—à–∏—Ä—è—é—â–∏–π —ç–Ω–µ—Ä–≥–æ–µ–º–∫–æ—Å—Ç—å. –ü–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ —ç–Ω–µ—Ä–≥–∏–∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –≤—Å–µ–ª–µ–Ω–Ω—ã—Ö.', currency: 'coins', locked: false, basePrice: 1280000, baseEffect: 32000}
                    ]
                },
                'autobot': {
                    name: 'ü§ñ –ö—Ä–∏–ø—Ç–æ-–ë–æ—Ç—ã',
                    emoji: 'ü§ñ',
                    items: [
                        // 10 –ø–æ–∑–∏—Ü–∏–π –∑–∞ –∫–æ–∏–Ω—ã (–≤—Å–µ–≥–¥–∞ 1 —Ç–∞–ø/—Å–µ–∫)
                        {level: 1, name: 'ü§ñ –ë–∞–∑–æ–≤—ã–π –ë–æ—Ç', desc: '–ê–≤—Ç–æ—Ç–∞–ø –Ω–∞ 15 –º–∏–Ω—É—Ç', speed: 1, duration: 15, price: 2000, currency: 'coins', locked: false},
                        {level: 2, name: '‚ö° –£–ª—É—á—à–µ–Ω–Ω—ã–π –ë–æ—Ç', desc: '–ê–≤—Ç–æ—Ç–∞–ø –Ω–∞ 30 –º–∏–Ω—É—Ç', speed: 1, duration: 30, price: 5000, currency: 'coins', locked: false},
                        {level: 3, name: 'üåü –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π –ë–æ—Ç', desc: '–ê–≤—Ç–æ—Ç–∞–ø –Ω–∞ 1 —á–∞—Å', speed: 1, duration: 60, price: 10000, currency: 'coins', locked: false},
                        {level: 4, name: 'üíé –≠–ª–∏—Ç–Ω—ã–π –ë–æ—Ç', desc: '–ê–≤—Ç–æ—Ç–∞–ø –Ω–∞ 2 —á–∞—Å–∞', speed: 1, duration: 120, price: 20000, currency: 'coins', locked: false},
                        {level: 5, name: 'üëë –ü—Ä–µ–º–∏—É–º –ë–æ—Ç', desc: '–ê–≤—Ç–æ—Ç–∞–ø –Ω–∞ 4 —á–∞—Å–∞', speed: 1, duration: 240, price: 40000, currency: 'coins', locked: false},
                        {level: 6, name: 'üåå –ú–∞—Å—Ç–µ—Ä –ë–æ—Ç', desc: '–ê–≤—Ç–æ—Ç–∞–ø –Ω–∞ 6 —á–∞—Å–æ–≤', speed: 1, duration: 360, price: 80000, currency: 'coins', locked: false},
                        {level: 7, name: 'üí´ –õ–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π –ë–æ—Ç', desc: '–ê–≤—Ç–æ—Ç–∞–ø –Ω–∞ 12 —á–∞—Å–æ–≤', speed: 1, duration: 720, price: 160000, currency: 'coins', locked: false},
                        {level: 8, name: 'üî• –ú–∏—Ñ–∏—á–µ—Å–∫–∏–π –ë–æ—Ç', desc: '–ê–≤—Ç–æ—Ç–∞–ø –Ω–∞ 1 –¥–µ–Ω—å', speed: 1, duration: 1440, price: 320000, currency: 'coins', locked: false},
                        {level: 9, name: '‚ö° –ë–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –ë–æ—Ç', desc: '–ê–≤—Ç–æ—Ç–∞–ø –Ω–∞ 2 –¥–Ω—è', speed: 1, duration: 2880, price: 640000, currency: 'coins', locked: false},
                        {level: 10, name: 'üëë –ò–º–ø–µ—Ä–∞—Ç–æ—Ä—Å–∫–∏–π –ë–æ—Ç', desc: '–ê–≤—Ç–æ—Ç–∞–ø –Ω–∞ 3 –¥–Ω—è', speed: 1, duration: 4320, price: 1280000, currency: 'coins', locked: false},
                    ]
                }
            };
            
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 450px; max-height: 85vh; overflow-y: auto;background: linear-gradient(135deg, rgba(10, 14, 39, 0.98), rgba(15, 23, 42, 0.98));border-radius: 24px;border: 2px solid rgba(167,139,250,0.4);box-shadow: 0 10px 40px rgba(167,139,250,0.3);">
                    <div style="background:linear-gradient(135deg,#a78bfa,#c084fc,#d946ef);padding:20px;border-radius:22px 22px 0 0;text-align:center;position:relative;">
                        <h2 style="font-size: 28px; color: #fff; margin: 0; font-weight: 900; text-shadow: 0 2px 8px rgba(0,0,0,0.5);">üõí –ú–ê–ì–ê–ó–ò–ù</h2>
                        <button class="close-btn" onclick="this.closest('.modal').remove()">‚úï</button>
                    </div>
                    <div style="padding:20px;">
                        <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-bottom:20px;">
                            <button class="shop-cat-btn" data-category="tap_boost" onclick="loadShopCategory('tap_boost')" style="padding:12px;background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border:none;border-radius:12px;cursor:pointer;font-weight:700;font-size:13px;">üí™ –£—Å–∏–ª–∏—Ç–µ–ª—å –¢–∞–ø–∞</button>
                            <button class="shop-cat-btn" data-category="energy_buy" onclick="loadShopCategory('energy_buy')" style="padding:12px;background:rgba(255,255,255,0.1);color:#fff;border:1px solid rgba(255,255,255,0.3);border-radius:12px;cursor:pointer;font-weight:700;font-size:13px;">‚ö° –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –≠–Ω–µ—Ä–≥–∏–∏</button>
                            <button class="shop-cat-btn" data-category="energy_expand" onclick="loadShopCategory('energy_expand')" style="padding:12px;background:rgba(255,255,255,0.1);color:#fff;border:1px solid rgba(255,255,255,0.3);border-radius:12px;cursor:pointer;font-weight:700;font-size:13px;">üìà –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ –≠–Ω–µ—Ä–≥–∏–∏</button>
                            <button class="shop-cat-btn" data-category="autobot" onclick="loadShopCategory('autobot')" style="padding:12px;background:rgba(255,255,255,0.1);color:#fff;border:1px solid rgba(255,255,255,0.3);border-radius:12px;cursor:pointer;font-weight:700;font-size:13px;">ü§ñ –ê–≤—Ç–æ–±–æ—Ç</button>
                        </div>
                        <!-- VIP Button Row -->
                        <div id="vipButtonRow" style="margin-bottom:15px;">
                            <div style="padding:6px;background:linear-gradient(135deg,rgba(255,215,0,0.2),rgba(255,237,78,0.2),rgba(255,215,0,0.2));border:2px solid rgba(255,215,0,0.7);border-radius:12px;position:relative;box-shadow:0 4px 15px rgba(255,215,0,0.3);">
                                <!-- Premium Button -->
                                <button id="vipButton" onclick="const currentCategory = window.currentShopCategory || 'tap_boost'; openVIPModal(currentCategory)" style="width:100%;padding:8px 12px;background:linear-gradient(135deg,#ffd700,#ffed4e,#ffd700);color:#000;border:2px solid #ffd700;border-radius:8px;cursor:pointer;font-weight:800;font-size:14px;transition:all 0.3s;box-shadow:0 3px 10px rgba(255,215,0,0.4);position:relative;display:flex;align-items:center;justify-content:center;" onmousedown="this.style.transform='scale(0.97)'" onmouseup="this.style.transform='scale(1)'" onmouseleave="this.style.transform='scale(1)'">
                                    <span style="font-size:18px;margin-right:8px;text-shadow:0 2px 4px rgba(0,0,0,0.3);filter:drop-shadow(0 0 3px rgba(255,215,0,0.8));">‚≠ê</span>
                                    <span style="flex:1;text-align:center;">–ö—É–ø–∏—Ç—å VIP —Ñ—É–Ω–∫—Ü–∏–∏ –∑–∞ Telegram Stars</span>
                                    <div style="background:linear-gradient(135deg,#000,#333);color:#fff;padding:2px 6px;border-radius:4px;font-size:10px;font-weight:900;margin-left:8px;">VIP</div>
                                </button>
                            </div>
                        </div>
                        <div id="shopItemsList" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px;"></div>
                        
                        <!-- –°—Ç–∏–ª—å–Ω–∞—è –∫–Ω–æ–ø–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è -->
                        <button class="category-close-btn" onclick="this.closest('.modal').remove()">
                            ‚úï –ó–∞–∫—Ä—ã—Ç—å –º–∞–≥–∞–∑–∏–Ω
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            // Store regular shop data first, then add VIP data
            window.shopData = shopData; // Store regular shop data
            // Add VIP data for VIP categories only
            window.shopData['tap_boost_vip'] = vipData['tap_boost'];
            window.shopData['energy_buy_vip'] = vipData['energy_buy'];
            window.shopData['energy_expand_vip'] = vipData['energy_expand'];
            window.shopData['autobot_vip'] = vipData['autobot'];
            
            // Load user's shop levels from database
            loadShopLevels();
            
            loadShopCategory('tap_boost');
        }
        
        function showVIPShopSection() {
            fetch('/api/user_data', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({user_id: window.user?.id})
            })
            .then(res => res.json())
            .then(data => {
                const vipLevel = data.vip_level || 0;
                const listDiv = document.getElementById('shopItemsList');
                
                if (vipLevel >= 3 && listDiv && !listDiv.querySelector('.vip-boosts-section')) {
                    const vipSection = document.createElement('div');
                    vipSection.className = 'vip-boosts-section';
                    vipSection.innerHTML = `
                        <div style="background:linear-gradient(135deg,#ffd700,#ffed4e);padding:12px;border-radius:12px;margin-bottom:15px;border:2px solid #ffd700;">
                            <div style="background:rgba(0,0,0,0.3);padding:10px;border-radius:8px;">
                                <div style="font-size:14px;font-weight:700;color:#000;margin-bottom:5px;">üëë VIP BOOST 20x</div>
                                <div style="font-size:11px;color:rgba(0,0,0,0.7);margin-bottom:8px;">x20 –¥–æ—Ö–æ–¥ –Ω–∞ 1 —á–∞—Å ‚Ä¢ –¢–æ–ª—å–∫–æ –¥–ª—è VIP</div>
                                <div style="font-size:10px;color:#000;margin-bottom:8px;">‚úÖ –¢—Ä–µ–±—É–µ—Ç—Å—è Gold VIP+</div>
                                <button onclick="buyVIPBoost('vip_boost_20x', 5000000)" style="width:100%;padding:10px;background:#000;color:#ffd700;border:none;border-radius:8px;font-weight:800;font-size:12px;cursor:pointer;">üí∞ 5M ü™ô</button>
                            </div>
                        </div>
                        ${vipLevel >= 5 ? `
                        <div style="background:linear-gradient(135deg,#c084fc,#a78bfa);padding:12px;border-radius:12px;margin-bottom:15px;border:2px solid #c084fc;">
                            <div style="background:rgba(0,0,0,0.3);padding:10px;border-radius:8px;">
                                <div style="font-size:14px;font-weight:700;color:#fff;margin-bottom:5px;">üíé DIAMOND BOOST 50x</div>
                                <div style="font-size:11px;color:rgba(255,255,255,0.8);margin-bottom:8px;">x50 –¥–æ—Ö–æ–¥ –Ω–∞ 24 —á–∞—Å–∞</div>
                                <div style="font-size:10px;color:#c084fc;margin-bottom:8px;">‚úÖ –¢–æ–ª—å–∫–æ –¥–ª—è Diamond VIP</div>
                                <button onclick="buyVIPBoost('diamond_boost_50x', 20000000)" style="width:100%;padding:10px;background:#fff;color:#a78bfa;border:none;border-radius:8px;font-weight:800;font-size:12px;cursor:pointer;">üí∞ 20M ü™ô</button>
                            </div>
                        </div>
                        ` : ''}
                    `;
                    if (listDiv) {
                        listDiv.insertBefore(vipSection, listDiv.firstChild);
                    }
                }
            });
        }
        
        function buyVIPBoost(boostType, price) {
            fetch('/api/buy_vip_boost', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    user_id: user?.id,
                    boost_type: boostType,
                    price: price
                })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    tg.showAlert('‚úÖ VIP –±—É—Å—Ç –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω!');
                    loadData();
                } else {
                    tg.showAlert('‚ùå ' + data.error);
                }
            })
            .catch(err => tg.showAlert('‚ùå –û—à–∏–±–∫–∞ –ø–æ–∫—É–ø–∫–∏'));
        }
        
        function openVIPModal(category) {
            const vipCategory = category + '_vip';
            const vipItems = window.shopData[vipCategory];
            if (!vipItems) return;
            
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.id = 'vipModal';
            
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 480px; max-height: 80vh; overflow-y: auto; background: linear-gradient(135deg, rgba(0,0,0,0.95), rgba(20,20,30,0.98)); border-radius: 24px; border: 2px solid rgba(255,215,0,0.7); box-shadow: 0 20px 60px rgba(255,215,0,0.3), 0 0 0 1px rgba(255,255,255,0.1); backdrop-filter: blur(20px);">
                    <div style="background: linear-gradient(135deg, #ffd700, #ffed4e, #ffd700); padding: 20px 50px 20px 20px; border-radius: 22px 22px 0 0; text-align: center; position: relative; box-shadow: 0 8px 30px rgba(255,215,0,0.4);">
                        <div style="display: flex; align-items: center; justify-content: center; gap: 12px;">
                            <div style="font-size: 36px; text-shadow: 0 3px 10px rgba(0,0,0,0.3); filter: drop-shadow(0 0 6px rgba(255,215,0,0.8)); animation: pulse 2s infinite;">‚≠ê</div>
                            <div>
                                <h2 style="font-size: 24px; color: #000; margin: 0; font-weight: 900; text-shadow: 0 2px 6px rgba(0,0,0,0.2);">${vipItems.name}</h2>
                                <div style="font-size: 14px; color: rgba(0,0,0,0.7); margin-top: 4px; font-weight: 600;">VIP —Ñ—É–Ω–∫—Ü–∏–∏ –∑–∞ Telegram Stars</div>
                            </div>
                        </div>
                        <button class="close-btn" onclick="this.closest('.modal').remove()">‚úï</button>
                    </div>
                    
                    <div style="padding: 20px;">
                        <div style="display: grid; gap: 12px;">
                            ${vipItems.items.map((item, index) => `
                                <div style="background: linear-gradient(135deg, rgba(255,215,0,0.12), rgba(255,237,78,0.18)); padding: 16px; border-radius: 16px; border: 1px solid rgba(255,215,0,0.3); position: relative; backdrop-filter: blur(8px); box-shadow: 0 6px 20px rgba(255,215,0,0.15); transition: all 0.3s ease; overflow: hidden; background-size: 200% 200%; animation: shimmer 3s ease-in-out infinite;" onmouseover="this.style.transform='translateY(-3px) scale(1.02)';this.style.boxShadow='0 10px 30px rgba(255,215,0,0.25)';this.style.background='linear-gradient(135deg, rgba(255,215,0,0.2), rgba(255,237,78,0.25))'" onmouseout="this.style.transform='translateY(0) scale(1)';this.style.boxShadow='0 6px 20px rgba(255,215,0,0.15)';this.style.background='linear-gradient(135deg, rgba(255,215,0,0.12), rgba(255,237,78,0.18))'">
                                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 6px;">
                                        <span style="font-size: 20px; filter: drop-shadow(0 0 4px rgba(255,215,0,0.6));">${item.name.split(' ')[0]}</span>
                                        <div style="flex: 1;">
                                            <div style="font-weight: 800; font-size: 14px; color: #fff; text-shadow: 0 1px 3px rgba(0,0,0,0.3);">${item.name.split(' ').slice(1).join(' ')}</div>
                                            <div style="font-size: 11px; color: rgba(255,255,255,0.8); margin-top: 2px;">${item.desc}</div>
                                        </div>
                                        <div style="background: linear-gradient(135deg, #ffd700, #ffed4e, #ffd700); color: #000; padding: 4px 8px; border-radius: 8px; font-size: 11px; font-weight: 900; text-shadow: 0 1px 3px rgba(0,0,0,0.3); border: 1px solid #ffd700; box-shadow: 0 3px 8px rgba(255,215,0,0.4); position: relative; overflow: hidden;">
                                            <div style="position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent); animation: shimmer 2s infinite;"></div>
                                            <span style="font-size: 12px; font-weight: 900; text-shadow: 0 1px 2px rgba(0,0,0,0.4);">VIP</span>
                                        </div>
                                    </div>
                                    
                                    ${category === 'autobot' ? `
                                        <div style="background: rgba(74,222,128,0.2); padding: 8px; border-radius: 8px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;">
                                            <span style="color: #4ade80; font-size: 12px; font-weight: 700;">‚è±Ô∏è –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:</span>
                                            <span style="color: #fff; font-size: 12px; font-weight: 800;">${formatDuration(item.duration)}</span>
                                        </div>
                                        <div style="background: rgba(74,222,128,0.2); padding: 8px; border-radius: 8px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;">
                                            <span style="color: #4ade80; font-size: 12px; font-weight: 700;">‚ö° –°–∫–æ—Ä–æ—Å—Ç—å:</span>
                                            <span style="color: #4ade80; font-size: 12px; font-weight: 800;">${item.speed} —Ç–∞–ø–æ–≤/—Å–µ–∫</span>
                                        </div>
                                    ` : ''}
                                    
                                    <button onclick="buyWithStars('${category}', ${index}, ${item.basePrice || item.price})" 
                                            style="width: 100%; padding: 10px 12px; background: linear-gradient(135deg, #ffd700, #ffed4e, #ffd700); color: #000; border: 1px solid #ffd700; border-radius: 10px; cursor: pointer; font-weight: 800; font-size: 13px; transition: all 0.3s; position: relative; overflow: hidden; box-shadow: 0 4px 12px rgba(255,215,0,0.3); text-shadow: 0 1px 2px rgba(0,0,0,0.2); display: flex; align-items: center; justify-content: center; gap: 6px;"
                                            onmousedown="this.style.transform='scale(0.98)'; this.style.boxShadow='0 6px 16px rgba(255,215,0,0.4)'"
                                            onmouseup="this.style.transform='scale(1)'; this.style.boxShadow='0 4px 12px rgba(255,215,0,0.3)'"
                                            onmouseleave="this.style.transform='scale(1)'; this.style.boxShadow='0 4px 12px rgba(255,215,0,0.3)'">
                                        <span>–ö—É–ø–∏—Ç—å –∑–∞ ${item.basePrice || item.price}</span>
                                        <span style="font-size: 16px; filter: drop-shadow(0 0 3px rgba(255,215,0,0.8)); text-shadow: 0 1px 2px rgba(0,0,0,0.3);">‚≠ê</span>
                                        <span>Telegram Stars</span>
                                    </button>
                                </div>
                            `).join('')}
                        </div>
                        
                        <!-- VIP —Å—Ç–∏–ª—å–Ω–∞—è –∫–Ω–æ–ø–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è -->
                        <button class="vip-close-btn" onclick="this.closest('.modal').remove()">
                            üëë –ó–∞–∫—Ä—ã—Ç—å VIP —Ñ—É–Ω–∫—Ü–∏–∏
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        function buyWithStars(category, level, price) {
            // Map VIP shop items to product IDs (using 81-100 to avoid conflict with Buy Currency 21-40)
            const productIdMap = {
                'tap_boost': {0: 81, 1: 82, 2: 83, 3: 84, 4: 85},
                'energy_buy': {0: 86, 1: 87, 2: 88, 3: 89, 4: 90},
                'energy_expand': {0: 91, 1: 92, 2: 93, 3: 94, 4: 95},
                'autobot': {0: 96, 1: 97, 2: 98, 3: 99, 4: 100}
            };
            
            const productId = productIdMap[category]?.[level] || 81;
            
            // Open Telegram payment (same as in currency purchase)
            const paymentUrl = `https://t.me/qanexus_bot?start=buy_stars_${productId}`;
            window.open(paymentUrl, '_blank');
            
            // Show beautiful VIP confirmation message
            const anim = document.createElement('div');
            anim.style.cssText='position:fixed;top:20%;left:50%;transform:translate(-50%,-50%);z-index:10000;pointer-events:none;';
            anim.innerHTML='<div style="background:linear-gradient(135deg,rgba(255,215,0,0.95),rgba(255,237,78,0.95));padding:25px 50px;border-radius:25px;font-size:26px;box-shadow:0 15px 50px rgba(255,215,0,0.7);color:#000;font-weight:800;display:flex;align-items:center;gap:20px;border:3px solid rgba(255,215,0,0.8);"><span style="font-size:40px;">‚≠ê</span><div><div style="font-size:28px;margin-bottom:8px;">VIP –ü–æ–∫—É–ø–∫–∞</div><div style="font-size:20px;opacity:0.8;">–û—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –æ–ø–ª–∞—Ç–∞ –∑–∞ ' + price + ' ‚≠ê Telegram Stars</div></div></div>';
            document.body.appendChild(anim);
            setTimeout(()=>{anim.style.opacity='0';anim.style.transform='translate(-50%,-70%)';setTimeout(()=>{anim.remove();},300);},2000);
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ —Ü–µ–Ω—ã –∏ –±–æ–Ω—É—Å–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ —É—Ä–æ–≤–Ω—è
        function calculateItemStats(basePrice, baseBonus, level, userLevel) {
            const priceMultiplier = 1 + (userLevel * 0.1); // +10% –∑–∞ –∫–∞–∂–¥—ã–π —É—Ä–æ–≤–µ–Ω—å
            const bonusMultiplier = 1 + (userLevel * 0.05); // +5% –∑–∞ –∫–∞–∂–¥—ã–π —É—Ä–æ–≤–µ–Ω—å
            return {
                price: Math.floor(basePrice * priceMultiplier),
                bonus: Math.floor(baseBonus * bonusMultiplier)
            };
        }
        
        // VIP –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∫–∞–∂–¥–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (–≥–ª–æ–±–∞–ª—å–Ω—ã–µ) - –¶–µ–Ω—ã —Å—Ç–∞—Ä—ã–µ, —ç—Ñ—Ñ–µ–∫—Ç—ã —É–º–µ–Ω—å—à–µ–Ω—ã
        const vipData = {
            'tap_boost': {
                name: '‚≠ê VIP –ö—Ä–∏–ø—Ç–æ-–ë—É—Å—Ç–µ—Ä—ã',
                items: [
                    {level: 0, name: 'üå† –ó–≤–µ–∑–¥–Ω—ã–π –®—Ç–æ—Ä–º', desc: 'VIP –±—É—Å—Ç–µ—Ä, —É–≤–µ–ª–∏—á–∏–≤–∞—é—â–∏–π –º–∞–π–Ω–∏–Ω–≥ –Ω–∞ +25 –∫–æ–∏–Ω –∑–∞ —Ç–∞–ø. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —ç–Ω–µ—Ä–≥–∏—é –∑–≤–µ–∑–¥–Ω—ã—Ö –≤—Å–ø—ã—à–µ–∫ –¥–ª—è —Å–≤–µ—Ä—Ö–º–æ—â–Ω–æ–≥–æ –º–∞–π–Ω–∏–Ω–≥–∞.', currency: 'stars', locked: false, basePrice: 100, baseEffect: 25},
                    {level: 0, name: 'üåë –ß–µ—Ä–Ω–∞—è –î—ã—Ä–∞', desc: '–≠–∫—Å–∫–ª—é–∑–∏–≤–Ω—ã–π –±—É—Å—Ç–µ—Ä, –¥–∞—é—â–∏–π +35 –∫–æ–∏–Ω –∑–∞ —Ç–∞–ø. –ü–æ–≥–ª–æ—â–∞–µ—Ç —ç–Ω–µ—Ä–≥–∏—é –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞-–≤—Ä–µ–º–µ–Ω–∏ –¥–ª—è –Ω–µ–≤–µ—Ä–æ—è—Ç–Ω–æ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏.', currency: 'stars', locked: false, basePrice: 200, baseEffect: 35},
                    {level: 0, name: '‚ú® –ê–±—Å–æ–ª—é—Ç', desc: '–õ–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π VIP –±—É—Å—Ç–µ—Ä, —É–≤–µ–ª–∏—á–∏–≤–∞—é—â–∏–π –º–∞–π–Ω–∏–Ω–≥ –Ω–∞ +50 –∫–æ–∏–Ω –∑–∞ —Ç–∞–ø. –ê–±—Å–æ–ª—é—Ç–Ω–∞—è –≤–ª–∞—Å—Ç—å –Ω–∞–¥ –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–Ω—ã–º–∏ –∞–ª–≥–æ—Ä–∏—Ç–º–∞–º–∏.', currency: 'stars', locked: false, basePrice: 350, baseEffect: 50},
                    {level: 0, name: 'üëë –ò–º–ø–µ—Ä—Å–∫–∏–π', desc: '–ò–º–ø–µ—Ä–∞—Ç–æ—Ä—Å–∫–∏–π –±—É—Å—Ç–µ—Ä, –¥–∞—é—â–∏–π +70 –∫–æ–∏–Ω –∑–∞ —Ç–∞–ø. –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è, –¥–æ—Å—Ç–æ–π–Ω–∞—è –∫—Ä–∏–ø—Ç–æ-–∏–º–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤ –∏ –±–ª–æ–∫—á–µ–π–Ω-–∫–æ—Ä–æ–ª–µ–π.', currency: 'stars', locked: false, basePrice: 500, baseEffect: 70},
                    {level: 0, name: 'üåü –õ–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π', desc: '–ú–∏—Ñ–∏—á–µ—Å–∫–∏–π VIP –±—É—Å—Ç–µ—Ä, —É–≤–µ–ª–∏—á–∏–≤–∞—é—â–∏–π –º–∞–π–Ω–∏–Ω–≥ –Ω–∞ +100 –∫–æ–∏–Ω –∑–∞ —Ç–∞–ø. –õ–µ–≥–µ–Ω–¥–∞—Ä–Ω–∞—è —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è –∏–∑ –¥—Ä–µ–≤–Ω–∏—Ö –∫—Ä–∏–ø—Ç–æ-—Ü–∏–≤–∏–ª–∏–∑–∞—Ü–∏–π.', currency: 'stars', locked: false, basePrice: 750, baseEffect: 100}
                ]
            },
            'energy_buy': {
                name: '‚≠ê VIP –≠–Ω–µ—Ä–≥–æ-–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä—ã',
                items: [
                    {level: 0, name: '‚òÄÔ∏è –°–æ–ª–Ω–µ—á–Ω–∞—è –ö–æ—Ä–æ–Ω–∞', desc: 'VIP –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä, –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—â–∏–π +1.5 —ç–Ω–µ—Ä–≥–∏–∏ –≤ —Å–µ–∫—É–Ω–¥—É. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —ç–Ω–µ—Ä–≥–∏—é —Å–æ–ª–Ω–µ—á–Ω–æ–π –∫–æ—Ä–æ–Ω—ã –¥–ª—è —Å–≤–µ—Ä—Ö–±—ã—Å—Ç—Ä–æ–π –ø–æ–¥–∑–∞—Ä—è–¥–∫–∏.', currency: 'stars', locked: false, basePrice: 120, baseEffect: 1.5},
                    {level: 0, name: 'üåå –ì–∞–ª–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –Ø–¥—Ä–æ', desc: '–≠–∫—Å–∫–ª—é–∑–∏–≤–Ω—ã–π –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä, –¥–∞—é—â–∏–π +2.25 —ç–Ω–µ—Ä–≥–∏–∏ –≤ —Å–µ–∫—É–Ω–¥—É. –ò–∑–≤–ª–µ–∫–∞–µ—Ç —ç–Ω–µ—Ä–≥–∏—é –∏–∑ —è–¥—Ä–∞ –≥–∞–ª–∞–∫—Ç–∏–∫–∏ —á–µ—Ä–µ–∑ –∫–≤–∞–Ω—Ç–æ–≤—ã–µ —Ç—É–Ω–Ω–µ–ª–∏.', currency: 'stars', locked: false, basePrice: 200, baseEffect: 2.25},
                    {level: 0, name: 'üí´ –ù–æ–≤–∞—è –ï—Ä–∞', desc: '–†–µ–≤–æ–ª—é—Ü–∏–æ–Ω–Ω—ã–π –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä, –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—â–∏–π +3.0 —ç–Ω–µ—Ä–≥–∏–∏ –≤ —Å–µ–∫—É–Ω–¥—É. –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è –Ω–æ–≤–æ–π —ç—Ä—ã –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–Ω–æ–≥–æ –±—É–¥—É—â–µ–≥–æ.', currency: 'stars', locked: false, basePrice: 300, baseEffect: 3.0},
                    {level: 0, name: '‚öõÔ∏è –ö–≤–∞–Ω—Ç–æ–≤—ã–π –†–µ–∞–∫—Ç–æ—Ä', desc: '–õ–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä, –¥–∞—é—â–∏–π +4.0 —ç–Ω–µ—Ä–≥–∏–∏ –≤ —Å–µ–∫—É–Ω–¥—É. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –∫–≤–∞–Ω—Ç–æ–≤—ã–µ —Ñ–ª—É–∫—Ç—É–∞—Ü–∏–∏ –¥–ª—è –Ω–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–π —ç–Ω–µ—Ä–≥–∏–∏.', currency: 'stars', locked: false, basePrice: 450, baseEffect: 4.0},
                    {level: 0, name: 'üå† –ù–µ–±–µ—Å–Ω—ã–π –ü–æ—Ä—Ç–∞–ª', desc: '–ú–∏—Ñ–∏—á–µ—Å–∫–∏–π –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä, –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—â–∏–π +5.0 —ç–Ω–µ—Ä–≥–∏–∏ –≤ —Å–µ–∫—É–Ω–¥—É. –ü–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ —ç–Ω–µ—Ä–≥–µ—Ç–∏—á–µ—Å–∫–∏–º –ø–æ—Ä—Ç–∞–ª–∞–º –Ω–µ–±–µ—Å–Ω—ã—Ö —Å—Ñ–µ—Ä.', currency: 'stars', locked: false, basePrice: 600, baseEffect: 5.0}
                ]
            },
            'energy_expand': {
                name: '‚≠ê VIP –≠–Ω–µ—Ä–≥–æ-–ë–∞—Ç–∞—Ä–µ–∏',
                items: [
                    {level: 0, name: 'üåå –ì–∞–ª–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –†–µ–∑–µ—Ä–≤—É–∞—Ä', desc: 'VIP –Ω–∞–∫–æ–ø–∏—Ç–µ–ª—å, —É–≤–µ–ª–∏—á–∏–≤–∞—é—â–∏–π –º–∞–∫—Å–∏–º—É–º —ç–Ω–µ—Ä–≥–∏–∏ –Ω–∞ +3750. –•—Ä–∞–Ω–∏—Ç —ç–Ω–µ—Ä–≥–∏—é —Ü–µ–ª–æ–π –≥–∞–ª–∞–∫—Ç–∏–∫–∏ –≤ –∫–æ–º–ø–∞–∫—Ç–Ω–æ–º –∫—Ä–∏—Å—Ç–∞–ª–ª–µ.', currency: 'stars', locked: false, basePrice: 150, baseEffect: 3750},
                    {level: 0, name: '‚öõÔ∏è –ö–≤–∞–Ω—Ç–æ–≤–∞—è –°—É–ø–µ—Ä–ø–æ–∑–∏—Ü–∏—è', desc: '–≠–∫—Å–∫–ª—é–∑–∏–≤–Ω—ã–π –Ω–∞–∫–æ–ø–∏—Ç–µ–ª—å, —Ä–∞—Å—à–∏—Ä—è—é—â–∏–π —ç–Ω–µ—Ä–≥–æ–µ–º–∫–æ—Å—Ç—å –Ω–∞ +6250. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –∫–≤–∞–Ω—Ç–æ–≤—É—é —Å—É–ø–µ—Ä–ø–æ–∑–∏—Ü–∏—é –¥–ª—è –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ–≥–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è.', currency: 'stars', locked: false, basePrice: 250, baseEffect: 6250},
                    {level: 0, name: 'üå† –ó–≤–µ–∑–¥–Ω–æ–µ –°–æ–∑–≤–µ–∑–¥–∏–µ', desc: '–õ–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π –Ω–∞–∫–æ–ø–∏—Ç–µ–ª—å, —É–≤–µ–ª–∏—á–∏–≤–∞—é—â–∏–π –º–∞–∫—Å–∏–º—É–º —ç–Ω–µ—Ä–≥–∏–∏ –Ω–∞ +10000. –°–æ–¥–µ—Ä–∂–∏—Ç —ç–Ω–µ—Ä–≥–∏—é —Ü–µ–ª–æ–≥–æ –∑–≤–µ–∑–¥–Ω–æ–≥–æ —Å–æ–∑–≤–µ–∑–¥–∏—è.', currency: 'stars', locked: false, basePrice: 400, baseEffect: 10000},
                    {level: 0, name: 'üåë –ê–±—Å–æ–ª—é—Ç–Ω–∞—è –ü—É—Å—Ç–æ—Ç–∞', desc: '–ú–∏—Ñ–∏—á–µ—Å–∫–∏–π –Ω–∞–∫–æ–ø–∏—Ç–µ–ª—å, —Ä–∞—Å—à–∏—Ä—è—é—â–∏–π —ç–Ω–µ—Ä–≥–æ–µ–º–∫–æ—Å—Ç—å –Ω–∞ +18750. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —ç–Ω–µ—Ä–≥–∏—é –∫–æ—Å–º–∏—á–µ—Å–∫–æ–π –ø—É—Å—Ç–æ—Ç—ã –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è.', currency: 'stars', locked: false, basePrice: 600, baseEffect: 18750},
                    {level: 0, name: 'üëë –ò–º–ø–µ—Ä—Å–∫–∞—è –°–æ–∫—Ä–æ–≤–∏—â–Ω–∏—Ü–∞', desc: '–ë–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –Ω–∞–∫–æ–ø–∏—Ç–µ–ª—å, —É–≤–µ–ª–∏—á–∏–≤–∞—é—â–∏–π –º–∞–∫—Å–∏–º—É–º —ç–Ω–µ—Ä–≥–∏–∏ –Ω–∞ +37500. –°–æ–∫—Ä–æ–≤–∏—â–Ω–∏—Ü–∞ –∫—Ä–∏–ø—Ç–æ-–∏–º–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤ —Å –Ω–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–π –µ–º–∫–æ—Å—Ç—å—é.', currency: 'stars', locked: false, basePrice: 800, baseEffect: 37500}
                ]
            },
            'autobot': {
                name: '‚≠ê VIP –ö—Ä–∏–ø—Ç–æ-–ë–æ—Ç—ã',
                items: [
                    {level: 0, name: '‚≠ê VIP –ë–∞–∑–æ–≤—ã–π –ë–æ—Ç', desc: 'VIP –∞–≤—Ç–æ—Ç–∞–ø –Ω–∞ 4 —á–∞—Å–∞', speed: 3, duration: 240, currency: 'stars', locked: false, basePrice: 100},
                    {level: 0, name: '‚≠ê VIP –£–ª—É—á—à–µ–Ω–Ω—ã–π –ë–æ—Ç', desc: 'VIP –∞–≤—Ç–æ—Ç–∞–ø –Ω–∞ 12 —á–∞—Å–æ–≤', speed: 3.25, duration: 720, currency: 'stars', locked: false, basePrice: 200},
                    {level: 0, name: '‚≠ê VIP –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π –ë–æ—Ç', desc: 'VIP –∞–≤—Ç–æ—Ç–∞–ø –Ω–∞ 2 –¥–Ω—è', speed: 3.5, duration: 2880, currency: 'stars', locked: false, basePrice: 350},
                    {level: 0, name: '‚≠ê VIP –≠–ª–∏—Ç–Ω—ã–π –ë–æ—Ç', desc: 'VIP –∞–≤—Ç–æ—Ç–∞–ø –Ω–∞ 5 –¥–Ω–µ–π', speed: 3.75, duration: 7200, currency: 'stars', locked: false, basePrice: 500},
                    {level: 0, name: '‚≠ê VIP –ü—Ä–µ–º–∏—É–º –ë–æ—Ç', desc: 'VIP –∞–≤—Ç–æ—Ç–∞–ø –Ω–∞ 10 –¥–Ω–µ–π', speed: 4, duration: 14400, currency: 'stars', locked: false, basePrice: 750}
                ]
            }
        };
        
        // Function to format duration with correct Russian endings
        function formatDuration(minutes) {
            if (minutes < 60) {
                return minutes === 1 ? '1 –º–∏–Ω—É—Ç–∞' : minutes < 5 ? `${minutes} –º–∏–Ω—É—Ç—ã` : `${minutes} –º–∏–Ω—É—Ç`;
            }
            const hours = Math.floor(minutes / 60);
            if (hours < 24) {
                if (hours === 1) return '1 —á–∞—Å';
                if (hours < 5) return `${hours} —á–∞—Å–∞`;
                if (hours < 21) return `${hours} —á–∞—Å–æ–≤`;
                return `${hours} —á–∞—Å–æ–≤`; // 21-23 hours
            }
            const days = Math.floor(hours / 24);
            if (days === 1) return '1 –¥–µ–Ω—å';
            if (days < 5) return `${days} –¥–Ω—è`;
            return `${days} –¥–Ω–µ–π`;
        }
        
        function loadShopCategory(category) {
            // Store current category globally
            window.currentShopCategory = category;
            
            // Update button states
            document.querySelectorAll('.shop-cat-btn').forEach(btn => {
                const btnCategory = btn.getAttribute('data-category');
                if(btnCategory === category) {
                    btn.style.background = 'linear-gradient(135deg,#667eea,#764ba2)';
                    btn.style.border = 'none';
                } else {
                    btn.style.background = 'rgba(255,255,255,0.1)';
                    btn.style.border = '1px solid rgba(255,255,255,0.3)';
                }
            });
            
            // SPECIAL HANDLING FOR AUTOBOT: Don't recreate buttons, only update state if needed
            if (category === 'autobot' || category === 'autobot_vip') {
                // Check if buttons already exist
                const existingButtons = document.querySelectorAll('[data-autobot-level]');
                if (existingButtons.length > 0 && window.userData) {
                    // Buttons exist, just update their state (don't recreate)
                    updateAutobotShopButtons(window.userData);
                    return; // Don't recreate buttons!
                }
            }
            
            const items = window.shopData[category].items;
            const list = document.getElementById('shopItemsList');
            
            // Get user's current level for this category from userData
            let userLevel = 0;
            if (window.userData) {
                if (category === 'tap_boost' || category === 'tap_boost_vip') {
                    userLevel = window.userData.tap_boost_level || 0;
                } else if (category === 'energy_buy' || category === 'energy_buy_vip') {
                    userLevel = window.userData.energy_buy_level || 0;
                } else if (category === 'energy_expand' || category === 'energy_expand_vip') {
                    userLevel = window.userData.energy_expand_level || 0;
            }
            }
            
            // Check autobot state BEFORE creating buttons (to show correct state immediately)
            let autobotState = null;
            if ((category === 'autobot' || category === 'autobot_vip') && window.userData) {
                const autobotExpiresAt = window.userData.auto_tap_expires_at || 0;
                const autobotLevel = window.userData.auto_tap_level || 0;
                const currentTime = Date.now();
                if (autobotExpiresAt > currentTime && autobotLevel > 0) {
                    autobotState = {
                        expiresAt: autobotExpiresAt,
                        level: autobotLevel,
                        currentTime: currentTime
                    };
                }
            }
            
            // Calculate price and effect for each item based on its current level
            list.innerHTML = items.map((item, index) => {
                const isLocked = false; // Remove locking - all items are available
                
                // Get current level from shopData (updated after purchase)
                const currentLevel = window.shopData && window.shopData[category] && window.shopData[category].items && window.shopData[category].items[index] 
                    ? window.shopData[category].items[index].level 
                    : item.level;
                
                // Calculate current effect and next level price based on current level
                let currentEffect = 0;
                let nextLevelPrice = 0;
                let nextLevelEffect = 0;
                
                if (category === 'tap_boost' || category === 'tap_boost_vip') {
                    const baseEffect = item.baseEffect || 1;
                    const basePrice = item.basePrice || 1000;
                    // Show total tap boosts - active_multiplier is already the number of clicks
                    const userMultiplier = window.userData?.active_multiplier || 1;
                    console.log('Tap boost - userMultiplier:', userMultiplier, 'window.userData:', window.userData);
                    const totalBoost = userMultiplier;
                    nextLevelPrice = Math.floor(basePrice * Math.pow(1.5, currentLevel + 1));
                    
                    // Special handling for first item (base_effect == 1): always gives +1
                    if (baseEffect === 1) {
                        nextLevelEffect = 1;
                        // For first item, show total since it's the base
                        currentEffect = totalBoost;
                    } else {
                        // For other items: use same logic as backend
                        // Backend formula: 
                        //   current_effect = base_effect * (1.2 ** (level - 1)) if level > 1 else 0
                        //   new_effect = base_effect * (1.2 ** level)
                        //   bonus = new_effect - current_effect
                        // When buying, we're at level=currentLevel, buying level=currentLevel+1
                        // So calculate the bonus that will be added when purchasing next level
                        // Backend formula: level is the next level we're buying
                        // So at currentLevel, we're buying level=currentLevel+1
                        // Backend calculates: current_effect = base_effect * (1.2 ** (level - 1))
                        // So for level=currentLevel+1: current_effect = base_effect * (1.2 ** currentLevel)
                        const currentItemEffect = currentLevel >= 1 ? Math.floor(baseEffect * Math.pow(1.2, currentLevel)) : 0;
                        // new_effect = base_effect * (1.2 ** level) = base_effect * (1.2 ** (currentLevel + 1))
                        const newEffect = Math.floor(baseEffect * Math.pow(1.2, currentLevel + 1));
                        nextLevelEffect = newEffect - currentItemEffect;
                        // Show what total would be AFTER buying this item
                        // Total would be current total + nextLevelEffect
                        currentEffect = totalBoost;
                    }
                } else if (category === 'energy_buy' || category === 'energy_buy_vip') {
                    const baseEffect = item.baseEffect || 0.5;
                    const basePrice = item.basePrice || 1500;
                    // Show total energy regen (energy_regen_rate includes base 1)
                    const userRegenRate = window.userData?.energy_regen_rate || 1;
                    console.log('Energy buy - userRegenRate:', userRegenRate, 'window.userData:', window.userData);
                    const totalRegen = Math.max(0, Math.round((userRegenRate - 1) * 10) / 10);
                    nextLevelPrice = Math.floor(basePrice * Math.pow(1.4, currentLevel + 1));
                    // Backend formula: level is the next level we're buying
                    // So at currentLevel, we're buying level=currentLevel+1
                    // Backend calculates: current_effect = base_effect * (1.15 ** (level - 1))
                    // So for level=currentLevel+1: current_effect = base_effect * (1.15 ** currentLevel)
                    const currentItemEffect = currentLevel >= 1 ? Math.round(baseEffect * Math.pow(1.15, currentLevel) * 10) / 10 : 0;
                    // new_effect = base_effect * (1.15 ** level) = base_effect * (1.15 ** (currentLevel + 1))
                    const nextItemEffect = Math.round(baseEffect * Math.pow(1.15, currentLevel + 1) * 10) / 10;
                    // Show the increment (difference)
                    nextLevelEffect = Math.round((nextItemEffect - currentItemEffect) * 10) / 10;
                    currentEffect = totalRegen;
                } else if (category === 'energy_expand' || category === 'energy_expand_vip') {
                    const baseEffect = item.baseEffect || 50;
                    const basePrice = item.basePrice || 2000;
                    // Show total energy expansion (max_energy includes base 1000)
                    const userMaxEnergy = window.userData?.max_energy || 1000;
                    console.log('Energy expand - userMaxEnergy:', userMaxEnergy, 'window.userData:', window.userData);
                    const totalExpansion = Math.max(0, userMaxEnergy - 1000);
                    nextLevelPrice = Math.floor(basePrice * Math.pow(1.6, currentLevel + 1));
                    // Backend formula: level is the next level we're buying
                    // So at currentLevel, we're buying level=currentLevel+1
                    // Backend calculates: current_effect = base_effect * (1.25 ** (level - 1))
                    // So for level=currentLevel+1: current_effect = base_effect * (1.25 ** currentLevel)
                    const currentItemEffect = currentLevel >= 1 ? Math.floor(baseEffect * Math.pow(1.25, currentLevel)) : 0;
                    // new_effect = base_effect * (1.25 ** level) = base_effect * (1.25 ** (currentLevel + 1))
                    const nextItemEffect = Math.floor(baseEffect * Math.pow(1.25, currentLevel + 1));
                    // Show the increment (difference)
                    nextLevelEffect = nextItemEffect - currentItemEffect;
                    currentEffect = totalExpansion;
                }
                
                const rarityColors = {
                    0: 'rgba(148,163,184,0.3)', // gray
                    5: 'rgba(59,130,246,0.3)', // blue
                    10: 'rgba(139,92,246,0.3)', // purple
                    15: 'rgba(236,72,153,0.3)', // pink
                    20: 'rgba(251,191,36,0.3)', // gold
                    25: 'rgba(34,197,94,0.3)', // green
                    30: 'rgba(239,68,68,0.3)', // red
                    35: 'rgba(168,85,247,0.3)', // violet
                    40: 'rgba(245,158,11,0.3)', // amber
                    45: 'rgba(6,182,212,0.3)', // cyan
                    50: 'rgba(255,215,0,0.3)' // gold
                };
                const rarityColor = item.level <= 5 ? rarityColors[0] : 
                                   item.level <= 10 ? rarityColors[5] : 
                                   item.level <= 15 ? rarityColors[10] : 
                                   item.level <= 20 ? rarityColors[15] : 
                                   item.level <= 25 ? rarityColors[20] :
                                   item.level <= 30 ? rarityColors[25] :
                                   item.level <= 35 ? rarityColors[30] :
                                   item.level <= 40 ? rarityColors[35] :
                                   item.level <= 45 ? rarityColors[40] :
                                   item.level <= 50 ? rarityColors[45] : rarityColors[50];
                
                // Use calculated price and bonus for next level
                
                return `
                    <div style="background:${isLocked ? 'rgba(0,0,0,0.5)' : item.premium ? 'linear-gradient(135deg,rgba(255,215,0,0.15),rgba(255,237,78,0.15))' : rarityColor};padding:14px;border-radius:14px;border:2px solid ${isLocked ? 'rgba(239,68,68,0.5)' : item.premium ? 'rgba(255,215,0,0.6)' : 'rgba(102,126,234,0.4)'};position:relative;${isLocked ? 'opacity:0.6;' : ''}">
                        ${isLocked ? `
                            <div style="position:absolute;top:8px;right:8px;background:rgba(239,68,68,0.8);color:#fff;padding:4px 8px;border-radius:6px;font-size:10px;font-weight:700;">üîí</div>
                        ` : item.premium ? `
                            <div style="position:absolute;top:8px;right:8px;background:linear-gradient(135deg,#ffd700,#ffed4e);color:#000;padding:4px 8px;border-radius:6px;font-size:10px;font-weight:700;box-shadow:0 2px 8px rgba(255,215,0,0.4);">‚≠ê VIP</div>
                        ` : ''}
                        <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
                            <span style="font-size:20px;">${item.name.split(' ')[0]}</span>
                            <div style="flex:1;">
                                <div style="display:flex;align-items:center;gap:8px;margin-bottom:2px;">
                                    <div style="font-weight:800;font-size:14px;color:#fff;">${item.name.split(' ').slice(1).join(' ')} #${index + 1}</div>
                                    <div style="background:linear-gradient(135deg,rgba(102,126,234,0.8),rgba(139,92,246,0.8));color:#fff;padding:2px 6px;border-radius:6px;font-size:10px;font-weight:700;box-shadow:0 2px 4px rgba(102,126,234,0.3);">–£—Ä.${currentLevel}</div>
                                </div>
                                <div style="font-size:11px;color:#94a3b8;">${item.desc}</div>
                            </div>
                        </div>
                        ${category === 'tap_boost' ? `
                            <div style="background:rgba(102,126,234,0.2);padding:8px;border-radius:8px;margin-bottom:8px;">
                                <div style="display:flex;justify-content:space-between;align-items:center;">
                                    <span style="color:#a78bfa;font-size:12px;font-weight:700;">üí™ –ö–ª–∏–∫–æ–≤ –∑–∞ —Ç–∞–ø:</span>
                                    <span style="color:#fff;font-size:13px;font-weight:800;">${currentEffect}</span>
                                </div>
                                <div style="display:flex;justify-content:space-between;align-items:center;margin-top:4px;">
                                    <span style="color:#a78bfa;font-size:12px;font-weight:700;">üí™ –ü—Ä–∏—Ä–æ—Å—Ç:</span>
                                    <span style="color:#4ade80;font-size:13px;font-weight:800;">+${nextLevelEffect} –∫–ª–∏–∫–æ–≤</span>
                                </div>
                            </div>
                        ` : category === 'energy_buy' ? `
                            <div style="background:rgba(251,191,36,0.2);padding:8px;border-radius:8px;margin-bottom:8px;">
                                <div style="display:flex;justify-content:space-between;align-items:center;">
                                    <span style="color:#fbbf24;font-size:12px;font-weight:700;">‚ö° –£ –≤–∞—Å —Å–µ–π—á–∞—Å:</span>
                                    <span style="color:#fff;font-size:13px;font-weight:800;">${currentEffect} —ç–Ω–µ—Ä–≥–∏–∏/—Å–µ–∫</span>
                                </div>
                                <div style="display:flex;justify-content:space-between;align-items:center;margin-top:4px;">
                                    <span style="color:#fbbf24;font-size:12px;font-weight:700;">‚ö° –ü—Ä–∏—Ä–æ—Å—Ç:</span>
                                    <span style="color:#4ade80;font-size:13px;font-weight:800;">+${nextLevelEffect} —ç–Ω–µ—Ä–≥–∏–∏/—Å–µ–∫</span>
                                </div>
                            </div>
                        ` : category === 'energy_expand' ? `
                            <div style="background:rgba(236,72,153,0.2);padding:8px;border-radius:8px;margin-bottom:8px;">
                                <div style="display:flex;justify-content:space-between;align-items:center;">
                                    <span style="color:#ec4899;font-size:12px;font-weight:700;">üìà –£ –≤–∞—Å —Å–µ–π—á–∞—Å:</span>
                                    <span style="color:#fff;font-size:13px;font-weight:800;">+${currentEffect > 0 ? currentEffect.toLocaleString() : '0'} –∫ —ç–Ω–µ—Ä–≥–∏–∏</span>
                                </div>
                                <div style="display:flex;justify-content:space-between;align-items:center;margin-top:4px;">
                                    <span style="color:#ec4899;font-size:12px;font-weight:700;">üìà –ü—Ä–∏—Ä–æ—Å—Ç:</span>
                                    <span style="color:#4ade80;font-size:13px;font-weight:800;">+${nextLevelEffect.toLocaleString()}</span>
                                </div>
                            </div>
                        ` : `
                            <div style="background:rgba(16,185,129,0.2);padding:8px;border-radius:8px;margin-bottom:8px;">
                                <div style="display:flex;justify-content:space-between;align-items:center;">
                                    <span style="color:#10b981;font-size:12px;font-weight:700;">‚è±Ô∏è –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:</span>
                                    <span style="color:#fff;font-size:12px;font-weight:800;">${formatDuration(item.duration)}</span>
                                </div>
                                ${item.speed > 1 ? `
                                <div style="display:flex;justify-content:space-between;align-items:center;margin-top:4px;">
                                    <span style="color:#10b981;font-size:12px;font-weight:700;">‚ö° –°–∫–æ—Ä–æ—Å—Ç—å:</span>
                                    <span style="color:#4ade80;font-size:12px;font-weight:800;">${item.speed} —Ç–∞–ø–æ–≤/—Å–µ–∫</span>
                                </div>
                                ` : ''}
                            </div>
                        `}
                        ${category === 'autobot' || category === 'autobot_vip' ? `
                            ${(() => {
                                // Check if autobot is active and this is the purchased button
                                const isPurchased = autobotState && autobotState.level === item.level;
                                const isBlocked = autobotState && autobotState.level !== item.level;
                                
                                let mainText = '';
                                let countdownHtml = '';
                                let btnStyle = '';
                                let btnDisabled = '';
                                
                                if (isPurchased) {
                                    // Purchased button: show active state with countdown
                                    const remainingMs = autobotState.expiresAt - autobotState.currentTime;
                                    const hours = Math.floor(remainingMs / 3600000);
                                    const minutes = Math.floor((remainingMs % 3600000) / 60000);
                                    const seconds = Math.floor((remainingMs % 60000) / 1000);
                                    const timeText = `${String(hours).padStart(2,'0')}:${String(minutes).padStart(2,'0')}:${String(seconds).padStart(2,'0')}`;
                                    
                                    mainText = 'ü§ñ –ê–≤—Ç–æ–±–æ—Ç –∞–∫—Ç–∏–≤–µ–Ω';
                                    countdownHtml = `<span class="autobot-countdown" style="display:block;font-size:10px;color:#86efac;font-weight:600;">‚è±Ô∏è –û—Å—Ç–∞–ª–æ—Å—å: ${timeText}</span>`;
                                    btnStyle = 'rgba(16,185,129,0.6)';
                                    btnDisabled = 'disabled';
                                } else if (isBlocked || autobotState) {
                                    // Other buttons when autobot is active: show blocked
                                    mainText = 'üîí –ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ';
                                    countdownHtml = `<span class="autobot-countdown" style="display:none;font-size:10px;color:#86efac;font-weight:600;"></span>`;
                                    btnStyle = 'rgba(148,163,184,0.3)';
                                    btnDisabled = 'disabled';
                                } else {
                                    // Autobot not active: show price
                                    mainText = isLocked ? 'üîí –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ' : (item.currency === 'stars' ? `–ö—É–ø–∏—Ç—å –∑–∞ ${item.basePrice || item.price} ‚≠ê Stars` : `–ö—É–ø–∏—Ç—å –∑–∞ ${item.price.toLocaleString()} ü™ô`);
                                    countdownHtml = `<span class="autobot-countdown" style="display:none;font-size:10px;color:#86efac;font-weight:600;"></span>`;
                                    btnStyle = isLocked ? 'rgba(239,68,68,0.6)' : (item.currency === 'stars' ? 'linear-gradient(135deg,#ffd700,#ffed4e,#ffd700)' : 'linear-gradient(135deg,#667eea,#764ba2)');
                                    btnDisabled = '';
                                }
                                
                                return `<button id="autobot-btn-${item.level}" data-autobot-level="${item.level}" ${btnDisabled} onclick="${isLocked || isBlocked || isPurchased ? 'return false;' : (item.currency === 'stars' ? `buyWithStars('${category}', ${item.level}, ${item.basePrice || item.price})` : `buyShopItem('${category}', ${item.level}, ${item.price})`)}" 
                                    style="width:100%;padding:8px 12px;background:${btnStyle};color:${item.currency === 'stars' && !autobotState ? '#000' : '#fff'};border:${item.currency === 'stars' && !autobotState ? '1px solid #ffd700' : 'none'};border-radius:10px;cursor:${isLocked || isBlocked || isPurchased ? 'not-allowed' : 'pointer'};font-weight:700;font-size:12px;transition:all 0.3s;position:relative;overflow:hidden;box-shadow:${item.currency === 'stars' && !autobotState ? '0 3px 10px rgba(255,215,0,0.3)' : '0 2px 6px rgba(102,126,234,0.3)'};display:flex;flex-direction:column;align-items:center;justify-content:center;gap:2px;">
                                <span class="autobot-btn-main-text">${mainText}</span>
                                ${countdownHtml}
                            </button>`;
                            })()}
                        ` : `
                            <button onclick="${isLocked ? 'tg.showAlert(\'üîí –°–Ω–∞—á–∞–ª–∞ –∫—É–ø–∏—Ç–µ –ø—Ä–µ–¥—ã–¥—É—â–∏–π —É—Ä–æ–≤–µ–Ω—å\')' : item.currency === 'stars' ? `buyWithStars('${category}', ${currentLevel}, ${item.basePrice || item.price})` : `buyShopItem('${category}', ${currentLevel}, ${nextLevelPrice}, ${index})`}" 
                                    style="width:100%;padding:8px 12px;background:${isLocked ? 'rgba(239,68,68,0.6)' : item.currency === 'stars' ? 'linear-gradient(135deg,#ffd700,#ffed4e,#ffd700)' : 'linear-gradient(135deg,#667eea,#764ba2)'};color:${item.currency === 'stars' ? '#000' : '#fff'};border:${item.currency === 'stars' ? '1px solid #ffd700' : 'none'};border-radius:10px;cursor:${isLocked ? 'not-allowed' : 'pointer'};font-weight:700;font-size:12px;transition:all 0.3s;position:relative;overflow:hidden;box-shadow:${item.currency === 'stars' ? '0 3px 10px rgba(255,215,0,0.3)' : '0 2px 6px rgba(102,126,234,0.3)'};display:flex;align-items:center;justify-content:center;gap:4px;"
                                    onmousedown="if(!${isLocked}){this.style.transform='scale(0.98)';this.style.boxShadow='${item.currency === 'stars' ? '0 4px 12px rgba(255,215,0,0.4)' : '0 3px 8px rgba(102,126,234,0.4)'}'}"
                                    onmouseup="if(!${isLocked}){this.style.transform='scale(1)';this.style.boxShadow='${item.currency === 'stars' ? '0 3px 10px rgba(255,215,0,0.3)' : '0 2px 6px rgba(102,126,234,0.3)'}'}"
                                    onmouseleave="if(!${isLocked}){this.style.transform='scale(1)';this.style.boxShadow='${item.currency === 'stars' ? '0 3px 10px rgba(255,215,0,0.3)' : '0 2px 6px rgba(102,126,234,0.3)'}'}">
                                ${isLocked ? 'üîí –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ' : item.currency === 'stars' ? `<span>–ö—É–ø–∏—Ç—å –∑–∞ ${item.basePrice || item.price}</span><span style="font-size:14px;">‚≠ê</span><span>Stars</span>` : `<span>–ö—É–ø–∏—Ç—å –∑–∞ ${nextLevelPrice.toLocaleString()}</span><span style="font-size:14px;">ü™ô</span>`}
                            </button>
                        `}
                    </div>
                `;
            }).join('');
            
            // Update VIP button for current category
            const vipButton = document.getElementById('vipButton');
            if (vipButton) {
                vipButton.setAttribute('onclick', `openVIPModal('${category}')`);
            }
            
            // Update autobot buttons if autobot category is loaded - set up timer for countdown updates
            if (category === 'autobot' || category === 'autobot_vip') {
                // Buttons were just created, initialize state and timer
                if (window.userData) {
                    // Update immediately (buttons already have correct initial state from HTML generation)
                    updateAutobotShopButtons(window.userData);
                } else {
                    // Fetch userData if not available
                    fetch('/api/user_data', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({user_id: window.user?.id})
                    })
                    .then(res => res.json())
                    .then(data => {
                        window.userData = data; // Store for future use
                        // Update immediately (buttons already have correct initial state from HTML generation)
                        updateAutobotShopButtons(data);
                    })
                    .catch(err => console.error('Error loading user data for autobots:', err));
                }
            }
        }
        
        function loadShopLevels() {
            const userId = window.userData?.id || window.user?.id;
            if (!userId) return;
            
            fetch('/api/get_shop_levels', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({user_id: userId})
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    // Update shopData with levels from database
                    if (window.shopData) {
                        // Update tap_boost levels
                        Object.keys(data.tap_boost_levels).forEach(index => {
                            if (window.shopData.tap_boost && window.shopData.tap_boost.items[index]) {
                                window.shopData.tap_boost.items[index].level = data.tap_boost_levels[index];
                            }
                        });
                        
                        // Update energy_buy levels
                        Object.keys(data.energy_buy_levels).forEach(index => {
                            if (window.shopData.energy_buy && window.shopData.energy_buy.items[index]) {
                                window.shopData.energy_buy.items[index].level = data.energy_buy_levels[index];
                            }
                        });
                        
                        // Update energy_expand levels
                        Object.keys(data.energy_expand_levels).forEach(index => {
                            if (window.shopData.energy_expand && window.shopData.energy_expand.items[index]) {
                                window.shopData.energy_expand.items[index].level = data.energy_expand_levels[index];
                            }
                        });
                        
                        // Refresh current shop category if it's open (but NOT autobot to prevent blinking)
                        const activeBtn = document.querySelector('.shop-cat-btn[style*="linear-gradient"]');
                        if (activeBtn && activeBtn.dataset.category) {
                            const category = activeBtn.dataset.category;
                            // Never reload autobot category - buttons should not be recreated
                            if (category !== 'autobot' && category !== 'autobot_vip') {
                                loadShopCategory(category);
                            }
                            // For autobot, do nothing - buttons are managed by updateAutobotShopButtons only
                        }
                    }
                }
            })
            .catch(err => console.error('Error loading shop levels:', err));
        }
        
        function showNotification(type, message) {
            const anim = document.createElement('div');
            anim.style.cssText = 'position:fixed;top:15%;left:50%;transform:translate(-50%,-50%);z-index:10000;pointer-events:none;';
            const bgColor = type === 'error' ? 'rgba(239,68,68,0.95),rgba(220,38,38,0.95)' : 'rgba(34,197,94,0.95),rgba(16,185,129,0.95)';
            const icon = type === 'error' ? 'üí∞' : '‚ú®';
            anim.innerHTML = `<div style="background:linear-gradient(135deg,${bgColor});padding:8px 16px;border-radius:20px;font-size:14px;box-shadow:0 4px 15px rgba(16,185,129,0.5);color:#fff;font-weight:700;display:flex;align-items:center;gap:6px;border:1px solid rgba(255,255,255,0.2);"><span style="font-size:16px;">${icon}</span> ${message}</div>`;
            document.body.appendChild(anim);
            setTimeout(() => {
                anim.style.opacity = '0';
                anim.style.transform = 'translate(-50%,-60%)';
                setTimeout(() => anim.remove(), 300);
            }, 1500);
        }
        
        function buyShopItem(category, level, price, itemIndex) {
            // Use direct price from the item (calculated by formulas)
            const actualPrice = price;
            const userId = window.userData?.id || window.user?.id;
            
            if (!userId) {
                showNotification('error', '–û—à–∏–±–∫–∞: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω');
                return;
            }
            
            // Play sound for shop purchase based on category
            const soundEnabled = localStorage.getItem('soundEnabled') === 'true';
            if (soundEnabled) {
                if (category === 'card') {
                    playSound('card');
                } else if (category === 'tap_boost' || category === 'energy_buy' || category === 'energy_expand' || category === 'autobot') {
                    playSound('purchase');
                }
            }
            
            // Haptic feedback
            const hapticsEnabled = localStorage.getItem('hapticsEnabled') === 'true';
            if (hapticsEnabled && tg?.HapticFeedback) {
                tg.HapticFeedback.impactOccurred('light');
            }
            
            // Special handling for cards - use /api/buy endpoint
            if (category === 'card') {
                // Get card data from shopData to find the correct item_type
                if (!window.shopData || !window.shopData.items) {
                    console.error('Shop data not loaded! Loading cards data...');
                    // Force reload cards data
                    fetch('/api/shop', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({user_id: userId, category: 'cards'})
                    })
                    .then(res => res.json())
                    .then(shopData => {
                        window.shopData = window.shopData || {};
                        window.shopData.items = shopData.items || [];
                        console.log('Reloaded shop data:', window.shopData);
                        // Retry the purchase with a small delay to avoid recursion issues
                        setTimeout(() => {
                            buyShopItem(category, level, price, itemIndex);
                        }, 100);
                    })
                    .catch(err => {
                        console.error('Error loading shop data:', err);
                        showNotification('error', '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –º–∞–≥–∞–∑–∏–Ω–∞');
                    });
                    return;
                }
                
                const shopData = window.shopData || {};
                const cards = shopData.items || [];
                
                console.log('Shop data for cards:', shopData);
                console.log('Cards array:', cards);
                console.log('Item index or id:', itemIndex);
                console.log('Actual price:', actualPrice);
                console.log('Cards length:', cards.length);
                console.log('Item index valid:', itemIndex >= 0 && itemIndex < cards.length);
                
                // If itemIndex is a string, it's actually the card id -> use directly
                let itemType = (typeof itemIndex === 'string') ? itemIndex : null;
                let card = null;
                if (!itemType) {
                    card = cards[itemIndex];
                    if (!card) {
                        console.error('Card not found at index:', itemIndex, 'cards length:', cards.length);
                        showNotification('error', '–ö–∞—Ä—Ç–æ—á–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
                        return;
                    }
                    itemType = card.id;
                } else {
                    card = cards.find(c => c.id === itemType) || null;
                }
                
                console.log('Buying card:', {card, itemType, actualPrice, cards: cards.length});
                console.log('Card ID for purchase:', itemType);
                console.log('Item type being sent:', itemType);
                
                fetch('/api/buy', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                        user_id: userId,
                        item_type: itemType,
                    price: actualPrice
                })
            })
            .then(res => res.json())
            .then(data => {
                    console.log('Card purchase response:', data);
                    console.log('Response success:', data.success);
                    console.log('Response error:', data.error);
                if(data.success) {
                        // Success sound and haptics
                        if (soundEnabled) playSound('success');
                        if (hapticsEnabled && tg?.HapticFeedback) {
                            tg.HapticFeedback.notificationOccurred('success');
                        }
                        
                        showNotification('success', '–ö–∞—Ä—Ç–æ—á–∫–∞ –∫—É–ø–ª–µ–Ω–∞!');
                    
                        // Reload cards data to update levels and prices
                        fetch('/api/shop', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({user_id: userId, category: 'cards'})
                        })
                        .then(res => res.json())
                        .then(shopData => {
                            console.log('Reloaded cards data after purchase:', shopData);
                            console.log('Cards items:', shopData.items);
                            window.shopData = window.shopData || {};
                            window.shopData.items = shopData.items || [];
                            
                            // Refresh cards display - force reload all cards
                            console.log('Refreshing all cards after purchase');
                            
                            // Find the currently active category and refresh it
                            const activeBtn = document.querySelector('#cardsShopSection .shop-cat-btn[style*="linear-gradient"]');
                            const activeCategory = activeBtn && activeBtn.dataset.category ? activeBtn.dataset.category : 'per_hour';
                            console.log('Active category:', activeCategory);
                            
                            // Log per_hour cards specifically
                            const perHourCards = shopData.items.filter(item => item.type === 'card' && item.income_type === 'per_hour');
                            console.log('Per hour cards after purchase:', perHourCards.map(c => ({
                                id: c.id,
                                level: c.level,
                                price: c.price,
                                income_per_min: c.income_per_min
                            })));
                            
                            // Force refresh the active category
                            loadCardsCategory(activeCategory);
                            
                            // Also refresh the main data to update user stats
                            loadData();
                        });
                    } else {
                        // Error sound
                        if (soundEnabled) playSound('error');
                        
                        showNotification('error', data.error || '–û—à–∏–±–∫–∞ –ø–æ–∫—É–ø–∫–∏');
                    }
                })
                .catch(err => {
                    console.error('Error buying card:', err);
                    if (soundEnabled) playSound('error');
                    showNotification('error', '–û—à–∏–±–∫–∞ –ø–æ–∫—É–ø–∫–∏');
                });
                return;
            }
            
            // For multilevel items we pass next level; for autobot use exact selected level
            const nextLevel = (category === 'autobot' || category === 'autobot_vip') ? level : (level + 1);
            
            // Get base effect and price from shopData
            const shopData = window.shopData || {};
            const item = shopData[category] && shopData[category].items && shopData[category].items[itemIndex] 
                ? shopData[category].items[itemIndex] 
                : { baseEffect: 1, basePrice: 1000 };
            
            console.log('Buying item:', {userId, category, level, price: actualPrice, itemIndex, item});
            
            fetch('/api/buy_shop_item', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    user_id: userId, 
                    category: category, 
                    level: nextLevel, 
                    price: actualPrice,
                    item_index: itemIndex,
                    base_effect: item.baseEffect || 1,
                    base_price: item.basePrice || 1000
                })
            })
            .then(res => res.json())
            .then(data => {
                if(data.success) {
                    // Success sound and haptics
                    if (soundEnabled) playSound('levelup');
                    if (hapticsEnabled && tg?.HapticFeedback) {
                        tg.HapticFeedback.notificationOccurred('success');
                    }
                    
                    // Update item level locally
                    if (category === 'tap_boost' || category === 'energy_buy' || category === 'energy_expand') {
                        // Find the item in shopData and increase its level
                        const shopData = window.shopData || {};
                        if (shopData[category] && shopData[category].items && shopData[category].items[itemIndex]) {
                            shopData[category].items[itemIndex].level = nextLevel;
                        }
                    }
                    
                    // Compact success notification for Telegram
                    const anim = document.createElement('div');
                    anim.style.cssText='position:fixed;top:15%;left:50%;transform:translate(-50%,-50%);z-index:10000;pointer-events:none;';
                    anim.innerHTML='<div style="background:linear-gradient(135deg,rgba(34,197,94,0.95),rgba(16,185,129,0.95));padding:8px 16px;border-radius:20px;font-size:14px;box-shadow:0 4px 15px rgba(16,185,129,0.5);color:#fff;font-weight:700;display:flex;align-items:center;gap:6px;border:1px solid rgba(255,255,255,0.2);"><span style="font-size:16px;">‚ú®</span> –£—Ä–æ–≤–µ–Ω—å –ø–æ–≤—ã—à–µ–Ω!</div>';
                    document.body.appendChild(anim);
                    setTimeout(()=>{anim.style.opacity='0';anim.style.transform='translate(-50%,-60%)';setTimeout(()=>{anim.remove();},300);},800);
                    
                    // Reload data and refresh shop display
                    loadData();
                    
                    // Refresh current shop category to show updated levels (but NOT autobot to prevent blinking)
                    setTimeout(() => {
                        const activeBtn = document.querySelector('.shop-cat-btn[style*="linear-gradient"]');
                        if (activeBtn && activeBtn.dataset.category) {
                            const category = activeBtn.dataset.category;
                            // For autobot, just update button states without reloading the whole category
                            if (category === 'autobot' || category === 'autobot_vip') {
                                // Update autobot buttons state only (one time after purchase)
                                if (window.userData) {
                                    updateAutobotShopButtons(window.userData);
                                }
                            } else {
                                // For other categories, reload normally
                                loadShopCategory(category);
                            }
                        }
                    }, 200);
                    
                    
                    // Update passive income immediately
                    updatePassiveIncome();
                } else {
                    // Error sound
                    if (soundEnabled) playSound('error');
                    
                    // Compact error notification for Telegram
                    const error = document.createElement('div');
                    error.style.cssText='position:fixed;top:15%;left:50%;transform:translate(-50%,-50%);z-index:10000;pointer-events:none;';
                    const errorText = (data.error.includes('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ') || data.error.includes('Not enough')) ? '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫–æ–∏–Ω–æ–≤' : data.error;
                    error.innerHTML='<div style="background:linear-gradient(135deg,rgba(239,68,68,0.95),rgba(220,38,38,0.95));padding:8px 16px;border-radius:20px;font-size:14px;box-shadow:0 4px 15px rgba(239,68,68,0.5);color:#fff;font-weight:700;display:flex;align-items:center;gap:6px;border:1px solid rgba(255,255,255,0.2);"><span style="font-size:16px;">üí∞</span> ' + errorText + '</div>';
                    document.body.appendChild(error);
                    setTimeout(()=>{error.style.opacity='0';error.style.transform='translate(-50%,-60%)';setTimeout(()=>{error.remove();},300);},1500);
                }
            });
        }

        function renderShop() {
            const boostsHtml = shopItems.boosts.map(item => `
                <div class="item" onclick="buyItem('boost', '${item.type}', ${item.price})">
                    <div class="item-info">
                        <div class="item-emoji">${item.emoji}</div>
                        <div class="item-details">
                            <div class="item-name">${item.name}</div>
                            <div class="item-desc">${item.desc}</div>
                            <div class="item-price">${item.price.toLocaleString()} ü™ô</div>
                        </div>
                    </div>
                </div>
            `).join('');
            document.getElementById('boostsList').innerHTML = boostsHtml;

            const automationHtml = shopItems.automation.map(item => `
                <div class="item" onclick="buyItem('automation', '${item.type}', ${item.price})">
                    <div class="item-info">
                        <div class="item-emoji">${item.emoji}</div>
                        <div class="item-details">
                            <div class="item-name">${item.name}</div>
                            <div class="item-desc">${item.desc}</div>
                            <div class="item-price">${item.price.toLocaleString()} ü™ô</div>
                        </div>
                    </div>
                </div>
            `).join('');
            document.getElementById('automationList').innerHTML = automationHtml;

            const energyHtml = shopItems.energy.map(item => `
                <div class="item" onclick="buyEnergy(${item.amount}, ${item.price})">
                    <div class="item-info">
                        <div class="item-emoji">${item.emoji}</div>
                        <div class="item-details">
                            <div class="item-name">–≠–Ω–µ—Ä–≥–∏—è +${item.amount}</div>
                            <div class="item-price">${item.price.toLocaleString()} ü™ô</div>
                        </div>
                    </div>
                </div>
            `).join('');
            document.getElementById('energyList').innerHTML = energyHtml;

            const cardsHtml = shopItems.cards.map(item => `
                <div class="item" onclick="buyItem('card', '${item.type}', ${item.price})">
                    <div class="item-info">
                        <div class="item-emoji">${item.emoji}</div>
                        <div class="item-details">
                            <div class="item-name">${item.name}</div>
                            <div class="item-desc">${item.desc}</div>
                            <div class="item-price">${item.price.toLocaleString()} ü™ô</div>
                        </div>
                    </div>
                </div>
            `).join('');
            document.getElementById('cardsList').innerHTML = cardsHtml;
        }

        function buyItem(type, id, price) {
            fetch('/api/buy', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({user_id: user?.id, item_type: id, price: price})
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    tg.showAlert('‚úÖ –£—Å–ø–µ—à–Ω–æ!');
                    loadData();
                    renderShop();
                } else {
                    tg.showAlert('‚ö†Ô∏è ' + data.error);
                }
            })
            .catch(err => {
                tg.showAlert('‚ùå –û—à–∏–±–∫–∞ –ø–æ–∫—É–ø–∫–∏');
            });
        }

        function buyEnergy(amount, price) {
            fetch('/api/buy_energy', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({user_id: user?.id, amount: amount, price: price})
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    tg.showAlert('‚úÖ –≠–Ω–µ—Ä–≥–∏—è –∫—É–ø–ª–µ–Ω–∞!');
                    loadData();
                    renderShop();
                } else {
                    tg.showAlert('‚ö†Ô∏è ' + data.error);
                }
            })
            .catch(err => {
                tg.showAlert('‚ùå –û—à–∏–±–∫–∞ –ø–æ–∫—É–ø–∫–∏');
            });
        }

        function openMining(e) {
            e.preventDefault();
            // Check if modal already exists
            const existingModal = document.getElementById('miningModal2');
            if(existingModal) {
                existingModal.style.display = 'block';
                existingModal.classList.add('active');
                loadMiningCategory('coins');
                return;
            }
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.id = 'miningModal2';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 420px; max-height: 85vh; overflow-y: auto;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                        <h2 style="font-size: 24px; color: #fff; font-weight: 800;">üè≠ –ú–∞–π–Ω–∏–Ω–≥</h2>
                        <button class="close-btn" onclick="this.closest('.modal').remove()">‚úï</button>
                    </div>
                    
                    <div style="background:linear-gradient(135deg,rgba(102,126,234,0.15),rgba(118,75,162,0.15));padding:15px;border-radius:15px;margin-bottom:20px;border:2px solid rgba(102,126,234,0.3);">
                        <div style="font-size:13px;color:#94a3b8;line-height:1.6;">
                            <strong style="color:#fff;">‚ö° –ü–∞—Å—Å–∏–≤–Ω—ã–π –¥–æ—Ö–æ–¥ 24/7:</strong> –î–æ–±—ã–≤–∞–π—Ç–µ QuanHash –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏! –†–∞–∑–Ω—ã–µ –º–∞—à–∏–Ω—ã = —Ä–∞–∑–Ω–∞—è –º–æ—â–Ω–æ—Å—Ç—å. –ó–∞—Ä–∞–±–∞—Ç—ã–≤–∞–π—Ç–µ –¥–∞–∂–µ –æ—Ñ—Ñ–ª–∞–π–Ω!
                        </div>
                    </div>
                    
                    <div id="miningShopSection" style="margin-bottom:25px;">
                        <div style="font-size:16px;font-weight:700;color:#fff;margin-bottom:15px;display:flex;align-items:center;gap:8px;grid-column:1/-1;">
                            <span style="background:linear-gradient(135deg,#667eea,#764ba2);padding:6px 12px;border-radius:8px;width:100%;text-align:center;">üõí –ú–∞–≥–∞–∑–∏–Ω –º–∞—à–∏–Ω</span>
                        </div>
                        <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-bottom:15px;">
                            <button class="mining-cat-btn" onclick="loadMiningCategory('coins')" style="padding:10px;background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border:none;border-radius:10px;cursor:pointer;font-weight:600;font-size:12px;">ü™ô –ó–∞ –∫–æ–∏–Ω—ã</button>
                            <button class="mining-cat-btn" onclick="loadMiningCategory('quanhash')" style="padding:10px;background:rgba(255,255,255,0.1);color:#fff;border:1px solid rgba(255,255,255,0.3);border-radius:10px;cursor:pointer;font-weight:600;font-size:12px;">üíé –ó–∞ QuanHash</button>
                        </div>
                        <div style="margin-bottom:15px;">
                            <div style="padding:6px;background:linear-gradient(135deg,rgba(255,215,0,0.2),rgba(255,237,78,0.2),rgba(255,215,0,0.2));border:2px solid rgba(255,215,0,0.7);border-radius:12px;position:relative;box-shadow:0 4px 15px rgba(255,215,0,0.3);">
                                <button onclick="openVIPMiningModal()" style="width:100%;padding:8px 12px;background:linear-gradient(135deg,#ffd700,#ffed4e,#ffd700);color:#000;border:2px solid #ffd700;border-radius:8px;cursor:pointer;font-weight:800;font-size:14px;transition:all 0.3s;box-shadow:0 3px 10px rgba(255,215,0,0.4);position:relative;display:flex;align-items:center;justify-content:center;" onmousedown="this.style.transform='scale(0.97)'" onmouseup="this.style.transform='scale(1)'" onmouseleave="this.style.transform='scale(1)'">
                                    <span style="font-size:18px;margin-right:8px;text-shadow:0 2px 4px rgba(0,0,0,0.3);filter:drop-shadow(0 0 3px rgba(255,215,0,0.8));">‚≠ê</span>
                                    <span style="flex:1;text-align:center;">–ö—É–ø–∏—Ç—å VIP —Ñ—É–Ω–∫—Ü–∏–∏ –∑–∞ Telegram Stars</span>
                                    <div style="background:linear-gradient(135deg,#000,#333);color:#fff;padding:2px 6px;border-radius:4px;font-size:10px;font-weight:900;margin-left:8px;">VIP</div>
                                </button>
                            </div>
                        </div>
                        <div id="miningShop" style="display:grid;grid-template-columns:repeat(2,1fr);gap:12px;"></div>
                        <div id="vipMiningSection" style="display:none;grid-template-columns:repeat(2,1fr);gap:12px;margin-top:20px;"></div>
                    </div>
                    
                    <div id="miningInfo" style="background:linear-gradient(135deg,rgba(16,185,129,0.2),rgba(34,197,94,0.2));padding:20px;border-radius:15px;border:2px solid rgba(16,185,129,0.4);text-align:center;margin-top:20px;margin-bottom:15px;">
                        <div style="font-size:14px;font-weight:700;margin-bottom:10px;color:#10b981;">üíé –û–±—â–∏–π –¥–æ—Ö–æ–¥ –æ—Ç –º–∞–π–Ω–∏–Ω–≥–∞</div>
                        <div style="font-size:36px;font-weight:900;color:#10b981;text-shadow:0 0 20px rgba(16,185,129,0.5);">+0 üíé/—á–∞—Å</div>
                    </div>
                    
                    <button onclick="this.closest('.modal').remove()" style="width:100%;padding:14px;background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border:none;border-radius:12px;cursor:pointer;font-weight:700;font-size:16px;">–ó–∞–∫—Ä—ã—Ç—å</button>
                </div>
            `;
            document.body.appendChild(modal);
            loadMiningCategory('coins');
        }
        // VIP Mining Cards - –î–æ—Ö–æ–¥ –æ—Ç 50 –¥–æ 500 QuanHash
        const vipMiningCards = [
            {id: 'vip_quantum_prime', name: 'Quantum Prime', emoji: '‚ö°', basePrice: 50, baseHashPerHour: 50, rarity: 'vip_prime', productId: 71, description: '–≠–ª–∏—Ç–Ω—ã–π –∫–≤–∞–Ω—Ç–æ–≤—ã–π –º–∞–π–Ω–µ—Ä'},
            {id: 'vip_solar_core', name: 'Solar Core', emoji: '‚òÄÔ∏è', basePrice: 100, baseHashPerHour: 100, rarity: 'vip_solar', productId: 72, description: '–°–æ–ª–Ω–µ—á–Ω–æ–µ —è–¥—Ä–æ —ç–Ω–µ—Ä–≥–∏–∏'},
            {id: 'vip_black_hole', name: 'Black Hole', emoji: 'üï≥Ô∏è', basePrice: 150, baseHashPerHour: 200, rarity: 'vip_blackhole', productId: 73, description: '–ß—ë—Ä–Ω–∞—è –¥—ã—Ä–∞ —ç–Ω–µ—Ä–≥–∏–∏'},
            {id: 'vip_nebula', name: 'Nebula –§–µ—Ä–º–∞', emoji: 'üå´Ô∏è', basePrice: 250, baseHashPerHour: 300, rarity: 'vip_nebula', productId: 74, description: '–§–µ—Ä–º–∞ –≤ —Ç—É–º–∞–Ω–Ω–æ—Å—Ç–∏'},
            {id: 'vip_multiverse', name: 'Multiverse –°—Ç–∞–Ω—Ü–∏—è', emoji: 'üåê', basePrice: 400, baseHashPerHour: 400, rarity: 'vip_multiverse', productId: 75, description: '–ú—É–ª—å—Ç–∏–≤—Å–µ–ª–µ–Ω–Ω–∞—è'},
            {id: 'vip_infinity', name: 'Infinity –ê–ª—å—è–Ω—Å', emoji: '‚ôæÔ∏è', basePrice: 750, baseHashPerHour: 500, rarity: 'vip_infinity', productId: 76, description: '–ë–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π –∞–ª—å—è–Ω—Å'}
        ];
        
        const miningMachinesData = {
            'coins': [
                {id: 'miner_cpu', name: 'CPU –ú–∞–π–Ω–µ—Ä', emoji: 'üíª', basePrice: 5000, baseHashPerHour: 10, currency: 'coins', description: '–ë–∞–∑–æ–≤—ã–π –º–∞–π–Ω–µ—Ä –Ω–∞ CPU'},
                {id: 'miner_gpu', name: 'GPU –ú–∞–π–Ω–µ—Ä', emoji: 'üéÆ', basePrice: 20000, baseHashPerHour: 50, currency: 'coins', description: '–í–∏–¥–µ–æ–∫–∞—Ä—Ç–∞ –¥–ª—è –º–∞–π–Ω–∏–Ω–≥–∞'},
                {id: 'miner_asic', name: 'ASIC –†–∏–≥', emoji: '‚ö°', basePrice: 80000, baseHashPerHour: 200, currency: 'coins', description: '–ê—Å–∏–∫-—É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ'},
                {id: 'miner_quantum', name: 'Quantum –ú–∞–π–Ω–µ—Ä', emoji: 'üíé', basePrice: 300000, baseHashPerHour: 800, currency: 'coins', description: '–ö–≤–∞–Ω—Ç–æ–≤—ã–π –º–∞–π–Ω–µ—Ä'},
                {id: 'miner_server', name: 'Server –§–µ—Ä–º–∞', emoji: 'üñ•Ô∏è', basePrice: 1000000, baseHashPerHour: 3000, currency: 'coins', description: '–°–µ—Ä–≤–µ—Ä–Ω–∞—è —Ñ–µ—Ä–º–∞'},
                {id: 'miner_cloud', name: 'Cloud –†–∏–≥', emoji: '‚òÅÔ∏è', basePrice: 3500000, baseHashPerHour: 12000, currency: 'coins', description: '–û–±–ª–∞—á–Ω–∞—è —Ñ–µ—Ä–º–∞'},
                {id: 'miner_data', name: 'Data –¶–µ–Ω—Ç—Ä', emoji: 'üè¢', basePrice: 12000000, baseHashPerHour: 50000, currency: 'coins', description: '–î–∞—Ç–∞-—Ü–µ–Ω—Ç—Ä'},
                {id: 'miner_quantum_farm', name: 'Quantum –§–µ—Ä–º–∞', emoji: 'üåå', basePrice: 40000000, baseHashPerHour: 200000, currency: 'coins', description: '–ö–≤–∞–Ω—Ç–æ–≤–∞—è —Ñ–µ—Ä–º–∞'},
                {id: 'miner_neural', name: 'Neural –ú–∞–π–Ω–µ—Ä', emoji: 'üß†', basePrice: 150000000, baseHashPerHour: 800000, currency: 'coins', description: '–ù–µ–π—Ä–æ—Å–µ—Ç–µ–≤–æ–π –º–∞–π–Ω–µ—Ä'},
                {id: 'miner_cosmic', name: 'Cosmic –°—Ç–∞–Ω—Ü–∏—è', emoji: 'üöÄ', basePrice: 500000000, baseHashPerHour: 3200000, currency: 'coins', description: '–ö–æ—Å–º–∏—á–µ—Å–∫–∞—è —Å—Ç–∞–Ω—Ü–∏—è'}
            ],
            'quanhash': [
                {id: 'hash_quantum_core', name: 'Quantum –Ø–¥—Ä–æ', emoji: '‚öõÔ∏è', basePrice: 10000, baseHashPerHour: 80, currency: 'quanhash', description: '–ö–≤–∞–Ω—Ç–æ–≤–æ–µ —è–¥—Ä–æ'},
                {id: 'hash_plasma_rig', name: 'Plasma –†–∏–≥', emoji: 'üî•', basePrice: 50000, baseHashPerHour: 400, currency: 'quanhash', description: '–ü–ª–∞–∑–º–µ–Ω–Ω—ã–π –º–∞–π–Ω–µ—Ä'},
                {id: 'hash_stellar', name: 'Stellar –ë–ª–æ–∫', emoji: '‚≠ê', basePrice: 250000, baseHashPerHour: 1800, currency: 'quanhash', description: '–ó–≤—ë–∑–¥–Ω—ã–π –±–ª–æ–∫'},
                {id: 'hash_cosmic_flux', name: 'Cosmic –ü–æ—Ç–æ–∫', emoji: 'üåä', basePrice: 1000000, baseHashPerHour: 7000, currency: 'quanhash', description: '–ö–æ—Å–º–∏—á–µ—Å–∫–∏–π –ø–æ—Ç–æ–∫'},
                {id: 'hash_nova', name: 'Nova –£—Å–∫–æ—Ä–∏—Ç–µ–ª—å', emoji: 'üåü', basePrice: 4000000, baseHashPerHour: 28000, currency: 'quanhash', description: '–ù–æ–≤–µ–π—à–∏–π —É—Å–∫–æ—Ä–∏—Ç–µ–ª—å'},
                {id: 'hash_galaxy', name: 'Galaxy –ú–∞—Ç—Ä–∏—Ü–∞', emoji: 'üåå', basePrice: 15000000, baseHashPerHour: 110000, currency: 'quanhash', description: '–ì–∞–ª–∞–∫—Ç–∏—á–µ—Å–∫–∞—è –º–∞—Ç—Ä–∏—Ü–∞'},
                {id: 'hash_void', name: 'Void –ü–æ—Ä—Ç–∞–ª—ã', emoji: 'üï≥Ô∏è', basePrice: 60000000, baseHashPerHour: 450000, currency: 'quanhash', description: '–í—Ä–∞—Ç–∞ –≤ –ø—É—Å—Ç–æ—Ç—É'},
                {id: 'hash_eternal', name: 'Eternal –î–≤–∏–∂–∏—Ç–µ–ª—å', emoji: '‚àû', basePrice: 250000000, baseHashPerHour: 1800000, currency: 'quanhash', description: '–í–µ—á–Ω—ã–π –¥–≤–∏–∂–∏—Ç–µ–ª—å'},
                {id: 'hash_divine', name: 'Divine –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä', emoji: 'üëë', basePrice: 1000000000, baseHashPerHour: 7200000, currency: 'quanhash', description: '–ë–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä'},
                {id: 'hash_absolute', name: 'Absolute –ú–æ—â—å', emoji: '‚ö°', basePrice: 4000000000, baseHashPerHour: 28800000, currency: 'quanhash', description: '–ê–±—Å–æ–ª—é—Ç–Ω–∞—è –º–æ—â—å'}
            ]
        };
        
        function loadMiningCategory(category) {
            // Update button states
            document.querySelectorAll('.mining-cat-btn').forEach(btn => {
                const isCoins = category === 'coins';
                const isActive = btn.textContent.includes(isCoins ? '–∫–æ–∏–Ω—ã' : 'QuanHash');
                if(isActive) {
                    btn.style.background = isCoins ? 'linear-gradient(135deg,rgba(102,126,234,0.25),rgba(118,75,162,0.25))' : 'linear-gradient(135deg,rgba(16,185,129,0.25),rgba(34,197,94,0.25))';
                    btn.style.border = isCoins ? '2px solid #667eea' : '2px solid #10b981';
                } else {
                    btn.style.background = 'rgba(255,255,255,0.05)';
                    btn.style.border = '2px solid rgba(102,126,234,0.2)';
                }
            });
            
            const machines = miningMachinesData[category] || [];
            const shop = document.getElementById('miningShop');
            if(shop) {
                const isCoins = category === 'coins';
                const bgGradient = isCoins ? 'linear-gradient(135deg,rgba(102,126,234,0.2),rgba(118,75,162,0.2))' : 'linear-gradient(135deg,rgba(16,185,129,0.2),rgba(34,197,94,0.2))';
                const borderColor = isCoins ? '#667eea' : '#10b981';
                const buttonGradient = isCoins ? 'linear-gradient(135deg,#667eea,#764ba2)' : 'linear-gradient(135deg,#10b981,#059669)';
                
                // Load user machines and levels from API
                fetch('/api/mining', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({user_id: window.user?.id, category: category})
                })
                .then(res => res.json())
                .then(data => {
                    // Update shop with levels
                    const machine_levels = data.machine_levels || {};
                    shop.innerHTML = machines.map((m, index) => {
                        const level = machine_levels[m.id] || 0;
                        const maxLevel = 50;
                        const isMaxLevel = level >= maxLevel;
                        const price = Math.floor(m.basePrice * Math.pow(1.15, level));
                        const hashPerHour = Math.floor(m.baseHashPerHour * Math.pow(1.15, level));
                        
                        return `
                            <div style="background:${bgGradient};padding:16px;border-radius:16px;border:3px solid ${borderColor};position:relative;box-shadow:0 8px 25px rgba(0,0,0,0.3);transition:all 0.3s;" onmouseover="this.style.transform='translateY(-3px)'; this.style.boxShadow='0 12px 35px rgba(0,0,0,0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 8px 25px rgba(0,0,0,0.3)'">
                                <div style="position:absolute;top:8px;right:8px;background:${borderColor};color:#fff;padding:3px 8px;border-radius:6px;font-size:9px;font-weight:900;box-shadow:0 2px 8px rgba(0,0,0,0.3);">‚ö°</div>
                                <div style="font-size:32px;text-align:center;margin-bottom:8px;filter:drop-shadow(0 4px 8px rgba(0,0,0,0.3));">${m.emoji}</div>
                                <div style="font-weight:900;font-size:13px;color:#fff;text-align:center;margin-bottom:4px;text-shadow:0 2px 4px rgba(0,0,0,0.5);">${m.name}</div>
                                <div style="font-size:9px;color:#94a3b8;text-align:center;margin-bottom:8px;font-weight:600;opacity:0.8;">${m.description || ''}</div>
                                <div style="font-size:10px;color:${isMaxLevel ? '#fbbf24' : '#94a3b8'};text-align:center;margin-bottom:8px;font-weight:600;">–£—Ä–æ–≤–µ–Ω—å ${level}${isMaxLevel ? ' ‚≠ê MAX' : ` / ${maxLevel}`}</div>
                                <div style="font-size:12px;color:#4ade80;font-weight:900;text-align:center;margin-bottom:12px;text-shadow:0 0 10px rgba(74,222,128,0.4);">–î–æ—Ö–æ–¥ +${hashPerHour.toLocaleString()} QuanHash/—á</div>
                                <button onclick="${isMaxLevel ? 'alert(\'‚ú® –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å –¥–æ—Å—Ç–∏–≥–Ω—É—Ç!\')' : `buyMachine('${m.id}', ${price}, '${m.currency}')`}" 
                                        style="width:100%;padding:11px;background:${isMaxLevel ? 'linear-gradient(135deg,#fbbf24,#fcd34d,#fbbf24)' : buttonGradient};color:${isMaxLevel ? '#000' : '#fff'};border:none;border-radius:10px;cursor:${isMaxLevel ? 'not-allowed' : 'pointer'};font-weight:900;font-size:11px;box-shadow:0 4px 15px rgba(0,0,0,0.3);transition:all 0.3s;display:flex;align-items:center;justify-content:center;gap:6px;opacity:${isMaxLevel ? 0.7 : 1};"
                                        onmousedown="${!isMaxLevel ? 'this.style.transform=\'scale(0.96)\'' : ''}" 
                                        onmouseup="${!isMaxLevel ? 'this.style.transform=\'scale(1)\'' : ''}" 
                                        onmouseleave="${!isMaxLevel ? 'this.style.transform=\'scale(1)\'' : ''}">
                                    <span>${isMaxLevel ? '‚ú® –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å' : `–ö—É–ø–∏—Ç—å –∑–∞ ${m.currency === 'coins' ? 'ü™ô' : 'üíé'} ${price.toLocaleString()} ${m.currency === 'coins' ? '–∫–æ–∏–Ω–æ–≤' : 'QuanHash'}`}</span>
                                </button>
                            </div>
                        `;
                    }).join('');
                    
                    const machinesList = document.getElementById('machinesList');
                    console.log('machinesList element:', machinesList, 'user_machines:', data.user_machines, 'length:', data.user_machines?.length);
                    if(machinesList && data.user_machines) {
                        console.log('user_machines array:', data.user_machines);
                        if(data.user_machines.length > 0) {
                            machinesList.innerHTML = data.user_machines.map(m => {
                                const count = m.count || 1;
                                const incomePerHour = m.income_per_hour || 0;
                                const totalIncome = m.total_income || (incomePerHour * count);
                                
                                return `
                                <div style="background:rgba(102,126,234,0.15);padding:12px;border-radius:12px;border:2px solid rgba(102,126,234,0.3);margin-bottom:10px;animation:slideIn 0.3s ease-out;box-shadow:0 4px 12px rgba(102,126,234,0.2);">
                                    <div style="display:flex;justify-content:space-between;align-items:center;">
                                        <div style="flex:1;">
                                            <div style="font-weight:900;font-size:14px;margin-bottom:4px;color:#fff;">${m.name} ${count > 1 ? `<span style="background:rgba(102,126,234,0.6);padding:2px 6px;border-radius:4px;font-size:10px;">x${count}</span>` : ''}</div>
                                            <div style="font-size:11px;color:#94a3b8;">–£—Ä–æ–≤–µ–Ω—å ${m.level} | ${(m.hash_rate || 0).toFixed(6)} Hash/s</div>
                                            <div style="font-size:12px;color:#4ade80;margin-top:4px;font-weight:700;">–î–æ—Ö–æ–¥ +${Math.floor(totalIncome).toLocaleString()} QuanHash/—á–∞—Å</div>
                                        </div>
                                        <div style="text-align:right;">
                                            <div style="font-size:28px;filter:drop-shadow(0 4px 8px rgba(102,126,234,0.5));">‚ö°</div>
                                        </div>
                                    </div>
                                </div>
                            `;
                            }).join('');
                        } else {
                            machinesList.innerHTML = '<p style="text-align:center;opacity:0.7;padding:15px;background:rgba(255,255,255,0.05);border-radius:12px;border:2px solid rgba(255,255,255,0.1);">üõí –£ –≤–∞—Å –Ω–µ—Ç –º–∞—à–∏–Ω. –ö—É–ø–∏—Ç–µ –∏—Ö –≤—ã—à–µ!</p>';
                        }
                    }
                })
                .catch(err => {
                    const machinesList = document.getElementById('machinesList');
                    if(machinesList) {
                        machinesList.innerHTML = '<p style="text-align:center;opacity:0.7;padding:15px;background:rgba(255,255,255,0.05);border-radius:12px;border:2px solid rgba(255,255,255,0.1);">üõí –£ –≤–∞—Å –Ω–µ—Ç –º–∞—à–∏–Ω. –ö—É–ø–∏—Ç–µ –∏—Ö –≤—ã—à–µ!</p>';
                    }
                });
            }
        }
        
        window.openVIPMiningModal = function() {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.style.zIndex = '10001';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 480px; max-height: 80vh; overflow-y: auto; background: linear-gradient(135deg, rgba(0,0,0,0.95), rgba(20,20,30,0.98)); border-radius: 24px; border: 2px solid rgba(255,215,0,0.7); box-shadow: 0 20px 60px rgba(255,215,0,0.3), 0 0 0 1px rgba(255,255,255,0.1); backdrop-filter: blur(20px);">
                    <div style="background: linear-gradient(135deg, #ffd700, #ffed4e, #ffd700); padding: 20px 50px 20px 20px; border-radius: 22px 22px 0 0; text-align: center; position: relative; box-shadow: 0 8px 30px rgba(255,215,0,0.4);">
                        <div style="display: flex; align-items: center; justify-content: center; gap: 12px;">
                            <div style="font-size: 36px; text-shadow: 0 3px 10px rgba(0,0,0,0.3); filter: drop-shadow(0 0 6px rgba(255,215,0,0.8)); animation: pulse 2s infinite;">‚≠ê</div>
                            <div>
                                <h2 style="font-size: 24px; color: #000; margin: 0; font-weight: 900; text-shadow: 0 2px 6px rgba(0,0,0,0.2);">VIP –ú–ê–®–ò–ù–´</h2>
                                <div style="font-size: 14px; color: rgba(0,0,0,0.7); margin-top: 4px; font-weight: 600;">–≠–∫—Å–∫–ª—é–∑–∏–≤–Ω–∞—è –¥–æ–±—ã—á–∞ QuanHash</div>
                            </div>
                        </div>
                        <button class="close-btn" onclick="this.closest('.modal').remove()">‚úï</button>
                    </div>
                    
                    <div style="padding: 20px;">
                        <div id="vipMiningContent" style="display:grid;gap:12px;"></div>
                        
                        <!-- VIP —Å—Ç–∏–ª—å–Ω–∞—è –∫–Ω–æ–ø–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è -->
                        <button class="vip-close-btn" onclick="this.closest('.modal').remove()" style="margin-top:20px;">
                            üëë –ó–∞–∫—Ä—ã—Ç—å VIP —Ñ—É–Ω–∫—Ü–∏–∏
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Load VIP levels from API
            fetch('/api/mining', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({user_id: user?.id, category: 'vip'})
            })
            .then(res => res.json())
            .then(data => {
                const vip_levels = data.machine_levels || {};
                renderVIPMiningCards(vip_levels);
            })
            .catch(err => {
                console.error('Failed to load VIP levels:', err);
                renderVIPMiningCards({});
            });
        };
        
        function renderVIPMiningCards(vip_levels) {
            const vipMiningContent = document.getElementById('vipMiningContent');
            if (!vipMiningContent) return;
            
            let html = vipMiningCards.map((card, index) => {
                const level = vip_levels[card.id] || 0;
                const maxLevel = 50;
                const isMaxLevel = level >= maxLevel;
                const price = Math.floor(card.basePrice * Math.pow(1.15, level));
                const hashPerHour = Math.floor(card.baseHashPerHour * Math.pow(1.15, level));
                
                return `
                    <div style="background: linear-gradient(135deg, rgba(255,215,0,0.12), rgba(255,237,78,0.18)); padding: 16px; border-radius: 16px; border: 1px solid rgba(255,215,0,0.3); position: relative; backdrop-filter: blur(8px); box-shadow: 0 6px 20px rgba(255,215,0,0.15); transition: all 0.3s ease; overflow: hidden; background-size: 200% 200%; animation: shimmer 3s ease-in-out infinite;" onmouseover="this.style.transform='translateY(-3px) scale(1.02)';this.style.boxShadow='0 10px 30px rgba(255,215,0,0.25)';this.style.background='linear-gradient(135deg, rgba(255,215,0,0.2), rgba(255,237,78,0.25))'" onmouseout="this.style.transform='translateY(0) scale(1)';this.style.boxShadow='0 6px 20px rgba(255,215,0,0.15)';this.style.background='linear-gradient(135deg, rgba(255,215,0,0.12), rgba(255,237,78,0.18))'">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 6px;">
                            <span style="font-size: 20px; filter: drop-shadow(0 0 4px rgba(255,215,0,0.6));">${card.emoji}</span>
                            <div style="flex: 1;">
                                <div style="font-weight: 800; font-size: 14px; color: #fff; text-shadow: 0 1px 3px rgba(0,0,0,0.3);">${card.name}</div>
                                <div style="font-size: 11px; color: rgba(255,255,255,0.8); margin-top: 2px;">${card.description || ''}</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #ffd700, #ffed4e, #ffd700); color: #000; padding: 4px 8px; border-radius: 8px; font-size: 11px; font-weight: 900; text-shadow: 0 1px 3px rgba(0,0,0,0.3); border: 1px solid #ffd700; box-shadow: 0 3px 8px rgba(255,215,0,0.4); position: relative; overflow: hidden;">
                                <div style="position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent); animation: shimmer 2s infinite;"></div>
                                <span style="font-size: 12px; font-weight: 900; text-shadow: 0 1px 2px rgba(0,0,0,0.4);">VIP</span>
                            </div>
                        </div>
                        ${isMaxLevel ? '' : `
                            <div style="background: rgba(74,222,128,0.2); padding: 8px; border-radius: 8px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;">
                                <span style="color: #4ade80; font-size: 12px; font-weight: 700;">‚ö° –î–æ—Ö–æ–¥:</span>
                                <span style="color: #fff; font-size: 12px; font-weight: 800;">+${hashPerHour.toLocaleString()} QuanHash/—á</span>
                            </div>
                            <div style="background: rgba(234,179,8,0.2); padding: 8px; border-radius: 8px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;">
                                <span style="color: #fbbf24; font-size: 12px; font-weight: 700;">üìä –£—Ä–æ–≤–µ–Ω—å:</span>
                                <span style="color: #fff; font-size: 12px; font-weight: 800;">${level} / ${maxLevel}</span>
                            </div>
                        `}
                        
                        <button onclick="${isMaxLevel ? 'alert(\'‚ú® –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å –¥–æ—Å—Ç–∏–≥–Ω—É—Ç!\')' : `buyVIPMiningMachineWithStars('${card.id}', ${price}, ${card.productId})`}" 
                                style="width: 100%; padding: 10px 12px; background: ${isMaxLevel ? 'linear-gradient(135deg,#fbbf24,#fcd34d,#fbbf24)' : 'linear-gradient(135deg, #ffd700, #ffed4e, #ffd700)'}; color: ${isMaxLevel ? '#000' : '#000'}; border: 1px solid #ffd700; border-radius: 10px; cursor: ${isMaxLevel ? 'not-allowed' : 'pointer'}; font-weight: 800; font-size: 13px; transition: all 0.3s; position: relative; overflow: hidden; box-shadow: 0 4px 12px rgba(255,215,0,0.3); text-shadow: 0 1px 2px rgba(0,0,0,0.2); display: flex; align-items: center; justify-content: center; gap: 6px;"
                                onmousedown="${!isMaxLevel ? 'this.style.transform=\'scale(0.98)\'; this.style.boxShadow=\'0 6px 16px rgba(255,215,0,0.4)\'' : ''}"
                                onmouseup="${!isMaxLevel ? 'this.style.transform=\'scale(1)\'; this.style.boxShadow=\'0 4px 12px rgba(255,215,0,0.3)\'' : ''}"
                                onmouseleave="${!isMaxLevel ? 'this.style.transform=\'scale(1)\'; this.style.boxShadow=\'0 4px 12px rgba(255,215,0,0.3)\'' : ''}">
                            <span>${isMaxLevel ? '‚ú® –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å' : `–ö—É–ø–∏—Ç—å –∑–∞ ${price}`}</span>
                            <span style="font-size: 16px; filter: drop-shadow(0 0 3px rgba(255,215,0,0.8)); text-shadow: 0 1px 2px rgba(0,0,0,0.3);">${isMaxLevel ? '' : '‚≠ê'}</span>
                            ${isMaxLevel ? '' : '<span>Telegram Stars</span>'}
                        </button>
                    </div>
                `;
            }).join('');
            
            vipMiningContent.innerHTML = html;
        };
        
        window.buyVIPMiningMachineWithStars = function(machineId, price, productId) {
            // Open Telegram payment
            const paymentUrl = `https://t.me/qanexus_bot?start=buy_stars_${productId}`;
            window.open(paymentUrl, '_blank');
            
            // Show beautiful VIP confirmation message
            const anim = document.createElement('div');
            anim.style.cssText = 'position:fixed;top:20%;left:50%;transform:translate(-50%,-50%);z-index:10000;pointer-events:none;';
            anim.innerHTML = '<div style="background:linear-gradient(135deg,rgba(255,215,0,0.95),rgba(255,237,78,0.95));padding:25px 50px;border-radius:25px;font-size:26px;box-shadow:0 15px 50px rgba(255,215,0,0.7);color:#000;font-weight:800;display:flex;align-items:center;gap:20px;border:3px solid rgba(255,215,0,0.8);"><span style="font-size:40px;">‚≠ê</span><div><div style="font-size:28px;margin-bottom:8px;">VIP –ü–æ–∫—É–ø–∫–∞</div><div style="font-size:20px;opacity:0.8;">–û—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –æ–ø–ª–∞—Ç–∞ –∑–∞ ' + price + ' ‚≠ê Telegram Stars</div></div></div>';
            document.body.appendChild(anim);
            setTimeout(() => {
                anim.style.opacity = '0';
                anim.style.transform = 'translate(-50%,-70%)';
                setTimeout(() => {anim.remove();}, 300);
            }, 2000);
        };
        
        function buyMachine(id, price, currency) {
            console.log('buyMachine called:', {id, price, currency, user_id: window.user?.id});
            
            // Play sound for mining purchase
            const soundEnabled = localStorage.getItem('soundEnabled') === 'true';
            if (soundEnabled) {
                playSound('mining');
            }
            
            // Haptic feedback
            const hapticsEnabled = localStorage.getItem('hapticsEnabled') === 'true';
            if (hapticsEnabled && tg?.HapticFeedback) {
                tg.HapticFeedback.impactOccurred('medium');
            }
            
            const anim = document.createElement('div');
            anim.style.cssText='position:fixed;top:15%;left:50%;transform:translate(-50%,-50%);z-index:10000;pointer-events:none;';
            anim.innerHTML='<div style="background:linear-gradient(135deg,rgba(102,126,234,0.95),rgba(118,75,162,0.95));padding:8px 16px;border-radius:20px;font-size:14px;box-shadow:0 4px 15px rgba(102,126,234,0.5);color:#fff;font-weight:700;display:flex;align-items:center;gap:6px;border:1px solid rgba(255,255,255,0.2);"><span style="font-size:16px;">‚ö°</span> –ü–æ–∫—É–ø–∫–∞...</div>';
            document.body.appendChild(anim);
            setTimeout(()=>{anim.style.opacity='1';},10);
            
            fetch('/api/buy_machine', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                    user_id: window.user?.id,
                    machine_id: id,
                    price: price,
                    currency: currency
                })
            })
            .then(res => res.json())
            .then(data => {
                console.log('buyMachine response:', data);
                if(data.success) {
                    // Success sound and haptics
                    if (soundEnabled) playSound('levelup');
                    if (hapticsEnabled && tg?.HapticFeedback) {
                        tg.HapticFeedback.notificationOccurred('success');
                    }
                    
                    // Success notification - like in shop
                    anim.innerHTML='<div style="background:linear-gradient(135deg,rgba(34,197,94,0.95),rgba(16,185,129,0.95));padding:8px 16px;border-radius:20px;font-size:14px;box-shadow:0 4px 15px rgba(16,185,129,0.5);color:#fff;font-weight:700;display:flex;align-items:center;gap:6px;border:1px solid rgba(255,255,255,0.2);"><span style="font-size:16px;">‚ú®</span> –ú–∞—à–∏–Ω–∞ —É–ª—É—á—à–µ–Ω–∞!</div>';
                    setTimeout(()=>{
                        anim.style.opacity='0';anim.style.transform='translate(-50%,-60%)';
                        setTimeout(()=>{anim.remove();},300);
                    },800);
                    // Reload current category - find active button by checking computed styles
                    let currentCat = 'coins';
                    document.querySelectorAll('.mining-cat-btn').forEach(btn => {
                        const bg = btn.style.background;
                        if(bg.includes('0.25') || bg.includes('linear-gradient')) {
                            if(btn.textContent.includes('–∫–æ–∏–Ω—ã') || btn.textContent.includes('Coins')) currentCat = 'coins';
                            else if(btn.textContent.includes('QuanHash')) currentCat = 'quanhash';
                        }
                    });
                    console.log('Reloading category:', currentCat);
                    loadMiningCategory(currentCat);
                    loadData();
                } else {
                    // Error sound
                    if (soundEnabled) playSound('error');
                    
                    // Error notification - like in shop
                    const errorText = data.error.includes('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ') || data.error.includes('Not enough') ? '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ ' + (currency === 'coins' ? '–∫–æ–∏–Ω–æ–≤' : 'QuanHash') : data.error;
                    anim.innerHTML='<div style="background:linear-gradient(135deg,rgba(239,68,68,0.95),rgba(220,38,38,0.95));padding:8px 16px;border-radius:20px;font-size:14px;box-shadow:0 4px 15px rgba(239,68,68,0.5);color:#fff;font-weight:700;display:flex;align-items:center;gap:6px;border:1px solid rgba(255,255,255,0.2);"><span style="font-size:16px;">üí∞</span> ' + errorText + '</div>';
                    setTimeout(()=>{
                        anim.style.opacity='0';anim.style.transform='translate(-50%,-60%)';
                        setTimeout(()=>{anim.remove();},300);
                    },1500);
                }
            });
        }

        function openCards(e) {
            e.preventDefault();
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.id = 'cardsModal2';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 420px; max-height: 85vh; overflow-y: auto;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                        <h2 style="font-size: 24px; color: #fff; font-weight: 800;">üí≥ –ö—Ä–∏–ø—Ç–æ-–ö–∞—Ä—Ç–æ—á–∫–∏</h2>
                        <button class="close-btn" onclick="this.closest('.modal').remove()">‚úï</button>
                    </div>
                    
                    <div style="background:linear-gradient(135deg,rgba(102,126,234,0.15),rgba(118,75,162,0.15));padding:15px;border-radius:15px;margin-bottom:20px;border:2px solid rgba(102,126,234,0.3);">
                        <div style="font-size:13px;color:#94a3b8;line-height:1.6;">
                            <strong style="color:#fff;">üìã –ü–∞—Å—Å–∏–≤–Ω—ã–π –¥–æ—Ö–æ–¥ 24/7:</strong> –ö—Ä–∏–ø—Ç–æ-–∫–∞—Ä—Ç–æ—á–∫–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç –∫–æ–∏–Ω—ã –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É! –†–∞–∑–Ω—ã–µ —Ä–µ–¥–∫–æ—Å—Ç–∏ = —Ä–∞–∑–Ω—ã–π –¥–æ—Ö–æ–¥. –ó–∞—Ä–∞–±–∞—Ç—ã–≤–∞–π—Ç–µ –¥–∞–∂–µ –æ—Ñ—Ñ–ª–∞–π–Ω!
                        </div>
                    </div>
                    
                    <div id="cardsShopSection" style="margin-bottom:25px;">
                        <div style="font-size:16px;font-weight:700;color:#fff;margin-bottom:15px;display:flex;align-items:center;gap:8px;grid-column:1/-1;">
                            <span style="background:linear-gradient(135deg,#667eea,#764ba2);padding:6px 12px;border-radius:8px;width:100%;text-align:center;">üõí –ú–∞–≥–∞–∑–∏–Ω –∫–∞—Ä—Ç–æ—á–µ–∫</span>
                        </div>
                        <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-bottom:15px;">
                            <button class="filter-btn shop-cat-btn" data-category="per_hour" onclick="loadCardsCategory('per_hour')" style="padding:10px;background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border:none;border-radius:10px;cursor:pointer;font-weight:600;font-size:12px;">‚ö° –í —á–∞—Å (–û—Å–Ω–æ–≤–Ω—ã–µ)</button>
                            <button class="filter-btn shop-cat-btn" data-category="per_minute" onclick="loadCardsCategory('per_minute')" style="padding:10px;background:rgba(255,255,255,0.1);color:#fff;border:1px solid rgba(255,255,255,0.3);border-radius:10px;cursor:pointer;font-weight:600;font-size:12px;">üíé –í –º–∏–Ω—É—Ç—É (–ü—Ä–µ–º–∏—É–º)</button>
                        </div>
                        <div style="margin-bottom:15px;">
                            <div style="padding:6px;background:linear-gradient(135deg,rgba(255,215,0,0.2),rgba(255,237,78,0.2),rgba(255,215,0,0.2));border:2px solid rgba(255,215,0,0.7);border-radius:12px;position:relative;box-shadow:0 4px 15px rgba(255,215,0,0.3);">
                                <button onclick="openVIPCardsModal()" style="width:100%;padding:8px 12px;background:linear-gradient(135deg,#ffd700,#ffed4e,#ffd700);color:#000;border:2px solid #ffd700;border-radius:8px;cursor:pointer;font-weight:800;font-size:14px;transition:all 0.3s;box-shadow:0 3px 10px rgba(255,215,0,0.4);position:relative;display:flex;align-items:center;justify-content:center;" onmousedown="this.style.transform='scale(0.97)'" onmouseup="this.style.transform='scale(1)'" onmouseleave="this.style.transform='scale(1)'">
                                    <span style="font-size:18px;margin-right:8px;text-shadow:0 2px 4px rgba(0,0,0,0.3);filter:drop-shadow(0 0 3px rgba(255,215,0,0.8));">‚≠ê</span>
                                    <span style="flex:1;text-align:center;">–ö—É–ø–∏—Ç—å VIP —Ñ—É–Ω–∫—Ü–∏–∏ –∑–∞ Telegram Stars</span>
                                    <div style="background:linear-gradient(135deg,#000,#333);color:#fff;padding:2px 6px;border-radius:4px;font-size:10px;font-weight:900;margin-left:8px;">VIP</div>
                                </button>
                            </div>
                        </div>
                        <div id="shopCardsList" style="display:grid;grid-template-columns:repeat(2,1fr);gap:12px;"></div>
                        <div id="vipCardsSection" style="display:none;grid-template-columns:repeat(2,1fr);gap:12px;margin-top:20px;"></div>
                    </div>
                    
                    <div id="passiveInfo" style="background:linear-gradient(135deg,rgba(16,185,129,0.2),rgba(34,197,94,0.2));padding:20px;border-radius:15px;border:2px solid rgba(16,185,129,0.4);text-align:center;margin-top:20px;margin-bottom:15px;">
                        <div style="font-size:14px;font-weight:700;margin-bottom:10px;color:#10b981;">üí∞ –û–±—â–∏–π –ø–∞—Å—Å–∏–≤–Ω—ã–π –¥–æ—Ö–æ–¥</div>
                        <div style="font-size:36px;font-weight:900;color:#10b981;text-shadow:0 0 20px rgba(16,185,129,0.5);">+0 ü™ô/—á–∞—Å</div>
                    </div>
                    
                    <button onclick="this.closest('.modal').remove()" style="width:100%;padding:14px;background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border:none;border-radius:12px;cursor:pointer;font-weight:700;font-size:16px;">–ó–∞–∫—Ä—ã—Ç—å</button>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Load cards function
            window.loadCardsCategory = function(category) {
                // Handle VIP cards section display
                const shopCardsList = document.getElementById('shopCardsList');
                const vipCardsSection = document.getElementById('vipCardsSection');
                
                shopCardsList.style.display = 'grid';
                if (vipCardsSection) vipCardsSection.style.display = 'none';
                
                document.querySelectorAll('#cardsShopSection .shop-cat-btn').forEach(btn => {
                    if(btn.textContent.toLowerCase().includes(category === 'per_hour' ? '—á–∞—Å' : '–º–∏–Ω—É—Ç—É')) {
                        btn.style.background = 'linear-gradient(135deg,#667eea,#764ba2)';
                        btn.style.border = 'none';
                    } else {
                        btn.style.background = 'rgba(255,255,255,0.1)';
                        btn.style.border = '1px solid rgba(255,255,255,0.3)';
                    }
                });
                loadCardsList(category);
            };
            
            window.buyVIPCard = function(cardType) {
                fetch('/api/buy_vip_card', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        user_id: user?.id,
                        card_type: cardType
                    })
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        tg.showAlert('‚úÖ VIP –∫–∞—Ä—Ç–æ—á–∫–∞ –∫—É–ø–ª–µ–Ω–∞!');
                        loadData();
                    } else {
                        tg.showAlert('‚ùå ' + data.error);
                    }
                })
                .catch(err => tg.showAlert('‚ùå –û—à–∏–±–∫–∞ –ø–æ–∫—É–ø–∫–∏'));
            };
            
            window.buyVIPCardWithStars = function(cardRarity, price, productId) {
                // Open Telegram payment (same as in VIP shop)
                const paymentUrl = `https://t.me/qanexus_bot?start=buy_stars_${productId}`;
                window.open(paymentUrl, '_blank');
                
                // Show beautiful VIP confirmation message
                const anim = document.createElement('div');
                anim.style.cssText = 'position:fixed;top:20%;left:50%;transform:translate(-50%,-50%);z-index:10000;pointer-events:none;';
                anim.innerHTML = '<div style="background:linear-gradient(135deg,rgba(255,215,0,0.95),rgba(255,237,78,0.95));padding:25px 50px;border-radius:25px;font-size:26px;box-shadow:0 15px 50px rgba(255,215,0,0.7);color:#000;font-weight:800;display:flex;align-items:center;gap:20px;border:3px solid rgba(255,215,0,0.8);"><span style="font-size:40px;">‚≠ê</span><div><div style="font-size:28px;margin-bottom:8px;">VIP –ü–æ–∫—É–ø–∫–∞</div><div style="font-size:20px;opacity:0.8;">–û—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –æ–ø–ª–∞—Ç–∞ –∑–∞ ' + price + ' ‚≠ê Telegram Stars</div></div></div>';
                document.body.appendChild(anim);
                setTimeout(() => {
                    anim.style.opacity = '0';
                    anim.style.transform = 'translate(-50%,-70%)';
                    setTimeout(() => {anim.remove();}, 300);
                }, 2000);
            };
            
            function loadCardsList(category) {
                fetch('/api/shop', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({user_id: user?.id, category: 'cards'})
                })
                .then(res => res.json())
                .then(shopData => {
                    console.log('Cards shop data:', shopData);
                    // Store cards data globally for buyShopItem function
                    if (!window.shopData) {
                        window.shopData = {};
                    }
                    window.shopData.items = shopData.items || [];
                    
                    const shopList = document.getElementById('shopCardsList');
                    const cards = shopData.items.filter(item => item.type === 'card' && (category === 'all' || item.income_type === category));
                    console.log('Filtered cards:', cards, 'category:', category);
                    console.log('Updating shopList for category:', category);
                    console.log('Cards data sample:', cards.slice(0, 2).map(c => ({
                        id: c.id,
                        name: c.name,
                        level: c.level,
                        price: c.price,
                        income: c.income,
                        income_per_min: c.income_per_min,
                        income_type: c.income_type
                    })));
                    console.log('All cards for category', category, ':', cards.map(c => ({
                        id: c.id,
                        level: c.level,
                        price: c.price,
                        income_per_min: c.income_per_min
                    })));
                    if(cards && cards.length > 0) {
                        shopList.innerHTML = cards.map((card, i) => {
                        // Skip locked cards
                        // Remove locking - all cards are available
                        const rarity = card.rarity || 'common';
                        const rarityInfo = {
                            'common': {emoji:'‚ö™', name:'–û–±—ã—á–Ω–∞—è', color:'rgba(255,255,255,0.15)', border:'rgba(255,255,255,0.4)'},
                            'rare': {emoji:'üîµ', name:'–†–µ–¥–∫–∞—è', color:'rgba(102,126,234,0.25)', border:'rgba(102,126,234,0.8)'},
                            'epic': {emoji:'üü£', name:'–≠–ø–∏—á–µ—Å–∫–∞—è', color:'rgba(118,75,162,0.25)', border:'rgba(118,75,162,0.8)'},
                            'legendary': {emoji:'üü°', name:'–õ–µ–≥–µ–Ω–¥–∞—Ä–Ω–∞—è', color:'rgba(234,179,8,0.25)', border:'rgba(234,179,8,0.8)'}
                        };
                        const info = rarityInfo[rarity];
                        const income = card.income_type === 'per_minute' ? (card.income_per_min || 0) : (card.income || 0);
                        const incomeType = card.income_type === 'per_minute' ? '/–º–∏–Ω' : '/—á–∞—Å';
                        const level = card.level || 1;
                        const nameParts = card.name || '–ö–∞—Ä—Ç–æ—á–∫–∞';
                        const cardEmoji = nameParts.match(/[\u{1F600}-\u{1F9FF}]/u)?.[0] || 'üí≥';
                        const cardName = nameParts.replace(/[\u{1F600}-\u{1F9FF}]/u, '').trim();
                        return `
                            <div style="background:${info.color};padding:12px;border-radius:12px;border:2px solid ${info.border};">
                                <div style="font-size:24px;text-align:center;margin-bottom:6px;">${cardEmoji}</div>
                                <div style="font-size:10px;font-weight:700;color:#fff;text-align:center;margin-bottom:6px;">${cardName}</div>
                                <div style="font-size:11px;color:#94a3b8;text-align:center;margin-bottom:6px;">${card.description}</div>
                                <div style="font-size:12px;color:#10b981;text-align:center;margin-bottom:6px;font-weight:700;">+${income.toFixed(1)} ü™ô${incomeType}</div>
                                <div style="font-size:9px;color:#fbbf24;text-align:center;margin-bottom:8px;font-weight:600;">Lv.${level} ${info.name}</div>
                                <button onclick="buyShopItem('card', ${card.level || 1}, ${card.price || 0}, '${card.id}')" style="width:100%;padding:8px;background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border:none;border-radius:8px;cursor:pointer;font-weight:700;font-size:11px;">
                                    ü™ô ${(card.price || 0).toLocaleString()}
                                </button>
                            </div>
                        `;
                    }).join('');
                    } else {
                        shopList.innerHTML = '<div style="grid-column:span 2;text-align:center;padding:20px;color:#94a3b8;background:rgba(255,255,255,0.05);border-radius:12px;">–ö–∞—Ä—Ç–æ—á–∫–∏ –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã</div>';
                    }
                });
            }
            
            // Load per_hour cards by default
            loadCardsList('per_hour');
            
            // Update passive income immediately
            updatePassiveIncome();
        }
        
        // VIP Cards Modal - defined globally
        window.openVIPCardsModal = function() {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.style.zIndex = '10000';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 480px; max-height: 80vh; overflow-y: auto; background: linear-gradient(135deg, rgba(0,0,0,0.95), rgba(20,20,30,0.98)); border-radius: 24px; border: 2px solid rgba(255,215,0,0.7); box-shadow: 0 20px 60px rgba(255,215,0,0.3), 0 0 0 1px rgba(255,255,255,0.1); backdrop-filter: blur(20px);">
                    <div style="background: linear-gradient(135deg, #ffd700, #ffed4e, #ffd700); padding: 20px 50px 20px 20px; border-radius: 22px 22px 0 0; text-align: center; position: relative; box-shadow: 0 8px 30px rgba(255,215,0,0.4);">
                        <div style="display: flex; align-items: center; justify-content: center; gap: 12px;">
                            <div style="font-size: 36px; text-shadow: 0 3px 10px rgba(0,0,0,0.3); filter: drop-shadow(0 0 6px rgba(255,215,0,0.8)); animation: pulse 2s infinite;">‚≠ê</div>
                            <div>
                                <h2 style="font-size: 24px; color: #000; margin: 0; font-weight: 900; text-shadow: 0 2px 6px rgba(0,0,0,0.2);">VIP –ö–ê–†–¢–û–ß–ö–ò</h2>
                                <div style="font-size: 14px; color: rgba(0,0,0,0.7); margin-top: 4px; font-weight: 600;">–≠–∫—Å–∫–ª—é–∑–∏–≤–Ω—ã–π –ø–∞—Å—Å–∏–≤–Ω—ã–π –¥–æ—Ö–æ–¥</div>
                            </div>
                        </div>
                        <button class="close-btn" onclick="this.closest('.modal').remove()">‚úï</button>
                    </div>
                    
                    <div style="padding: 20px;">
                        <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-bottom:15px;">
                            <button id="vipCardsBtnHour" onclick="loadVIPCardsCategory('per_hour')" style="padding:10px;background:linear-gradient(135deg,rgba(255,215,0,0.15),rgba(255,237,78,0.15));color:#fff;border:2px solid #ffd700;border-radius:10px;cursor:pointer;font-weight:600;font-size:12px;transition:all 0.3s;">
                                ‚ö° –í —á–∞—Å
                            </button>
                            <button id="vipCardsBtnMin" onclick="loadVIPCardsCategory('per_minute')" style="padding:10px;background:rgba(255,255,255,0.05);color:#fff;border:2px solid rgba(167,139,250,0.3);border-radius:10px;cursor:pointer;font-weight:600;font-size:12px;transition:all 0.3s;">
                                üíé –í –º–∏–Ω—É—Ç—É
                            </button>
                        </div>
                        
                        <div id="vipCardsContent" style="display:grid;gap:12px;"></div>
                        
                        <!-- VIP —Å—Ç–∏–ª—å–Ω–∞—è –∫–Ω–æ–ø–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è -->
                        <button class="vip-close-btn" onclick="this.closest('.modal').remove()" style="margin-top:20px;">
                            üëë –ó–∞–∫—Ä—ã—Ç—å VIP —Ñ—É–Ω–∫—Ü–∏–∏
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            loadVIPCardsCategory('per_hour');
            
            // Update passive income after modal is opened
            setTimeout(() => {
                if (typeof updatePassiveIncome === 'function') {
                    updatePassiveIncome();
                }
            }, 100);
        };
        
        window.loadVIPCardsCategory = function(category) {
            document.getElementById('vipCardsBtnHour').style.background = category === 'per_hour' ? 'linear-gradient(135deg,rgba(255,215,0,0.15),rgba(255,237,78,0.15))' : 'rgba(255,255,255,0.05)';
            document.getElementById('vipCardsBtnHour').style.border = category === 'per_hour' ? '2px solid #ffd700' : '2px solid rgba(167,139,250,0.3)';
            document.getElementById('vipCardsBtnMin').style.background = category === 'per_minute' ? 'linear-gradient(135deg,rgba(139,92,246,0.15),rgba(167,139,250,0.15))' : 'rgba(255,255,255,0.05)';
            document.getElementById('vipCardsBtnMin').style.border = category === 'per_minute' ? '2px solid #8b5cf6' : '2px solid rgba(167,139,250,0.3)';
            window.showVIPCardsList(category);
        };
        
        window.showVIPCardsList = function(category = 'per_hour') {
            const vipCardsContent = document.getElementById('vipCardsContent');
            const vipCardsSection = document.getElementById('vipCardsSection');
            const targetElement = vipCardsContent || vipCardsSection;
            if (!targetElement) return;
            
            // VIP Card definitions - –î–æ—Ö–æ–¥ –æ—Ç 300 –¥–æ 20000 –≤ —á–∞—Å, –æ—Ç 15 –¥–æ 1000 –≤ –º–∏–Ω—É—Ç—É
            // Using product IDs 101-116 to avoid conflict with Buy Currency (51-60)
            const vipCardsPerHour = [
                {name: 'VIP Silver', emoji: '‚≠ê', basePrice: 100, baseIncome: 300, rarity: 'vip_silver', productId: 101},
                {name: 'VIP Gold', emoji: 'üíé', basePrice: 250, baseIncome: 800, rarity: 'vip_gold', productId: 102},
                {name: 'VIP Platinum', emoji: 'üëë', basePrice: 500, baseIncome: 1800, rarity: 'vip_platinum', productId: 103},
                {name: 'VIP Diamond', emoji: 'üíç', basePrice: 1000, baseIncome: 4000, rarity: 'vip_diamond', productId: 104},
                {name: 'VIP Elite', emoji: 'üåü', basePrice: 2500, baseIncome: 9000, rarity: 'vip_elite', productId: 105},
                {name: 'VIP Ultimate', emoji: '‚ö°', basePrice: 5000, baseIncome: 20000, rarity: 'vip_ultimate', productId: 106}
            ];
            
            const vipCardsPerMinute = [
                {name: 'VIP Nova', emoji: '‚ú®', basePrice: 500, baseIncome: 15, rarity: 'vip_nova', productId: 111},
                {name: 'VIP Quantum', emoji: '‚ö°', basePrice: 1250, baseIncome: 50, rarity: 'vip_quantum', productId: 112},
                {name: 'VIP Cosmic', emoji: 'üî•', basePrice: 2500, baseIncome: 150, rarity: 'vip_cosmic', productId: 113},
                {name: 'VIP Stellar', emoji: 'üéÜ', basePrice: 5000, baseIncome: 350, rarity: 'vip_stellar', productId: 114},
                {name: 'VIP Galaxy', emoji: 'üåå', basePrice: 10000, baseIncome: 600, rarity: 'vip_galaxy', productId: 115},
                {name: 'VIP Infinity', emoji: 'üå†', basePrice: 20000, baseIncome: 1000, rarity: 'vip_infinity', productId: 116}
            ];
            
            const cards = category === 'per_hour' ? vipCardsPerHour : vipCardsPerMinute;
            let html = '';
            
            cards.forEach((card, index) => {
                const level = 1;
                const price = category === 'per_hour' 
                    ? Math.floor(card.basePrice * Math.pow(1.2, level - 1))
                    : Math.floor(card.basePrice * Math.pow(1.3, level - 1));
                const income = category === 'per_hour'
                    ? Math.floor(card.baseIncome * Math.pow(1.15, level - 1))
                    : Math.floor(card.baseIncome * Math.pow(1.2, level - 1));
                const incomeText = category === 'per_hour' ? `+${income.toLocaleString()} ü™ô/—á–∞—Å` : `+${income.toLocaleString()} ü™ô/–º–∏–Ω`;
                const isHour = category === 'per_hour';
                const borderColor = isHour ? '#ffd700' : '#8b5cf6';
                const bgGradient = isHour ? 'linear-gradient(135deg,rgba(255,215,0,0.25),rgba(255,237,78,0.25))' : 'linear-gradient(135deg,rgba(139,92,246,0.25),rgba(167,139,250,0.25))';
                const badgeBg = isHour ? '#ffd700' : '#8b5cf6';
                const badgeColor = isHour ? '#000' : '#fff';
                const buttonGradient = isHour ? 'linear-gradient(135deg,#ffd700,#ffed4e,#ffd700)' : 'linear-gradient(135deg,#8b5cf6,#a78bfa,#8b5cf6)';
                const buttonColor = isHour ? '#000' : '#fff';
                const incomeColor = isHour ? '#4ade80' : '#a78bfa';
                
                html += `
                    <div style="background: linear-gradient(135deg, rgba(255,215,0,0.12), rgba(255,237,78,0.18)); padding: 16px; border-radius: 16px; border: 1px solid rgba(255,215,0,0.3); position: relative; backdrop-filter: blur(8px); box-shadow: 0 6px 20px rgba(255,215,0,0.15); transition: all 0.3s ease; overflow: hidden; background-size: 200% 200%; animation: shimmer 3s ease-in-out infinite;" onmouseover="this.style.transform='translateY(-3px) scale(1.02)';this.style.boxShadow='0 10px 30px rgba(255,215,0,0.25)';this.style.background='linear-gradient(135deg, rgba(255,215,0,0.2), rgba(255,237,78,0.25))'" onmouseout="this.style.transform='translateY(0) scale(1)';this.style.boxShadow='0 6px 20px rgba(255,215,0,0.15)';this.style.background='linear-gradient(135deg, rgba(255,215,0,0.12), rgba(255,237,78,0.18))'">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 6px;">
                            <span style="font-size: 20px; filter: drop-shadow(0 0 4px rgba(255,215,0,0.6));">${card.emoji}</span>
                            <div style="flex: 1;">
                                <div style="font-weight: 800; font-size: 14px; color: #fff; text-shadow: 0 1px 3px rgba(0,0,0,0.3);">${card.name}</div>
                                <div style="font-size: 11px; color: rgba(255,255,255,0.8); margin-top: 2px;">–ü–∞—Å—Å–∏–≤–Ω—ã–π –¥–æ—Ö–æ–¥ 24/7</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #ffd700, #ffed4e, #ffd700); color: #000; padding: 4px 8px; border-radius: 8px; font-size: 11px; font-weight: 900; text-shadow: 0 1px 3px rgba(0,0,0,0.3); border: 1px solid #ffd700; box-shadow: 0 3px 8px rgba(255,215,0,0.4); position: relative; overflow: hidden;">
                                <div style="position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent); animation: shimmer 2s infinite;"></div>
                                <span style="font-size: 12px; font-weight: 900; text-shadow: 0 1px 2px rgba(0,0,0,0.4);">VIP</span>
                            </div>
                        </div>
                        <div style="background: rgba(74,222,128,0.2); padding: 8px; border-radius: 8px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;">
                            <span style="color: #4ade80; font-size: 12px; font-weight: 700;">üí∞ –î–æ—Ö–æ–¥:</span>
                            <span style="color: #fff; font-size: 12px; font-weight: 800;">${incomeText}</span>
                        </div>
                        <button onclick="buyVIPCardWithStars('${card.rarity}', ${price}, ${card.productId})" 
                                style="width: 100%; padding: 10px 12px; background: linear-gradient(135deg, #ffd700, #ffed4e, #ffd700); color: #000; border: 1px solid #ffd700; border-radius: 10px; cursor: pointer; font-weight: 800; font-size: 13px; transition: all 0.3s; position: relative; overflow: hidden; box-shadow: 0 4px 12px rgba(255,215,0,0.3); text-shadow: 0 1px 2px rgba(0,0,0,0.2); display: flex; align-items: center; justify-content: center; gap: 6px;"
                                onmousedown="this.style.transform='scale(0.98)'; this.style.boxShadow='0 6px 16px rgba(255,215,0,0.4)'"
                                onmouseup="this.style.transform='scale(1)'; this.style.boxShadow='0 4px 12px rgba(255,215,0,0.3)'"
                                onmouseleave="this.style.transform='scale(1)'; this.style.boxShadow='0 4px 12px rgba(255,215,0,0.3)'">
                            <span>–ö—É–ø–∏—Ç—å –∑–∞ ${price}</span>
                            <span style="font-size: 16px; filter: drop-shadow(0 0 3px rgba(255,215,0,0.8)); text-shadow: 0 1px 2px rgba(0,0,0,0.3);">‚≠ê</span>
                            <span>Telegram Stars</span>
                        </button>
                    </div>
                `;
            });
            
            targetElement.innerHTML = html;
        };
        
        function updatePassiveIncome() {
            fetch('/api/cards', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({user_id: window.user?.id})
            })
            .then(res => res.json())
            .then(data => {
                // Update passive info display with rounded whole numbers
                const totalPassive = Math.round(data.total_passive_per_hour || 0);
                const passiveInfo = document.getElementById('passiveInfo');
                if(passiveInfo && passiveInfo.querySelector('div:last-child')) {
                    passiveInfo.querySelector('div:last-child').textContent = `+${totalPassive.toLocaleString()} ü™ô/—á–∞—Å`;
                }
            })
            .catch(err => console.error('Error updating passive income:', err));
        }
        
        // Update passive income every second when cards modal is open
        let passiveIncomeInterval = null;
        document.addEventListener('click', function(e) {
            if(e.target.textContent && e.target.textContent.includes('–ö–∞—Ä—Ç–æ—á–∫–∏')) {
                if(!passiveIncomeInterval) {
                    updatePassiveIncome();
                    passiveIncomeInterval = setInterval(updatePassiveIncome, 1000);
                }
            }
        });
        function openStats(e) {
            e.preventDefault();
            document.getElementById('statsModal').classList.add('active');
            fetch('/api/stats', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({user_id: window.user?.id})
            })
            .then(res => res.json())
            .then(data => {
                const statsHtml = `
                    <div class="stats-row">
                        <span class="stats-label">üëÜ –í—Å–µ–≥–æ —Ç–∞–ø–æ–≤</span>
                        <span class="stats-value">${data.total_taps || 0}</span>
                    </div>
                    <div class="stats-row">
                        <span class="stats-label">üí∞ –ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ</span>
                        <span class="stats-value">${Math.floor(data.total_earned || 0)} ü™ô</span>
                    </div>
                    <div class="stats-row">
                        <span class="stats-label">üíé –î–æ–±—ã—Ç–æ</span>
                        <span class="stats-value">${Math.floor(data.total_mined || 0)} ‚ö°</span>
                    </div>
                    <div class="stats-row">
                        <span class="stats-label">üí∞ –ë–∞–ª–∞–Ω—Å</span>
                        <span class="stats-value">${Math.floor(data.coins || 0)} ü™ô</span>
                    </div>
                    <div class="stats-row">
                        <span class="stats-label">üíé QuanHash</span>
                        <span class="stats-value">${Math.floor(data.quanhash || 0)} ‚ö°</span>
                    </div>
                `;
                document.getElementById('statsContent').innerHTML = statsHtml;
            });
        }

        // Generate all 165 achievements dynamically
        function generateAllAchievements(data) {
            const achievements = [];
            
            // Taps (20 achievements)
            const tapsList = [[1,'üëÜ'],[10,'üéØ'],[50,'‚ö°'],[100,'üî•'],[500,'üí´'],[1000,'üåä'],[5000,'üöÄ'],[10000,'üí•'],[25000,'‚ö°'],[50000,'üî•'],[100000,'üëë'],[250000,'üíÄ'],[500000,'üòà'],[1000000,'‚àû'],[2500000,'üåå'],[5000000,'üåÄ'],[10000000,'üí´'],[25000000,'‚≠ê'],[50000000,'‚ú®'],[100000000,'üåü']];
            const tapsTitlesRu = ['–ü–µ—Ä–≤—ã–π —Ç–∞–ø','–ù–æ–≤–∏—á–æ–∫','–ê–∫—Ç–∏–≤–∏—Å—Ç','–ú–∞—Å—Ç–µ—Ä','–≠–∫—Å–ø–µ—Ä—Ç','–ü—Ä–æ—Ñ–∏','–í–µ—Ç–µ—Ä–∞–Ω','–õ–µ–≥–µ–Ω–¥–∞','–ì—É—Ä—É','–¢–∏—Ç–∞–Ω','–ë–æ–≥','–î–µ–º–æ–Ω','–ê–±—Å–æ–ª—é—Ç','–ë–µ—Å–∫–æ–Ω–µ—á–Ω–æ—Å—Ç—å','–í—Å–µ–ª–µ–Ω–Ω–∞—è','–ú—É–ª—å—Ç–∏–≤—Å–µ–ª–µ–Ω–Ω–∞—è','–ö–æ—Å–º–æ—Å','–ó–≤–µ–∑–¥–∞','–°—É–ø–µ—Ä','–ú–ê–ö–°–ò–ú–£–ú'];
            tapsList.forEach(([thresh, icon], idx) => {
                achievements.push({
                    id:`taps_${thresh}`, threshold:thresh, icon:icon,
                    title: icon + ' ' + tapsTitlesRu[idx],
                    desc: `–°–¥–µ–ª–∞–π—Ç–µ ${thresh} —Ç–∞–ø–æ–≤`,
                    unlocked: data.total_taps >= thresh,
                    category: 'taps', color: '#60a5fa'
                });
            });
            
            // Coins (20 achievements)
            const coinsList = [[1000000,'üí∞'],[2500000,'üí∏'],[5000000,'üíµ'],[10000000,'üíé'],[25000000,'üèÜ'],[50000000,'üëë'],[100000000,'‚≠ê'],[250000000,'üåü'],[500000000,'‚ú®'],[1000000000,'üí´'],[2500000000,'üî•'],[5000000000,'‚ö°'],[10000000000,'üåå'],[25000000000,'üåÄ'],[50000000000,'‚≠ê'],[100000000000,'‚ú®'],[250000000000,'üí´'],[500000000000,'üåü'],[1000000000000,'üî•'],[10000000000000,'üëë']];
            const coinsTitlesRu = ['–ú–∏–ª–ª–∏–æ–Ω–µ—Ä','–ë–∞—Ä–æ–Ω','–¢–∏—Ä–∞–Ω','–ú–∞–≥–Ω–∞—Ç','–ö–æ—Ä–æ–ª—å','–û–ª–∏–≥–∞—Ä—Ö','–ò–º–ø–µ—Ä–∏—è','–§–µ–¥–µ—Ä–∞—Ü–∏—è','–ö–æ–Ω–≥–ª–æ–º–µ—Ä–∞—Ç','–ì–∞–ª–∞–∫—Ç–∏–∫–∞','–ö–æ—Å–º–æ—Å','–ë–µ—Å–∫–æ–Ω–µ—á–Ω–æ—Å—Ç—å','–í—Å–µ–ª–µ–Ω–Ω–∞—è','–ú—É–ª—å—Ç–∏–≤—Å–µ–ª–µ–Ω–Ω–∞—è','–°—É–ø–µ—Ä','–ì–∏–ø–µ—Ä','–£–ª—å—Ç—Ä–∞','–ú–µ—Ç–∞','–¢—Ä–∞–Ω—Å','–í–°–ï–õ–ï–ù–ù–ê–Ø'];
            coinsList.forEach(([thresh, icon], idx) => {
                achievements.push({
                    id:`coins_${thresh}`, threshold:thresh, icon:icon,
                    title: icon + ' ' + coinsTitlesRu[idx],
                    desc: `–ó–∞—Ä–∞–±–æ—Ç–∞–π—Ç–µ ${thresh/1000000}M –∫–æ–∏–Ω–æ–≤`,
                    unlocked: data.total_earned >= thresh,
                    category: 'coins', color: '#fbbf24'
                });
            });
            
            // Cards (15 achievements)
            const cardsList = [[1,'üÉè'],[5,'üé¥'],[10,'üÉè'],[25,'üé¥'],[50,'üÉè'],[100,'üé¥'],[150,'üÉè'],[250,'üé¥'],[350,'üÉè'],[500,'üé¥'],[750,'üÉè'],[1000,'üé¥'],[1500,'üÉè'],[2500,'üé¥'],[5000,'üÉè']];
            const cardsTitlesRu = ['–ü–µ—Ä–≤–∞—è –∫–∞—Ä—Ç–∞','–ö–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–µ—Ä','–ö–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–µ—Ä+','–ú–∞—Å—Ç–µ—Ä','–ú–∞—Å—Ç–µ—Ä –∫–∞—Ä—Ç','–õ–µ–≥–µ–Ω–¥–∞','–ú–∏—Ñ–∏—á–µ—Å–∫–∏–π','–ë–æ–≥ –∫–∞—Ä—Ç','–ë–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π','–ö–æ—Å–º–æ—Å','–í—Å–µ–ª–µ–Ω–Ω–∞—è','–ú—É–ª—å—Ç–∏–≤—Å–µ–ª–µ–Ω–Ω–∞—è','–ë–µ—Å–∫–æ–Ω–µ—á–Ω–æ—Å—Ç—å','–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π','–ö–û–°–ú–ò–ß–ï–°–ö–ò–ô'];
            cardsList.forEach(([thresh, icon], idx) => {
                achievements.push({
                    id:`cards_${thresh}`, threshold:thresh, icon:icon,
                    title: icon + ' ' + cardsTitlesRu[idx],
                    desc: `–ö—É–ø–∏—Ç–µ ${thresh} –∫–∞—Ä—Ç`,
                    unlocked: (data.cards && data.cards.length >= thresh),
                    category: 'cards', color: '#8b5cf6'
                });
            });
            
            // Mining (15 achievements)
            const miningList = [[1,'‚õèÔ∏è'],[5,'üè≠'],[10,'üèóÔ∏è'],[25,'‚öôÔ∏è'],[50,'üè≠'],[100,'üèóÔ∏è'],[150,'‚öôÔ∏è'],[250,'üè≠'],[350,'üèóÔ∏è'],[500,'‚öôÔ∏è'],[750,'üè≠'],[1000,'üèóÔ∏è'],[1500,'‚öôÔ∏è'],[2500,'üè≠'],[5000,'üèóÔ∏è']];
            const miningTitlesRu = ['–ü–µ—Ä–≤–∞—è –º–∞—à–∏–Ω–∞','–¶–µ—Ö','–§–∞–±—Ä–∏–∫–∞','–ó–∞–≤–æ–¥','–ú–µ–≥–∞—Ñ–∞–±—Ä–∏–∫–∞','–ö–æ—Ä–ø–æ—Ä–∞—Ü–∏—è','–ö–æ–Ω–≥–ª–æ–º–µ—Ä–∞—Ç','–ê–ª—å—è–Ω—Å','–ò–º–ø–µ—Ä–∏—è','–ö–æ—Å–º–æ—Å','–í—Å–µ–ª–µ–Ω–Ω–∞—è','–ú—É–ª—å—Ç–∏–≤—Å–µ–ª–µ–Ω–Ω–∞—è','–ë–µ—Å–∫–æ–Ω–µ—á–Ω–æ—Å—Ç—å','–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π','–ö–û–°–ú–ò–ß–ï–°–ö–ò–ô'];
            miningList.forEach(([thresh, icon], idx) => {
                achievements.push({
                    id:`mining_${thresh}`, threshold:thresh, icon:icon,
                    title: icon + ' ' + miningTitlesRu[idx],
                    desc: `–ö—É–ø–∏—Ç–µ ${thresh} –º–∞—à–∏–Ω`,
                    unlocked: (data.machines && data.machines.length >= thresh),
                    category: 'mining', color: '#10b981'
                });
            });
            
            // Levels (15 achievements)
            const levelsList = [[5,'üåü'],[10,'‚≠ê'],[15,'‚ú®'],[20,'üí´'],[25,'üåü'],[30,'‚≠ê'],[35,'‚ú®'],[40,'üí´'],[50,'üåü'],[60,'‚≠ê'],[70,'‚ú®'],[80,'üí´'],[90,'üåü'],[95,'‚≠ê'],[100,'üí´']];
            const levelsTitlesRu = ['–£—Ä–æ–≤–µ–Ω—å 5','–£—Ä–æ–≤–µ–Ω—å 10','–£—Ä–æ–≤–µ–Ω—å 15','–£—Ä–æ–≤–µ–Ω—å 20','–£—Ä–æ–≤–µ–Ω—å 25','–£—Ä–æ–≤–µ–Ω—å 30','–£—Ä–æ–≤–µ–Ω—å 35','–£—Ä–æ–≤–µ–Ω—å 40','–£—Ä–æ–≤–µ–Ω—å 50','–£—Ä–æ–≤–µ–Ω—å 60','–£—Ä–æ–≤–µ–Ω—å 70','–£—Ä–æ–≤–µ–Ω—å 80','–£—Ä–æ–≤–µ–Ω—å 90','–£—Ä–æ–≤–µ–Ω—å 95','–ú–ê–ö–°–ò–ú–£–ú'];
            levelsList.forEach(([thresh, icon], idx) => {
                achievements.push({
                    id:`level_${thresh}`, threshold:thresh, icon:icon,
                    title: icon + ' ' + levelsTitlesRu[idx],
                    desc: `–î–æ—Å—Ç–∏–≥–Ω–∏—Ç–µ ${thresh} —É—Ä–æ–≤–Ω—è`,
                    unlocked: data.level >= thresh,
                    category: 'level', color: '#a78bfa'
                });
            });
            
            // VIP (15 achievements)
            const vipList = [[1,'ü•â'],[2,'ü•à'],[3,'ü•á'],[4,'üíé'],[5,'üëë'],[6,'‚≠ê'],[7,'‚ú®'],[8,'üí´'],[9,'üåü'],[10,'üî•'],[11,'‚ö°'],[12,'üåå'],[13,'üåÄ'],[14,'‚≠ê'],[15,'üëë']];
            const vipTitlesRu = ['VIP –ë—Ä–æ–Ω–∑–∞','VIP –°–µ—Ä–µ–±—Ä–æ','VIP –ó–æ–ª–æ—Ç–æ','VIP –ü–ª–∞—Ç–∏–Ω–∞','VIP –î–ò–ê–ú–û–ù–î','VIP –ó–í–ï–ó–î–ê','VIP –ö–û–°–ú–û–°','VIP –í–°–ï–õ–ï–ù–ù–ê–Ø','VIP –ú–£–õ–¨–¢–ò','VIP –ë–û–ì','VIP –ê–ë–°–û–õ–Æ–¢','VIP –ì–ê–õ–ê–ö–¢–ò–ö–ê','VIP –ö–û–°–ú–û–°','VIP –£–õ–¨–¢–†–ê','VIP –í–°–ï–õ–ï–ù–ù–ê–Ø'];
            vipList.forEach(([thresh, icon], idx) => {
                achievements.push({
                    id:`vip_${thresh}`, threshold:thresh, icon:icon,
                    title: icon + ' ' + vipTitlesRu[idx],
                    desc: `VIP —É—Ä–æ–≤–µ–Ω—å ${thresh}`,
                    unlocked: (data.vip_level || 0) >= thresh,
                    category: 'vip', color: '#ffd700'
                });
            });
            
            // Social (15 achievements)
            const socialList = [[1,'üë•'],[5,'üë´'],[10,'üåê'],[15,'üë¨'],[25,'üë≠'],[50,'ü§ù'],[75,'üôå'],[100,'üëç'],[150,'ü§ù'],[250,'üôè'],[500,'üëë'],[1000,'üåü'],[2500,'‚ú®'],[5000,'üí´'],[10000,'üî•']];
            const socialTitlesRu = ['–ü–µ—Ä–≤—ã–π –¥—Ä—É–≥','–ú–∞–≥','–ú–∞—Å—Ç–µ—Ä','–õ–∏–¥–µ—Ä','–ö–∞–ø–∏—Ç–∞–Ω','–õ–µ–≥–µ–Ω–¥–∞','–ü—Ä–æ—Ñ–∏','–ì—É—Ä—É','–¢–∏—Ç–∞–Ω','–ë–æ–≥','–ö–æ—Å–º–æ—Å','–í—Å–µ–ª–µ–Ω–Ω–∞—è','–ú—É–ª—å—Ç–∏–≤—Å–µ–ª–µ–Ω–Ω–∞—è','–ë–µ—Å–∫–æ–Ω–µ—á–Ω–æ—Å—Ç—å','–í–°–ï–õ–ï–ù–ù–ê–Ø'];
            socialList.forEach(([thresh, icon], idx) => {
                achievements.push({
                    id:`social_${thresh}`, threshold:thresh, icon:icon,
                    title: icon + ' ' + socialTitlesRu[idx],
                    desc: `–ü—Ä–∏–≥–ª–∞—Å–∏—Ç–µ ${thresh} –¥—Ä—É–∑–µ–π`,
                    unlocked: (data.referrals_count || 0) >= thresh,
                    category: 'social', color: '#ec4899'
                });
            });
            
            // Energy (10 achievements)
            const energyList = [[10,'‚ö°'],[50,'üîã'],[100,'‚ö°'],[500,'üîã'],[1000,'‚ö°'],[2500,'üîã'],[5000,'‚ö°'],[10000,'üîã'],[25000,'‚ö°'],[50000,'üîã']];
            const energyTitlesRu = ['–≠–Ω–µ—Ä–≥–∏—è 10','–≠–Ω–µ—Ä–≥–∏—è 50','–≠–Ω–µ—Ä–≥–∏—è 100','–≠–Ω–µ—Ä–≥–∏—è 500','–≠–Ω–µ—Ä–≥–∏—è 1000','–≠–Ω–µ—Ä–≥–∏—è 2500','–≠–Ω–µ—Ä–≥–∏—è 5000','–≠–Ω–µ—Ä–≥–∏—è 10K','–≠–Ω–µ—Ä–≥–∏—è 25K','–≠–Ω–µ—Ä–≥–∏—è 50K'];
            energyList.forEach(([thresh, icon], idx) => {
                achievements.push({
                    id:`energy_${thresh}`, threshold:thresh, icon:icon,
                    title: icon + ' ' + energyTitlesRu[idx],
                    desc: `–ù–∞–∫–∞–ø–ª–∏–≤–∞–π—Ç–µ ${thresh} —ç–Ω–µ—Ä–≥–∏–∏`,
                    unlocked: false, // Placeholder - energy tracking not implemented yet
                    category: 'energy', color: '#f59e0b'
                });
            });
            
            // Shop (10 achievements)
            const shopList = [[1,'üõçÔ∏è'],[10,'üí≥'],[25,'üõí'],[50,'üõçÔ∏è'],[100,'üí≥'],[250,'üõí'],[500,'üõçÔ∏è'],[1000,'üí≥'],[2500,'üõí'],[5000,'üõçÔ∏è']];
            const shopTitlesRu = ['–ü–µ—Ä–≤–∞—è –ø–æ–∫—É–ø–∫–∞','–ü–æ–∫—É–ø–∞—Ç–µ–ª—å','–®–æ–ø–µ—Ä','–ü–æ–∫—É–ø–∞—Ç–µ–ª—å+','–ú–∞—Å—Ç–µ—Ä','–≠–∫—Å–ø–µ—Ä—Ç','–ü—Ä–æ—Ñ–∏','–õ–µ–≥–µ–Ω–¥–∞','–ë–æ–≥','–ö–û–°–ú–û–°'];
            shopList.forEach(([thresh, icon], idx) => {
                achievements.push({
                    id:`shop_${thresh}`, threshold:thresh, icon:icon,
                    title: icon + ' ' + shopTitlesRu[idx],
                    desc: `–°–¥–µ–ª–∞–π—Ç–µ ${thresh} –ø–æ–∫—É–ø–æ–∫`,
                    unlocked: false, // Placeholder - shop purchase tracking not implemented yet
                    category: 'shop', color: '#6366f1'
                });
            });
            
            // QuanHash (10 achievements)
            const quanhashList = [[100,'üíé'],[1000,'üí†'],[10000,'üíé'],[100000,'üí†'],[1000000,'üíé'],[10000000,'üí†'],[100000000,'üíé'],[1000000000,'üí†'],[10000000000,'üíé'],[100000000000,'üí†']];
            const quanhashTitlesRu = ['100 QuanHash','1K QuanHash','10K QuanHash','100K QuanHash','1M QuanHash','10M QuanHash','100M QuanHash','1B QuanHash','10B QuanHash','100B QuanHash'];
            quanhashList.forEach(([thresh, icon], idx) => {
                const display = thresh >= 1000 ? thresh/1000 + 'K' : thresh;
                achievements.push({
                    id:`quanhash_${thresh}`, threshold:thresh, icon:icon,
                    title: icon + ' ' + quanhashTitlesRu[idx],
                    desc: `–î–æ–±—ã—Ç—å ${display} QuanHash`,
                    unlocked: (data.quanhash || 0) >= thresh,
                    category: 'quanhash', color: '#a855f7'
                });
            });
            
            // Time (10 achievements)
            const timeList = [[1,'üìÖ'],[7,'üìÜ'],[30,'üóìÔ∏è'],[60,'üìÖ'],[100,'üìÜ'],[180,'üóìÔ∏è'],[365,'üìÖ'],[730,'üìÜ'],[1095,'üóìÔ∏è'],[1825,'üìÖ']];
            const timeTitlesRu = ['1 –¥–µ–Ω—å','1 –Ω–µ–¥–µ–ª—è','1 –º–µ—Å—è—Ü','2 –º–µ—Å—è—Ü–∞','100 –¥–Ω–µ–π','6 –º–µ—Å—è—Ü–µ–≤','1 –≥–æ–¥','2 –≥–æ–¥–∞','3 –≥–æ–¥–∞','5 –ª–µ—Ç'];
            timeList.forEach(([thresh, icon], idx) => {
                achievements.push({
                    id:`time_${thresh}`, threshold:thresh, icon:icon,
                    title: icon + ' ' + timeTitlesRu[idx],
                    desc: `–ò–≥—Ä–∞–π—Ç–µ ${thresh} –¥–Ω–µ–π`,
                    unlocked: false, // Placeholder - time tracking not implemented yet
                    category: 'time', color: '#06b6d4'
                });
            });
            
            // Premium (10 achievements)
            const premiumList = [[1,'üéÅ'],[5,'üéâ'],[10,'üéÅ'],[25,'üéâ'],[50,'üéÅ'],[100,'üéâ'],[250,'üéÅ'],[500,'üéâ'],[1000,'üéÅ'],[2500,'üéâ']];
            const premiumTitlesRu = ['–ü–µ—Ä–≤—ã–π –±–æ–Ω—É—Å','–ë–æ–Ω—É—Å x5','–ë–æ–Ω—É—Å x10','–ë–æ–Ω—É—Å x25','–ë–æ–Ω—É—Å x50','–ë–æ–Ω—É—Å x100','–ë–æ–Ω—É—Å x250','–ë–æ–Ω—É—Å x500','–ë–æ–Ω—É—Å x1K','–ë–æ–Ω—É—Å x2.5K'];
            premiumList.forEach(([thresh, icon], idx) => {
                achievements.push({
                    id:`premium_${thresh}`, threshold:thresh, icon:icon,
                    title: icon + ' ' + premiumTitlesRu[idx],
                    desc: `–ü–æ–ª—É—á–∏—Ç–µ ${thresh} –±–æ–Ω—É—Å–æ–≤`,
                    unlocked: false, // Placeholder - premium tracking not implemented yet
                    category: 'premium', color: '#ef4444'
                });
            });
            
            return achievements;
        }
        
        function openAchievements() {
            fetch('/api/user_data', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({user_id: window.user?.id})
            })
            .then(res => res.json())
            .then(data => {
                const modal = document.createElement('div');
                modal.className = 'modal active';
                modal.style.zIndex = '10000';
                
                const achievements = generateAllAchievements(data);
                
                const unlockedCount = achievements.filter(a => a.unlocked).length;
                const totalCount = achievements.length;
                const progress = (unlockedCount / totalCount * 100).toFixed(0);
                
                // Group achievements by category
                const categories = {
                    taps: {icon:'üëÜ', title:'–¢–∞–ø—ã', color:'#60a5fa'},
                    coins: {icon:'üí∞', title:'–î–æ—Ö–æ–¥', color:'#fbbf24'},
                    cards: {icon:'üÉè', title:'–ö–∞—Ä—Ç—ã', color:'#8b5cf6'},
                    mining: {icon:'‚õèÔ∏è', title:'–ú–∞–π–Ω–∏–Ω–≥', color:'#10b981'},
                    level: {icon:'üåü', title:'–£—Ä–æ–≤–Ω–∏', color:'#a78bfa'},
                    vip: {icon:'üëë', title:'VIP', color:'#ffd700'},
                    social: {icon:'üë•', title:'–°–æ—Ü–∏–∞–ª—å–Ω–æ–µ', color:'#ec4899'},
                    energy: {icon:'‚ö°', title:'–≠–Ω–µ—Ä–≥–∏—è', color:'#f59e0b'},
                    shop: {icon:'üõçÔ∏è', title:'–ú–∞–≥–∞–∑–∏–Ω', color:'#6366f1'},
                    quanhash: {icon:'üíé', title:'QuanHash', color:'#a855f7'},
                    time: {icon:'üìÖ', title:'–í—Ä–µ–º—è', color:'#06b6d4'},
                    premium: {icon:'üéÅ', title:'–ü—Ä–µ–º–∏—É–º', color:'#ef4444'}
                };
                
                const grouped = {};
                achievements.forEach(ach => {
                    if(!grouped[ach.category]) grouped[ach.category] = [];
                    grouped[ach.category].push(ach);
                });
                
                modal.innerHTML = `
                    <div class="modal-content" style="max-width:500px;max-height:85vh;overflow-y:auto;background:linear-gradient(135deg,rgba(10,14,39,0.98),rgba(15,23,42,0.98));border-radius:24px;border:2px solid rgba(167,139,250,0.4);box-shadow:0 10px 40px rgba(167,139,250,0.3);">
                        <div style="background:linear-gradient(135deg,#667eea,#764ba2);padding:24px;border-radius:22px 22px 0 0;text-align:center;position:relative;">
                            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
                                <h2 style="font-size:24px;color:#fff;margin:0;font-weight:900;">üèÜ –î–û–°–¢–ò–ñ–ï–ù–ò–Ø</h2>
                                <button class="close-btn" onclick="this.closest('.modal').remove()">‚úï</button>
                            </div>
                            <div style="background:rgba(0,0,0,0.3);padding:12px;border-radius:12px;color:#fff;">
                                <div style="font-size:14px;font-weight:700;margin-bottom:8px;">–ü—Ä–æ–≥—Ä–µ—Å—Å: ${unlockedCount}/${totalCount}</div>
                                <div style="background:rgba(255,255,255,0.2);height:10px;border-radius:10px;overflow:hidden;">
                                    <div style="width:${progress}%;height:100%;background:linear-gradient(90deg,#10b981,#4ade80);transition:width 0.5s;box-shadow:0 0 10px rgba(16,185,129,0.6);"></div>
                                </div>
                                <div style="font-size:11px;margin-top:8px;opacity:0.9;">${progress}% –∑–∞–≤–µ—Ä—à–µ–Ω–æ</div>
                            </div>
                        </div>
                        <div style="padding:20px;">
                            ${Object.keys(grouped).map(catKey => {
                                const cat = categories[catKey];
                                const catAchievements = grouped[catKey];
                                const unlockedInCat = catAchievements.filter(a => a.unlocked).length;
                                const totalInCat = catAchievements.length;
                                const catProgress = (unlockedInCat / totalInCat * 100).toFixed(0);
                                
                                return `
                                    <div style="margin-bottom:20px;background:linear-gradient(135deg,${cat.color}15,${cat.color}05);border:2px solid ${cat.color}40;border-radius:16px;overflow:hidden;">
                                        <div style="background:linear-gradient(135deg,${cat.color},${cat.color}cc);padding:12px 16px;display:flex;align-items:center;justify-content:space-between;">
                                            <div style="display:flex;align-items:center;gap:10px;">
                                                <span style="font-size:24px;">${cat.icon}</span>
                                                <span style="font-size:16px;font-weight:800;color:#fff;">${cat.title}</span>
                                            </div>
                                            <span style="font-size:13px;font-weight:700;color:#fff;background:rgba(0,0,0,0.2);padding:4px 10px;border-radius:8px;">${unlockedInCat}/${totalInCat}</span>
                                        </div>
                                        <div style="padding:12px;">
                                            ${catAchievements.map(ach => `
                                                <div style="margin-bottom:10px;background:${ach.unlocked ? `linear-gradient(135deg,${ach.color}20,${ach.color}05)` : 'rgba(0,0,0,0.3)'};padding:14px;border-radius:12px;border:2px solid ${ach.unlocked ? `${ach.color}50` : 'rgba(255,255,255,0.1)'};transition:all 0.3s;position:relative;overflow:hidden;">
                                                    ${ach.unlocked ? `<div style="position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,${ach.color},transparent);"></div>` : ''}
                                                    <div style="display:flex;align-items:center;gap:14px;">
                                                        <div style="font-size:36px;filter:${ach.unlocked ? 'none' : 'grayscale(100%) opacity(0.4)'};transform:${ach.unlocked ? 'scale(1)' : 'scale(0.9)'};transition:all 0.3s;">${ach.icon}</div>
                                                        <div style="flex:1;">
                                                            <div style="font-size:15px;font-weight:800;color:${ach.unlocked ? '#fff' : '#94a3b8'};margin-bottom:5px;display:flex;align-items:center;gap:6px;">
                                                                ${ach.title}
                                                                ${ach.unlocked ? '<span style="font-size:12px;color:#86efac;">‚ú®</span>' : ''}
                                                            </div>
                                                            <div style="font-size:12px;color:${ach.unlocked ? '#86efac' : '#64748b'};font-weight:500;">${ach.desc}</div>
                                                        </div>
                                                        ${ach.unlocked ? `
                                                            <div style="font-size:28px;animation:pulse 2s ease-in-out infinite;">‚úÖ</div>
                                                        ` : `
                                                            <div style="font-size:28px;opacity:0.2;">üîí</div>
                                                        `}
                                                    </div>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                modal.onclick = (e) => {if(e.target === modal) modal.remove();};
            });
        }
        
        function openSettingsModal() {
            fetch('/api/user_data', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({user_id: window.user?.id})
            })
            .then(res => res.json())
            .then(data => {
                const modal = document.createElement('div');
                modal.className = 'modal active';
                modal.style.zIndex = '10000';
                
                // Get saved settings from localStorage or use defaults (disabled by default)
                const savedSound = localStorage.getItem('soundEnabled') === 'true';
                const savedHaptics = localStorage.getItem('hapticsEnabled') === 'true';
                const savedNotifications = localStorage.getItem('notificationsEnabled') === 'true';
                const savedUsername = localStorage.getItem('username') || data.username || data.first_name || '–ò–≥—Ä–æ–∫';
                
                modal.innerHTML = `
                    <div class="modal-content" style="max-width:450px;max-height:85vh;overflow-y:auto;background:linear-gradient(135deg,rgba(10,14,39,0.98),rgba(15,23,42,0.98));border-radius:24px;border:2px solid rgba(75,85,99,0.4);box-shadow:0 10px 40px rgba(75,85,99,0.3);">
                        <div style="background:linear-gradient(135deg,#4b5563,#374151);padding:24px;border-radius:22px 22px 0 0;text-align:center;position:relative;">
                            <div style="display:flex;justify-content:space-between;align-items:center;">
                                <h2 style="font-size:24px;color:#fff;margin:0;font-weight:900;">‚öôÔ∏è –ù–ê–°–¢–†–û–ô–ö–ò</h2>
                                <button class="close-btn" onclick="this.closest('.modal').remove()">‚úï</button>
                            </div>
                        </div>
                        <div style="padding:20px;">
                            <div style="margin-bottom:20px;">
                                <div style="font-size:15px;font-weight:700;color:#fff;margin-bottom:12px;padding-bottom:8px;border-bottom:1px solid rgba(255,255,255,0.1);">üë§ –ü–†–û–§–ò–õ–¨</div>
                                <div style="background:rgba(0,0,0,0.2);padding:14px;border-radius:12px;border:1px solid rgba(255,255,255,0.1);">
                                    <div style="font-size:12px;color:#94a3b8;margin-bottom:6px;">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</div>
                                    <div style="display:flex;gap:8px;align-items:flex-start;">
                                        <input type="text" id="usernameInput" value="${savedUsername}" style="flex:1;padding:10px;background:rgba(255,255,255,0.05);border:1px solid rgba(102,126,234,0.3);border-radius:8px;color:#fff;font-size:14px;outline:none;transition:all 0.3s;" 
                                               onfocus="this.style.borderColor='#667eea';this.style.background='rgba(102,126,234,0.1)';" 
                                               onblur="this.style.borderColor='rgba(102,126,234,0.3)';this.style.background='rgba(255,255,255,0.05)';">
                                        <button onclick="saveUsername();" style="padding:10px 14px;background:linear-gradient(135deg,#667eea,#764ba2);border:none;border-radius:8px;color:#fff;font-size:14px;font-weight:700;cursor:pointer;transition:all 0.3s;flex-shrink:0;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">‚úì</button>
                                    </div>
                                    <div id="usernameError" style="display:none;margin-top:8px;padding:8px;background:rgba(239,68,68,0.2);border:1px solid rgba(239,68,68,0.5);border-radius:8px;color:#ef4444;font-size:12px;font-weight:600;"></div>
                                    <div id="usernameSuccess" style="display:none;margin-top:8px;padding:8px;background:rgba(16,185,129,0.2);border:1px solid rgba(16,185,129,0.5);border-radius:8px;color:#10b981;font-size:12px;font-weight:600;"></div>
                                </div>
                            </div>
                            
                            <div style="margin-bottom:20px;">
                                <div style="font-size:15px;font-weight:700;color:#fff;margin-bottom:12px;padding-bottom:8px;border-bottom:1px solid rgba(255,255,255,0.1);">üîä –ó–í–£–ö –ò –í–ò–ë–†–ê–¶–ò–Ø</div>
                                
                                <div style="background:rgba(0,0,0,0.2);padding:14px;border-radius:12px;border:1px solid rgba(255,255,255,0.1);margin-bottom:10px;">
                                    <div style="display:flex;justify-content:space-between;align-items:center;">
                                        <div style="display:flex;align-items:center;gap:10px;">
                                            <span style="font-size:24px;">üîä</span>
                                            <div>
                                                <div style="font-size:13px;font-weight:700;color:#fff;">–ó–≤—É–∫–∏</div>
                                                <div style="font-size:11px;color:#94a3b8;">–í–∫–ª—é—á–∏—Ç—å –∑–≤—É–∫–æ–≤—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã</div>
                                            </div>
                                        </div>
                                        <label style="position:relative;display:inline-block;width:50px;height:28px;">
                                            <input type="checkbox" id="soundToggle" ${savedSound ? 'checked' : ''} onchange="handleSoundToggle(this);" style="opacity:0;width:0;height:0;">
                                            <span class="toggle-track" style="position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background-color:${savedSound ? '#667eea' : '#4b5563'};border-radius:34px;transition:all 0.3s;">
                                                <span style="position:absolute;content:'';height:22px;width:22px;left:3px;bottom:3px;background-color:#fff;border-radius:50%;transition:all 0.3s;transform:translateX(${savedSound ? '22px' : '0'});"></span>
                                            </span>
                                        </label>
                                    </div>
                                </div>
                                
                                <div style="background:rgba(0,0,0,0.2);padding:14px;border-radius:12px;border:1px solid rgba(255,255,255,0.1);">
                                    <div style="display:flex;justify-content:space-between;align-items:center;">
                                        <div style="display:flex;align-items:center;gap:10px;">
                                            <span style="font-size:24px;">üì≥</span>
                                            <div>
                                                <div style="font-size:13px;font-weight:700;color:#fff;">–í–∏–±—Ä–∞—Ü–∏—è</div>
                                                <div style="font-size:11px;color:#94a3b8;">–¢–∞–∫—Ç–∏–ª—å–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å</div>
                                            </div>
                                        </div>
                                        <label style="position:relative;display:inline-block;width:50px;height:28px;">
                                            <input type="checkbox" id="hapticsToggle" ${savedHaptics ? 'checked' : ''} onchange="localStorage.setItem('hapticsEnabled', this.checked); updateToggleVisual(this);" style="opacity:0;width:0;height:0;">
                                            <span class="toggle-track" style="position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background-color:${savedHaptics ? '#667eea' : '#4b5563'};border-radius:34px;transition:all 0.3s;">
                                                <span style="position:absolute;content:'';height:22px;width:22px;left:3px;bottom:3px;background-color:#fff;border-radius:50%;transition:all 0.3s;transform:translateX(${savedHaptics ? '22px' : '0'});"></span>
                                            </span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                            
                            <div style="margin-bottom:20px;">
                                <div style="font-size:15px;font-weight:700;color:#fff;margin-bottom:12px;padding-bottom:8px;border-bottom:1px solid rgba(255,255,255,0.1);">üîî –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø</div>
                                
                                <div style="background:rgba(0,0,0,0.2);padding:14px;border-radius:12px;border:1px solid rgba(255,255,255,0.1);">
                                    <div style="display:flex;justify-content:space-between;align-items:center;">
                                        <div style="display:flex;align-items:center;gap:10px;">
                                            <span style="font-size:24px;">üîî</span>
                                            <div>
                                                <div style="font-size:13px;font-weight:700;color:#fff;">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</div>
                                                <div style="font-size:11px;color:#94a3b8;">–ü–æ–ª—É—á–∞—Ç—å push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</div>
                                            </div>
                                        </div>
                                        <label style="position:relative;display:inline-block;width:50px;height:28px;">
                                            <input type="checkbox" id="notificationsToggle" ${savedNotifications ? 'checked' : ''} onchange="localStorage.setItem('notificationsEnabled', this.checked); updateToggleVisual(this);" style="opacity:0;width:0;height:0;">
                                            <span class="toggle-track" style="position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background-color:${savedNotifications ? '#667eea' : '#4b5563'};border-radius:34px;transition:all 0.3s;">
                                                <span style="position:absolute;content:'';height:22px;width:22px;left:3px;bottom:3px;background-color:#fff;border-radius:50%;transition:all 0.3s;transform:translateX(${savedNotifications ? '22px' : '0'});"></span>
                                            </span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                            
                            
                            <button onclick="saveSettings(); this.closest('.modal').remove();" style="width:100%;padding:14px;background:linear-gradient(135deg,#10b981,#059669);border-radius:12px;cursor:pointer;font-weight:800;font-size:15px;color:#fff;margin-bottom:10px;border:none;box-shadow:0 4px 12px rgba(16,185,129,0.3);transition:all 0.3s;" onmouseover="this.style.transform='scale(1.02)';this.style.boxShadow='0 6px 16px rgba(16,185,129,0.4)'" onmouseout="this.style.transform='scale(1)';this.style.boxShadow='0 4px 12px rgba(16,185,129,0.3)'">
                                üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
                            </button>
                            
                            <button onclick="this.closest('.modal').remove()" style="width:100%;padding:14px;background:linear-gradient(135deg,#64748b,#475569);border-radius:12px;cursor:pointer;font-weight:700;font-size:15px;color:#fff;border:none;">–û—Ç–º–µ–Ω–∞</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                modal.onclick = (e) => {if(e.target === modal) modal.remove();};
            });
        }
        
        function updateToggleVisual(checkbox) {
            const track = checkbox.parentElement.querySelector('.toggle-track');
            const thumb = track ? track.querySelector('span') : null;
            if (track && thumb) {
                if (checkbox.checked) {
                    track.style.backgroundColor = '#667eea';
                    thumb.style.transform = 'translateX(22px)';
                } else {
                    track.style.backgroundColor = '#4b5563';
                    thumb.style.transform = 'translateX(0)';
                }
            }
        }
        
        function saveSettings() {
            const username = document.getElementById('usernameInput')?.value;
            const soundEnabled = document.getElementById('soundToggle')?.checked;
            const hapticsEnabled = document.getElementById('hapticsToggle')?.checked;
            const notificationsEnabled = document.getElementById('notificationsToggle')?.checked;
            
            console.log('saveSettings - soundEnabled:', soundEnabled, 'hapticsEnabled:', hapticsEnabled);
            
            // Save to localStorage first
            if(username) localStorage.setItem('username', username);
            if(soundEnabled !== undefined) {
                localStorage.setItem('soundEnabled', soundEnabled);
                console.log('Saved soundEnabled to localStorage:', soundEnabled);
            }
            if(hapticsEnabled !== undefined) localStorage.setItem('hapticsEnabled', hapticsEnabled);
            if(notificationsEnabled !== undefined) localStorage.setItem('notificationsEnabled', notificationsEnabled);
            
            // Save username to database
            if(username && window.user?.id) {
                fetch('/api/update_username', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        user_id: window.user.id,
                        username: username
                    })
                })
                .then(res => res.json())
                .then(data => {
                    if(!data.success) {
                        console.error('Failed to update username in database:', data.error);
                    } else {
                        // Username updated successfully, update window.user for immediate profile refresh
                        if(window.user) {
                            window.user.username = username;
                            window.user.first_name = username;
                        }
                    }
                })
                .catch(err => {
                    console.error('Error updating username in database:', err);
                });
            }
            
            // Show success message
            tg.showAlert('‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!');
            
            // Initialize AudioContext if not already done (for immediate sound feedback)
            initAudio();
            
            // Play success sound if enabled (use the value we just saved)
            console.log('About to play success sound, soundEnabled === true?', soundEnabled === true);
            if (soundEnabled === true) {
                console.log('Playing success sound after settings save');
                // Wait a moment for AudioContext to resume if needed
                setTimeout(() => {
                    playSound('success');
                }, 100);
            } else {
                console.log('Sound not enabled, skipping success sound');
            }
            
            // Trigger haptic feedback if enabled (use the value we just saved)
            if (hapticsEnabled === true && tg?.HapticFeedback) {
                tg.HapticFeedback.notificationOccurred('success');
            }
        }
        
        function handleSoundToggle(checkbox) {
            if (checkbox.checked) {
                // Show permission request modal
                const confirmModal = document.createElement('div');
                confirmModal.className = 'modal active';
                confirmModal.style.zIndex = '10001';
                confirmModal.innerHTML = `
                    <div style="background:linear-gradient(135deg,rgba(10,14,39,0.98),rgba(15,23,42,0.98));border-radius:24px;border:2px solid rgba(102,126,234,0.4);box-shadow:0 10px 40px rgba(102,126,234,0.3);max-width:400px;padding:30px;text-align:center;position:relative;">
                        <div style="font-size:64px;margin-bottom:20px;">üéµ</div>
                        <h2 style="font-size:22px;color:#fff;margin:0 0 15px;font-weight:800;">–†–∞–∑—Ä–µ—à–∏—Ç—å –∑–≤—É–∫–∏?</h2>
                        <p style="font-size:14px;color:#94a3b8;line-height:1.6;margin-bottom:25px;">–î–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è –∑–≤—É–∫–æ–≤—ã—Ö —ç—Ñ—Ñ–µ–∫—Ç–æ–≤ –Ω—É–∂–Ω–æ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –±—Ä–∞—É–∑–µ—Ä–∞ –Ω–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∑–≤—É–∫–∞</p>
                        <div style="display:flex;gap:10px;">
                            <button onclick="document.getElementById('soundToggle').checked=false;this.closest('.modal').remove()" style="flex:1;padding:12px;background:rgba(255,255,255,0.1);color:#fff;border:2px solid rgba(255,255,255,0.3);border-radius:12px;cursor:pointer;font-weight:700;font-size:14px;">–û—Ç–º–µ–Ω–∞</button>
                            <button onclick="this.closest('.modal').remove();localStorage.setItem('soundEnabled', 'true');updateToggleVisual(document.getElementById('soundToggle'));initAudio();" style="flex:1;padding:12px;background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border:none;border-radius:12px;cursor:pointer;font-weight:700;font-size:14px;">–†–∞–∑—Ä–µ—à–∏—Ç—å</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(confirmModal);
                confirmModal.onclick = (e) => {if(e.target === confirmModal) confirmModal.remove();};
            } else {
                localStorage.setItem('soundEnabled', 'false');
                updateToggleVisual(checkbox);
            }
        }
        
        function saveUsername() {
            const input = document.getElementById('usernameInput');
            const errorDiv = document.getElementById('usernameError');
            const successDiv = document.getElementById('usernameSuccess');
            const username = input?.value?.trim();
            
            if (!username) {
                errorDiv.textContent = '–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º';
                errorDiv.style.display = 'block';
                successDiv.style.display = 'none';
                return;
            }
            
            if (username.length < 3) {
                errorDiv.textContent = '–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞';
                errorDiv.style.display = 'block';
                successDiv.style.display = 'none';
                return;
            }
            
            if (!window.user?.id) {
                errorDiv.textContent = '–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏';
                errorDiv.style.display = 'block';
                successDiv.style.display = 'none';
                return;
            }
            
            fetch('/api/update_username', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    user_id: window.user.id,
                    username: username
                })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    localStorage.setItem('username', username);
                    if (window.user) {
                        window.user.username = username;
                        window.user.first_name = username;
                    }
                    errorDiv.style.display = 'none';
                    successDiv.textContent = '‚úÖ –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ!';
                    successDiv.style.display = 'block';
                    setTimeout(() => {
                        successDiv.style.display = 'none';
                    }, 3000);
                } else {
                    errorDiv.textContent = data.error || '‚ùå –¢–∞–∫–æ–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç';
                    errorDiv.style.display = 'block';
                    successDiv.style.display = 'none';
                }
            })
            .catch(err => {
                errorDiv.textContent = '‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É';
                errorDiv.style.display = 'block';
                successDiv.style.display = 'none';
            });
        }
        
        function openReferrals(e) {
            e.preventDefault();
            try { tg.HapticFeedback.impactOccurred('light'); } catch(err) {}
            document.getElementById('referralsModal').classList.add('active');
            fetch('/api/referrals', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({user_id: window.user?.id})
            })
            .then(res => res.json())
            .then(data => {
                document.getElementById('refCount').textContent = data.referrals_count || 0;
                document.getElementById('refPremiumCount').textContent = data.premium_referrals_count || 0;
                document.getElementById('refRegularCount').textContent = data.regular_referrals_count || 0;
                document.getElementById('refIncome').textContent = `${Math.floor(data.referral_income || 0)} ü™ô`;
                
                // Generate correct referral link
                const botUsername = 'qanexus_bot';
                const refCode = data.referral_code || window.user?.id || 'no_code';
                const refLink = `https://t.me/${botUsername}?start=${refCode}`;
                document.getElementById('refLink').textContent = refLink;
                
                // Render referrals list
                renderReferralsList(data.referrals || []);
            })
            .catch(err => {
                console.error('Error loading referrals:', err);
            });
        }
        
        function renderReferralsList(referrals) {
            const listContainer = document.getElementById('referralsList');
            if (!referrals || referrals.length === 0) {
                listContainer.innerHTML = '<div style="text-align: center; padding: 30px; color: rgba(255,255,255,0.5); font-size: 14px;">–ü–æ–∫–∞ –Ω–µ—Ç —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤</div>';
                return;
            }
            
            listContainer.innerHTML = referrals.map(ref => {
                const isPremium = ref.is_premium || false;
                const isVIP = ref.is_vip || false;
                const badge = isPremium ? '‚≠ê Premium' : isVIP ? 'üëë VIP' : '‚úÖ';
                const badgeColor = isPremium ? '#ffd700' : isVIP ? '#667eea' : '#10b981';
                const borderColor = isPremium ? 'rgba(255,215,0,0.5)' : isVIP ? 'rgba(102,126,234,0.5)' : 'rgba(16,185,129,0.4)';
                const bgColor = isPremium ? 'rgba(255,215,0,0.1)' : isVIP ? 'rgba(102,126,234,0.1)' : 'rgba(16,185,129,0.1)';
                const percent = ref.referral_income_percent || (isPremium ? 10 : isVIP ? 10 : 5);
                const earned = Math.floor(ref.total_earned || 0);
                const income = Math.floor(ref.income_from_ref || 0);
                const coins = Math.floor(ref.coins || 0);
                const joinedDate = ref.joined_at ? new Date(ref.joined_at).toLocaleDateString('ru-RU') : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
                
                return `
                    <div style="background: ${bgColor}; border: 2px solid ${borderColor}; border-radius: 14px; padding: 16px; margin-bottom: 12px; transition: all 0.3s; box-shadow: 0 2px 8px ${badgeColor}20;" onmouseover="this.style.transform='scale(1.02)'; this.style.boxShadow='0 4px 12px ${badgeColor}40';" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 2px 8px ${badgeColor}20';">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 14px;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <div style="font-size: 24px; filter: drop-shadow(0 2px 4px ${badgeColor}40);">${badge}</div>
                                <div style="font-weight: 900; color: #fff; font-size: 15px; text-shadow: 0 2px 4px rgba(0,0,0,0.3);">${ref.username}</div>
                            </div>
                            <div style="background: linear-gradient(135deg, ${badgeColor} 0%, ${badgeColor}dd 100%); color: #fff; padding: 6px 14px; border-radius: 20px; font-size: 12px; font-weight: 900; box-shadow: 0 2px 8px ${badgeColor}60; text-shadow: 0 2px 4px rgba(0,0,0,0.3);">
                                ${percent}%
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; font-size: 13px;">
                            <div style="color: rgba(255,255,255,0.75); font-weight: 600; display: flex; align-items: center;">
                                üí∞ –ó–∞—Ä–∞–±–æ—Ç–∞–ª:
                            </div>
                            <div style="font-weight: 800; color: #10b981; text-align: right; font-size: 14px; text-shadow: 0 2px 4px rgba(16,185,129,0.3);">
                                ${earned.toLocaleString()} ü™ô
                            </div>
                            <div style="color: rgba(255,255,255,0.75); font-weight: 600; display: flex; align-items: center;">
                                üíµ –í–∞—à –¥–æ—Ö–æ–¥:
                            </div>
                            <div style="font-weight: 800; color: #ffd700; text-align: right; font-size: 14px; text-shadow: 0 2px 4px rgba(255,215,0,0.3);">
                                ${income.toLocaleString()} ü™ô
                            </div>
                            <div style="color: rgba(255,255,255,0.75); font-weight: 600; display: flex; align-items: center;">
                                üí≥ –ë–∞–ª–∞–Ω—Å:
                            </div>
                            <div style="font-weight: 800; color: #667eea; text-align: right; font-size: 14px; text-shadow: 0 2px 4px rgba(102,126,234,0.3);">
                                ${coins.toLocaleString()} ü™ô
                            </div>
                            <div style="color: rgba(255,255,255,0.75); font-weight: 600; display: flex; align-items: center;">
                                üìÖ –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è:
                            </div>
                            <div style="font-weight: 800; color: rgba(255,255,255,0.95); text-align: right; font-size: 14px;">
                                ${joinedDate}
                            </div>
                        </div>
                        ${isPremium ? `
                        <div style="margin-top: 10px; padding: 8px; background: rgba(255,215,0,0.15); border: 1px solid rgba(255,215,0,0.3); border-radius: 8px; text-align: center;">
                            <div style="font-size: 11px; font-weight: 700; color: #ffd700;">
                                ‚≠ê Premium –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å - —É–¥–≤–æ–µ–Ω–Ω—ã–π –¥–æ—Ö–æ–¥!
                            </div>
                        </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        function copyRefLink() {
            const link = document.getElementById('refLink').textContent;
            if (link === '-') return;
            
            navigator.clipboard.writeText(link).then(() => {
                try { tg.HapticFeedback.impactOccurred('light'); } catch(err) {}
                
                // Show beautiful toast notification
                const toast = document.getElementById('copyToast');
                toast.style.transform = 'translate(-50%, -50%) scale(1)';
                
                setTimeout(() => {
                    toast.style.transform = 'translate(-50%, -50%) scale(0)';
                }, 2000);
            });
        }

        function openWithdrawModal(e) {
            if(e && e.preventDefault) e.preventDefault();
            document.getElementById('withdrawModal').classList.add('active');
            
            // Check if user has enough QuanHash
            fetch('/api/user_data', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({user_id: window.user?.id})
            })
            .then(res => res.json())
            .then(data => {
                const quanhash = Math.floor(data.quanhash || 0);
                const hasEnough = quanhash >= 500000;
                const vipLevel = data.vip_level || 0;
                const isVIP = vipLevel >= 3;
                const isDiamond = vipLevel >= 5;
                
                // VIP bonuses
                const feePercent = isDiamond ? 0 : isVIP ? 2 : 5;
                const minWithdraw = isDiamond ? 100000 : isVIP ? 250000 : 500000;
                const withdrawMultiplier = isDiamond ? 2 : isVIP ? 1.5 : 1;
                
                document.getElementById('withdrawContent').innerHTML = `
                    <div style="padding: 15px;">
                        <div style="text-align: center; margin-bottom: 15px;">
                            <div style="font-size: 40px; margin-bottom: 8px;">üíé</div>
                            <div style="font-size: 16px; font-weight: bold;">–í—ã–≤–æ–¥ —Å—Ä–µ–¥—Å—Ç–≤</div>
                            <div style="font-size: 13px; opacity: 0.7; margin-top: 4px;">–£ –≤–∞—Å: ${quanhash.toLocaleString()} üíé</div>
                            ${isVIP ? `
                            <div style="background:linear-gradient(135deg,#ffd700,#ffed4e);padding:8px 12px;border-radius:8px;margin-top:8px;font-size:12px;font-weight:800;color:#000;border:2px solid #ffd700;">
                                üëë VIP –ë–û–ù–£–°: ${feePercent === 0 ? '0% –∫–æ–º–∏—Å—Å–∏—è!' : feePercent + '% –∫–æ–º–∏—Å—Å–∏—è ‚Ä¢ x' + withdrawMultiplier + ' –ª–∏–º–∏—Ç'}
                            </div>
                            ` : ''}
                        </div>
                        <div style="background: rgba(102, 126, 234, 0.1); border: 1px solid rgba(102, 126, 234, 0.3); border-radius: 10px; padding: 12px; margin-bottom: 15px;">
                            <div style="font-size: 13px; opacity: 0.8; margin-bottom: 4px;">–û–±–º–µ–Ω</div>
                            <div style="font-size: 16px; font-weight: bold;">500,000 üíé = $1 USDT</div>
                            ${feePercent === 0 ? `
                            <div style="font-size:12px;color:#ffd700;font-weight:700;margin-top:4px;">‚ú® –ù–ï–¢ –ö–û–ú–ò–°–°–ò–ò (Diamond VIP)</div>
                            ` : ''}
                        </div>
                        <div style="margin-bottom: 12px;">
                            <div style="margin-bottom: 6px; font-weight: 500; font-size: 13px;">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ QuanHash (–º–∏–Ω. 500,000):</div>
                            <input type="number" id="quanhashAmount" value="${minWithdraw}" min="${minWithdraw}" step="1000" style="width: 100%; padding: 10px; background: rgba(255,255,255,0.1); border: 1px solid rgba(102, 126, 234, 0.3); border-radius: 10px; color: white; font-size: 14px;" oninput="updateUSDTAmount()">
                            <div id="usdtAmount" style="margin-top: 6px; font-size: 13px; font-weight: bold; color: #10b981;">–ü–æ–ª—É—á–∏—Ç–µ: $1.00 USDT</div>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <div style="margin-bottom: 6px; font-weight: 500; font-size: 13px;">BEP20 –∞–¥—Ä–µ—Å:</div>
                            <input type="text" id="usdtAddress" placeholder="0x0000...0000" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(102, 126, 234, 0.3); border-radius: 10px; color: white; font-size: 14px; font-weight: 600;">
                        </div>
                        <button id="withdrawBtn" class="action-btn" onclick="withdraw()" style="width: 100%; margin-bottom: 15px; padding: 12px; ${hasEnough ? '' : 'opacity: 0.5; cursor: not-allowed;'}" ${hasEnough ? '' : 'disabled'}>${hasEnough ? 'üí∏ –í—ã–≤–µ—Å—Ç–∏' : '‚ö†Ô∏è –ù–µ—Ç QuanHash'}</button>
                        <div style="border-top: 2px solid rgba(255,255,255,0.1); padding-top: 15px; margin-top: 15px;">
                            <div style="font-size: 15px; font-weight: bold; margin-bottom: 12px; text-align: center;">üìú –ò—Å—Ç–æ—Ä–∏—è –≤—ã–≤–æ–¥–æ–≤</div>
                            <div id="withdrawHistory" style="max-height: 120px; overflow-y: auto;"></div>
                        </div>
                    </div>
                `;
                    
                    // Load transaction history
                    loadWithdrawHistory();
            });
        }

        function loadWithdrawHistory() {
            fetch('/api/history', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({user_id: window.user?.id})
            })
            .then(res => res.json())
            .then(data => {
                const historyDiv = document.getElementById('withdrawHistory');
                if(!historyDiv) return;
                
                console.log('Withdrawal history data:', data);
                
                const withdrawals = data.history || [];
                console.log('Withdrawals found:', withdrawals.length);
                
                if(withdrawals.length > 0) {
                    historyDiv.innerHTML = withdrawals.map(w => {
                        const date = new Date(w.date);
                        // Status in Russian from server
                        const statusText = w.status || '–í –ø—Ä–æ—Ü–µ—Å—Å–µ';
                        const statusEmoji = statusText === '–í –ø—Ä–æ—Ü–µ—Å—Å–µ' ? '‚è≥' : statusText === '–í—ã–ø–ª–∞—á–µ–Ω–æ' ? '‚úÖ' : statusText === '–û—Ç–∫–ª–æ–Ω–µ–Ω–æ' ? '‚ùå' : '‚è≥';
                        const statusColor = statusText === '–í –ø—Ä–æ—Ü–µ—Å—Å–µ' ? '#f59e0b' : statusText === '–í—ã–ø–ª–∞—á–µ–Ω–æ' ? '#10b981' : statusText === '–û—Ç–∫–ª–æ–Ω–µ–Ω–æ' ? '#ef4444' : '#94a3b8';
                        return `
                            <div style="background:rgba(0,0,0,0.2);padding:10px;border-radius:8px;margin-bottom:8px;">
                                <div style="display:flex;justify-content:space-between;margin-bottom:5px;">
                                    <span style="font-size:12px;font-weight:600;">${statusEmoji} $${Math.floor(w.amount || 0)}</span>
                                    <span style="font-size:11px;opacity:0.7;">${date.toLocaleDateString('ru')}</span>
                                </div>
                                <div style="font-size:10px;opacity:0.6;margin-bottom:5px;">${w.address ? (w.address.substring(0,10) + '...') : ''}</div>
                                <div style="font-size:10px;color:${statusColor};font-weight:600;">${statusText}</div>
                            </div>
                        `;
                    }).join('');
                } else {
                    historyDiv.innerHTML = '<div style="text-align:center;opacity:0.5;font-size:12px;padding:10px;">–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞</div>';
                }
            })
            .catch(err => {
                console.error('Error loading history:', err);
                const historyDiv = document.getElementById('withdrawHistory');
                if(historyDiv) {
                    historyDiv.innerHTML = '<div style="text-align:center;opacity:0.5;font-size:12px;padding:10px;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>';
                }
            });
        }

        function updateUSDTAmount() {
            const amount = parseInt(document.getElementById('quanhashAmount').value) || 500000;
            const usdtAmount = amount / 500000;
            document.getElementById('usdtAmount').textContent = `–ü–æ–ª—É—á–∏—Ç–µ: $${usdtAmount.toFixed(2)} USDT`;
        }
        
        function withdraw() {
            const address = document.getElementById('usdtAddress').value.trim();
            const amount = parseInt(document.getElementById('quanhashAmount').value) || 500000;
            
            if (!address || !address.match(/^0x[a-fA-F0-9]{40}$/)) {
                tg.showAlert('‚ö†Ô∏è –í–≤–µ–¥–∏—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π BEP20 –∞–¥—Ä–µ—Å');
                return;
            }
            
            if (amount < 500000) {
                tg.showAlert('‚ö†Ô∏è –ú–∏–Ω–∏–º—É–º 500,000 QuanHash');
                return;
            }

            fetch('/api/withdraw', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    user_id: user?.id, 
                    address: address,
                    amount: amount
                })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    tg.showAlert('‚úÖ –ó–∞–ø—Ä–æ—Å –Ω–∞ –≤—ã–≤–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!');
                    loadData();
                    // Reload withdrawal history after successful request
                    setTimeout(() => {
                        openWithdrawModal({preventDefault: () => {}});
                    }, 500);
                } else {
                    tg.showAlert('‚ö†Ô∏è ' + data.error);
                }
            });
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        loadData();
        checkOfflineIncome();
        startEnergyRegen();
        startAutoTap();
        updateSupportBadge();
        
        // Create loadUserDataOnly function to update stats without flickering autobot
        function loadUserDataOnly() {
            fetch('/api/user_data', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({user_id: window.user?.id})
            })
            .then(res => res.json())
            .then(data => {
                // Update only stats, don't touch autobot button
                const coins = Math.floor(data.coins || 0);
                const quanhash = Math.floor(data.quanhash || 0);
                const energy = parseInt(data.energy || 0);
                const maxEnergy = parseInt(data.max_energy || 1000);
                const passiveCoins = Math.floor(data.passive_coins_per_hour || 0);
                const passiveHash = Math.floor(data.passive_hash_per_hour || 0);
                
                document.getElementById('coins').textContent = coins.toLocaleString();
                document.getElementById('quanhash').textContent = quanhash.toLocaleString();
                document.getElementById('energy-text').textContent = `${energy}/${maxEnergy}`;
                document.getElementById('passiveCoins').textContent = `+${passiveCoins.toLocaleString()}/—á–∞—Å`;
                document.getElementById('passiveHash').textContent = `+${passiveHash.toLocaleString()}/—á–∞—Å`;
                
                const energyPercent = Math.min(100, Math.max(0, (energy / maxEnergy) * 100));
                const fillBar = document.getElementById('energy-bar-fill');
                const percentText = document.getElementById('energy-percent');
                if (fillBar) {
                    fillBar.style.width = energyPercent + '%';
                }
                if (percentText) {
                    percentText.textContent = Math.round(energyPercent) + '%';
                }
            })
            .catch(err => console.error('Error:', err));
        }
        
        // Auto-update data every 2 seconds
        setInterval(() => {
            loadUserDataOnly();
        }, 2000);
        
        // Update support badge every 5 seconds
        setInterval(() => {
            updateSupportBadge();
        }, 5000);
        
        function updateSupportBadge() {
            fetch('/api/user_support', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({user_id: window.user?.id})
            })
            .then(res => res.json())
            .then(data => {
                const answeredTickets = (data.tickets || []).filter(t => t.status === 'answered' && t.answer && !t.is_read).length;
                const badge = document.getElementById('supportBadge');
                if(answeredTickets > 0) {
                    badge.textContent = answeredTickets;
                    badge.style.display = 'inline-block';
                } else {
                    badge.style.display = 'none';
                }
            })
            .catch(() => {});
        }
        
        // Auto-tap function - Constantly running to check status
        function startAutoTap() {
            // Check status every 2 seconds to restart if needed
            setInterval(() => {
                fetch('/api/user_data', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({user_id: window.user?.id})
                })
                .then(res => res.json())
                .then(data => {
                    const isEnabled = data.auto_tap_enabled;
                    const hasMinEnergy = data.energy > 10;
                    const autobotExpiresAt = data.auto_tap_expires_at || 0;
                    const isStillValid = autobotExpiresAt > Date.now();
                    
                    // Start or restart auto-tap interval if conditions are met
                    if(isEnabled && hasMinEnergy && isStillValid && !window.autoTapInterval) {
                        const speed = 1000 / (data.auto_tap_speed || 1); // taps per second
                        window.autoTapInterval = setInterval(() => {
                            fetch('/api/user_data', {
                                method: 'POST',
                                headers: {'Content-Type': 'application/json'},
                                body: JSON.stringify({user_id: window.user?.id})
                            })
                            .then(res => res.json())
                            .then(data => {
                                const isEnabled = data.auto_tap_enabled;
                                const hasMinEnergy = data.energy > 10;
                                const autobotExpiresAt = data.auto_tap_expires_at || 0;
                                const isStillValid = autobotExpiresAt > Date.now();
                                
                                if(isEnabled && hasMinEnergy && isStillValid) {
                                    // Perform tap
                                    fetch('/api/tap', {
                                        method: 'POST',
                                        headers: {'Content-Type': 'application/json'},
                                        body: JSON.stringify({user_id: window.user?.id, is_auto: true})
                                    })
                                    .then(res => res.json())
                                    .then(data => {
                                        if(data.success) {
                                            // Show animation for autobot
                                            const hasOpenModal = document.querySelector('.modal.active');
                                            if (!hasOpenModal) {
                                                const button = document.querySelector('.tap-button');
                                                if(button) {
                                                    const rect = button.getBoundingClientRect();
                                                    const centerX = rect.left + rect.width / 2;
                                                    const centerY = rect.top + rect.height / 2;
                                                    
                                                    const coinAnimation = document.createElement('div');
                                                    coinAnimation.className = 'coin-animation';
                                                    coinAnimation.textContent = '+' + data.reward;
                                                    coinAnimation.style.left = centerX + 'px';
                                                    coinAnimation.style.top = centerY + 'px';
                                                    coinAnimation.style.transform = 'translate(-50%, -50%)';
                                                    coinAnimation.style.zIndex = '999';
                                                    document.body.appendChild(coinAnimation);
                                                    setTimeout(() => {
                                                        if(document.body.contains(coinAnimation)) {
                                                            document.body.removeChild(coinAnimation);
                                                        }
                                                    }, 1000);
                                                }
                                                loadUserDataOnly(); // Silent update
                                            } else {
                                                loadUserDataOnly();
                                            }
                                        }
                                    })
                                    .catch(err => console.error('Auto-tap error:', err));
                                } else {
                                    // Stop auto-tap if conditions not met
                                    clearInterval(window.autoTapInterval);
                                    window.autoTapInterval = null;
                                }
                            })
                            .catch(err => console.error('Status check error:', err));
                        }, speed);
                    } else if((!isEnabled || !hasMinEnergy || !isStillValid) && window.autoTapInterval) {
                        // Stop if conditions no longer met
                        clearInterval(window.autoTapInterval);
                        window.autoTapInterval = null;
                    }
                })
                .catch(err => console.error('Auto-tap status error:', err));
            }, 2000); // Check status every 2 seconds
        }
        
        // Support functions
        function openSupport(event) {
            event.preventDefault();
            tg.HapticFeedback.impactOccurred('light');
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.id = 'supportModal';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 400px;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                        <h2 style="font-size:20px;color:#fff;font-weight:700;">üí¨ –ü–æ–¥–¥–µ—Ä–∂–∫–∞</h2>
                        <button class="close-btn" onclick="document.getElementById('supportModal').remove()">‚úï</button>
                    </div>
                    
                    <div style="margin-bottom:20px;">
                        <label style="display:block;font-size:13px;font-weight:600;margin-bottom:8px;color:#94a3b8;">–¢–µ–º–∞ –æ–±—Ä–∞—â–µ–Ω–∏—è</label>
                        <select id="supportTopic" style="width:100%;padding:14px 16px;background:rgba(0,0,0,0.4);border:2px solid rgba(102,126,234,0.3);border-radius:14px;color:#fff;font-size:14px;outline:none;transition:all 0.3s;">
                            <option value="–û–±—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã">‚ùì –û–±—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã</option>
                            <option value="–ü—Ä–æ–±–ª–µ–º—ã —Å –±–∞–ª–∞–Ω—Å–æ–º">üí≥ –ü—Ä–æ–±–ª–µ–º—ã —Å –±–∞–ª–∞–Ω—Å–æ–º</option>
                            <option value="–í—ã–≤–æ–¥ —Å—Ä–µ–¥—Å—Ç–≤">üí∏ –í—ã–≤–æ–¥ —Å—Ä–µ–¥—Å—Ç–≤</option>
                            <option value="–ú–∞–π–Ω–∏–Ω–≥">‚ö° –ú–∞–π–Ω–∏–Ω–≥</option>
                            <option value="–ö–∞—Ä—Ç–æ—á–∫–∏">üí≥ –ö–∞—Ä—Ç–æ—á–∫–∏</option>
                            <option value="–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞">üë• –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞</option>
                            <option value="–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã">üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã</option>
                            <option value="–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è">üí° –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è</option>
                            <option value="–ñ–∞–ª–æ–±—ã">‚ö†Ô∏è –ñ–∞–ª–æ–±—ã</option>
                            <option value="–î—Ä—É–≥–æ–µ">üìù –î—Ä—É–≥–æ–µ</option>
                        </select>
                    </div>
                    
                    <div style="margin-bottom:25px;">
                        <label style="display:block;font-size:13px;font-weight:600;margin-bottom:8px;color:#94a3b8;">–°–æ–æ–±—â–µ–Ω–∏–µ</label>
                        <textarea id="supportMessage" placeholder="–û–ø–∏—à–∏—Ç–µ –ø–æ–¥—Ä–æ–±–Ω–æ –≤–∞—à –≤–æ–ø—Ä–æ—Å –∏–ª–∏ –ø—Ä–æ–±–ª–µ–º—É..." rows="5" style="width:100%;padding:14px 16px;background:rgba(0,0,0,0.4);border:2px solid rgba(102,126,234,0.3);border-radius:14px;color:#fff;font-size:14px;outline:none;transition:all 0.3s;resize:vertical;font-family:inherit;"></textarea>
                    </div>
                    
                    <div style="display:flex;gap:12px;">
                        <button onclick="sendSupport()" style="flex:1;padding:16px;background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border:none;border-radius:14px;cursor:pointer;font-weight:700;font-size:15px;box-shadow:0 8px 24px rgba(102,126,234,0.4);transition:all 0.3s;">üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                        <button onclick="document.getElementById('supportModal').remove()" style="flex:1;padding:16px;background:rgba(255,255,255,0.1);color:#fff;border:2px solid rgba(255,255,255,0.3);border-radius:14px;cursor:pointer;font-weight:600;font-size:15px;transition:all 0.3s;">–û—Ç–º–µ–Ω–∞</button>
                    </div>
                    
                    <div style="text-align:center;margin-top:20px;padding-top:20px;border-top:1px solid rgba(255,255,255,0.1);">
                        <p style="font-size:11px;opacity:0.5;">‚è±Ô∏è –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞: 24 —á–∞—Å–∞</p>
                    </div>
                    
                    <button onclick="loadMyTickets()" style="width:100%;margin-top:15px;padding:12px;background:rgba(102,126,234,0.2);color:#667eea;border:1px solid rgba(102,126,234,0.4);border-radius:12px;cursor:pointer;font-weight:600;">üìã –ú–æ–∏ –æ–±—Ä–∞—â–µ–Ω–∏—è</button>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Add focus effects
            const topicSelect = document.getElementById('supportTopic');
            const messageText = document.getElementById('supportMessage');
            
            if(topicSelect) {
                topicSelect.addEventListener('focus', () => {
                    topicSelect.style.borderColor = 'rgba(102,126,234,0.8)';
                    topicSelect.style.boxShadow = '0 0 20px rgba(102,126,234,0.3)';
                });
                topicSelect.addEventListener('blur', () => {
                    topicSelect.style.borderColor = 'rgba(102,126,234,0.3)';
                    topicSelect.style.boxShadow = 'none';
                });
            }
            
            if(messageText) {
                messageText.addEventListener('focus', () => {
                    messageText.style.borderColor = 'rgba(102,126,234,0.8)';
                    messageText.style.boxShadow = '0 0 20px rgba(102,126,234,0.3)';
                });
                messageText.addEventListener('blur', () => {
                    messageText.style.borderColor = 'rgba(102,126,234,0.3)';
                    messageText.style.boxShadow = 'none';
                });
            }
        }
        
        function sendSupport() {
            const topicEl = document.querySelector('[id*="supportTopic"]');
            const messageEl = document.querySelector('[id*="supportMessage"]');
            
            if (!topicEl || !messageEl) {
                console.error('Support form elements not found');
                return;
            }
            
            const topic = topicEl.value;
            const message = messageEl.value;
            
            if (!topic) {
                alert('‚ö†Ô∏è –í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–º—É');
                return;
            }
            
            if (!message) {
                alert('‚ö†Ô∏è –í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ');
                return;
            }
            
            fetch('/api/support', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    user_id: user?.id,
                    topic: topic,
                    message: message
                })
            })
            .then(res => {
                console.log('Support response status:', res.status);
                return res.json();
            })
            .then(data => {
                console.log('Support response data:', data);
                if (data.success) {
                    alert('‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!');
                    const modal = document.querySelector('#supportModal') || document.querySelector('.modal.active');
                    if (modal) modal.remove();
                } else {
                    alert('‚ùå –û—à–∏–±–∫–∞: ' + (data.error || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è'));
                }
            })
            .catch(err => {
                console.error('Support send error:', err);
                alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ: ' + err.message);
            });
        }
        
        function loadMyTickets() {
            // Hide badge when opening my tickets
            const badge = document.getElementById('supportBadge');
            badge.style.display = 'none';
            
            // Mark all answered tickets as read
            fetch('/api/mark_tickets_read', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({user_id: window.user?.id})
            });
            
            fetch('/api/user_support', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({user_id: window.user?.id})
            })
            .then(res => res.json())
            .then(data => {
                if(data.tickets && data.tickets.length > 0) {
                    const ticketsList = data.tickets.map(t => `
                        <div style="background:rgba(0,0,0,0.3);padding:15px;border-radius:12px;margin-bottom:10px;border-left:4px solid ${t.status === 'answered' ? '#10b981' : '#f59e0b'};">
                            <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:10px;">
                                <div>
                                    <div style="font-weight:700;font-size:14px;color:#fff;margin-bottom:4px;">${t.topic}</div>
                                    <div style="font-size:11px;color:#94a3b8;">${new Date(t.created_at).toLocaleString()}</div>
                                </div>
                                <div style="padding:4px 10px;background:${t.status === 'answered' ? 'rgba(16,185,129,0.2)' : 'rgba(245,158,11,0.2)'};border-radius:8px;font-size:11px;font-weight:700;color:${t.status === 'answered' ? '#10b981' : '#f59e0b'};">
                                    ${t.status === 'answered' ? '‚úÖ –ì–æ—Ç–æ–≤–æ' : '‚è≥ –í –ø—Ä–æ—Ü–µ—Å—Å–µ'}
                                </div>
                            </div>
                            <div style="font-size:12px;color:#fff;margin-bottom:10px;opacity:0.9;">${t.message}</div>
                            ${t.answer ? `<div style="background:rgba(16,185,129,0.15);padding:10px;border-radius:8px;margin-top:10px;border-left:3px solid #10b981;"><div style="font-size:11px;color:#10b981;font-weight:700;margin-bottom:6px;">üìù –û—Ç–≤–µ—Ç:</div><div style="font-size:12px;color:#fff;">${t.answer}</div></div>` : ''}
                        </div>
                    `).join('');
                    
                    const modal = document.createElement('div');
                    modal.className = 'modal active';
                    modal.innerHTML = `
                        <div class="modal-content" style="max-width: 400px; max-height: 80vh; overflow-y: auto;">
                            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                                <h2 style="font-size: 20px; color: #fff;">üìã –ú–æ–∏ –æ–±—Ä–∞—â–µ–Ω–∏—è</h2>
                                <button class="close-btn" onclick="this.closest('.modal').remove()">‚úï</button>
                            </div>
                            <div>${ticketsList}</div>
                        </div>
                    `;
                    document.body.appendChild(modal);
                } else {
                    alert('üì≠ –£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –æ–±—Ä–∞—â–µ–Ω–∏–π');
                }
            })
            .catch(() => alert('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏'));
        }
    </script>
    
    <script>
        function openDailyBonus(e) {
            if (e && typeof e.preventDefault === 'function') {
                e.preventDefault();
            }
            // Check if modal already exists
            let modal = document.getElementById('dailyBonusModal');
            if (modal) {
                // Modal already exists - just show it, don't reload tasks
                // This preserves the current UI state including claimed rewards
                modal.style.display = 'flex';
                modal.style.alignItems = 'center';
                modal.style.justifyContent = 'center';
                modal.classList.add('active');
                return;
            }
            modal = document.createElement('div');
            modal.className = 'modal active';
            modal.id = 'dailyBonusModal';
            modal.style.display = 'flex';
            modal.style.alignItems = 'center';
            modal.style.justifyContent = 'center';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 500px; width: 95vw; max-height: 90vh; overflow: hidden; background: linear-gradient(135deg, rgba(0,0,0,0.95), rgba(20,20,30,0.98)); border-radius: 24px; backdrop-filter: blur(20px); padding: 0; border: 2px solid rgba(102,126,234,0.3);">
                    <!-- VIP Style Header with Layered Effect -->
                    <div style="background: linear-gradient(135deg, #667eea, #764ba2); padding: 24px 50px 24px 24px; border-radius: 20px 20px 0 0; position: relative; box-shadow: 0 8px 30px rgba(102,126,234,0.4); overflow: hidden;">
                        <!-- Background Window Effect -->
                        <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(135deg, rgba(102,126,234,0.3) 0%, rgba(118,75,162,0.2) 50%, rgba(102,126,234,0.3) 100%); border-radius: 20px 20px 0 0; opacity: 0.5; pointer-events: none; filter: blur(20px);"></div>
                        <div style="position: absolute; bottom: -30%; left: -20%; right: -20%; height: 80%; background: radial-gradient(circle, rgba(255,255,255,0.15) 0%, transparent 70%); border-radius: 50%; pointer-events: none;"></div>
                        
                        <div style="display: flex; align-items: center; justify-content: center; gap: 12px; position: relative; z-index: 1;">
                            <div style="font-size: 38px; text-shadow: 0 4px 15px rgba(0,0,0,0.4); filter: drop-shadow(0 0 10px rgba(102,126,234,0.9)); animation: pulse 2s infinite;">üéÅ</div>
                            <div style="flex: 1; min-width: 0;">
                                <h2 style="font-size: 22px; color: #fff; margin: 0; font-weight: 900; text-shadow: 0 3px 8px rgba(0,0,0,0.3); line-height: 1.2;">–ï–ñ–ï–î–ù–ï–í–ù–´–ï –ó–ê–î–ê–ù–ò–Ø</h2>
                                <div style="font-size: 13px; color: rgba(255,255,255,0.85); margin-top: 4px; font-weight: 700;">–í—ã–ø–æ–ª–Ω—è–π—Ç–µ –∏ –ø–æ–ª—É—á–∞–π—Ç–µ –Ω–∞–≥—Ä–∞–¥—ã!</div>
                            </div>
                        </div>
                        <button class="close-btn" onclick="this.closest('.modal').remove()" style="position: absolute; top: 10px; right: 10px; background: rgba(255,255,255,0.2); color: #fff; border: 2px solid rgba(255,255,255,0.3); width: 34px; height: 34px; border-radius: 50%; cursor: pointer; font-size: 20px; font-weight: bold; transition: all 0.3s; z-index: 3; flex-shrink: 0;">‚úï</button>
                    </div>
                    
                    <div style="padding: 20px; overflow-y: auto; max-height: calc(90vh - 150px);">
                        <!-- Countdown Timer -->
                        <div id="dailyTasksCountdown" style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.2), rgba(118, 75, 162, 0.15)); border: 2px solid rgba(102, 126, 234, 0.5); border-radius: 16px; padding: 18px; margin-bottom: 20px; text-align: center; box-shadow: 0 6px 25px rgba(102,126,234,0.3);">
                            <div style="font-size: 14px; font-weight: 800; color: rgba(255,255,255,0.9); margin-bottom: 8px;">‚è∞ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑:</div>
                            <div id="countdownTimer" style="font-size: 24px; font-weight: 900; color: #667eea; text-shadow: 0 2px 10px rgba(102,126,234,0.5);">--:--:--</div>
                        </div>
                        
                        <div id="dailyTasksList" style="display:flex;flex-direction:column;gap:15px;"></div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Start countdown timer
            function updateCountdown() {
                const countdownEl = document.getElementById('countdownTimer');
                if (!countdownEl) return;
                
                // Get current time and next midnight
                const now = new Date();
                const tomorrow = new Date(now);
                tomorrow.setDate(tomorrow.getDate() + 1);
                tomorrow.setHours(0, 0, 0, 0);
                
                const diff = tomorrow - now;
                
                if (diff > 0) {
                    const hours = Math.floor(diff / (1000 * 60 * 60));
                    const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                    const seconds = Math.floor((diff % (1000 * 60)) / 1000);
                    
                    countdownEl.textContent = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                } else {
                    countdownEl.textContent = '00:00:00';
                }
            }
            
            updateCountdown();
            setInterval(updateCountdown, 1000);
            
            // Load daily tasks
            fetch('/api/daily_tasks', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({user_id: window.user?.id})
            })
            .then(res => res.json())
            .then(data => {
                const list = document.getElementById('dailyTasksList');
                if(data.tasks && data.tasks.length > 0) {
                    let html = '';
                    
                    html += data.tasks.map((task, index) => {
                        // Always use server state - don't check local claimed state
                        // Server knows the real state (claimed or not)
                        const bgColor = task.completed ? 'rgba(16,185,129,0.15)' : 'rgba(0,0,0,0.3)';
                        const borderColor = task.completed ? 'rgba(74,222,128,0.6)' : 'rgba(102,126,234,0.5)';
                        const textColor = task.completed ? '#4ade80' : '#f093fb';
                        
                        // Special handling for channel subscription
                        const isChannelTask = task.type === 'channel_subscription';
                        const minHeight = isChannelTask ? '200px' : 'auto';
                        
                        return `
                            <div data-task-id="${task.id}" style="background: ${bgColor}; border: 2px solid ${borderColor}; border-radius: 16px; padding: 18px; box-shadow: 0 4px 15px ${borderColor}30; min-height: ${minHeight};" onmouseover="this.style.transform='translateY(-2px)'; this.style.transition='transform 0.2s, box-shadow 0.2s'; this.style.boxShadow='0 6px 20px ${borderColor}50';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px ${borderColor}30';">
                                <div style="display: flex; align-items: flex-start; gap: 12px; margin-bottom: 12px;">
                                    <div style="font-size: 32px; filter: drop-shadow(0 2px 6px rgba(0,0,0,0.4)); flex-shrink: 0;">${task.emoji}</div>
                                    <div style="flex: 1; min-width: 0;">
                                        <div style="font-size: 16px; font-weight: 900; color: #fff; margin-bottom: 6px; text-shadow: 0 2px 4px rgba(0,0,0,0.3);">${task.name}</div>
                                        <div style="font-size: 13px; color: rgba(255,255,255,0.85); line-height: 1.4; margin-bottom: 10px;">${task.description}</div>
                                    </div>
                                    ${task.completed ? `
                                        <div style="background: linear-gradient(135deg, #10b981, #059669); color: #fff; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 900; box-shadow: 0 2px 8px rgba(16,185,129,0.4); text-shadow: 0 2px 4px rgba(0,0,0,0.3); flex-shrink: 0;">
                                            ‚úÖ –ì–û–¢–û–í–û
                                        </div>
                                    ` : ''}
                                </div>
                                
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                    <div style="font-size: 14px; color: ${textColor}; font-weight: 700; display: flex; align-items: center; gap: 6px;">
                                        ${task.completed ? '‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ' : task.description && task.description.includes('–í–µ—Ä–Ω–∏—Ç–µ—Å—å —á–µ—Ä–µ–∑') ? `
                                            <span id="returnTimer_${task.id}">‚è≥ –†–∞—Å—á–µ—Ç –≤—Ä–µ–º–µ–Ω–∏...</span>
                                        ` : `üìä –ü—Ä–æ–≥—Ä–µ—Å—Å: ${task.progress}/${task.target}`}
                                    </div>
                                    <div style="font-size: 18px; font-weight: 900; color: #10b981; text-shadow: 0 2px 8px rgba(16,185,129,0.5);">üí∞ +${task.reward.toLocaleString()}</div>
                                </div>
                                
                                ${!task.completed && task.description && task.description.includes('–í–µ—Ä–Ω–∏—Ç–µ—Å—å —á–µ—Ä–µ–∑') ? `
                                    <div style="background: rgba(102,126,234,0.1); border: 1px solid rgba(102,126,234,0.3); border-radius: 8px; padding: 8px; margin-top: 8px; text-align: center;">
                                        <div style="font-size: 12px; color: rgba(255,255,255,0.7); margin-bottom: 4px;">–í–µ—Ä–Ω–∏—Ç–µ—Å—å —á–µ—Ä–µ–∑ ${task.target} —á–∞—Å–æ–≤ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–∞–≥—Ä–∞–¥—ã</div>
                                    </div>
                                ` : ''}
                                
                                ${!task.completed && isChannelTask ? `
                                    <a href="${task.channel_url}" target="_blank" style="width: 100%; padding: 12px; font-size: 15px; font-weight: 900; background: linear-gradient(135deg, #0088cc, #0066aa); color: #fff; border: none; border-radius: 12px; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 15px rgba(0,136,204,0.4); text-shadow: 0 2px 4px rgba(0,0,0,0.3); display: inline-block; text-align: center; text-decoration: none;" onmouseover="this.style.transform='scale(1.02)'; this.style.boxShadow='0 6px 20px rgba(0,136,204,0.6)'" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 4px 15px rgba(0,136,204,0.4)'">
                                        üì¢ –ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –∫–∞–Ω–∞–ª
                                    </a>
                                    <button onclick="verifyChannelSubscription(${task.id})" style="width: 100%; margin-top: 8px; padding: 10px; font-size: 14px; font-weight: 700; background: rgba(102,126,234,0.3); color: #a5b4fc; border: 2px solid rgba(102,126,234,0.5); border-radius: 10px; cursor: pointer; transition: all 0.3s;">
                                        ‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É
                                    </button>
                                ` : task.completed && !task.claimed ? `
                                    <button onclick="claimReward(${task.id})" style="width: 100%; padding: 12px; font-size: 15px; font-weight: 900; background: linear-gradient(135deg, #667eea, #764ba2); color: #fff; border: none; border-radius: 12px; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 15px rgba(102,126,234,0.4); text-shadow: 0 2px 4px rgba(0,0,0,0.3);" onmouseover="this.style.transform='scale(1.02)'; this.style.boxShadow='0 6px 20px rgba(102,126,234,0.6)'" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 4px 15px rgba(102,126,234,0.4)'">
                                        üéÅ –ó–∞–±—Ä–∞—Ç—å –Ω–∞–≥—Ä–∞–¥—É
                                    </button>
                                ` : task.claimed ? `
                                    <div style="width: 100%; padding: 12px; font-size: 15px; font-weight: 900; background: rgba(16,185,129,0.3); color: #10b981; border: 2px solid rgba(16,185,129,0.5); border-radius: 12px; text-align: center; text-shadow: 0 2px 4px rgba(16,185,129,0.3);">
                                        ‚úÖ –ù–∞–≥—Ä–∞–¥–∞ –ø–æ–ª—É—á–µ–Ω–∞!
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    }).join('');
                    
                    // Always use server state - replace all tasks
                    list.innerHTML = html;
                    
                    // Start countdown timers for return tasks - use setTimeout to ensure DOM is ready
                    setTimeout(() => {
                        data.tasks.forEach((task, index) => {
                            if (task.return_task) {
                                const timerEl = document.getElementById('returnTimer_' + task.id);
                                if (timerEl) {
                                    if (task.completed) {
                                        // Task already completed
                                        timerEl.textContent = '‚úÖ –ó–∞–¥–∞–Ω–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ!';
                                        timerEl.style.color = '#10b981';
                                    } else if (task.last_active) {
                                        const lastActiveTime = new Date(task.last_active).getTime();
                                        const targetHours = parseFloat(task.target) || 2;
                                        
                                        function updateReturnTimer() {
                                            if (!timerEl || !timerEl.parentElement) {
                                                return; // Element removed
                                            }
                                            
                                            const now = new Date().getTime();
                                            const hoursPassed = (now - lastActiveTime) / (1000 * 60 * 60);
                                            const hoursRemaining = Math.max(0, targetHours - hoursPassed);
                                            
                                            if (hoursRemaining > 0) {
                                                const hours = Math.floor(hoursRemaining);
                                                const minutes = Math.floor((hoursRemaining - hours) * 60);
                                                const seconds = Math.floor(((hoursRemaining - hours) * 60 - minutes) * 60);
                                                timerEl.textContent = `‚è≥ –û—Å—Ç–∞–ª–æ—Å—å: ${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                                                timerEl.style.color = '#fbbf24';
                                            } else {
                                                timerEl.textContent = '‚úÖ –í—Ä–µ–º—è –≤—ã—à–ª–æ! –ú–æ–∂–Ω–æ –∑–∞–±—Ä–∞—Ç—å –Ω–∞–≥—Ä–∞–¥—É';
                                                timerEl.style.color = '#10b981';
                                                // Reload tasks to update status only if modal is open
                                                setTimeout(() => {
                                                    const modal = document.getElementById('dailyBonusModal');
                                                    if (modal && modal.classList.contains('active')) {
                                                        openDailyBonus();
                                                    }
                                                }, 1000);
                                            }
                                        }
                                        updateReturnTimer();
                                        const intervalId = setInterval(updateReturnTimer, 1000);
                                        // Store interval ID for cleanup if needed
                                        timerEl.dataset.intervalId = intervalId;
                                    } else {
                                        timerEl.textContent = '‚è≥ –ù–∞—á–Ω–∏—Ç–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è (–∞–∫—Ç–∏–≤–∏—Ä—É–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ)';
                                    }
                                }
                            }
                        });
                    }, 100);
                } else {
                    list.innerHTML = '<p style="text-align:center;opacity:0.7;padding:20px;">–ó–∞–¥–∞–Ω–∏—è –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è...</p>';
                }
            });
        }
        
        function joinVIPTournament() {
            tg.showAlert('üéâ –í—ã –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª–∏—Å—å –∫ VIP –¢—É—Ä–Ω–∏—Ä—É! –°—Ä–∞–∑–∏—Ç–µ—Å—å –∑–∞ —Ç–æ–ø-3 –º–µ—Å—Ç–∞!');
        }
        
        function activateDiamondChallenge() {
            tg.showAlert('‚ö° Diamond Challenge –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω! –ü–æ–ª—É—á–∞–π—Ç–µ x50 –±–æ–Ω—É—Å –∫ –¥–æ—Ö–æ–¥–∞–º –Ω–∞ 24 —á–∞—Å–∞!');
        }
        function claimReward(taskId) {
            // Find task card and button
            const taskCard = document.querySelector(`[data-task-id="${taskId}"]`);
            const claimButton = taskCard ? taskCard.querySelector('button') : null;
            
            // Immediately update UI to show loading
            if (claimButton) {
                claimButton.disabled = true;
                claimButton.style.opacity = '0.6';
                claimButton.style.cursor = 'not-allowed';
                claimButton.textContent = '‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...';
            }
            
            fetch('/api/claim_task', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({user_id: window.user?.id, task_id: taskId})
            })
            .then(res => res.json())
            .then(data => {
                if(data.success) {
                    // Instantly mark task as claimed - replace button with success message
                    if (taskCard && claimButton) {
                        const successDiv = document.createElement('div');
                        successDiv.textContent = '‚úÖ –ù–∞–≥—Ä–∞–¥–∞ –ø–æ–ª—É—á–µ–Ω–∞!';
                        successDiv.style.cssText = 'width: 100%; padding: 12px; font-size: 15px; font-weight: 900; background: rgba(16,185,129,0.3); color: #10b981; border: 2px solid rgba(16,185,129,0.5); border-radius: 12px; text-align: center; text-shadow: 0 2px 4px rgba(16,185,129,0.3);';
                        claimButton.parentNode.replaceChild(successDiv, claimButton);
                    }
                    // Update coins display immediately - no alerts, just instant update
                    loadData();
                } else {
                    // Restore button on error
                    if (claimButton) {
                        claimButton.disabled = false;
                        claimButton.style.opacity = '1';
                        claimButton.style.cursor = 'pointer';
                        claimButton.textContent = 'üéÅ –ó–∞–±—Ä–∞—Ç—å –Ω–∞–≥—Ä–∞–¥—É';
                    }
                    if (window.tg && tg.showAlert) {
                        tg.showAlert('‚ùå ' + (data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –Ω–∞–≥—Ä–∞–¥—ã'));
                    }
                }
            })
            .catch(err => {
                console.error('Claim reward error:', err);
                // Restore button on error
                if (claimButton) {
                    claimButton.disabled = false;
                    claimButton.style.opacity = '1';
                    claimButton.style.cursor = 'pointer';
                    claimButton.textContent = 'üéÅ –ó–∞–±—Ä–∞—Ç—å –Ω–∞–≥—Ä–∞–¥—É';
                }
                if (window.tg && tg.showAlert) {
                    tg.showAlert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –Ω–∞–≥—Ä–∞–¥—ã');
                }
            });
        }
        
        function verifyChannelSubscription(taskId) {
            console.log('verifyChannelSubscription called for taskId:', taskId);
            // Find task card - always find it fresh each time
            const taskCard = document.querySelector(`[data-task-id="${taskId}"]`);
            if (!taskCard) {
                console.error('Task card not found for taskId:', taskId);
                return;
            }
            
            // Find button - try multiple selectors
            let verifyButton = taskCard.querySelector(`button[onclick*="verifyChannelSubscription(${taskId})"]`);
            if (!verifyButton) {
                verifyButton = taskCard.querySelector('button');
            }
            
            let originalText = '';
            if (verifyButton) {
                originalText = verifyButton.textContent;
                verifyButton.disabled = true;
                verifyButton.style.opacity = '0.6';
                verifyButton.style.cursor = 'not-allowed';
                verifyButton.style.pointerEvents = 'none';
                verifyButton.textContent = '‚è≥ –ü—Ä–æ–≤–µ—Ä–∫–∞...';
            }
            
            fetch('/api/verify_channel_subscription', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({user_id: window.user?.id, task_id: taskId})
            })
            .then(res => {
                if (!res.ok) {
                    throw new Error(`HTTP error! status: ${res.status}`);
                }
                return res.json();
            })
            .then(data => {
                console.log('Verification response:', JSON.stringify(data));
                
                // Restore button state helper
                const restoreButton = () => {
                    if (verifyButton && originalText) {
                        verifyButton.disabled = false;
                        verifyButton.style.opacity = '1';
                        verifyButton.style.cursor = 'pointer';
                        verifyButton.style.pointerEvents = 'auto';
                        verifyButton.textContent = originalText;
                    }
                };
                
                // Check API response first
                if (!data || data.success === false) {
                    console.error('API error:', data);
                    restoreButton();
                    // Only show alert if user is not subscribed (important feedback)
                    // Otherwise silently fail to avoid interruptions
                    return;
                }
                
                // Check if subscribed - handle both true and explicit false
                const isSubscribed = data.subscribed === true || data.subscribed === 'true';
                console.log('Is subscribed?', isSubscribed, 'data.subscribed:', data.subscribed);
                
                if (isSubscribed) {
                    console.log('‚úÖ User is subscribed! Claiming reward immediately...');
                    
                    // INSTANTLY remove button and link, show success message IMMEDIATELY
                    const currentTaskCard = document.querySelector(`[data-task-id="${taskId}"]`);
                    if (!currentTaskCard) {
                        console.error('Task card not found');
                        return;
                    }
                    
                    // Remove ALL buttons and links IMMEDIATELY
                    const allButtons = currentTaskCard.querySelectorAll('button');
                    const allLinks = currentTaskCard.querySelectorAll('a[target="_blank"]');
                    allButtons.forEach(btn => btn.remove());
                    allLinks.forEach(link => link.remove());
                    
                    // Create success message IMMEDIATELY - show it right away (exactly like bottom card)
                    const successDiv = document.createElement('div');
                    successDiv.textContent = '‚úÖ –ù–∞–≥—Ä–∞–¥–∞ –ø–æ–ª—É—á–µ–Ω–∞!';
                    // Use exact same style as bottom card (task.claimed)
                    successDiv.style.cssText = 'width: 100%; padding: 12px; font-size: 15px; font-weight: 900; background: rgba(16,185,129,0.3); color: #10b981; border: 2px solid rgba(16,185,129,0.5); border-radius: 12px; text-align: center; text-shadow: 0 2px 4px rgba(16,185,129,0.3);';
                    successDiv.setAttribute('data-claimed-message', 'true');
                    
                    // Insert success message at the bottom of card (after all content, like bottom card)
                    // Find the last element before any existing claimed message
                    const existingClaimedMsg = currentTaskCard.querySelector('[data-claimed-message="true"]');
                    if (existingClaimedMsg) {
                        existingClaimedMsg.remove();
                    }
                    
                    // Insert at the very end of the card content
                    currentTaskCard.appendChild(successDiv);
                    
                    // Update progress text IMMEDIATELY to "‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ"
                    const progressText = currentTaskCard.querySelector('div[style*="font-size: 14px"]');
                    if (progressText) {
                        progressText.textContent = '‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ';
                        progressText.style.color = '#10b981';
                    }
                    
                    // Update progress bar IMMEDIATELY
                    const progressBar = currentTaskCard.querySelector('[style*="width"]');
                    if (progressBar) {
                        progressBar.style.width = '100%';
                        progressBar.style.background = 'linear-gradient(90deg, rgba(16,185,129,0.8) 0%, rgba(16,185,129,1) 100%)';
                    }
                    
                    // Add "‚úÖ –ì–û–¢–û–í–û" badge IMMEDIATELY (like bottom card)
                    const header = currentTaskCard.querySelector('div[style*="display: flex; align-items: flex-start"]');
                    if (header) {
                        const existingBadge = header.querySelector('div[style*="background: linear-gradient(135deg, #10b981"]');
                        if (!existingBadge) {
                            const badge = document.createElement('div');
                            badge.style.cssText = 'background: linear-gradient(135deg, #10b981, #059669); color: #fff; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 900; box-shadow: 0 2px 8px rgba(16,185,129,0.4); text-shadow: 0 2px 4px rgba(0,0,0,0.3); flex-shrink: 0;';
                            badge.textContent = '‚úÖ –ì–û–¢–û–í–û';
                            header.appendChild(badge);
                        }
                    }
                    
                    // Update card style IMMEDIATELY (green background and border)
                    currentTaskCard.style.background = 'rgba(16,185,129,0.15)';
                    currentTaskCard.style.borderColor = 'rgba(74,222,128,0.6)';
                    
                    // Try to get reward amount from DOM and update coins balance OPTIMISTICALLY
                    const rewardText = currentTaskCard.querySelector('div[style*="font-size: 18px"]');
                    if (rewardText) {
                        const rewardMatch = rewardText.textContent.match(/\d[\d\s]*/);
                        if (rewardMatch) {
                            const rewardAmount = parseInt(rewardMatch[0].replace(/\s/g, '')) || 0;
                            if (rewardAmount > 0) {
                                // Update coins balance optimistically
                                const coinsEl = document.getElementById('coins');
                                if (coinsEl) {
                                    const currentCoins = parseInt(coinsEl.textContent.replace(/\s/g, '')) || 0;
                                    const newCoins = currentCoins + rewardAmount;
                                    coinsEl.textContent = newCoins.toLocaleString();
                                }
                            }
                        }
                    }
                    
                    console.log('‚úÖ Success message and progress updated instantly!');
                    
                    // Call claim API - only update card style after successful claim
                    fetch('/api/claim_task', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({user_id: window.user?.id, task_id: taskId})
                    })
                        .then(res => {
                            if (!res.ok) {
                                throw new Error(`HTTP error! status: ${res.status}`);
                            }
                            return res.json();
                        })
                        .then(claimData => {
                            console.log('Claim response:', claimData);
                            if (claimData.success) {
                                console.log('‚úÖ Reward claimed successfully! Updating card style...');
                                
                                // Only update card style after successful claim
                                const taskCard = document.querySelector(`[data-task-id="${taskId}"]`);
                                if (taskCard) {
                                    // Update progress indicator
                                    const progressBar = taskCard.querySelector('[style*="width"]');
                                    if (progressBar) {
                                        progressBar.style.width = '100%';
                                        progressBar.style.background = 'linear-gradient(90deg, rgba(16,185,129,0.8) 0%, rgba(16,185,129,1) 100%)';
                                    }
                                    
                                    const progressText = taskCard.querySelector('div[style*="font-size: 14px"]');
                                    if (progressText) {
                                        if (progressText.textContent && progressText.textContent.includes('–ü—Ä–æ–≥—Ä–µ—Å—Å:')) {
                                            progressText.textContent = '‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ';
                                            progressText.style.color = '#10b981';
                                        }
                                    }
                                    
                                    // Card style and badge already updated immediately, no need to update again
                                }
                                
                                // Update coins balance
                                fetch('/api/user_data', {
                                    method: 'POST',
                                    headers: {'Content-Type': 'application/json'},
                                    body: JSON.stringify({user_id: window.user?.id})
                                })
                                .then(res => res.json())
                                .then(data => {
                                    const coins = Math.floor(data.coins || 0);
                                    const coinsEl = document.getElementById('coins');
                                    if (coinsEl) {
                                        coinsEl.textContent = coins.toLocaleString();
                                    }
                                })
                                .catch(err => console.error('Error updating coins:', err));
                            } else {
                                console.error('Claim failed:', claimData);
                                // Remove success message if claim failed
                                const taskCard = document.querySelector(`[data-task-id="${taskId}"]`);
                                if (taskCard) {
                                    const successMsg = taskCard.querySelector('[data-claimed-message="true"]');
                                    if (successMsg) {
                                        successMsg.remove();
                                    }
                                }
                            }
                        })
                        .catch(err => {
                            console.error('Error claiming reward:', err);
                            // Remove success message if error
                            const taskCard = document.querySelector(`[data-task-id="${taskId}"]`);
                            if (taskCard) {
                                const successMsg = taskCard.querySelector('[data-claimed-message="true"]');
                                if (successMsg) {
                                    successMsg.remove();
                                }
                            }
                        });
                } else {
                    console.log('‚ùå User is NOT subscribed');
                    // Not subscribed - show error and restore button
                    restoreButton();
                    const errorMessage = '–í—ã –µ—â—ë –Ω–µ –ø–æ–¥–ø–∏—Å–∞–ª–∏—Å—å –Ω–∞ –∫–∞–Ω–∞–ª @quantum_nexus\n\nüì¢ –ü–æ–¥–ø–∏—à–∏—Ç–µ—Å—å –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞!';
                    if (window.tg && tg.showAlert) {
                        tg.showAlert('‚ùå ' + errorMessage);
                    } else {
                        alert('‚ùå ' + errorMessage);
                    }
                }
            })
            .catch(err => {
                console.error('Verification fetch error:', err);
                // Restore button on error
                if (verifyButton && originalText) {
                    verifyButton.disabled = false;
                    verifyButton.style.opacity = '1';
                    verifyButton.style.cursor = 'pointer';
                    verifyButton.style.pointerEvents = 'auto';
                    verifyButton.textContent = originalText;
                }
                try {
                    if (window.tg && tg.showAlert) {
                        tg.showAlert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–ø–∏—Å–∫–∏: ' + err.message);
                    } else {
                        alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–ø–∏—Å–∫–∏: ' + err.message);
                    }
                } catch(e) {}
            });
        }
        
        let currentCategory = 'all';
        
        // Currency Products Data - VIP Style
        const currencyProductsData = [
            // STARTER CATEGORY - –û—Ç 20,000 –¥–æ 200,000 –∫–æ–∏–Ω–æ–≤
            {id: 1, category: 'starter', name: '–ü–µ—Ä–≤—ã–µ —à–∞–≥–∏', nameEmoji: 'üí´', emoji: 'üåü', reward: '20,000 –∫–æ–∏–Ω–æ–≤', rewardIcon: 'üí∞', price: 50, description: 'üåü –°—Ç–∞—Ä—Ç–æ–≤—ã–π –ø–∞–∫–µ—Ç –¥–ª—è –Ω–æ–≤–∏—á–∫–æ–≤ —Å –±–∞–∑–æ–≤—ã–º –∫–∞–ø–∏—Ç–∞–ª–æ–º', badge: '–°–¢–ê–†–¢', badgeColor: '#667eea', cardColor: 'rgba(102,126,234,0.12),rgba(139,92,246,0.18)', borderColor: 'rgba(102,126,234,0.3)', hoverColor: 'rgba(102,126,234,0.25)', btnColor: '#667eea,#764ba2', iconShadow: 'rgba(102,126,234,0.6)'},
            {id: 2, category: 'starter', name: '–ë–∞–∑–æ–≤—ã–π —Å—Ç–∞—Ä—Ç', nameEmoji: '‚ú®', emoji: 'üöÄ', reward: '40,000 –∫–æ–∏–Ω–æ–≤', rewardIcon: 'üí∞', price: 120, description: 'üöÄ –£—Å–∫–æ—Ä–µ–Ω–Ω—ã–π –≤—Ö–æ–¥ –≤ –∏–≥—Ä—É —Å –≤—ã–≥–æ–¥–Ω—ã–º –±–æ–Ω—É—Å–æ–º', badge: '', badgeColor: '', cardColor: 'rgba(102,126,234,0.12),rgba(139,92,246,0.18)', borderColor: 'rgba(102,126,234,0.3)', hoverColor: 'rgba(102,126,234,0.25)', btnColor: '#667eea,#764ba2', iconShadow: 'rgba(102,126,234,0.6)'},
            {id: 3, category: 'starter', name: '–ù–∞—á–∞–ª–æ –ø—É—Ç–∏', nameEmoji: '‚≠ê', emoji: 'üíé', reward: '60,000 –∫–æ–∏–Ω–æ–≤', rewardIcon: 'üí∞', price: 180, description: 'üíé –°–æ–ª–∏–¥–Ω—ã–π –∫–∞–ø–∏—Ç–∞–ª –¥–ª—è —É–≤–µ—Ä–µ–Ω–Ω–æ–≥–æ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞', badge: '', badgeColor: '', cardColor: 'rgba(102,126,234,0.12),rgba(139,92,246,0.18)', borderColor: 'rgba(102,126,234,0.3)', hoverColor: 'rgba(102,126,234,0.25)', btnColor: '#667eea,#764ba2', iconShadow: 'rgba(102,126,234,0.6)'},
            {id: 4, category: 'starter', name: '–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π', nameEmoji: 'üíé', emoji: 'üéÅ', reward: '80,000 –∫–æ–∏–Ω–æ–≤', rewardIcon: 'üí∞', price: 240, description: 'üéÅ –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π –±–æ–Ω—É—Å –¥–ª—è –Ω–æ–≤—ã—Ö –∏–≥—Ä–æ–∫–æ–≤', badge: '', badgeColor: '', cardColor: 'rgba(102,126,234,0.12),rgba(139,92,246,0.18)', borderColor: 'rgba(102,126,234,0.3)', hoverColor: 'rgba(102,126,234,0.25)', btnColor: '#667eea,#764ba2', iconShadow: 'rgba(102,126,234,0.6)'},
            {id: 5, category: 'starter', name: '–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å', nameEmoji: 'üéÅ', emoji: '‚ö°', reward: '100,000 –∫–æ–∏–Ω–æ–≤', rewardIcon: 'üí∞', price: 320, description: '‚ö° –ú–æ—â–Ω—ã–π —Å—Ç–∞—Ä—Ç–æ–≤—ã–π –∏–º–ø—É–ª—å—Å –≤ –∫–≤–∞–Ω—Ç–æ–≤–æ–π –≤—Å–µ–ª–µ–Ω–Ω–æ–π', badge: '', badgeColor: '', cardColor: 'rgba(102,126,234,0.12),rgba(139,92,246,0.18)', borderColor: 'rgba(102,126,234,0.3)', hoverColor: 'rgba(102,126,234,0.25)', btnColor: '#667eea,#764ba2', iconShadow: 'rgba(102,126,234,0.6)'},
            {id: 6, category: 'starter', name: '–°—Ç–∞—Ä—Ç–æ–≤—ã–π –ø–∞–∫–µ—Ç', nameEmoji: 'üí∞', emoji: 'üèÜ', reward: '120,000 –∫–æ–∏–Ω–æ–≤', rewardIcon: 'üí∞', price: 400, description: 'üèÜ –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –Ω–∞–±–æ—Ä –¥–ª—è —Å–µ—Ä—å—ë–∑–Ω—ã—Ö –∏–≥—Ä–æ–∫–æ–≤', badge: '', badgeColor: '', cardColor: 'rgba(102,126,234,0.12),rgba(139,92,246,0.18)', borderColor: 'rgba(102,126,234,0.3)', hoverColor: 'rgba(102,126,234,0.25)', btnColor: '#667eea,#764ba2', iconShadow: 'rgba(102,126,234,0.6)'},
            {id: 7, category: 'starter', name: '–ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç', nameEmoji: '‚ö°', emoji: 'üåü', reward: '140,000 –∫–æ–∏–Ω–æ–≤', rewardIcon: 'üí∞', price: 480, description: 'üåü –ú–æ–ª–Ω–∏–µ–Ω–æ—Å–Ω—ã–π —Ä–æ—Å—Ç —Å –ø—Ä–µ–º–∏—É–º –∫–∞–ø–∏—Ç–∞–ª–æ–º', badge: '', badgeColor: '', cardColor: 'rgba(102,126,234,0.12),rgba(139,92,246,0.18)', borderColor: 'rgba(102,126,234,0.3)', hoverColor: 'rgba(102,126,234,0.25)', btnColor: '#667eea,#764ba2', iconShadow: 'rgba(102,126,234,0.6)'},
            {id: 8, category: 'starter', name: '–ü–µ—Ä–≤—ã–π —à–∞–≥', nameEmoji: 'üéØ', emoji: 'üí´', reward: '160,000 –∫–æ–∏–Ω–æ–≤', rewardIcon: 'üí∞', price: 560, description: 'üí´ –¢–æ—á–Ω–æ –≤ —Ü–µ–ª—å - –∏–¥–µ–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ä—Ç –¥–ª—è –∞–º–±–∏—Ü–∏–æ–∑–Ω—ã—Ö', badge: '', badgeColor: '', cardColor: 'rgba(102,126,234,0.12),rgba(139,92,246,0.18)', borderColor: 'rgba(102,126,234,0.3)', hoverColor: 'rgba(102,126,234,0.25)', btnColor: '#667eea,#764ba2', iconShadow: 'rgba(102,126,234,0.6)'},
            {id: 9, category: 'starter', name: '–†–∞–¥—É–∂–Ω—ã–π –Ω–∞–±–æ—Ä', nameEmoji: 'üåà', emoji: 'üíñ', reward: '180,000 –∫–æ–∏–Ω–æ–≤', rewardIcon: 'üí∞', price: 640, description: 'üíñ –†–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π –∏ —è—Ä–∫–∏—Ö –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤', badge: '', badgeColor: '', cardColor: 'rgba(102,126,234,0.12),rgba(139,92,246,0.18)', borderColor: 'rgba(102,126,234,0.3)', hoverColor: 'rgba(102,126,234,0.25)', btnColor: '#667eea,#764ba2', iconShadow: 'rgba(102,126,234,0.6)'},
            {id: 10, category: 'starter', name: '–í–æ–ª—à–µ–±–Ω—ã–π —Å—Ç–∞—Ä—Ç', nameEmoji: 'üí´', emoji: 'üîÆ', reward: '200,000 –∫–æ–∏–Ω–æ–≤', rewardIcon: 'üí∞', price: 720, description: 'üîÆ –ú–∞–≥–∏—á–µ—Å–∫–æ–µ –Ω–∞—á–∞–ª–æ –≤–∞—à–µ–≥–æ –∫–≤–∞–Ω—Ç–æ–≤–æ–≥–æ –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏—è', badge: '', badgeColor: '', cardColor: 'rgba(102,126,234,0.12),rgba(139,92,246,0.18)', borderColor: 'rgba(102,126,234,0.3)', hoverColor: 'rgba(102,126,234,0.25)', btnColor: '#667eea,#764ba2', iconShadow: 'rgba(102,126,234,0.6)'},
            // PREMIUM CATEGORY - –û—Ç 120,000 –¥–æ 500,000 –∫–æ–∏–Ω–æ–≤
            {id: 11, category: 'premium', name: '–°–≤–µ—Ç–æ–≤–æ–π –ø–∞–∫–µ—Ç', nameEmoji: '‚ö°', emoji: 'üåü', reward: '120,000 –∫–æ–∏–Ω–æ–≤', rewardIcon: 'üí∞', price: 300, description: 'üåü –Ø—Ä–∫–∏–π —Å–≤–µ—Ç –≤–∞—à–µ–≥–æ —É—Å–ø–µ—Ö–∞ –∏ –±—ã—Å—Ç—Ä–æ–≥–æ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞', badge: '', badgeColor: '', cardColor: 'rgba(234,179,8,0.12),rgba(245,158,11,0.18)', borderColor: 'rgba(234,179,8,0.3)', hoverColor: 'rgba(234,179,8,0.25)', btnColor: '#f59e0b,#f59e0b', iconShadow: 'rgba(234,179,8,0.6)'},
            {id: 12, category: 'premium', name: '–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª', nameEmoji: 'üéØ', emoji: 'üèÖ', reward: '160,000 –∫–æ–∏–Ω–æ–≤', rewardIcon: 'üí∞', price: 600, description: 'üèÖ –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å –∏–≥—Ä—ã —Å –ø—Ä–µ–º–∏—É–º –±–æ–Ω—É—Å–∞–º–∏', badge: '', badgeColor: '', cardColor: 'rgba(234,179,8,0.12),rgba(245,158,11,0.18)', borderColor: 'rgba(234,179,8,0.3)', hoverColor: 'rgba(234,179,8,0.25)', btnColor: '#f59e0b,#f59e0b', iconShadow: 'rgba(234,179,8,0.6)'},
            {id: 13, category: 'premium', name: '–ú–æ—â–Ω—ã–π –Ω–∞–±–æ—Ä', nameEmoji: 'üöÄ', emoji: 'üí•', reward: '220,000 –∫–æ–∏–Ω–æ–≤', rewardIcon: 'üí∞', price: 900, description: 'üí• –ú–æ—â–Ω—ã–π —Ä—ã–≤–æ–∫ –∫ –≤–µ—Ä—à–∏–Ω–∞–º –∫–≤–∞–Ω—Ç–æ–≤–æ–≥–æ —É—Å–ø–µ—Ö–∞', badge: '', badgeColor: '', cardColor: 'rgba(234,179,8,0.12),rgba(245,158,11,0.18)', borderColor: 'rgba(234,179,8,0.3)', hoverColor: 'rgba(234,179,8,0.25)', btnColor: '#f59e0b,#f59e0b', iconShadow: 'rgba(234,179,8,0.6)'},
            {id: 14, category: 'premium', name: '–ê–ª–º–∞–∑–Ω—ã–π –ø–∞–∫–µ—Ç', nameEmoji: 'üíé', emoji: '‚ú®', reward: '280,000 –∫–æ–∏–Ω–æ–≤', rewardIcon: 'üí∞', price: 1200, description: '‚ú® –ù–µ–ø—Ä–µ–≤–∑–æ–π–¥—ë–Ω–Ω–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ –∏ –∞–ª–º–∞–∑–Ω–∞—è –ø—Ä–æ—á–Ω–æ—Å—Ç—å', badge: '', badgeColor: '', cardColor: 'rgba(234,179,8,0.12),rgba(245,158,11,0.18)', borderColor: 'rgba(234,179,8,0.3)', hoverColor: 'rgba(234,179,8,0.25)', btnColor: '#f59e0b,#f59e0b', iconShadow: 'rgba(234,179,8,0.6)'},
            {id: 15, category: 'premium', name: '–û–≥–Ω–µ–Ω–Ω—ã–π –Ω–∞–±–æ—Ä', nameEmoji: 'üî•', emoji: '‚ö°', reward: '340,000 –∫–æ–∏–Ω–æ–≤', rewardIcon: 'üí∞', price: 1500, description: '‚ö° –ü–ª–∞–º–µ–Ω–Ω–∞—è —ç–Ω–µ—Ä–≥–∏—è –¥–ª—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–≥–æ —Ä–æ—Å—Ç–∞', badge: '', badgeColor: '', cardColor: 'rgba(234,179,8,0.12),rgba(245,158,11,0.18)', borderColor: 'rgba(234,179,8,0.3)', hoverColor: 'rgba(234,179,8,0.25)', btnColor: '#f59e0b,#f59e0b', iconShadow: 'rgba(234,179,8,0.6)'},
            {id: 16, category: 'premium', name: '–≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã–π', nameEmoji: '‚ö°', emoji: 'üíª', reward: '380,000 –∫–æ–∏–Ω–æ–≤', rewardIcon: 'üí∞', price: 1800, description: 'üíª –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –±—É—Å—Ç –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏', badge: '', badgeColor: '', cardColor: 'rgba(234,179,8,0.12),rgba(245,158,11,0.18)', borderColor: 'rgba(234,179,8,0.3)', hoverColor: 'rgba(234,179,8,0.25)', btnColor: '#f59e0b,#f59e0b', iconShadow: 'rgba(234,179,8,0.6)'},
            {id: 17, category: 'premium', name: '–ó–≤—ë–∑–¥–Ω—ã–π –ø–∞–∫–µ—Ç', nameEmoji: 'üåü', emoji: '‚≠ê', reward: '420,000 –∫–æ–∏–Ω–æ–≤', rewardIcon: 'üí∞', price: 2100, description: '‚≠ê –î–æ—Å—Ç–∏–≥–Ω–∏—Ç–µ –∑–≤—ë–∑–¥–Ω–æ–≥–æ —É—Ä–æ–≤–Ω—è –≤ –∫–≤–∞–Ω—Ç–æ–≤–æ–π —Å–∏—Å—Ç–µ–º–µ', badge: '', badgeColor: '', cardColor: 'rgba(234,179,8,0.12),rgba(245,158,11,0.18)', borderColor: 'rgba(234,179,8,0.3)', hoverColor: 'rgba(234,179,8,0.25)', btnColor: '#f59e0b,#f59e0b', iconShadow: 'rgba(234,179,8,0.6)'},
            {id: 18, category: 'premium', name: '–ö–æ—Å–º–∏—á–µ—Å–∫–∏–π', nameEmoji: 'üí´', emoji: 'üåå', reward: '450,000 –∫–æ–∏–Ω–æ–≤', rewardIcon: 'üí∞', price: 2400, description: 'üåå –ó–∞–ø—É—Å–∫ –≤ –∫–æ—Å–º–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ—Å—Ç–æ—Ä—ã –∫–≤–∞–Ω—Ç–æ–≤–æ–≥–æ –º–∏—Ä–∞', badge: '', badgeColor: '', cardColor: 'rgba(234,179,8,0.12),rgba(245,158,11,0.18)', borderColor: 'rgba(234,179,8,0.3)', hoverColor: 'rgba(234,179,8,0.25)', btnColor: '#f59e0b,#f59e0b', iconShadow: 'rgba(234,179,8,0.6)'},
            {id: 19, category: 'premium', name: '–ü–æ–¥–∞—Ä–æ—á–Ω—ã–π VIP', nameEmoji: 'üéÅ', emoji: 'üëë', reward: '480,000 –∫–æ–∏–Ω–æ–≤', rewardIcon: 'üí∞', price: 2700, description: 'üëë –û—Å–æ–±—ã–π –ø–æ–¥–∞—Ä–æ—á–Ω—ã–π VIP —Å—Ç–∞—Ç—É—Å —Å —ç–∫—Å–∫–ª—é–∑–∏–≤–æ–º', badge: '', badgeColor: '', cardColor: 'rgba(234,179,8,0.12),rgba(245,158,11,0.18)', borderColor: 'rgba(234,179,8,0.3)', hoverColor: 'rgba(234,179,8,0.25)', btnColor: '#f59e0b,#f59e0b', iconShadow: 'rgba(234,179,8,0.6)'},
            {id: 20, category: 'premium', name: '–ú–∞–≥–∏—á–µ—Å–∫–∏–π', nameEmoji: 'üîÆ', emoji: '‚ú®', reward: '500,000 –∫–æ–∏–Ω–æ–≤', rewardIcon: 'üí∞', price: 3000, description: '‚ú® –í–æ–ª—à–µ–±–Ω–∞—è —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è –≤–∞—à–µ–≥–æ –∫–≤–∞–Ω—Ç–æ–≤–æ–≥–æ –±—É–¥—É—â–µ–≥–æ', badge: '', badgeColor: '', cardColor: 'rgba(234,179,8,0.12),rgba(245,158,11,0.18)', borderColor: 'rgba(234,179,8,0.3)', hoverColor: 'rgba(234,179,8,0.25)', btnColor: '#f59e0b,#f59e0b', iconShadow: 'rgba(234,179,8,0.6)'},
            // VIP CATEGORY - –û—Ç 400,000 –¥–æ 2,000,000 –∫–æ–∏–Ω–æ–≤
            {id: 21, category: 'vip', name: 'VIP —Å—Ç–∞—Ä—Ç–æ–≤—ã–π', nameEmoji: 'üíé', emoji: 'üëë', reward: '400,000 –∫–æ–∏–Ω–æ–≤', rewardIcon: 'üí∞', price: 1000, description: 'üëë –ü—Ä–∏–≤–∏–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –Ω–∞—á–∞–ª–æ VIP –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏—è', badge: '', cardColor: 'rgba(255,215,0,0.12),rgba(255,237,78,0.18)', borderColor: 'rgba(255,215,0,0.3)', hoverColor: 'rgba(255,215,0,0.25)', btnColor: '#ffd700,#ffd700', iconShadow: 'rgba(255,215,0,0.6)'},
            {id: 22, category: 'vip', name: 'VIP —É—Å–∫–æ—Ä–µ–Ω–∏–µ', nameEmoji: 'üöÄ', emoji: '‚ö°', reward: '600,000 –∫–æ–∏–Ω–æ–≤', rewardIcon: 'üí∞', price: 1600, description: '‚ö° –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∏ —Ç—É—Ä–±–æ-—Ä–µ–∂–∏–º VIP', badge: '', cardColor: 'rgba(255,215,0,0.12),rgba(255,237,78,0.18)', borderColor: 'rgba(255,215,0,0.3)', hoverColor: 'rgba(255,215,0,0.25)', btnColor: '#ffd700,#ffd700', iconShadow: 'rgba(255,215,0,0.6)'},
            {id: 23, category: 'vip', name: 'VIP —Å—Ç–∞—Ç—É—Å', nameEmoji: 'üëë', emoji: 'üåü', reward: '800,000 –∫–æ–∏–Ω–æ–≤', rewardIcon: 'üí∞', price: 2400, description: 'üåü –≠–∫—Å–∫–ª—é–∑–∏–≤–Ω—ã–π —Å—Ç–∞—Ç—É—Å —Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–º–∏ –ø—Ä–∏–≤–∏–ª–µ–≥–∏—è–º–∏', badge: '', cardColor: 'rgba(255,215,0,0.12),rgba(255,237,78,0.18)', borderColor: 'rgba(255,215,0,0.3)', hoverColor: 'rgba(255,215,0,0.25)', btnColor: '#ffd700,#ffd700', iconShadow: 'rgba(255,215,0,0.6)'},
            {id: 24, category: 'vip', name: 'VIP —Ç—É—Ä–±–æ', nameEmoji: '‚ö°', emoji: 'üí•', reward: '1,000,000 –∫–æ–∏–Ω–æ–≤', rewardIcon: 'üí∞', price: 3200, description: 'üí• –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å –∏ VIP —Ç—É—Ä–±–æ-–±—É—Å—Ç', badge: '', cardColor: 'rgba(255,215,0,0.12),rgba(255,237,78,0.18)', borderColor: 'rgba(255,215,0,0.3)', hoverColor: 'rgba(255,215,0,0.25)', btnColor: '#ffd700,#ffd700', iconShadow: 'rgba(255,215,0,0.6)'},
            {id: 25, category: 'vip', name: 'VIP –∫–æ—Ä–æ–ª–µ–≤—Å—Ç–≤–æ', nameEmoji: 'üíé', emoji: 'üè∞', reward: '1,200,000 –∫–æ–∏–Ω–æ–≤', rewardIcon: 'üí∞', price: 4000, description: 'üè∞ –ö–æ—Ä–æ–ª–µ–≤—Å–∫–∏–π —É—Ä–æ–≤–µ–Ω—å —Å –±–µ–∑–≥—Ä–∞–Ω–∏—á–Ω—ã–º–∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è–º–∏', badge: '', cardColor: 'rgba(255,215,0,0.12),rgba(255,237,78,0.18)', borderColor: 'rgba(255,215,0,0.3)', hoverColor: 'rgba(255,215,0,0.25)', btnColor: '#ffd700,#ffd700', iconShadow: 'rgba(255,215,0,0.6)'},
            {id: 26, category: 'vip', name: 'VIP –±–µ–∑–ª–∏–º–∏—Ç', nameEmoji: 'üîì', emoji: '‚ôæÔ∏è', reward: '1,400,000 –∫–æ–∏–Ω–æ–≤', rewardIcon: 'üí∞', price: 5000, description: '‚ôæÔ∏è –ù–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–∞—è –º–æ—â—å –∏ –±–µ—Å–∫—Ä–∞–π–Ω–∏–µ –≥–æ—Ä–∏–∑–æ–Ω—Ç—ã', badge: '', cardColor: 'rgba(255,215,0,0.12),rgba(255,237,78,0.18)', borderColor: 'rgba(255,215,0,0.3)', hoverColor: 'rgba(255,215,0,0.25)', btnColor: '#ffd700,#ffd700', iconShadow: 'rgba(255,215,0,0.6)'},
            {id: 27, category: 'vip', name: 'VIP —á–µ–º–ø–∏–æ–Ω', nameEmoji: 'üèÜ', emoji: '‚≠ê', reward: '1,600,000 –∫–æ–∏–Ω–æ–≤', rewardIcon: 'üí∞', price: 6000, description: '‚≠ê –ß–µ–º–ø–∏–æ–Ω—Å–∫–∏–π —Å—Ç–∞—Ç—É—Å –≤ –∫–≤–∞–Ω—Ç–æ–≤–æ–π –ª–∏–≥–µ', badge: '', cardColor: 'rgba(255,215,0,0.12),rgba(255,237,78,0.18)', borderColor: 'rgba(255,215,0,0.3)', hoverColor: 'rgba(255,215,0,0.25)', btnColor: '#ffd700,#ffd700', iconShadow: 'rgba(255,215,0,0.6)'},
            {id: 28, category: 'vip', name: 'VIP –ª–µ–≥–µ–Ω–¥–∞', nameEmoji: 'üåü', emoji: 'üå†', reward: '1,800,000 –∫–æ–∏–Ω–æ–≤', rewardIcon: 'üí∞', price: 7000, description: 'üå† –õ–µ–≥–µ–Ω–¥–∞—Ä–Ω–æ–µ –∏–º—è –≤ –∏—Å—Ç–æ—Ä–∏–∏ –∫–≤–∞–Ω—Ç–æ–≤–æ–≥–æ –º–∏—Ä–∞', badge: '', cardColor: 'rgba(255,215,0,0.12),rgba(255,237,78,0.18)', borderColor: 'rgba(255,215,0,0.3)', hoverColor: 'rgba(255,215,0,0.25)', btnColor: '#ffd700,#ffd700', iconShadow: 'rgba(255,215,0,0.6)'},
            {id: 29, category: 'vip', name: 'VIP –∞–ª–º–∞–∑', nameEmoji: 'üíé', emoji: 'üî∑', reward: '1,900,000 –∫–æ–∏–Ω–æ–≤', rewardIcon: 'üí∞', price: 8000, description: 'üî∑ –ê–ª–º–∞–∑–Ω–∞—è —á–∏—Å—Ç–æ—Ç–∞ –∏ —Å–æ–≤–µ—Ä—à–µ–Ω—Å—Ç–≤–æ VIP –∫–ª–∞—Å—Å–∞', badge: '', cardColor: 'rgba(255,215,0,0.12),rgba(255,237,78,0.18)', borderColor: 'rgba(255,215,0,0.3)', hoverColor: 'rgba(255,215,0,0.25)', btnColor: '#ffd700,#ffd700', iconShadow: 'rgba(255,215,0,0.6)'},
            {id: 30, category: 'vip', name: 'VIP –∏–º–ø–µ—Ä–∞—Ç–æ—Ä', nameEmoji: 'üëë', emoji: 'üåç', reward: '2,000,000 –∫–æ–∏–Ω–æ–≤', rewardIcon: 'üí∞', price: 9000, description: 'üåç –ò–º–ø–µ—Ä—Å–∫–æ–µ –≤–ª–∏—è–Ω–∏–µ –≤–æ –≤—Å–µ–π –∫–≤–∞–Ω—Ç–æ–≤–æ–π –≤—Å–µ–ª–µ–Ω–Ω–æ–π', badge: '', cardColor: 'rgba(255,215,0,0.12),rgba(255,237,78,0.18)', borderColor: 'rgba(255,215,0,0.3)', hoverColor: 'rgba(255,215,0,0.25)', btnColor: '#ffd700,#ffd700', iconShadow: 'rgba(255,215,0,0.6)'},
            // LIMITED/QUANHASH CATEGORY - –û—Ç 500 –¥–æ 300,000 QuanHash
            {id: 31, category: 'limited', name: 'Starter Hash', nameEmoji: 'üîÆ', emoji: 'üîÆ', description: 'üå± –ü–µ—Ä–≤—ã–µ —à–∞–≥–∏ –≤ –∫–≤–∞–Ω—Ç–æ–≤–æ–º –º–∞–π–Ω–∏–Ω–≥–µ —Å –±–∞–∑–æ–≤—ã–º –∫–∞–ø–∏—Ç–∞–ª–æ–º', reward: '500 QuanHash', rewardIcon: 'üíé', price: 150, badge: '', cardColor: 'rgba(239,68,68,0.12),rgba(220,38,38,0.18)', borderColor: 'rgba(239,68,68,0.3)', hoverColor: 'rgba(239,68,68,0.25)', btnColor: '#ef4444,#ef4444', iconShadow: 'rgba(239,68,68,0.6)'},
            {id: 32, category: 'limited', name: 'Basic Hash', nameEmoji: 'üíé', emoji: 'üíé', description: '‚öõÔ∏è –ë–∞–∑–æ–≤–∞—è –º–æ—â–Ω–æ—Å—Ç—å –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ–≥–æ –∫–≤–∞–Ω—Ç–æ–≤–æ–≥–æ –º–∞–π–Ω–∏–Ω–≥–∞', reward: '7,000 QuanHash', rewardIcon: 'üíé', price: 300, badge: '', cardColor: 'rgba(239,68,68,0.12),rgba(220,38,38,0.18)', borderColor: 'rgba(239,68,68,0.3)', hoverColor: 'rgba(239,68,68,0.25)', btnColor: '#ef4444,#ef4444', iconShadow: 'rgba(239,68,68,0.6)'},
            {id: 33, category: 'limited', name: 'Power Hash', nameEmoji: '‚ö°', emoji: '‚ö°', description: 'üî• –ü–æ–≤—ã—à–µ–Ω–Ω–∞—è —ç–Ω–µ—Ä–≥–∏—è –∫–≤–∞–Ω—Ç–æ–≤—ã—Ö –≤—ã—á–∏—Å–ª–µ–Ω–∏–π', reward: '15,000 QuanHash', rewardIcon: 'üíé', price: 600, badge: '', cardColor: 'rgba(239,68,68,0.12),rgba(220,38,38,0.18)', borderColor: 'rgba(239,68,68,0.3)', hoverColor: 'rgba(239,68,68,0.25)', btnColor: '#ef4444,#ef4444', iconShadow: 'rgba(239,68,68,0.6)'},
            {id: 34, category: 'limited', name: 'Fire Hash', nameEmoji: 'üî•', emoji: 'üî•', description: 'üí• –û–≥–Ω–µ–Ω–Ω–∞—è –º–æ—â—å –∫–≤–∞–Ω—Ç–æ–≤–æ–π –¥–æ–±—ã—á–∏ —Ä–µ—Å—É—Ä—Å–æ–≤', reward: '30,000 QuanHash', rewardIcon: 'üíé', price: 900, badge: '', cardColor: 'rgba(239,68,68,0.12),rgba(220,38,38,0.18)', borderColor: 'rgba(239,68,68,0.3)', hoverColor: 'rgba(239,68,68,0.25)', btnColor: '#ef4444,#ef4444', iconShadow: 'rgba(239,68,68,0.6)'},
            {id: 35, category: 'limited', name: 'Blast Hash', nameEmoji: 'üí•', emoji: 'üí•', description: 'üåü –í–∑—Ä—ã–≤–Ω–æ–π —Ä–æ—Å—Ç –º–∞–π–Ω–∏–Ω–≥–æ–≤—ã—Ö –º–æ—â–Ω–æ—Å—Ç–µ–π', reward: '60,000 QuanHash', rewardIcon: 'üíé', price: 1500, badge: '', cardColor: 'rgba(239,68,68,0.12),rgba(220,38,38,0.18)', borderColor: 'rgba(239,68,68,0.3)', hoverColor: 'rgba(239,68,68,0.25)', btnColor: '#ef4444,#ef4444', iconShadow: 'rgba(239,68,68,0.6)'},
            {id: 36, category: 'limited', name: 'Stellar Hash', nameEmoji: 'üåü', emoji: 'üåü', description: '‚≠ê –ó–≤—ë–∑–¥–Ω–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∫–≤–∞–Ω—Ç–æ–≤–æ–≥–æ –º–∞–π–Ω–µ—Ä–∞', reward: '100,000 QuanHash', rewardIcon: 'üíé', price: 2400, badge: '', cardColor: 'rgba(239,68,68,0.12),rgba(220,38,38,0.18)', borderColor: 'rgba(239,68,68,0.3)', hoverColor: 'rgba(239,68,68,0.25)', btnColor: '#ef4444,#ef4444', iconShadow: 'rgba(239,68,68,0.6)'},
            {id: 37, category: 'limited', name: 'Diamond Hash', nameEmoji: 'üíé', emoji: 'üíé', description: 'üî∑ –ê–ª–º–∞–∑–Ω–∞—è —á–∏—Å—Ç–æ—Ç–∞ –∫–≤–∞–Ω—Ç–æ–≤—ã—Ö –≤—ã—á–∏—Å–ª–µ–Ω–∏–π', reward: '150,000 QuanHash', rewardIcon: 'üíé', price: 3600, badge: '', cardColor: 'rgba(239,68,68,0.12),rgba(220,38,38,0.18)', borderColor: 'rgba(239,68,68,0.3)', hoverColor: 'rgba(239,68,68,0.25)', btnColor: '#ef4444,#ef4444', iconShadow: 'rgba(239,68,68,0.6)'},
            {id: 38, category: 'limited', name: 'Rocket Hash', nameEmoji: 'üöÄ', emoji: 'üöÄ', description: 'üåå –†–∞–∫–µ—Ç–Ω—ã–π –∑–∞–ø—É—Å–∫ –≤ –∫–æ—Å–º–∏—á–µ—Å–∫–∏–π –º–∞–π–Ω–∏–Ω–≥', reward: '200,000 QuanHash', rewardIcon: 'üíé', price: 5100, badge: '', cardColor: 'rgba(239,68,68,0.12),rgba(220,38,38,0.18)', borderColor: 'rgba(239,68,68,0.3)', hoverColor: 'rgba(239,68,68,0.25)', btnColor: '#ef4444,#ef4444', iconShadow: 'rgba(239,68,68,0.6)'},
            {id: 39, category: 'limited', name: 'Crown Hash', nameEmoji: 'üëë', emoji: 'üëë', description: 'üè∞ –ö–æ—Ä–æ–ª–µ–≤—Å–∫–∞—è –º–æ—â—å –∫–≤–∞–Ω—Ç–æ–≤—ã—Ö —Ñ–µ—Ä–º', reward: '250,000 QuanHash', rewardIcon: 'üíé', price: 7200, badge: '', cardColor: 'rgba(239,68,68,0.12),rgba(220,38,38,0.18)', borderColor: 'rgba(239,68,68,0.3)', hoverColor: 'rgba(239,68,68,0.25)', btnColor: '#ef4444,#ef4444', iconShadow: 'rgba(239,68,68,0.6)'},
            {id: 40, category: 'limited', name: 'Ultimate Hash', nameEmoji: 'üí´', emoji: 'üí´', description: '‚ôæÔ∏è –ê–±—Å–æ–ª—é—Ç–Ω–∞—è –º–æ—â—å –∫–≤–∞–Ω—Ç–æ–≤–æ–≥–æ –º–∞–π–Ω–∏–Ω–≥–∞', reward: '300,000 QuanHash', rewardIcon: 'üíé', price: 10000, badge: '', cardColor: 'rgba(239,68,68,0.12),rgba(220,38,38,0.18)', borderColor: 'rgba(239,68,68,0.3)', hoverColor: 'rgba(239,68,68,0.25)', btnColor: '#ef4444,#ef4444', iconShadow: 'rgba(239,68,68,0.6)'},
            // ULTRA/COMBO CATEGORY - –° –∫–∞—Ä—Ç–æ—á–∫–∞–º–∏ –∏ –∫–æ–∏–Ω–∞–º–∏
            {id: 41, category: 'ultra', name: '–°—Ç–∞—Ä—Ç–æ–≤—ã–π –º–µ–≥–∞—Å–µ—Ç', nameEmoji: 'üéÅ', emoji: 'üíé', reward: '10 –∫–∞—Ä—Ç–æ—á–µ–∫ + 300,000 –∫–æ–∏–Ω–æ–≤', rewardIcon: 'üí∞', price: 5000, description: 'üíé –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –Ω–∞–±–æ—Ä –¥–ª—è –∫–æ–º–ø–ª–µ–∫—Å–Ω–æ–≥–æ —Å—Ç–∞—Ä—Ç–∞', badge: '', cardColor: 'rgba(168,85,247,0.12),rgba(139,92,246,0.18)', borderColor: 'rgba(168,85,247,0.3)', hoverColor: 'rgba(168,85,247,0.25)', btnColor: '#a855f7,#8b5cf6', iconShadow: 'rgba(168,85,247,0.6)'},
            {id: 42, category: 'ultra', name: '–ì–æ—Ä—è—á–∏–π –∫–æ–º–±–æ', nameEmoji: 'üî•', emoji: '‚ö°', reward: '20 –∫–∞—Ä—Ç–æ—á–µ–∫ + 800,000 –∫–æ–∏–Ω–æ–≤', rewardIcon: 'üí∞', price: 7000, description: '‚ö° –û–≥–Ω–µ–Ω–Ω–∞—è —Å–≤—è–∑–∫–∞ –∫–∞—Ä—Ç –∏ –º–æ—â–Ω—ã—Ö –±–æ–Ω—É—Å–æ–≤', badge: '', cardColor: 'rgba(168,85,247,0.12),rgba(139,92,246,0.18)', borderColor: 'rgba(168,85,247,0.3)', hoverColor: 'rgba(168,85,247,0.25)', btnColor: '#a855f7,#8b5cf6', iconShadow: 'rgba(168,85,247,0.6)'},
            {id: 43, category: 'ultra', name: '–≠–ª–∏—Ç–Ω—ã–π –Ω–∞–±–æ—Ä', nameEmoji: 'üíé', emoji: 'üëë', reward: '50 –∫–∞—Ä—Ç–æ—á–µ–∫ + 1,500,000 –∫–æ–∏–Ω–æ–≤', rewardIcon: 'üí∞', price: 9000, description: 'üëë –≠–ª–∏—Ç–Ω—ã–π –∫–æ–º–±–æ —Å VIP –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞–º–∏', badge: '', cardColor: 'rgba(168,85,247,0.12),rgba(139,92,246,0.18)', borderColor: 'rgba(168,85,247,0.3)', hoverColor: 'rgba(168,85,247,0.25)', btnColor: '#a855f7,#8b5cf6', iconShadow: 'rgba(168,85,247,0.6)'},
            {id: 44, category: 'ultra', name: '–ú–µ–≥–∞ —Å–≤—è–∑–∫–∞', nameEmoji: 'üöÄ', emoji: 'üåü', reward: '100 –∫–∞—Ä—Ç–æ—á–µ–∫ + 2,500,000 –∫–æ–∏–Ω–æ–≤', rewardIcon: 'üí∞', price: 11000, description: 'üåü –ú–µ–≥–∞-–∫–æ–º–±–æ –¥–ª—è –∫–æ—Å–º–∏—á–µ—Å–∫–æ–≥–æ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞', badge: '', cardColor: 'rgba(168,85,247,0.12),rgba(139,92,246,0.18)', borderColor: 'rgba(168,85,247,0.3)', hoverColor: 'rgba(168,85,247,0.25)', btnColor: '#a855f7,#8b5cf6', iconShadow: 'rgba(168,85,247,0.6)'},
            {id: 45, category: 'ultra', name: '–õ–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π –º–µ–≥–∞—Å–µ—Ç', nameEmoji: 'üåü', emoji: 'üèÜ', reward: '200 –∫–∞—Ä—Ç–æ—á–µ–∫ + 4,000,000 –∫–æ–∏–Ω–æ–≤', rewardIcon: 'üí∞', price: 13000, description: 'üèÜ –õ–µ–≥–µ–Ω–¥–∞—Ä–Ω–∞—è –∫–æ–ª–ª–µ–∫—Ü–∏—è –¥–ª—è —á–µ–º–ø–∏–æ–Ω–æ–≤', badge: '', cardColor: 'rgba(168,85,247,0.12),rgba(139,92,246,0.18)', borderColor: 'rgba(168,85,247,0.3)', hoverColor: 'rgba(168,85,247,0.25)', btnColor: '#a855f7,#8b5cf6', iconShadow: 'rgba(168,85,247,0.6)'},
            {id: 46, category: 'ultra', name: '–ë—Ä–∏–ª–ª–∏–∞–Ω—Ç–æ–≤–∞—è —Å–≤—è–∑–∫–∞', nameEmoji: 'üíé', emoji: 'üî∑', reward: '500 –∫–∞—Ä—Ç–æ—á–µ–∫ + 5,500,000 –∫–æ–∏–Ω–æ–≤', rewardIcon: 'üí∞', price: 15000, description: 'üî∑ –ë—Ä–∏–ª–ª–∏–∞–Ω—Ç–æ–≤–∞—è —á–∏—Å—Ç–æ—Ç–∞ –±–µ–∑–≥—Ä–∞–Ω–∏—á–Ω—ã—Ö –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π', badge: '', cardColor: 'rgba(168,85,247,0.12),rgba(139,92,246,0.18)', borderColor: 'rgba(168,85,247,0.3)', hoverColor: 'rgba(168,85,247,0.25)', btnColor: '#a855f7,#8b5cf6', iconShadow: 'rgba(168,85,247,0.6)'},
            {id: 47, category: 'ultra', name: '–ö–æ—Ä–æ–ª–µ–≤—Å–∫–∏–π –∫–æ–º–±–æ', nameEmoji: 'üëë', emoji: 'üè∞', reward: '1000 –∫–∞—Ä—Ç–æ—á–µ–∫ + 7,000,000 –∫–æ–∏–Ω–æ–≤', rewardIcon: 'üí∞', price: 17000, description: 'üè∞ –ö–æ—Ä–æ–ª–µ–≤—Å–∫–æ–µ –≤–µ–ª–∏–∫–æ–ª–µ–ø–∏–µ –∫–≤–∞–Ω—Ç–æ–≤–æ–≥–æ –Ω–∞–±–æ—Ä–∞', badge: '', cardColor: 'rgba(168,85,247,0.12),rgba(139,92,246,0.18)', borderColor: 'rgba(168,85,247,0.3)', hoverColor: 'rgba(168,85,247,0.25)', btnColor: '#a855f7,#8b5cf6', iconShadow: 'rgba(168,85,247,0.6)'},
            {id: 48, category: 'ultra', name: '–û–≥–Ω–µ–Ω–Ω—ã–π –º–µ–≥–∞—Å–µ—Ç', nameEmoji: 'üî•', emoji: 'üí•', reward: '2000 –∫–∞—Ä—Ç–æ—á–µ–∫ + 8,500,000 –∫–æ–∏–Ω–æ–≤', rewardIcon: 'üí∞', price: 19000, description: 'üí• –ü–ª–∞–º–µ–Ω–Ω–∞—è –º–æ—â—å –º–µ–≥–∞—Å–µ—Ç–∞ —Å –±–µ–∑–≥—Ä–∞–Ω–∏—á–Ω—ã–º –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª–æ–º', badge: '', cardColor: 'rgba(168,85,247,0.12),rgba(139,92,246,0.18)', borderColor: 'rgba(168,85,247,0.3)', hoverColor: 'rgba(168,85,247,0.25)', btnColor: '#a855f7,#8b5cf6', iconShadow: 'rgba(168,85,247,0.6)'},
            {id: 49, category: 'ultra', name: '–ö–æ—Å–º–∏—á–µ—Å–∫–∏–π –∫–æ–º–±–æ', nameEmoji: 'üí´', emoji: 'üåå', reward: '5000 –∫–∞—Ä—Ç–æ—á–µ–∫ + 10,000,000 –∫–æ–∏–Ω–æ–≤', rewardIcon: 'üí∞', price: 21000, description: 'üåå –ö–æ—Å–º–∏—á–µ—Å–∫–∏–µ –º–∞—Å—à—Ç–∞–±—ã –∫–≤–∞–Ω—Ç–æ–≤–æ–≥–æ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞', badge: '', cardColor: 'rgba(168,85,247,0.12),rgba(139,92,246,0.18)', borderColor: 'rgba(168,85,247,0.3)', hoverColor: 'rgba(168,85,247,0.25)', btnColor: '#a855f7,#8b5cf6', iconShadow: 'rgba(168,85,247,0.6)'},
            {id: 50, category: 'ultra', name: '–ê–ë–°–û–õ–Æ–¢ –í–°–Å', nameEmoji: 'üéØ', emoji: '‚ôæÔ∏è', reward: '10,000 –∫–∞—Ä—Ç–æ—á–µ–∫ + 15,000,000 –∫–æ–∏–Ω–æ–≤', rewardIcon: 'üí∞', price: 24000, description: '‚ôæÔ∏è –ê–±—Å–æ–ª—é—Ç–Ω–∞—è –ø–æ–ª–Ω–æ—Ç–∞ –≤—Å–µ—Ö –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π –∏–≥—Ä—ã', badge: '', cardColor: 'rgba(168,85,247,0.12),rgba(139,92,246,0.18)', borderColor: 'rgba(168,85,247,0.3)', hoverColor: 'rgba(168,85,247,0.25)', btnColor: '#a855f7,#8b5cf6', iconShadow: 'rgba(168,85,247,0.6)'},
            // MEGA CATEGORY - –û—Ç 50,000 –¥–æ 5,000,000 –∫–æ–∏–Ω–æ–≤
            {id: 51, category: 'mega', name: 'VIP –í—Å—ë –≤–∫–ª—é—á–µ–Ω–æ', nameEmoji: 'üëë', emoji: 'üåü', reward: '50,000 –∫–æ–∏–Ω–æ–≤', rewardIcon: 'üí∞', price: 1800, description: 'üåü –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π VIP –ø–∞–∫–µ—Ç —Å–æ –≤—Å–µ–º–∏ —Ñ—É–Ω–∫—Ü–∏—è–º–∏', badge: '', cardColor: 'rgba(255,215,0,0.12),rgba(255,237,78,0.18)', borderColor: 'rgba(255,215,0,0.3)', hoverColor: 'rgba(255,215,0,0.25)', btnColor: '#ffd700,#ffd700', iconShadow: 'rgba(255,215,0,0.6)'},
            {id: 52, category: 'mega', name: '–≠–∫—Å–∫–ª—é–∑–∏–≤–Ω—ã–π –±–µ–π–¥–∂', nameEmoji: '‚≠ê', emoji: '‚ú®', reward: '600,000 –∫–æ–∏–Ω–æ–≤', rewardIcon: 'üí∞', price: 2500, description: '‚ú® –£–Ω–∏–∫–∞–ª—å–Ω–∞—è –º–µ—Ç–∫–∞ –≤–∞—à–µ–≥–æ VIP —Å—Ç–∞—Ç—É—Å–∞', badge: '', cardColor: 'rgba(255,215,0,0.12),rgba(255,237,78,0.18)', borderColor: 'rgba(255,215,0,0.3)', hoverColor: 'rgba(255,215,0,0.25)', btnColor: '#ffd700,#ffd700', iconShadow: 'rgba(255,215,0,0.6)'},
            {id: 53, category: 'mega', name: '–ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω —Ç–æ–ø', nameEmoji: 'üèÜ', emoji: 'üéØ', reward: '1,100,000 –∫–æ–∏–Ω–æ–≤', rewardIcon: 'üí∞', price: 4000, description: 'üéØ –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –º–µ—Å—Ç–æ —Å—Ä–µ–¥–∏ –ª—É—á—à–∏—Ö –∏–≥—Ä–æ–∫–æ–≤', badge: '', cardColor: 'rgba(255,215,0,0.12),rgba(255,237,78,0.18)', borderColor: 'rgba(255,215,0,0.3)', hoverColor: 'rgba(255,215,0,0.25)', btnColor: '#ffd700,#ffd700', iconShadow: 'rgba(255,215,0,0.6)'},
            {id: 54, category: 'mega', name: '–ú–≥–Ω–æ–≤–µ–Ω–Ω—ã–π –¥–æ—Ö–æ–¥', nameEmoji: '‚ö°', emoji: 'üí•', reward: '1,800,000 –∫–æ–∏–Ω–æ–≤', rewardIcon: 'üí∞', price: 6000, description: 'üí• –°—Ç–æ—Ö–æ–∫—Ä–∞—Ç–Ω–æ–µ —É—Å–∫–æ—Ä–µ–Ω–∏–µ –≤—Å–µ—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤', badge: '', cardColor: 'rgba(255,215,0,0.12),rgba(255,237,78,0.18)', borderColor: 'rgba(255,215,0,0.3)', hoverColor: 'rgba(255,215,0,0.25)', btnColor: '#ffd700,#ffd700', iconShadow: 'rgba(255,215,0,0.6)'},
            {id: 55, category: 'mega', name: '–°–Ω—è—Ç—å –ª–∏–º–∏—Ç—ã', nameEmoji: 'üîì', emoji: '‚ôæÔ∏è', reward: '2,500,000 –∫–æ–∏–Ω–æ–≤', rewardIcon: 'üí∞', price: 8000, description: '‚ôæÔ∏è –ü–æ–ª–Ω–∞—è —Å–≤–æ–±–æ–¥–∞ –±–µ–∑ –∫–∞–∫–∏—Ö-–ª–∏–±–æ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π', badge: '', cardColor: 'rgba(255,215,0,0.12),rgba(255,237,78,0.18)', borderColor: 'rgba(255,215,0,0.3)', hoverColor: 'rgba(255,215,0,0.25)', btnColor: '#ffd700,#ffd700', iconShadow: 'rgba(255,215,0,0.6)'},
            {id: 56, category: 'mega', name: '–ê–≤—Ç–æ–ø—Ä–æ–∫–∞—á–∫–∞', nameEmoji: 'üöÄ', emoji: 'ü§ñ', reward: '3,300,000 –∫–æ–∏–Ω–æ–≤', rewardIcon: 'üí∞', price: 10000, description: 'ü§ñ –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –≤—Å–µ—Ö –∏–≥—Ä–æ–≤—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤', badge: '', cardColor: 'rgba(255,215,0,0.12),rgba(255,237,78,0.18)', borderColor: 'rgba(255,215,0,0.3)', hoverColor: 'rgba(255,215,0,0.25)', btnColor: '#ffd700,#ffd700', iconShadow: 'rgba(255,215,0,0.6)'},
            {id: 57, category: 'mega', name: '–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –ø–æ–º–æ—â—å', nameEmoji: 'üíé', emoji: 'üëë', reward: '3,800,000 –∫–æ–∏–Ω–æ–≤', rewardIcon: 'üí∞', price: 3500, description: 'üëë –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–∞—è VIP –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –∫—Ä—É–≥–ª–æ—Å—É—Ç–æ—á–Ω–æ', badge: '', cardColor: 'rgba(255,215,0,0.12),rgba(255,237,78,0.18)', borderColor: 'rgba(255,215,0,0.3)', hoverColor: 'rgba(255,215,0,0.25)', btnColor: '#ffd700,#ffd700', iconShadow: 'rgba(255,215,0,0.6)'},
            {id: 58, category: 'mega', name: '–ó–æ–ª–æ—Ç–æ–π –ø—Ä–æ—Ñ–∏–ª—å', nameEmoji: 'üëë', emoji: '‚ú®', reward: '4,400,000 –∫–æ–∏–Ω–æ–≤', rewardIcon: 'üí∞', price: 4500, description: '‚ú® –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –¥–∏–∑–∞–π–Ω –∑–æ–ª–æ—Ç–æ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è VIP', badge: '', cardColor: 'rgba(255,215,0,0.12),rgba(255,237,78,0.18)', borderColor: 'rgba(255,215,0,0.3)', hoverColor: 'rgba(255,215,0,0.25)', btnColor: '#ffd700,#ffd700', iconShadow: 'rgba(255,215,0,0.6)'},
            {id: 59, category: 'mega', name: '–°—É–ø–µ—Ä —Å—Ç–∞—Ç—É—Å', nameEmoji: 'üåü', emoji: 'üèÖ', reward: '4,700,000 –∫–æ–∏–Ω–æ–≤', rewardIcon: 'üí∞', price: 7000, description: 'üèÖ –°—É–ø–µ—Ä-–ø—Ä–∞–≤–∞ –≤–æ –≤—Å–µ—Ö –∏–≥—Ä–æ–≤—ã—Ö —Å–∏—Å—Ç–µ–º–∞—Ö', badge: '', cardColor: 'rgba(255,215,0,0.12),rgba(255,237,78,0.18)', borderColor: 'rgba(255,215,0,0.3)', hoverColor: 'rgba(255,215,0,0.25)', btnColor: '#ffd700,#ffd700', iconShadow: 'rgba(255,215,0,0.6)'},
            {id: 60, category: 'mega', name: '–ê–ë–°–û–õ–Æ–¢ –í–°–Å VIP', nameEmoji: 'üéØ', emoji: '‚ôæÔ∏è', reward: '5,000,000 –∫–æ–∏–Ω–æ–≤', rewardIcon: 'üí∞', price: 15000, description: '‚ôæÔ∏è –ê–±—Å–æ–ª—é—Ç–Ω–∞—è –ø–æ–ª–Ω–æ—Ç–∞ –≤—Å–µ—Ö –ø—Ä–µ–º–∏—É–º —Ñ—É–Ω–∫—Ü–∏–π', badge: '', cardColor: 'rgba(255,215,0,0.12),rgba(255,237,78,0.18)', borderColor: 'rgba(255,215,0,0.3)', hoverColor: 'rgba(255,215,0,0.25)', btnColor: '#ffd700,#ffd700', iconShadow: 'rgba(255,215,0,0.6)'},
        ];
        
        // Function to render VIP Currency Cards dynamically
        function renderVIPCurrencyCards(products) {
            const categoryColors = {
                'starter': {bg: 'rgba(102,126,234,0.12),rgba(139,92,246,0.18)', border: 'rgba(102,126,234,0.3)', hover: 'rgba(102,126,234,0.25)', btn: '#667eea,#764ba2', shadow: 'rgba(102,126,234,0.6)', title: 'üéØ –°–¢–ê–†–¢–û–í–´–ï –ù–ê–ë–û–†–´'},
                'premium': {bg: 'rgba(234,179,8,0.12),rgba(245,158,11,0.18)', border: 'rgba(234,179,8,0.3)', hover: 'rgba(234,179,8,0.25)', btn: '#f59e0b,#f59e0b', shadow: 'rgba(234,179,8,0.6)', title: 'üöÄ –ü–†–ï–ú–ò–£–ú –ù–ê–ë–û–†–´'},
                'vip': {bg: 'rgba(255,215,0,0.12),rgba(255,237,78,0.18)', border: 'rgba(255,215,0,0.3)', hover: 'rgba(255,215,0,0.25)', btn: '#ffd700,#ffd700', shadow: 'rgba(255,215,0,0.6)', title: '‚≠ê –ü–†–ï–ú–ò–£–ú –§–£–ù–ö–¶–ò–ò'},
                'limited': {bg: 'rgba(239,68,68,0.12),rgba(220,38,38,0.18)', border: 'rgba(239,68,68,0.3)', hover: 'rgba(239,68,68,0.25)', btn: '#ef4444,#ef4444', shadow: 'rgba(239,68,68,0.6)', title: 'üîÆ QUANHASH –ù–ê–ë–û–†–´'},
                'ultra': {bg: 'rgba(168,85,247,0.12),rgba(139,92,246,0.18)', border: 'rgba(168,85,247,0.3)', hover: 'rgba(168,85,247,0.25)', btn: '#a855f7,#8b5cf6', shadow: 'rgba(168,85,247,0.6)', title: 'üéÅ –ö–û–ú–ë–û –°–ï–¢–´'},
                'mega': {bg: 'rgba(255,215,0,0.12),rgba(255,237,78,0.18)', border: 'rgba(255,215,0,0.3)', hover: 'rgba(255,215,0,0.25)', btn: '#ffd700,#ffd700', shadow: 'rgba(255,215,0,0.6)', title: 'üëë VIP –§–£–ù–ö–¶–ò–ò'}
            };
            
            let html = '';
            let currentCategory = '';
            
            products.forEach(product => {
                if(currentCategory !== product.category) {
                    currentCategory = product.category;
                    const colors = categoryColors[product.category];
                    // –£–±–∏—Ä–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –¥–ª—è –±–æ–ª–µ–µ –∫–æ–º–ø–∞–∫—Ç–Ω–æ–≥–æ –≤–∏–¥–∞ (–∫–∞–∫ –≤ VIP –º–∞–π–Ω–∏–Ω–≥–µ)
                    // html += `<div data-category="${product.category}" style="display:block;text-align:center;font-size:16px;font-weight:900;color:#fff;margin:8px 0 8px;padding:8px;background:linear-gradient(135deg,${colors.bg});border-radius:12px;grid-column:1/-1;">${colors.title}</div>`;
                }
                
                const colors = categoryColors[product.category];
                html += `
                    <div data-category="${product.category}" style="background: linear-gradient(135deg, ${colors.bg}); padding: 18px; border-radius: 16px; border: 2px solid ${colors.border}; position: relative; backdrop-filter: blur(8px); box-shadow: 0 8px 25px ${colors.border.replace('0.3)', '0.15)')}; transition: all 0.3s ease; background-size: 200% 200%; animation: shimmer 3s ease-in-out infinite; width: 100%; box-sizing: border-box;" onmouseover="this.style.transform='translateY(-3px)';this.style.boxShadow='0 12px 35px ${colors.border.replace('0.3)', '0.25)')}';this.style.background='linear-gradient(135deg, ${colors.hover})'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 8px 25px ${colors.border.replace('0.3)', '0.15)')}';this.style.background='linear-gradient(135deg, ${colors.bg})'">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 10px;">
                            <span style="font-size: 26px; filter: drop-shadow(0 0 4px ${colors.shadow});">${product.nameEmoji || product.emoji}</span>
                            <div style="flex: 1;">
                                <div style="font-weight: 800; font-size: 15px; color: #fff; text-shadow: 0 1px 3px rgba(0,0,0,0.3);">${product.name}</div>
                                <div style="font-size: 12px; color: rgba(255,255,255,0.8); margin-top: 2px; line-height: 1.4;">${product.description}</div>
                            </div>
                            ${product.badge ? `<div style="background: linear-gradient(135deg, ${colors.btn}); color: ${product.category === 'vip' || product.category === 'mega' ? '#000' : '#fff'}; padding: 4px 8px; border-radius: 8px; font-size: 11px; font-weight: 900; text-shadow: 0 1px 3px rgba(0,0,0,0.3); border: 1px solid ${colors.border}; box-shadow: 0 3px 8px ${colors.shadow.replace('0.6)', '0.4)')}; position: relative; overflow: hidden;"><div style="position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent); animation: shimmer 2s infinite;"></div><span style="font-size: 12px; font-weight: 900; text-shadow: 0 1px 2px rgba(0,0,0,0.4);">${product.badge}</span></div>` : ''}
                        </div>
                        <div style="background: rgba(74,222,128,0.2); padding: 8px; border-radius: 8px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;">
                            <span style="color: #4ade80; font-size: 12px; font-weight: 700;">${product.rewardIcon || 'üí∞'} –ù–∞–≥—Ä–∞–¥–∞:</span>
                            <span style="color: #fff; font-size: 12px; font-weight: 800;">${product.reward}</span>
                        </div>
                        <button onclick="window.open('https://t.me/qanexus_bot?start=buy_stars_${product.id}')" style="width: 100%; padding: 10px 12px; background: linear-gradient(135deg, ${colors.btn}); color: ${product.category === 'vip' || product.category === 'mega' ? '#000' : '#fff'}; border: 1px solid ${colors.border}; border-radius: 10px; cursor: pointer; font-weight: 800; font-size: 13px; transition: all 0.3s; position: relative; overflow: hidden; box-shadow: 0 4px 12px ${colors.border.replace('0.3)', '0.3)')}; text-shadow: 0 1px 2px rgba(0,0,0,0.2); display: flex; align-items: center; justify-content: center; gap: 6px;" onmousedown="this.style.transform='scale(0.98)'; this.style.boxShadow='0 6px 16px ${colors.border.replace('0.3)', '0.4)')}" onmouseup="this.style.transform='scale(1)'; this.style.boxShadow='0 4px 12px ${colors.border.replace('0.3)', '0.3)')}" onmouseleave="this.style.transform='scale(1)'; this.style.boxShadow='0 4px 12px ${colors.border.replace('0.3)', '0.3)')}">
                            <span>–ö—É–ø–∏—Ç—å –∑–∞ ${product.price}</span>
                            <span style="font-size: 16px; filter: drop-shadow(0 0 3px ${colors.shadow}); text-shadow: 0 1px 2px rgba(0,0,0,0.3);">‚≠ê</span>
                            <span>Telegram Stars</span>
                        </button>
                    </div>
                `;
            });
            
            return html;
        }
        
        // v6.7.31 - Referral System: Equal bonuses for both (500/2000), VIP header style, link on top, full-width design
        
        // v6.7.30 - Enhanced Referral System: Increased bonuses (500 regular/2000 premium), detailed premium indicators, beautiful cards
        
        // v6.7.29 - Enhanced Referral System: Premium bonuses, detailed stats, beautiful UI
        
        // v6.7.28 - Buy Currency modal: Larger wider cards, improved spacing and sizing for better visibility
        window.openBuyCurrency = function(e) {
            try {
                e.preventDefault();
            } catch(err) {}
            try {
                tg.HapticFeedback.impactOccurred('light');
            } catch(err) {}
            
            // Debug: Create simple modal
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.id = 'buyCurrencyModal';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 500px; width: 95vw; max-height: 90vh; overflow-y: auto; background: linear-gradient(135deg, rgba(0,0,0,0.95), rgba(20,20,30,0.98)); border-radius: 24px; border: 2px solid rgba(255,215,0,0.7); box-shadow: 0 20px 60px rgba(255,215,0,0.3), 0 0 0 1px rgba(255,255,255,0.1); backdrop-filter: blur(20px);">
                    <!-- VIP Style Header -->
                    <div style="background: linear-gradient(135deg, #ffd700, #ffed4e, #ffd700); padding: 20px 50px 20px 20px; border-radius: 20px 20px 0 0; text-align: center; position: relative; box-shadow: 0 8px 30px rgba(255,215,0,0.4);">
                        <div style="display: flex; align-items: center; justify-content: center; gap: 12px;">
                            <div style="font-size: 34px; text-shadow: 0 3px 10px rgba(0,0,0,0.3); filter: drop-shadow(0 0 6px rgba(255,215,0,0.8)); animation: pulse 2s infinite;">‚≠ê</div>
                            <div>
                                <h2 style="font-size: 20px; color: #000; margin: 0; font-weight: 900; text-shadow: 0 2px 6px rgba(0,0,0,0.2);">–ö–£–ü–ò–¢–¨ –í–ê–õ–Æ–¢–£</h2>
                                <div style="font-size: 12px; color: rgba(0,0,0,0.7); margin-top: 2px; font-weight: 600;">–ü–æ–∫—É–ø–∫–∞ —á–µ—Ä–µ–∑ Telegram Stars</div>
                            </div>
                        </div>
                        <button class="close-btn" onclick="this.closest('.modal').remove()" style="position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.3); border: 2px solid rgba(0,0,0,0.2); color: #000; font-size: 20px; width: 34px; height: 34px; border-radius: 50%; cursor: pointer; font-weight: 700; transition: all 0.3s; display: flex; align-items: center; justify-content: center; z-index: 3; flex-shrink: 0;">‚úï</button>
                    </div>
                    
                    <div style="padding: 16px;">
                    
                        <!-- Category Buttons - VIP Style -->
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px;">
                            <button onclick="filterCategory('starter')" class="category-btn active" style="background: linear-gradient(135deg, rgba(102,126,234,0.4), rgba(139,92,246,0.4)); border: 2px solid rgba(102,126,234,0.7); padding: 12px 8px; border-radius: 10px; color: #fff; cursor: pointer; font-weight: 800; font-size: 11px; transition: all 0.3s; box-shadow: 0 3px 10px rgba(102,126,234,0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 5px 15px rgba(102,126,234,0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 3px 10px rgba(102,126,234,0.3)'">üéØ –°—Ç–∞—Ä—Ç</button>
                            <button onclick="filterCategory('premium')" class="category-btn" style="background: linear-gradient(135deg, rgba(234,179,8,0.4), rgba(245,158,11,0.4)); border: 2px solid rgba(234,179,8,0.7); padding: 12px 8px; border-radius: 10px; color: #fff; cursor: pointer; font-weight: 800; font-size: 11px; transition: all 0.3s; box-shadow: 0 3px 10px rgba(234,179,8,0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 5px 15px rgba(234,179,8,0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 3px 10px rgba(234,179,8,0.3)'">üöÄ –ü—Ä–µ–º–∏—É–º</button>
                            <button onclick="filterCategory('vip')" class="category-btn" style="background: linear-gradient(135deg, rgba(255,215,0,0.4), rgba(255,237,78,0.4)); border: 2px solid rgba(255,215,0,0.7); padding: 12px 8px; border-radius: 10px; color: #fff; cursor: pointer; font-weight: 800; font-size: 11px; transition: all 0.3s; box-shadow: 0 3px 10px rgba(255,215,0,0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 5px 15px rgba(255,215,0,0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 3px 10px rgba(255,215,0,0.3)'">‚≠ê VIP</button>
                            <button onclick="filterCategory('limited')" class="category-btn" style="background: linear-gradient(135deg, rgba(239,68,68,0.4), rgba(220,38,38,0.4)); border: 2px solid rgba(239,68,68,0.7); padding: 12px 8px; border-radius: 10px; color: #fff; cursor: pointer; font-weight: 800; font-size: 11px; transition: all 0.3s; box-shadow: 0 3px 10px rgba(239,68,68,0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 5px 15px rgba(239,68,68,0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 3px 10px rgba(239,68,68,0.3)'">üîÆ QuanHash</button>
                            <button onclick="filterCategory('ultra')" class="category-btn" style="background: linear-gradient(135deg, rgba(168,85,247,0.4), rgba(139,92,246,0.4)); border: 2px solid rgba(168,85,247,0.7); padding: 12px 8px; border-radius: 10px; color: #fff; cursor: pointer; font-weight: 800; font-size: 11px; transition: all 0.3s; box-shadow: 0 3px 10px rgba(168,85,247,0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 5px 15px rgba(168,85,247,0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 3px 10px rgba(168,85,247,0.3)'">üéÅ –ö–æ–º–±–æ</button>
                            <button onclick="filterCategory('mega')" class="category-btn" style="background: linear-gradient(135deg, rgba(255,215,0,0.4), rgba(255,237,78,0.4)); border: 2px solid rgba(255,215,0,0.7); padding: 12px 8px; border-radius: 10px; color: #fff; cursor: pointer; font-weight: 800; font-size: 11px; transition: all 0.3s; box-shadow: 0 3px 10px rgba(255,215,0,0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 5px 15px rgba(255,215,0,0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 3px 10px rgba(255,215,0,0.3)'">üëë VIP Mega</button>
                        </div>
                    
                    <div id="currencyProductsList" style="display: flex; flex-direction: column; gap: 14px; max-height: 70vh; overflow-y: auto; padding: 5px 5px 5px 0; width: 100%; box-sizing: border-box;">
                        <!-- Currency cards will be rendered dynamically by renderVIPCurrencyCards -->
                    </div>
                </div>
            </div>
        </div>
        `;
        document.body.appendChild(modal);
        
        // Render all currency cards dynamically using VIP style
        const currencyProductsContainer = document.getElementById('currencyProductsList');
        if (currencyProductsContainer) {
            currencyProductsContainer.innerHTML = renderVIPCurrencyCards(currencyProductsData);
        }
        
        // Set initial active category after modal is attached
        setTimeout(() => window.filterCategory('starter'), 100);
    }
    
    window.filterCategory = function(category) {
        try {
            // Update button states
            document.querySelectorAll('#buyCurrencyModal .category-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            if(event?.target) {
                event.target.classList.add('active');
            }
            
            // Filter and show products
            const products = document.querySelectorAll('#currencyProductsList [data-category]');
            products.forEach(product => {
                if(product.dataset.category === category) {
                    product.style.display = 'block';
                } else {
                    product.style.display = 'none';
                }
            });
        } catch(err) {
            console.error('filterCategory error:', err);
        }
    }

    </script>

    <!-- Initialize on page load -->
    <script>
        // Initialize default settings if not already set (enabled by default)
        // Don't set explicit values - let the check for null handle defaults
        // This way the logic "null || 'true' || true" will work correctly
        
        // Initialize audio on first user interaction
        // Use capture phase to ensure AudioContext is ready before handlers run
        function initAudioOnClick(e) {
            initAudio();
            // Remove this listener after first click
            document.removeEventListener('click', initAudioOnClick, true);
        }
        document.addEventListener('click', initAudioOnClick, true);
        
        // Start periodic updates
        loadData();
        setInterval(loadData, 3000); // Reload every 3 seconds
        startEnergyRegen();
        
        // Initialize shop and other components
        window.addEventListener('load', () => {
            if (window.shopData) {
                const firstCategory = Object.keys(window.shopData).find(key => 
                    window.shopData[key] && window.shopData[key].items && window.shopData[key].items.length > 0
                );
                if (firstCategory) {
                    loadShopCategory(firstCategory);
                }
            }
        });
    </script>


</body>
</html>