<!DOCTYPE html>
<!-- Quantum Nexus v6.2 - Fixed machine display, accurate level calculations, beautiful notifications - ИНСТРУКЦИЯ: Выполните git pull и systemctl restart на сервере -->
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quantum Nexus v2.0</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #0a0e27;
            color: #fff;
            min-height: 100vh;
            padding: 20px;
            position: relative;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent !important;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }
        
        * {
            -webkit-tap-highlight-color: transparent !important;
            -webkit-focus-ring-color: transparent !important;
            -webkit-touch-callout: none !important;
        }
        
        button:focus,
        button:active {
            outline: none !important;
            box-shadow: none !important;
            border: none !important;
        }
        
        .tap-button:focus,
        .tap-button:active,
        .tap-button:focus-visible {
            outline: none !important;
            box-shadow: none !important;
            border: none !important;
        }
        
        /* Prevent all visual selection highlights */
        .tap-button,
        .tap-button * {
            -webkit-tap-highlight-color: transparent !important;
            -webkit-touch-callout: none !important;
            user-select: none !important;
            -webkit-user-select: none !important;
            -ms-user-select: none !important;
            -moz-user-select: none !important;
            -webkit-focus-ring-color: transparent !important;
        }
        
        /* Remove all possible focus states */
        button.tap-button:hover,
        button.tap-button:active,
        button.tap-button:focus,
        button.tap-button:focus-visible,
        button.tap-button:focus-within,
        button.tap-button:visited {
            outline: none !important;
            border: none !important;
            box-shadow: none !important;
            -webkit-tap-highlight-color: transparent !important;
            -webkit-touch-callout: none !important;
        }
        
        /* Extra protection for Telegram WebView */
        html, body {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent !important;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                linear-gradient(45deg, transparent 30%, rgba(102, 126, 234, 0.05) 50%, transparent 70%),
                radial-gradient(circle at 20% 50%, rgba(102, 126, 234, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(118, 75, 162, 0.1) 0%, transparent 50%);
            pointer-events: none;
            animation: drift 20s linear infinite;
        }

        @keyframes drift {
            0%, 100% { transform: translateX(0); }
            50% { transform: translateX(-20px); }
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            position: relative;
        }

        .header::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 60%;
            height: 2px;
            background: linear-gradient(90deg, transparent, #667eea, transparent);
        }

        .header h1 {
            font-size: 28px;
            font-weight: 900;
            margin-bottom: 10px;
            text-shadow: 0 0 30px rgba(102, 126, 234, 0.5);
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: glow 3s ease-in-out infinite;
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        @keyframes glow {
            0%, 100% { filter: drop-shadow(0 0 10px rgba(102, 126, 234, 0.5)); }
            50% { filter: drop-shadow(0 0 20px rgba(118, 75, 162, 0.8)); }
        }
        
        /* VIP Styles */
        .vip-container {
            position: relative;
        }
        
        .vip-particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1000;
        }
        
        @keyframes vip-float {
            0% { transform: translateY(0) rotate(0deg); opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { transform: translateY(-100vh) rotate(360deg); opacity: 0; }
        }
        
        .vip-golden-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, 
                rgba(255, 215, 0, 0.12) 0%,
                rgba(255, 255, 255, 0.05) 25%,
                rgba(255, 215, 0, 0.10) 50%,
                rgba(255, 255, 255, 0.07) 75%,
                rgba(255, 215, 0, 0.12) 100%
            );
            background-size: 400% 400%;
            animation: vip-gradient 15s ease infinite;
            pointer-events: none;
            z-index: 0;
        }
        
        .vip-premium-shine {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 20%, rgba(255, 215, 0, 0.08) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(255, 215, 0, 0.08) 0%, transparent 50%),
                radial-gradient(circle at 40% 60%, rgba(255, 255, 255, 0.03) 0%, transparent 50%);
            animation: vip-premium-shine 8s ease-in-out infinite;
            pointer-events: none;
            z-index: 0;
        }
        
        @keyframes vip-premium-shine {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }
        
        .vip-top-leaders {
            position: fixed;
            top: 10px;
            left: 10px;
            width: 140px;
            background: rgba(0, 0, 0, 0.65);
            backdrop-filter: blur(12px);
            border: 2px solid rgba(255, 215, 0, 0.35);
            border-radius: 12px;
            padding: 12px;
            z-index: 1000;
            box-shadow: 0 4px 20px rgba(255, 215, 0, 0.25);
        }
        
        .vip-profile-icon {
            position: relative;
            width: 45px;
            height: 45px;
            background: linear-gradient(135deg, #a78bfa, #c084fc, #d946ef);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            border: 3px solid rgba(255, 255, 255, 0.4);
            cursor: pointer;
            z-index: 10;
            box-shadow: 0 0 20px rgba(167, 139, 250, 0.6), 0 4px 15px rgba(167, 139, 250, 0.5);
            transition: all 0.3s ease;
            overflow: hidden;
            animation: vip-icon-glow 2s ease-in-out infinite;
        }
        
        @keyframes vip-icon-glow {
            0%, 100% { box-shadow: 0 0 20px rgba(167, 139, 250, 0.6), 0 4px 15px rgba(167, 139, 250, 0.5); }
            50% { box-shadow: 0 0 30px rgba(167, 139, 250, 0.9), 0 6px 20px rgba(167, 139, 250, 0.8); }
        }
        
        .vip-profile-icon img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .vip-profile-icon:hover {
            transform: scale(1.12);
            box-shadow: 0 0 35px rgba(217, 70, 239, 0.8), 0 8px 25px rgba(217, 70, 239, 0.7);
        }
        
        .vip-top-button {
            position: relative;
            width: 45px;
            height: 45px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            cursor: pointer;
            z-index: 10;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.5);
            transition: all 0.3s ease;
        }
        
        .vip-top-button:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.7);
        }
        
        @keyframes vip-gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        .vip-aura {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 300px;
            height: 300px;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(255,215,0,0.3), transparent);
            animation: vip-aura-pulse 3s ease-in-out infinite;
            pointer-events: none;
            z-index: 0;
        }
        
        @keyframes vip-aura-pulse {
            0%, 100% { transform: translate(-50%, -50%) scale(1); opacity: 0.5; }
            50% { transform: translate(-50%, -50%) scale(1.5); opacity: 0.2; }
        }
        
        .vip-rainbow-border {
            border: 3px solid;
            border-image: linear-gradient(45deg, #ff0000, #ff7f00, #ffff00, #00ff00, #0000ff, #4b0082, #9400d3) 1;
            animation: vip-rainbow 3s linear infinite;
        }
        
        @keyframes vip-rainbow {
            0% { filter: hue-rotate(0deg); }
            100% { filter: hue-rotate(360deg); }
        }
        
        .vip-shine-effect {
            position: relative;
            overflow: hidden;
        }
        
        .vip-shine-effect::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.8), transparent);
            animation: vip-shine 3s ease-in-out infinite;
        }
        
        @keyframes vip-shine {
            0% { left: -100%; }
            100% { left: 100%; }
        }
        
        .vip-glow-box {
            box-shadow: 0 0 30px rgba(255,215,0,0.8), 
                        0 0 60px rgba(255,215,0,0.5),
                        0 0 90px rgba(255,215,0,0.3);
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.05); }
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-3px); }
            20%, 40%, 60%, 80% { transform: translateX(3px); }
        }
        
        @keyframes shine-btn {
            0% { left: -100%; }
            100% { left: 100%; }
        }
        
        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        @keyframes premium-pulse {
            0%, 100% { transform: scale(1); box-shadow: 0 0 30px rgba(255, 215, 0, 0.6), 0 0 60px rgba(255, 140, 0, 0.4); }
            50% { transform: scale(1.03); box-shadow: 0 0 40px rgba(255, 215, 0, 0.8), 0 0 80px rgba(255, 140, 0, 0.6); }
        }

        .stats {
            background: linear-gradient(135deg, rgba(15, 23, 42, 0.9) 0%, rgba(26, 29, 46, 0.9) 100%);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 12px;
            margin-bottom: 16px;
            border: 1px solid rgba(102, 126, 234, 0.3);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.5);
            position: relative;
            overflow: hidden;
        }

        .stats::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(102, 126, 234, 0.1), transparent);
            animation: shine 3s infinite;
        }

        @keyframes shine {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid rgba(102, 126, 234, 0.2);
            position: relative;
            z-index: 1;
        }

        .stat-row:last-child {
            border-bottom: none;
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .stat-value {
            font-size: 18px;
            font-weight: bold;
            color: #f093fb;
            text-shadow: 0 0 10px rgba(240, 147, 251, 0.3);
        }

        .stat-compact-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 8px;
        }

        .stat-item-compact {
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            padding: 8px;
            text-align: center;
            border: 1px solid rgba(102, 126, 234, 0.3);
        }

        .stat-main-value {
            font-size: 18px;
            font-weight: 900;
            color: #fff;
            margin-bottom: 2px;
        }

        .stat-passive-value {
            font-size: 10px;
            color: #4ade80;
            margin-bottom: 6px;
            font-weight: 600;
        }

        .stat-label-small {
            font-size: 12px;
            color: #94a3b8;
        }

        .energy-bar-container {
            padding-top: 15px;
        }

        .energy-bar {
            width: 100%;
            height: 10px;
            background: rgba(255,255,255,0.1);
            border-radius: 5px;
            overflow: hidden;
            margin-top: 5px;
            position: relative;
        }

        .energy-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2, #f093fb);
            transition: width 0.5s ease;
            position: relative;
            overflow: hidden;
        }

        .energy-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: energyFlow 2s infinite;
        }

        @keyframes energyFlow {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        .energy-regen {
            font-size: 12px;
            color: #4ade80;
            margin-top: 5px;
            text-align: center;
        }

        .buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .btn {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.2) 0%, rgba(118, 75, 162, 0.2) 100%);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(102, 126, 234, 0.4);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 16px;
            font-weight: 600;
            color: white;
            text-decoration: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn:hover {
            transform: translateY(-3px);
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.3) 0%, rgba(118, 75, 162, 0.3) 100%);
            border-color: rgba(102, 126, 234, 0.6);
            box-shadow: 0 8px 32px rgba(102, 126, 234, 0.4);
        }

        .btn-emoji {
            font-size: 32px;
            filter: drop-shadow(0 0 10px rgba(102, 126, 234, 0.3));
        }

        .tap-button {
            width: 280px;
            height: 280px;
            margin: 30px auto;
            border-radius: 50%;
            position: relative;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.8) 0%, rgba(118, 75, 162, 0.8) 100%);
            border: 4px solid transparent;
            cursor: pointer;
            box-shadow: 0 15px 50px rgba(102, 126, 234, 0.3);
            transition: all 0.08s cubic-bezier(0.25, 1.8, 0.75, 0.5);
            user-select: none;
            -webkit-tap-highlight-color: transparent !important;
            -webkit-touch-callout: none;
            animation: pulse 2s ease-in-out infinite;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            outline: none !important;
            -webkit-focus-ring-color: transparent !important;
        }

        .tap-button svg {
            width: 100%;
            height: 100%;
            filter: drop-shadow(0 0 20px rgba(255, 192, 203, 0.6));
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 15px 50px rgba(102, 126, 234, 0.5), 0 0 0 0 rgba(102, 126, 234, 0.4);
                border-color: rgba(102, 126, 234, 0.6);
            }
            50% {
                transform: scale(1.05);
                box-shadow: 0 20px 60px rgba(102, 126, 234, 0.7), 0 0 40px 20px rgba(102, 126, 234, 0.3);
                border-color: rgba(240, 147, 251, 0.8);
            }
        }
        
        @keyframes tapPress {
            0% { 
                transform: scale(1);
                filter: brightness(1);
            }
            15% {
                transform: scale(0.92);
                filter: brightness(1.1);
            }
            30% {
                transform: scale(1.03);
                filter: brightness(1.08);
            }
            50% {
                transform: scale(0.99);
                filter: brightness(1.05);
            }
            70% {
                transform: scale(1.02);
                filter: brightness(1.04);
            }
            100% {
                transform: scale(1);
                filter: brightness(1);
            }
        }
        
        @keyframes neonBurst {
            0% {
                box-shadow: 0 0 0 0 rgba(240, 147, 251, 0);
            }
            50% {
                box-shadow: 0 0 0 20px rgba(240, 147, 251, 0), 0 0 0 40px rgba(102, 126, 234, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(240, 147, 251, 0), 0 0 0 0 rgba(102, 126, 234, 0);
            }
        }
        
        .tap-button.tap-pressed {
            animation: tapPress 0.3s cubic-bezier(0.25, 1, 0.5, 1);
        }

        .tap-button::before {
            content: '';
            position: absolute;
            inset: -10px;
            border-radius: 50%;
            background: linear-gradient(45deg, rgba(102, 126, 234, 0.6), rgba(118, 75, 162, 0.6));
            filter: blur(20px);
            opacity: 0;
            animation: neonPulse 2s ease-in-out infinite;
        }
        
        .tap-button::after {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 50%;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.3), rgba(118, 75, 162, 0.3));
            filter: blur(15px);
            opacity: 0;
            animation: neonPulse 2s ease-in-out infinite 0.3s;
        }
        
        @keyframes neonPulse {
            0%, 100% { opacity: 0.3; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.05); }
        }

        /* Offline Income Notice */
        .offline-notice {
            background: linear-gradient(135deg, rgba(76, 222, 128, 0.2) 0%, rgba(34, 197, 94, 0.2) 100%);
            border: 1px solid rgba(76, 222, 128, 0.5);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
            animation: slideDown 0.5s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* Withdraw Section */
        .withdraw-section {
            background: linear-gradient(135deg, rgba(15, 23, 42, 0.9) 0%, rgba(26, 29, 46, 0.9) 100%);
            border: 1px solid rgba(102, 126, 234, 0.3);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .withdraw-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #f093fb;
        }

        .withdraw-info {
            font-size: 14px;
            opacity: 0.8;
            margin-bottom: 10px;
        }

        .input-group {
            margin-bottom: 10px;
        }

        .input-group input {
            width: 100%;
            padding: 12px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(102, 126, 234, 0.3);
            border-radius: 10px;
            color: white;
            font-size: 14px;
        }

        .input-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .action-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 10px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(102, 126, 234, 0.4);
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            overflow-y: auto;
            padding: 20px;
            backdrop-filter: blur(8px);
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: linear-gradient(135deg, #0a0e27 0%, #1a1d2e 100%);
            border: 1px solid rgba(102, 126, 234, 0.5);
            border-radius: 20px;
            padding: 20px;
            max-width: 400px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.8);
            position: relative;
        }

        /* .modal-content::before - Removed to fix double border issue */

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 24px;
            font-weight: bold;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .close-btn {
            background: rgba(255,255,255,0.1) !important;
            border: none !important;
            border-radius: 50% !important;
            width: 40px !important;
            height: 40px !important;
            cursor: pointer !important;
            color: white !important;
            font-size: 20px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            transition: all 0.3s ease !important;
            position: absolute !important;
            top: 15px !important;
            right: 15px !important;
            z-index: 1000 !important;
        }

        .close-btn:hover {
            background: rgba(255,255,255,0.2);
            transform: none !important;
        }


        /* Стильная кнопка закрытия для категорий */
        .category-close-btn {
            width: 100%;
            padding: 16px 24px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: #fff;
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 16px;
            cursor: pointer;
            font-weight: 800;
            font-size: 16px;
            margin-top: 20px;
            transition: all 0.3s ease;
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
            text-shadow: 0 1px 3px rgba(0,0,0,0.3);
            position: relative;
            overflow: hidden;
        }

        .category-close-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.6);
            background: linear-gradient(135deg, #5a67d8, #6b46c1);
            border-color: rgba(255,255,255,0.3);
        }

        .category-close-btn:active {
            transform: translateY(-1px);
        }

        /* VIP стильная кнопка закрытия */
        .vip-close-btn {
            width: 100%;
            padding: 14px 20px;
            background: linear-gradient(135deg, #ffd700, #ffed4e, #ffd700);
            color: #000;
            border: 2px solid #ffd700;
            border-radius: 14px;
            cursor: pointer;
            font-weight: 800;
            font-size: 16px;
            margin-top: 20px;
            transition: all 0.3s ease;
            box-shadow: 0 6px 20px rgba(255, 215, 0, 0.4);
            position: relative;
            overflow: hidden;
            text-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }

        .vip-close-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 35px rgba(255, 215, 0, 0.7);
            background: linear-gradient(135deg, #ffed4e, #ffd700, #ffed4e);
        }

        .vip-close-btn:active {
            transform: translateY(-1px);
        }

        .vip-close-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.6), transparent);
            transition: left 0.6s;
        }

        .vip-close-btn:hover::before {
            left: 100%;
        }

        /* Анимация пульсации для VIP звезды */
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        .shop-category {
            margin-bottom: 20px;
        }

        .category-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #f093fb;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .item {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(102, 126, 234, 0.3);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(102, 126, 234, 0.2), transparent);
            transition: left 0.5s;
        }

        .item:hover::before {
            left: 100%;
        }

        .item:hover {
            background: rgba(102, 126, 234, 0.2);
            border-color: rgba(102, 126, 234, 0.6);
            transform: translateX(5px);
        }

        .item-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .item-emoji {
            font-size: 24px;
        }

        .item-details {
            flex: 1;
        }

        .item-name {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .item-desc {
            font-size: 12px;
            opacity: 0.7;
            margin-bottom: 5px;
        }

        .item-price {
            font-size: 14px;
            color: #f093fb;
            font-weight: bold;
        }

        .mining-machine {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(102, 126, 234, 0.3);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 10px;
            position: relative;
            overflow: hidden;
        }

        .machine-tag {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 4px 10px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: bold;
        }

        .machine-tag.free {
            background: rgba(76, 222, 128, 0.2);
            color: #4ade80;
            border: 1px solid #4ade80;
        }

        .machine-tag.premium {
            background: rgba(240, 147, 251, 0.2);
            color: #f093fb;
            border: 1px solid #f093fb;
        }

        .machine-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .machine-name {
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .machine-level {
            font-size: 14px;
            opacity: 0.8;
        }

        .machine-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            font-size: 14px;
        }

        .stat-item {
            background: rgba(102, 126, 234, 0.1);
            padding: 8px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-label {
            font-size: 11px;
            opacity: 0.7;
            margin-bottom: 4px;
        }

        .stat-value {
            font-weight: bold;
            color: #f093fb;
        }

        .card-item {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(102, 126, 234, 0.3);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 10px;
            position: relative;
            overflow: hidden;
        }

        .card-glow {
            position: absolute;
            inset: -2px;
            border-radius: 15px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .card-item:hover .card-glow {
            opacity: 1;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .card-name {
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .card-level {
            font-size: 14px;
            opacity: 0.8;
        }

        .card-stats {
            display: flex;
            gap: 15px;
            font-size: 14px;
        }

        .stats-window {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(102, 126, 234, 0.3);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 10px;
        }

        .stats-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid rgba(102, 126, 234, 0.1);
        }

        .stats-row:last-child {
            border-bottom: none;
        }

        .stats-label {
            opacity: 0.8;
        }

        .stats-value {
            font-weight: bold;
            color: #f093fb;
        }

        .referral-link {
            background: rgba(102, 126, 234, 0.1);
            border: 1px solid rgba(102, 126, 234, 0.3);
            border-radius: 10px;
            padding: 12px;
            margin: 10px 0;
            font-family: monospace;
            word-break: break-all;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .referral-benefits {
            background: rgba(76, 222, 128, 0.1);
            border: 1px solid rgba(76, 222, 128, 0.3);
            border-radius: 10px;
            padding: 12px;
            margin: 10px 0;
        }

        .benefit-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 8px 0;
            font-size: 14px;
        }

        @keyframes coinFloat {
            0% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
            100% {
                opacity: 0;
                transform: translateY(-50px) scale(0.5);
            }
        }

        .coin-animation {
            position: fixed;
            font-size: 32px;
            font-weight: 900;
            pointer-events: none;
            animation: coinFloat 2s ease-out forwards;
            z-index: 9999;
            color: #ffd700;
            text-shadow: 
                0 0 10px rgba(255, 215, 0, 1),
                0 0 20px rgba(255, 215, 0, 0.8),
                0 0 30px rgba(255, 215, 0, 0.6),
                0 0 40px rgba(255, 215, 0, 0.4),
                0 0 50px rgba(255, 215, 0, 0.2);
            filter: drop-shadow(0 0 10px rgba(255, 215, 0, 1));
            will-change: transform, opacity, filter;
        }

        @keyframes coinFloat {
            0% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(0.5) rotate(0deg);
                filter: blur(0px) brightness(1);
            }
            10% {
                opacity: 1;
                transform: translate(-50%, -80%) scale(0.7) rotate(90deg);
                filter: blur(0px) brightness(1.2);
            }
            20% {
                opacity: 1;
                transform: translate(-50%, -120%) scale(0.9) rotate(180deg);
                filter: blur(0px) brightness(1.3);
            }
            30% {
                opacity: 1;
                transform: translate(-50%, -170%) scale(1.1) rotate(270deg);
                filter: blur(1px) brightness(1.2);
            }
            40% {
                opacity: 1;
                transform: translate(-50%, -230%) scale(1.3) rotate(360deg);
                filter: blur(1px) brightness(1.1);
            }
            50% {
                opacity: 1;
                transform: translate(-50%, -300%) scale(1.5) rotate(450deg);
                filter: blur(2px) brightness(1);
            }
            60% {
                opacity: 0.9;
                transform: translate(-50%, -380%) scale(1.7) rotate(540deg);
                filter: blur(2px) brightness(0.9);
            }
            70% {
                opacity: 0.7;
                transform: translate(-50%, -470%) scale(1.9) rotate(630deg);
                filter: blur(3px) brightness(0.7);
            }
            80% {
                opacity: 0.5;
                transform: translate(-50%, -570%) scale(2.1) rotate(720deg);
                filter: blur(4px) brightness(0.5);
            }
            90% {
                opacity: 0.3;
                transform: translate(-50%, -680%) scale(2.3) rotate(810deg);
                filter: blur(5px) brightness(0.3);
            }
            100% {
                opacity: 0;
                transform: translate(-50%, -800%) scale(2.5) rotate(900deg);
                filter: blur(6px) brightness(0);
            }
        }

        .loading {
            text-align: center;
            padding: 40px;
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header" style="position: relative;">
            <div style="display: flex; align-items: center; justify-content: center; gap: 20px; margin-bottom: 20px;">
                <div class="vip-top-button" style="width: 45px; height: 45px; background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 24px; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.5); transition: all 0.3s; flex-shrink: 0;" onclick="openVIPTopLeaders();" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">🏆</div>
                
                <h1 id="mainTitle" style="margin: 0; text-align: center; font-size: 26px; white-space: nowrap;">Quantum Nexus</h1>
                
                <div class="vip-profile-icon" style="width: 45px; height: 45px; background: linear-gradient(135deg, #a78bfa, #c084fc); border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 24px; box-shadow: 0 4px 15px rgba(167, 139, 250, 0.5); transition: all 0.3s; flex-shrink: 0;" onclick="openVIPProfileModal();" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">👤</div>
            </div>
            
            <div id="vipPrivileges" style="display:none;margin-top:5px;font-size:11px;color:#94a3b8;"></div>
        </div>

        <!-- Offline Income Popup -->
        <div id="offlinePopup" class="modal">
            <div class="modal-content" style="max-width: 350px;">
                <div class="modal-header">
                    <div class="modal-title">💰 Оффлайн доход</div>
                    <button class="close-btn" onclick="closeModal('offlinePopup')">✕</button>
                </div>
                <div id="offlineContent"></div>
            </div>
        </div>

        <div class="stats">
            <div class="stat-compact-row">
                <div class="stat-item-compact">
                    <div class="stat-main-value" id="coins">0</div>
                    <div class="stat-passive-value" id="passiveCoins">+0/час</div>
                    <div class="stat-label-small">💰 Коины</div>
                </div>
                <div class="stat-item-compact">
                    <div class="stat-main-value" id="quanhash">0</div>
                    <div class="stat-passive-value" id="passiveHash">+0/час</div>
                    <div class="stat-label-small">💎 QuanHash</div>
                </div>
            </div>
            <div class="energy-bar-container" style="margin-bottom: 16px;">
                <div class="energy-bar-wrapper" style="position: relative; background: linear-gradient(135deg, rgba(15,15,30,0.92), rgba(20,20,35,0.95)); border: 2px solid rgba(118,75,162,0.4); border-radius: 18px; padding: 16px 12px; box-shadow: 0 0 30px rgba(118,75,162,0.3), 0 4px 20px rgba(0,0,0,0.5); width: 100%;">
                    <!-- Ultra-wide progress bar with everything inside -->
                    <div class="energy-bar" style="width: 100%; height: 44px; background: rgba(0,0,0,0.4); border-radius: 14px; overflow: visible; position: relative; box-shadow: inset 0 2px 10px rgba(0,0,0,0.7), 0 0 10px rgba(118,75,162,0.2); border: 1px solid rgba(118,75,162,0.3);">
                        <!-- Energy fill with tap button colors (soft purple gradient) -->
                        <div class="energy-fill" id="energy-bar-fill" style="width: 0%; height: 100%; background: linear-gradient(90deg, #667eea 0%, #764ba2 50%, #8b5cf6 100%); box-shadow: 0 0 30px rgba(102,126,234,0.6), inset 0 0 20px rgba(118,75,162,0.3), 0 2px 10px rgba(102,126,234,0.4); position: absolute; top: 0; left: 0; transition: width 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94); border-radius: 12px;">
                            <!-- Soft shine effect -->
                            <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(90deg, transparent 0%, rgba(255,255,255,0.3) 50%, transparent 100%); animation: softShine 3s infinite; border-radius: 12px;"></div>
                        </div>
                        
                        <!-- Label: Energy - Value - Percentage with soft readable text -->
                        <div style="position: absolute; top: 50%; left: 0; right: 0; transform: translateY(-50%); display: flex; align-items: center; justify-content: space-between; padding: 0 16px; pointer-events: none; z-index: 10;">
                            <div style="font-size: 13px; font-weight: 700; color: #a78bfa; text-shadow: 0 1px 3px rgba(0,0,0,0.8), 0 0 10px rgba(167,139,250,0.5); letter-spacing: 0.3px;">⚡ Энергия</div>
                            <div id="energy-text" style="font-size: 15px; font-weight: 800; color: #fff; text-shadow: 0 1px 4px rgba(0,0,0,1), 0 0 15px rgba(255,255,255,0.6); letter-spacing: 0.5px; font-variant-numeric: tabular-nums;">0/1000</div>
                            <div id="energy-percent" style="font-size: 13px; font-weight: 700; color: #86efac; text-shadow: 0 1px 3px rgba(0,0,0,0.8), 0 0 10px rgba(134,239,172,0.5); letter-spacing: 0.3px;">0%</div>
                        </div>
                    </div>
                    
                    <!-- Regen info nicely positioned under the bar -->
                    <div class="energy-regen" id="energy-regen-text" style="text-align: center; margin-top: 12px; font-size: 12px; color: #86efac; font-weight: 800; text-shadow: 0 0 10px rgba(134,239,172,0.7); letter-spacing: 0.5px;">Восстановление: +1/сек</div>
                </div>
                
                <style>
                    @keyframes softShine {
                        0% { transform: translateX(-150%); opacity: 0; }
                        20% { opacity: 0.4; }
                        80% { opacity: 0.4; }
                        100% { transform: translateX(350%); opacity: 0; }
                    }
                </style>
            </div>
            
            <!-- Autobot status display (no toggle button) -->
            <div id="autobotStatusSection" style="display: none; margin-top: 10px; opacity: 1; transition: opacity 0.3s ease;">
                <div id="autobotStatusBtn" style="width: 100%; padding: 12px 16px; background: linear-gradient(135deg, #10b981, #059669); color: #fff; border: none; border-radius: 10px; font-size: 13px; font-weight: 700; box-shadow: 0 4px 12px rgba(16,185,129,0.4); min-height: 44px; text-align: center;">
                    🤖 Автобот активен
                </div>
            </div>
        </div>

        <button class="tap-button" onclick="tap(); return false;" type="button" style="outline:none!important;box-shadow:none!important;-webkit-tap-highlight-color:transparent!important;">
            <svg width="220" height="220" viewBox="0 0 220 220" style="width:100%;height:100%;">
                <defs>
                    <radialGradient id="tapGrad" cx="50%" cy="50%">
                        <stop offset="0%" style="stop-color:#667eea;stop-opacity:1" />
                        <stop offset="100%" style="stop-color:#764ba2;stop-opacity:0.9" />
                    </radialGradient>
                    <filter id="glow">
                        <feGaussianBlur stdDeviation="4" result="coloredBlur"/>
                        <feMerge>
                            <feMergeNode in="coloredBlur"/>
                            <feMergeNode in="SourceGraphic"/>
                        </feMerge>
                    </filter>
                </defs>
                <circle cx="110" cy="110" r="100" fill="url(#tapGrad)" filter="url(#glow)" opacity="0.9"/>
                <circle cx="110" cy="110" r="90" fill="none" stroke="#f093fb" stroke-width="2" opacity="0.6"/>
                <text x="110" y="150" font-size="100" text-anchor="middle" fill="#fff" font-weight="bold" style="filter: drop-shadow(0 0 15px rgba(255, 192, 203, 0.8));">💰</text>
            </svg>
        </button>
        <div class="buttons">
            <a href="#" class="btn" onclick="openShop(event)">
                <div class="btn-emoji">🛒</div>
                <div>Магазин</div>
            </a>
            <a href="#" class="btn" onclick="openMining(event)">
                <div class="btn-emoji">🏭</div>
                <div>Майнинг</div>
            </a>
            <a href="#" class="btn" onclick="openCards(event)">
                <div class="btn-emoji">💳</div>
                <div>Карточки</div>
            </a>
            <a href="#" class="btn" onclick="openSupport(event)" id="supportBtn" style="position:relative;">
                <div class="btn-emoji">💬</div>
                <div>Поддержка</div>
                <span id="supportBadge" style="display:none;position:absolute;top:5px;right:5px;background:linear-gradient(135deg,#ef4444,#dc2626);color:#fff;padding:3px 7px;border-radius:10px;font-size:11px;font-weight:700;box-shadow:0 2px 8px rgba(239,68,68,0.5);animation:pulse 2s ease-in-out infinite;">0</span>
            </a>
            <a href="#" class="btn" onclick="openReferrals(event)">
                <div class="btn-emoji">👥</div>
                <div>Рефералы</div>
            </a>
            <a href="#" class="btn" onclick="openWithdrawModal(event)">
                <div class="btn-emoji">💸</div>
                <div>Вывод</div>
            </a>
            <a href="#" class="btn" onclick="openDailyBonus(event)">
                <div class="btn-emoji">🎁</div>
                <div>Ежедневные задания</div>
            </a>
            <a href="#" class="btn" onclick="openBuyCurrency(event)" style="background:linear-gradient(135deg,rgba(255,215,0,0.3),rgba(255,140,0,0.3));border:2px solid rgba(255,215,0,0.6);box-shadow:0 4px 15px rgba(255,215,0,0.3);">
                <div class="btn-emoji">⭐</div>
                <div style="font-weight:700;">Купить валюту</div>
            </a>
        </div>
    </div>

    <!-- Stats Modal -->
    <div id="statsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">📊 Статистика</div>
                <button class="close-btn" onclick="closeModal('statsModal')">✕</button>
            </div>
            <div class="stats-window" id="statsContent"></div>
            
            <!-- Стильная кнопка закрытия -->
            <button class="category-close-btn" onclick="closeModal('statsModal')">
                ✕ Закрыть статистику
            </button>
        </div>
    </div>

    <!-- Shop Modal -->
    <div id="shopModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">🛒 Магазин</div>
                <button class="close-btn" onclick="closeModal('shopModal')">✕</button>
            </div>
            <div class="shop-category">
                <div class="category-title">⚡ Бусты</div>
                <div id="boostsList"></div>
            </div>
            <div class="shop-category">
                <div class="category-title">🤖 Автоматизация</div>
                <div id="automationList"></div>
            </div>
            <div class="shop-category">
                <div class="category-title">⚡ Энергия</div>
                <div id="energyList"></div>
            </div>
            <div class="shop-category">
                <div class="category-title">💳 Карточки</div>
                <div id="cardsList"></div>
            </div>
            
            <!-- Стильная кнопка закрытия для старого магазина -->
            <button class="category-close-btn" onclick="closeModal('shopModal')">
                ✕ Закрыть магазин
            </button>
        </div>
    </div>

    <!-- Mining Modal -->
    <div id="miningModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">🏭 Майнинг</div>
                <button class="close-btn" onclick="closeModal('miningModal')">✕</button>
            </div>
            <div id="machinesList"></div>
            <button class="btn" onclick="closeModal('miningModal'); openShop(event)">➕ Купить машину</button>
            
            <!-- Стильная кнопка закрытия -->
            <button class="category-close-btn" onclick="closeModal('miningModal')" style="margin-top: 15px;">
                ✕ Закрыть майнинг
            </button>
        </div>
    </div>

    <!-- Cards Modal -->
    <div id="cardsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">💳 Мои Карточки</div>
                <button class="close-btn" onclick="closeModal('cardsModal')">✕</button>
            </div>
            <div id="myCardsList"></div>
            
            <!-- Стильная кнопка закрытия -->
            <button class="category-close-btn" onclick="closeModal('cardsModal')">
                ✕ Закрыть карточки
            </button>
        </div>
    </div>

    <!-- Withdraw Modal -->
    <div id="withdrawModal" class="modal">
        <div class="modal-content" style="max-height: 80vh; overflow-y: auto;">
            <div class="modal-header">
                <div class="modal-title">💸 Вывод средств</div>
                <button class="close-btn" onclick="closeModal('withdrawModal')">✕</button>
            </div>
            <div id="withdrawContent"></div>
            
            <!-- Стильная кнопка закрытия -->
            <button class="category-close-btn" onclick="closeModal('withdrawModal')">
                ✕ Закрыть вывод
            </button>
        </div>
    </div>

    <!-- Referrals Modal -->
    <div id="referralsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">👥 Реферальная система</div>
                <button class="close-btn" onclick="closeModal('referralsModal')">✕</button>
            </div>
            <div class="referral-benefits">
                <div class="benefit-item">✅ 5% пассивный доход от приглашенных</div>
                <div class="benefit-item">🎁 100 🪙 за каждого реферала</div>
                <div class="benefit-item">💰 Доход в реальном времени</div>
            </div>
            <div class="stats-window">
                <div class="stats-row">
                    <span class="stats-label">Рефералов</span>
                    <span class="stats-value" id="refCount">0</span>
                </div>
                <div class="stats-row">
                    <span class="stats-label">Реферальный доход</span>
                    <span class="stats-value" id="refIncome">0 🪙</span>
                </div>
            </div>
            <div style="margin-top: 20px;">
                <div style="margin-bottom: 10px; font-weight: bold;">Ваша реферальная ссылка:</div>
                <div class="referral-link" id="refLink">-</div>
                <button class="btn" onclick="copyRefLink()">📋 Копировать ссылку</button>
            </div>
            
            <!-- Стильная кнопка закрытия -->
            <button class="category-close-btn" onclick="closeModal('referralsModal')">
                ✕ Закрыть рефералы
            </button>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();

        // Make user globally available
        window.user = tg.initDataUnsafe?.user;
        if (window.user) {
            const usernameEl = document.getElementById('username');
            if (usernameEl) {
                usernameEl.textContent = window.user.first_name || 'Майнер';
            }
        }

        let energyRegenInterval;

        // VIP Status Management
        function loadVIPStatus(userData) {
            const vipLevel = userData.vip_level || 0;
            const vipBadge = userData.vip_badge || '';
            const hasPremium = userData.has_premium_support || false;
            const hasGolden = userData.has_golden_profile || false;
            const hasTop = userData.has_top_place || false;
            const hasUnique = userData.has_unique_design || false;
            
            // Buttons are now in the header, no need to add them dynamically
            
            if (vipLevel > 0) {
                const badgeEl = document.getElementById('vipBadge');
                const privEl = document.getElementById('vipPrivileges');
                
                // VIP badge display
                const badges = {
                    'bronze_vip': '🥉 BRONZE VIP',
                    'silver_vip': '🥈 SILVER VIP',
                    'gold_vip': '🥇 GOLD VIP',
                    'platinum_vip': '💎 PLATINUM VIP',
                    'diamond_vip': '💠 DIAMOND VIP',
                    'absolute_vip': '👑 ABSOLUTE VIP'
                };
                
                if (badgeEl && vipBadge && vipLevel > 0) {
                    badgeEl.innerHTML = '<span style="background:linear-gradient(135deg,#ffd700,#ffed4e);color:#000;padding:4px 10px;border-radius:8px;font-size:10px;font-weight:700;">' + (badges[vipBadge] || 'VIP') + '</span>';
                    badgeEl.style.display = 'inline';
                } else if (badgeEl) {
                    badgeEl.style.display = 'none';
                }
                
                // VIP privileges display
                if (privEl) {
                    const privs = [];
                    if (hasPremium && vipLevel > 0) privs.push('⭐ Premium Support');
                    if (hasGolden && vipLevel > 0) privs.push('🌟 Golden Profile');
                    if (hasTop && vipLevel > 0) privs.push('🏆 Top Place');
                    if (hasUnique && vipLevel > 0) privs.push('✨ Unique Design');
                    
                    if (privs.length > 0) {
                        privEl.textContent = privs.join(' • ');
                        privEl.style.display = 'block';
                    } else {
                        privEl.style.display = 'none';
                    }
                }
                
                // Apply VIP styling to header
                if (hasGolden && document.getElementById('mainTitle')) {
                    document.getElementById('mainTitle').style.background = 'linear-gradient(135deg, #ffd700, #ffed4e)';
                    document.getElementById('mainTitle').style.webkitBackgroundClip = 'text';
                    document.getElementById('mainTitle').style.webkitTextFillColor = 'transparent';
                    document.getElementById('mainTitle').style.filter = 'drop-shadow(0 0 20px rgba(255,215,0,0.5))';
                }
                
                // Add VIP premium background effect
                if (vipLevel >= 3) {
                    let bgExists = document.querySelector('.vip-golden-bg');
                    if (!bgExists) {
                        const goldenBg = document.createElement('div');
                        goldenBg.className = 'vip-golden-bg';
                        document.body.appendChild(goldenBg);
                        
                        // Add premium shine effect
                        const premiumShine = document.createElement('div');
                        premiumShine.className = 'vip-premium-shine';
                        document.body.appendChild(premiumShine);
                    }
                }
                
                // Add VIP particle effects
                if (vipLevel >= 4) {
                    startVIPParticles();
                }
                
                // Add Aura effect for VIP level 6
                if (vipLevel >= 6) {
                    addVIPAura();
                    addRainbowEffects();
                }
                
                // Apply VIP glow to all clickable elements
                if (vipLevel >= 3) {
                    document.querySelectorAll('.btn, .tap-button').forEach(el => {
                        el.classList.add('vip-glow-box');
                    });
                }
                
                // Show VIP sections if user has appropriate level
                if (vipLevel >= 5) {
                    showVIPMiningSection();
                }
                
                if (vipLevel >= 4) {
                    showVIPEventsSection();
                }
            }
        }
        
        function showVIPMiningSection() {
            // This will be called when VIP user opens mining modal
            const miningModal = document.getElementById('miningModal2');
            if (miningModal && !miningModal.querySelector('#vipMiningSection')) {
                const vipSection = document.createElement('div');
                vipSection.innerHTML = document.getElementById('vipMiningSection')?.innerHTML || '';
                if (miningModal.querySelector('.machinesList')) {
                    miningModal.querySelector('.machinesList').appendChild(vipSection);
                }
            }
        }
        
        function showVIPEventsSection() {
            // VIP events accessible from menu
            // Will be integrated into main interface
        }
        function openVIPProfileModal() {
            fetch('/api/user_data', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({user_id: window.user?.id})
            })
            .then(res => res.json())
            .then(userData => {
                const vipLevel = userData.vip_level || 0;
                const badges = {
                    'bronze_vip': '🥉 BRONZE VIP',
                    'silver_vip': '🥈 SILVER VIP',
                    'gold_vip': '🥇 GOLD VIP',
                    'platinum_vip': '💎 PLATINUM VIP',
                    'diamond_vip': '💠 DIAMOND VIP',
                    'absolute_vip': '👑 ABSOLUTE VIP'
                };
                
                const savedPhoto = localStorage.getItem('vip_profile_photo') || '';
                const photoPlaceholder = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTIwIiBoZWlnaHQ9IjEyMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZGVmcz48bGluZWFyR3JhZGllbnQgaWQ9ImciIHgxPSIwJSIgeTE9IjAlIiB4Mj0iMTAwJSIgeTI9IjEwMCUiPjxzdG9wIG9mZnNldD0iMCUiIHN0b3AtY29sb3I9IiM2NjdFZUEiLz48c3RvcCBvZmZzZXQ9IjEwMCUiIHN0b3AtY29sb3I9IiM3NjRCRUEiLz48L2xpbmVhckdyYWRpZW50PjwvZGVmcz48cmVjdCB3aWR0aD0iMTIwIiBoZWlnaHQ9IjEyMCIgZmlsbD0idXJsKCNnKSIgcng9IjUwJSIvPjx0ZXh0IHg9IjYwIiB5PSI2NSIgZm9udC1zaXplPSI1MCIgZmlsbD0iI2ZmZiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iIGZvbnQtZmFtaWx5PSJBcmlhbCI+4piCPC90ZXh0Pjwvc3ZnPg==';
                
                const modal = document.createElement('div');
                modal.className = 'modal active';
                modal.style.zIndex = '10000';
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 400px; max-height: 90vh; overflow-y: auto;background: linear-gradient(135deg, rgba(10, 14, 39, 0.98), rgba(15, 23, 42, 0.98));border-radius: 24px;border: 2px solid rgba(167,139,250,0.4);box-shadow: 0 10px 40px rgba(167,139,250,0.3);">
                        <div style="background:linear-gradient(135deg,#a78bfa,#c084fc,#d946ef);padding:24px;border-radius:22px 22px 0 0;text-align:center;">
                            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;">
                                <h2 style="font-size: 24px; color: #fff; margin: 0; font-weight: 900;">👑 ${userData.username || 'Майнер'}</h2>
                                <button class="close-btn" onclick="this.closest('.modal').remove()">✕</button>
                            </div>
                            
                            <div style="position:relative;width:110px;height:110px;margin:0 auto 18px;border-radius:50%;background:linear-gradient(135deg,#a78bfa,#c084fc,#d946ef);padding:4px;cursor:pointer;transition:all 0.3s ease;" onclick="document.getElementById('photoInput').click()" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                                <img id="profilePhoto" src="${savedPhoto || photoPlaceholder}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;border:3px solid rgba(255,255,255,0.3);">
                                <div style="position:absolute;bottom:0;right:0;width:36px;height:36px;background:#000;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:18px;border:3px solid #fff;box-shadow:0 2px 10px rgba(0,0,0,0.3);">📷</div>
                            </div>
                            <input type="file" id="photoInput" accept="image/*" style="display:none;" onchange="handlePhotoUpload(event)">
                            
                            <div style="background:rgba(0,0,0,0.3);padding:12px;border-radius:12px;color:#fff;margin-bottom:10px;">
                                <div style="font-size:18px;font-weight:900;color:#fff;">${vipLevel > 0 ? (badges[userData.vip_badge || ''] || 'VIP') + ' (Уровень ' + vipLevel + ')' : 'Обычный игрок'}</div>
                                <div style="font-size:13px;margin-top:5px;opacity:0.8;color:#fff;">${userData.username || 'Майнер'}</div>
                            </div>
                        </div>
                        
                        <div style="padding:20px;">
                            ${vipLevel >= 3 ? `
                            <div style="background:linear-gradient(135deg,rgba(255,215,0,0.1),rgba(255,255,255,0.05));padding:12px;border-radius:12px;border:1px solid rgba(255,215,0,0.2);margin-bottom:12px;">
                                <div style="font-size:13px;font-weight:700;margin-bottom:8px;color:#ffd700;">✨ VIP ПРИВИЛЕГИИ</div>
                                <div style="font-size:11px;color:#fff;line-height:1.8;">
                                    ${userData.has_premium_support ? '⭐ Premium Support ' : ''}
                                    ${userData.has_golden_profile ? '🌟 Golden Profile ' : ''}
                                    ${userData.has_top_place ? '🏆 Top Place ' : ''}
                                    ${userData.has_unique_design ? '✨ Unique Design' : ''}
                                </div>
                            </div>
                            ` : `
                            <button onclick="openBuyVIPModal(); this.closest('.modal').remove();" style="width:100%;padding:14px;background:linear-gradient(135deg,#ffd700,#ffed4e);color:#000;border:none;border-radius:12px;cursor:pointer;font-weight:800;font-size:15px;margin-bottom:15px;box-shadow:0 4px 15px rgba(255,215,0,0.5);">👑 Купить VIP</button>
                            `}
                            
                            <div style="background:rgba(0,0,0,0.2);padding:15px;border-radius:12px;margin-bottom:15px;border:1px solid rgba(255,255,255,0.2);">
                                <div style="font-size:14px;font-weight:700;margin-bottom:12px;color:#fff;text-align:center;">📊 СТАТИСТИКА</div>
                                <div style="font-size:12px;line-height:1.9;">
                                    <div style="display:flex;justify-content:space-between;padding:10px;border-bottom:1px solid rgba(255,255,255,0.1);">
                                        <span style="color:#94a3b8;">💰 Коины:</span>
                                        <span data-stat="coins" style="font-weight:700;color:#fff;">${Math.floor(userData.coins || 0)}</span>
                                    </div>
                                    <div style="display:flex;justify-content:space-between;padding:10px;border-bottom:1px solid rgba(255,255,255,0.1);">
                                        <span style="color:#94a3b8;">💎 QuanHash:</span>
                                        <span data-stat="quanhash" style="font-weight:700;color:#fff;">${Math.floor(userData.quanhash || 0)}</span>
                                    </div>
                                    <div style="display:flex;justify-content:space-between;padding:10px;border-bottom:1px solid rgba(255,255,255,0.1);">
                                        <span style="color:#94a3b8;">⚡ Энергия:</span>
                                        <span data-stat="energy" style="font-weight:700;color:#fff;">${Math.floor(userData.energy || 0)}/${userData.max_energy || 1000}</span>
                                    </div>
                                    <div style="display:flex;justify-content:space-between;padding:10px;border-bottom:1px solid rgba(255,255,255,0.1);">
                                        <span style="color:#94a3b8;">👆 Всего тапов:</span>
                                        <span data-stat="total_taps" style="font-weight:700;color:#fff;">${Math.floor(userData.total_taps || 0)}</span>
                                    </div>
                                    ${userData.active_multiplier > 1 ? `
                                    <div style="display:flex;justify-content:space-between;padding:10px;border-bottom:1px solid rgba(255,255,255,0.1);">
                                        <span style="color:#94a3b8;">⚡ Усилитель тапа:</span>
                                        <span style="font-weight:700;color:#fbbf24;">+${userData.active_multiplier - 1} тапов</span>
                                    </div>
                                    ` : ''}
                                    <div style="display:flex;justify-content:space-between;padding:10px;">
                                        <span style="color:#94a3b8;">💵 Общий доход:</span>
                                        <span data-stat="total_earned" style="font-weight:700;color:#10b981;">${Math.floor(userData.total_earned || 0)}</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-bottom:15px;">
                                <!-- My Purchases Button -->
                                <div id="myPurchasesBtn" style="cursor:pointer;padding:14px;background:linear-gradient(135deg,#10b981,#059669);border-radius:12px;text-align:center;font-weight:800;font-size:13px;color:#fff;transition:all 0.3s;box-shadow:0 4px 12px rgba(16,185,129,0.3);" onmouseover="this.style.transform='scale(1.05)';this.style.boxShadow='0 6px 16px rgba(16,185,129,0.4)'" onmouseout="this.style.transform='scale(1)';this.style.boxShadow='0 4px 12px rgba(16,185,129,0.3)'">
                                    🛍️ Покупки
                                </div>
                                
                                <!-- Achievements Button -->
                                <div onclick="openAchievements(); this.closest('.modal').remove();" style="cursor:pointer;padding:14px;background:linear-gradient(135deg,#667eea,#764ba2);border-radius:12px;text-align:center;font-weight:800;font-size:13px;color:#fff;transition:all 0.3s;box-shadow:0 4px 12px rgba(102,126,234,0.3);" onmouseover="this.style.transform='scale(1.05)';this.style.boxShadow='0 6px 16px rgba(102,126,234,0.4)'" onmouseout="this.style.transform='scale(1)';this.style.boxShadow='0 4px 12px rgba(102,126,234,0.3)'">
                                    🏆 Достижения
                                </div>
                            </div>
                            
                            <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-bottom:15px;">
                                <!-- Leaderboard Button -->
                                <div onclick="openVIPTopLeaders(); this.closest('.modal').remove();" style="cursor:pointer;padding:14px;background:linear-gradient(135deg,#fbbf24,#fcd34d);border-radius:12px;text-align:center;font-weight:800;font-size:13px;color:#000;transition:all 0.3s;box-shadow:0 4px 12px rgba(251,191,36,0.3);" onmouseover="this.style.transform='scale(1.05)';this.style.boxShadow='0 6px 16px rgba(251,191,36,0.4)'" onmouseout="this.style.transform='scale(1)';this.style.boxShadow='0 4px 12px rgba(251,191,36,0.3)'">
                                    🏅 Топ
                                </div>
                                
                                <!-- History Button -->
                                <div onclick="openReferrals({preventDefault:()=>{}}); this.closest('.modal').remove();" style="cursor:pointer;padding:14px;background:linear-gradient(135deg,#06b6d4,#0891b2);border-radius:12px;text-align:center;font-weight:800;font-size:13px;color:#fff;transition:all 0.3s;box-shadow:0 4px 12px rgba(6,182,212,0.3);" onmouseover="this.style.transform='scale(1.05)';this.style.boxShadow='0 6px 16px rgba(6,182,212,0.4)'" onmouseout="this.style.transform='scale(1)';this.style.boxShadow='0 4px 12px rgba(6,182,212,0.3)'">
                                    📜 История
                                </div>
                            </div>
                            
                            <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-bottom:15px;">
                                <!-- Referrals Button -->
                                <div onclick="openReferrals({preventDefault:()=>{}}); this.closest('.modal').remove();" style="cursor:pointer;padding:14px;background:linear-gradient(135deg,#8b5cf6,#7c3aed);border-radius:12px;text-align:center;font-weight:800;font-size:13px;color:#fff;transition:all 0.3s;box-shadow:0 4px 12px rgba(139,92,246,0.3);" onmouseover="this.style.transform='scale(1.05)';this.style.boxShadow='0 6px 16px rgba(139,92,246,0.4)'" onmouseout="this.style.transform='scale(1)';this.style.boxShadow='0 4px 12px rgba(139,92,246,0.3)'">
                                    👥 Рефералы
                                </div>
                                
                                <!-- Support Button -->
                                <div onclick="openSupport({preventDefault:()=>{}}); this.closest('.modal').remove();" style="cursor:pointer;padding:14px;background:linear-gradient(135deg,#ef4444,#dc2626);border-radius:12px;text-align:center;font-weight:800;font-size:13px;color:#fff;transition:all 0.3s;box-shadow:0 4px 12px rgba(239,68,68,0.3);" onmouseover="this.style.transform='scale(1.05)';this.style.boxShadow='0 6px 16px rgba(239,68,68,0.4)'" onmouseout="this.style.transform='scale(1)';this.style.boxShadow='0 4px 12px rgba(239,68,68,0.3)'">
                                    🆘 Поддержка
                                </div>
                            </div>
                            
                            <button onclick="this.closest('.modal').remove()" style="width:100%;padding:14px;background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border:none;border-radius:12px;cursor:pointer;font-weight:700;font-size:15px;margin-top:10px;">Закрыть</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                modal.onclick = (e) => {if(e.target === modal) modal.remove();};
                
                // Add click handler for My Purchases button
                const purchasesBtn = document.getElementById('myPurchasesBtn');
                if (purchasesBtn) {
                    purchasesBtn.addEventListener('click', () => {
                        openMyPurchases(userData);
                    });
                }
            });
        }
        
        function openMyPurchases(userData) {
            // Close profile modal first
            document.querySelectorAll('.modal.active').forEach(m => m.remove());
            
            // Fetch detailed purchase data
            fetch('/api/user_data', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({user_id: window.user?.id})
            })
            .then(res => res.json())
            .then(data => {
                const modal = document.createElement('div');
                modal.className = 'modal active';
                modal.style.zIndex = '10001';
                
                // Get current time for time remaining calculations
                const now = new Date();
                
                let purchasesContent = `
                    <div style="background:linear-gradient(135deg,rgba(10,14,39,0.98),rgba(15,23,42,0.98));border-radius:24px;border:2px solid rgba(167,139,250,0.4);box-shadow:0 10px 40px rgba(167,139,250,0.3);max-width:450px;max-height:85vh;overflow-y:auto;">
                        <div style="background:linear-gradient(135deg,#10b981,#059669);padding:20px;border-radius:22px 22px 0 0;text-align:center;">
                            <h2 style="font-size:22px;color:#fff;margin:0;font-weight:900;">🛍️ МОИ ПОКУПКИ</h2>
                            <button class="close-btn" onclick="this.closest('.modal').remove()">✕</button>
                        </div>
                        <div style="padding:20px;">
                `;
                
                // Shop purchases: Tap Boost Amplifiers - Show total only
                if (data.active_multiplier > 1 || (data.tap_boost_levels && Object.keys(data.tap_boost_levels).some(k => data.tap_boost_levels[k] > 0))) {
                    purchasesContent += `
                        <div style="margin-bottom:16px;">
                            <div style="font-size:15px;font-weight:800;color:#fff;margin-bottom:10px;padding:8px;background:rgba(251,191,36,0.2);border-radius:8px;">⚡ УСИЛИТЕЛЬ ТАПА</div>
                    `;
                    
                    // Show total combined effect
                    const totalTapsFromActiveMultiplier = data.active_multiplier > 1 ? (data.active_multiplier - 1) : 0;
                    purchasesContent += `
                        <div style="background:rgba(251,191,36,0.3);padding:12px;border-radius:10px;margin-bottom:8px;border:1px solid rgba(251,191,36,0.5);">
                            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:5px;">
                                <span style="color:#fff;font-weight:700;font-size:13px;">Общий усилитель тапа</span>
                                <span style="color:#4ade80;font-weight:700;font-size:13px;">+${totalTapsFromActiveMultiplier} тапов</span>
                            </div>
                            <div style="color:#86efac;font-size:11px;font-weight:600;">✨ Навсегда</div>
                        </div>
                    `;
                    
                    purchasesContent += `</div>`;
                }
                
                // Shop purchases: Energy Buy (Energy per second recovery) - Show total only
                if (data.energy_regen_rate > 1 || (data.energy_buy_levels && Object.keys(data.energy_buy_levels).some(k => data.energy_buy_levels[k] > 0))) {
                    purchasesContent += `
                        <div style="margin-bottom:16px;">
                            <div style="font-size:15px;font-weight:800;color:#fff;margin-bottom:10px;padding:8px;background:rgba(16,185,129,0.2);border-radius:8px;">⚡ ВОССТАНОВЛЕНИЕ ЭНЕРГИИ</div>
                    `;
                    
                    // Show total regen rate (includes base 1.0 + upgrades)
                    const totalRegen = data.energy_regen_rate || 1.0;
                    const bonusRegen = (totalRegen - 1.0).toFixed(2);
                    if (bonusRegen > 0) {
                        purchasesContent += `
                            <div style="background:rgba(16,185,129,0.3);padding:12px;border-radius:10px;margin-bottom:8px;border:1px solid rgba(16,185,129,0.5);">
                                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:5px;">
                                    <span style="color:#fff;font-weight:700;font-size:13px;">Общая скорость восстановления</span>
                                    <span style="color:#4ade80;font-weight:700;font-size:13px;">+${bonusRegen}/сек</span>
                                </div>
                                <div style="color:#86efac;font-size:11px;font-weight:600;">✨ Навсегда</div>
                            </div>
                        `;
                    }
                    
                    purchasesContent += `</div>`;
                }
                
                // Shop purchases: Energy Expand (Max Energy) - Show total only
                if (data.max_energy > 1000 || (data.energy_expand_levels && Object.keys(data.energy_expand_levels).some(k => data.energy_expand_levels[k] > 0))) {
                    purchasesContent += `
                        <div style="margin-bottom:16px;">
                            <div style="font-size:15px;font-weight:800;color:#fff;margin-bottom:10px;padding:8px;background:rgba(59,130,246,0.2);border-radius:8px;">⚡ РАСШИРЕНИЕ ЭНЕРГИИ</div>
                    `;
                    
                    // Show total max energy (includes base 1000 + upgrades)
                    const totalMaxEnergy = data.max_energy || 1000;
                    const bonusEnergy = totalMaxEnergy - 1000;
                    if (bonusEnergy > 0) {
                        purchasesContent += `
                            <div style="background:rgba(59,130,246,0.3);padding:12px;border-radius:10px;margin-bottom:8px;border:1px solid rgba(59,130,246,0.5);">
                                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:5px;">
                                    <span style="color:#fff;font-weight:700;font-size:13px;">Общая максимальная энергия</span>
                                    <span style="color:#4ade80;font-weight:700;font-size:13px;">+${bonusEnergy} энергии</span>
                                </div>
                                <div style="color:#86efac;font-size:11px;font-weight:600;">✨ Навсегда</div>
                            </div>
                        `;
                    }
                    
                    purchasesContent += `</div>`;
                }
                
                // Autobot status
                if (data.auto_tap_level > 0 && data.auto_tap_expires_at) {
                    const expiresAt = new Date(data.auto_tap_expires_at);
                    if (expiresAt > now) {
                        const remaining = Math.max(0, Math.floor((expiresAt - now) / 1000));
                        const days = Math.floor(remaining / 86400);
                        const hours = Math.floor((remaining % 86400) / 3600);
                        const minutes = Math.floor((remaining % 3600) / 60);
                        
                        purchasesContent += `
                            <div style="margin-bottom:16px;">
                                <div style="font-size:15px;font-weight:800;color:#fff;margin-bottom:10px;padding:8px;background:rgba(16,185,129,0.2);border-radius:8px;">🤖 АВТОБОТ</div>
                                <div style="background:rgba(16,185,129,0.3);padding:12px;border-radius:10px;border:1px solid rgba(16,185,129,0.5);">
                                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:5px;">
                                        <span style="color:#fff;font-weight:700;font-size:13px;">Уровень ${data.auto_tap_level} | Скорость ${data.auto_tap_speed}/сек</span>
                                        <span style="color:#4ade80;font-weight:700;font-size:13px;">${data.auto_tap_enabled ? '🟢 Активен' : '⚪ Остановлен'}</span>
                                    </div>
                                    <div style="color:#94a3b8;font-size:11px;font-weight:600;">⏱️ Осталось: ${days}д ${String(hours).padStart(2,'0')}:${String(minutes).padStart(2,'0')}</div>
                                </div>
                            </div>
                        `;
                    }
                }
                
                // Group and display purchased cards
                if (data.cards && data.cards.length > 0) {
                    const cardGroups = {};
                    data.cards.forEach(card => {
                        if (!cardGroups[card.name]) {
                            cardGroups[card.name] = { count: 0, totalIncome: 0 };
                        }
                        cardGroups[card.name].count++;
                        cardGroups[card.name].totalIncome += (card.income || 0);
                    });
                    
                    const cardsList = Object.entries(cardGroups);
                    if (cardsList.length > 0) {
                        purchasesContent += `
                            <div style="margin-bottom:16px;">
                                <div style="font-size:15px;font-weight:800;color:#fff;margin-bottom:10px;padding:8px;background:rgba(59,130,246,0.2);border-radius:8px;">💳 МОИ КАРТОЧКИ</div>
                        `;
                        
                        cardsList.forEach(([name, info]) => {
                            // Convert per minute income to per hour
                            const incomePerHour = Math.floor(info.totalIncome * 60);
                            purchasesContent += `
                                <div style="background:rgba(59,130,246,0.3);padding:12px;border-radius:10px;margin-bottom:8px;border:1px solid rgba(59,130,246,0.5);">
                                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:5px;">
                                        <span style="color:#fff;font-weight:700;font-size:13px;">${name} ${info.count > 1 ? `x${info.count}` : ''}</span>
                                        <span style="color:#4ade80;font-weight:700;font-size:13px;">+${incomePerHour}/час</span>
                                    </div>
                                    <div style="color:#86efac;font-size:11px;font-weight:600;">✨ Постоянная карточка</div>
                                </div>
                            `;
                        });
                        
                        purchasesContent += `</div>`;
                    }
                }
                
                // Group and display purchased machines
                if (data.machines && data.machines.length > 0) {
                    const machineGroups = {};
                    data.machines.forEach(machine => {
                        if (!machineGroups[machine.name]) {
                            machineGroups[machine.name] = { count: 0, totalHashRate: 0 };
                        }
                        machineGroups[machine.name].count++;
                        machineGroups[machine.name].totalHashRate += (machine.hash_rate || 0);
                    });
                    
                    const machinesList = Object.entries(machineGroups);
                    if (machinesList.length > 0) {
                        purchasesContent += `
                            <div style="margin-bottom:16px;">
                                <div style="font-size:15px;font-weight:800;color:#fff;margin-bottom:10px;padding:8px;background:rgba(168,85,247,0.2);border-radius:8px;">🏭 МОИ МАЙНИНГИ</div>
                        `;
                        
                        machinesList.forEach(([name, info]) => {
                            purchasesContent += `
                                <div style="background:rgba(168,85,247,0.3);padding:12px;border-radius:10px;margin-bottom:8px;border:1px solid rgba(168,85,247,0.5);">
                                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:5px;">
                                        <span style="color:#fff;font-weight:700;font-size:13px;">${name} ${info.count > 1 ? `x${info.count}` : ''}</span>
                                        <span style="color:#4ade80;font-weight:700;font-size:13px;">+${(info.totalHashRate * 3600).toFixed(2)}/час</span>
                                    </div>
                                    <div style="color:#86efac;font-size:11px;font-weight:600;">✨ Постоянная майнинг-ферма</div>
                                </div>
                            `;
                        });
                        
                        purchasesContent += `</div>`;
                    }
                }
                
                purchasesContent += `
                        </div>
                    </div>
                `;
                
                modal.innerHTML = purchasesContent;
                document.body.appendChild(modal);
                modal.onclick = (e) => {if(e.target === modal) modal.remove();};
            })
            .catch(err => {
                console.error('Error loading purchases:', err);
                tg.showAlert('❌ Ошибка загрузки покупок');
            });
        }
        
        function handlePhotoUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const photoUrl = e.target.result;
                    localStorage.setItem('vip_profile_photo', photoUrl);
                    document.getElementById('profilePhoto').src = photoUrl;
                    const icon = document.querySelector('.vip-profile-icon');
                    if (icon) {
                        icon.innerHTML = '';
                        const img = document.createElement('img');
                        img.src = photoUrl;
                        icon.appendChild(img);
                    }
                };
                reader.readAsDataURL(file);
            }
        }
        function openVIPTopLeaders() {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.style.zIndex = '10000';
            
            function loadTopData() {
                fetch('/api/top_users', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({limit: 999})
                })
                .then(res => {
                    console.log('[TOP_LEADERS] Response status:', res.status);
                    return res.json();
                })
                .then(topData => {
                    console.log('[TOP_LEADERS] Received data:', topData);
                    const topUsers = topData.users || [];
                    console.log('[TOP_LEADERS] Users count:', topUsers.length);
                    
                    // Sort: VIPs first, then by total_earned descending
                    const sortedUsers = [...topUsers].sort((a, b) => {
                        const aVip = a.vip_level || 0;
                        const bVip = b.vip_level || 0;
                        if (aVip !== bVip) return bVip - aVip; // VIPs first
                        return (b.total_earned || 0) - (a.total_earned || 0);
                    });
                    
                    let topHTML = sortedUsers.map((u, idx) => {
                        const medal = idx === 0 ? '🥇' : idx === 1 ? '🥈' : idx === 2 ? '🥉' : '';
                        const rankColor = idx === 0 ? '#ffd700' : idx === 1 ? '#c0c0c0' : idx === 2 ? '#cd7f32' : '#94a3b8';
                        const isVIP = u.vip_level && u.vip_level > 0;
                        const vipBadge = isVIP ? `<span style="background:linear-gradient(135deg,#ffd700,#ffed4e);color:#000;padding:2px 8px;border-radius:8px;font-size:10px;font-weight:800;">👑 VIP ${u.vip_level}</span>` : '';
                        
                        const vipNames = {1: 'Bronze', 2: 'Silver', 3: 'Gold', 4: 'Platinum', 5: 'Diamond', 6: 'Absolute'};
                        const vipName = vipNames[u.vip_level] || '';
                        const vipInfo = isVIP ? `<div style="font-size:10px;color:#ffd700;margin-top:2px;">${vipName} VIP</div>` : '';
                        
                        const passiveIncome = (u.passive_income || 0).toLocaleString();
                        const totalEarned = (u.total_earned || 0).toLocaleString();
                        const totalTaps = (u.total_taps || 0).toLocaleString();
                        const quanhash = (u.quanhash || 0).toLocaleString();
                        
                        return `<div style="padding:14px;background:${isVIP ? 'linear-gradient(135deg,rgba(255,215,0,0.15),rgba(255,255,255,0.08))' : 'rgba(0,0,0,0.25)'};border-radius:12px;margin-bottom:12px;border:2px solid ${isVIP ? 'rgba(255,215,0,0.4)' : 'rgba(255,255,255,0.1)'};">
                            <div style="display:flex;align-items:center;gap:14px;margin-bottom:10px;">
                                <div style="width:50px;height:50px;background:linear-gradient(135deg,#667eea,#764ba2);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:24px;font-weight:900;color:${rankColor};${idx < 3 ? 'box-shadow:0 0 15px rgba(255,215,0,0.5);' : ''}">${medal || (idx + 1)}</div>
                                <div style="flex:1;">
                                    <div style="font-size:16px;font-weight:800;color:#fff;margin-bottom:3px;">${u.username}</div>
                                    <div style="font-size:11px;color:#94a3b8;">Уровень ${u.level || 1}</div>
                                    ${vipInfo}
                                    ${vipBadge}
                                </div>
                            </div>
                            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:10px;padding-top:10px;border-top:1px solid rgba(255,255,255,0.1);">
                                <div style="background:rgba(0,0,0,0.3);padding:8px;border-radius:8px;">
                                    <div style="font-size:10px;color:#94a3b8;margin-bottom:3px;">💰 Коины</div>
                                    <div style="font-size:14px;font-weight:800;color:#ffd700;">${u.coins ? (u.coins).toLocaleString() : 0}</div>
                                </div>
                                <div style="background:rgba(0,0,0,0.3);padding:8px;border-radius:8px;">
                                    <div style="font-size:10px;color:#94a3b8;margin-bottom:3px;">💎 QuanHash</div>
                                    <div style="font-size:14px;font-weight:800;color:#10b981;">${quanhash}</div>
                                </div>
                                <div style="padding:8px;border-radius:8px;">
                                    <div style="font-size:10px;color:#94a3b8;margin-bottom:3px;">📈 Пассивный доход</div>
                                    <div style="font-size:14px;font-weight:800;color:#f093fb;">+${passiveIncome}/час</div>
                                </div>
                                <div style="background:rgba(0,0,0,0.3);padding:8px;border-radius:8px;">
                                    <div style="font-size:10px;color:#94a3b8;margin-bottom:3px;">💵 Всего заработано</div>
                                    <div style="font-size:14px;font-weight:800;color:#10b981;">${totalEarned}</div>
                                </div>
                                <div style="background:rgba(0,0,0,0.3);padding:8px;border-radius:8px;">
                                    <div style="font-size:10px;color:#94a3b8;margin-bottom:3px;">👆 Всего тапов</div>
                                    <div style="font-size:14px;font-weight:800;color:#94a3b8;">${totalTaps}</div>
                                </div>
                                <div style="background:rgba(0,0,0,0.3);padding:8px;border-radius:8px;">
                                    <div style="font-size:10px;color:#94a3b8;margin-bottom:3px;">🏆 Рейтинг</div>
                                    <div style="font-size:14px;font-weight:800;color:#667eea;">${totalEarned} 🪙</div>
                                </div>
                            </div>
                        </div>`;
                    }).join('');
                    
                    const contentDiv = modal.querySelector('#topLeadersContent');
                    if (contentDiv) {
                        contentDiv.innerHTML = topUsers.length > 0 ? topHTML : '<div style="text-align:center;color:#94a3b8;padding:40px;font-size:14px;">Рейтинг пуст</div>';
                    }
                })
                .catch(err => {
                    console.error('[TOP_LEADERS] Error loading top users:', err);
                    const contentDiv = modal.querySelector('#topLeadersContent');
                    if (contentDiv) {
                        contentDiv.innerHTML = '<div style="text-align:center;color:#ef4444;padding:40px;font-size:14px;">Ошибка загрузки рейтинга</div>';
                    }
                });
            }
            
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 450px; max-height: 90vh; overflow-y: auto;background: linear-gradient(135deg, rgba(10, 14, 39, 0.98), rgba(15, 23, 42, 0.98));border-radius: 20px;border: 2px solid rgba(102,126,234,0.4);">
                    <div style="background:linear-gradient(135deg,#667eea,#764ba2);padding:20px;border-radius:18px 18px 0 0;text-align:center;">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                            <h2 style="font-size: 24px; color: #fff; margin: 0; font-weight: 900;">🏆 ТОП ЛИДЕРЫ</h2>
                            <button class="close-btn" onclick="this.closest('.modal').remove(); if(window.topLeadersInterval) clearInterval(window.topLeadersInterval);">✕</button>
                        </div>
                        <div style="font-size:13px;color:rgba(255,255,255,0.8);">🔄 Лучшие игроки Quantum Nexus (Автообновление)</div>
                    </div>
                    
                    <div style="padding:20px;">
                        <div id="topLeadersContent" style="max-height:550px;overflow-y:auto;">
                            <div style="text-align:center;color:#94a3b8;padding:40px;font-size:14px;">Загрузка...</div>
                        </div>
                        
                        <button onclick="this.closest('.modal').remove(); if(window.topLeadersInterval) clearInterval(window.topLeadersInterval);" style="width:100%;margin-top:15px;padding:14px;background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border:none;border-radius:12px;cursor:pointer;font-weight:700;font-size:15px;">Закрыть</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            modal.onclick = (e) => {if(e.target === modal) { modal.remove(); if(window.topLeadersInterval) clearInterval(window.topLeadersInterval); }};
            
            // Load data immediately
            loadTopData();
            
            // Auto-refresh every 2.5 seconds
            window.topLeadersInterval = setInterval(loadTopData, 2500);
        }
        
        function addVIPAura() {
            let aura = document.querySelector('.vip-aura');
            if (!aura) {
                aura = document.createElement('div');
                aura.className = 'vip-aura';
                document.body.appendChild(aura);
            }
        }
        
        function openBuyVIPModal() {
            const vipPackages = [
                {level: 1, name: 'Bronze VIP', stars: 300, color: '#cd7f32', badge: '🥉', benefits: ['⭐ Premium Support', '✨ Уникальный маркер', '➕ 20% к тапу'], productId: 51},
                {level: 2, name: 'Silver VIP', stars: 600, color: '#c0c0c0', badge: '🥈', benefits: ['⭐ Premium Support', '✨ Уникальный маркер', '🏆 Top Place', '➕ 50% к тапу'], productId: 52},
                {level: 3, name: 'Gold VIP', stars: 1000, color: '#ffd700', badge: '🥇', benefits: ['⭐ Premium Support', '🌟 Golden Profile', '🏆 Top Place', '✨ Unique Design', '➕ 100% к тапу', '⚡ 50% энергии'], productId: 53},
                {level: 4, name: 'Platinum VIP', stars: 1500, color: '#e5e4e2', badge: '💎', benefits: ['Все из Gold VIP', '🎉 VIP Турниры', '✨ Частицы', '➕ 150% к тапу'], productId: 54},
                {level: 5, name: 'Diamond VIP', stars: 2000, color: '#b9f2ff', badge: '💠', benefits: ['Все из Platinum VIP', '👑 Корона', '💰 0% комиссия', '➕ 250% к тапу', '💎 VIP Boost 50x'], productId: 55},
                {level: 6, name: 'Absolute VIP', stars: 3000, color: '#ff69b4', badge: '👑', benefits: ['Все из Diamond VIP', '✨ Аура', '🌈 Радуга', '➕ 450% к тапу', '🌐 VIP Машины'], productId: 56}
            ];
            
            let vipHTML = vipPackages.map(pkg => `
                <div style="background:linear-gradient(135deg,${pkg.color},rgba(255,255,255,0.1));padding:14px;border-radius:12px;margin-bottom:12px;border:2px solid ${pkg.color};box-shadow:0 4px 15px ${pkg.color}40;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                        <div style="display:flex;align-items:center;gap:10px;">
                            <span style="font-size:28px;">${pkg.badge}</span>
                            <div>
                                <div style="font-size:16px;font-weight:900;color:#000;">${pkg.name}</div>
                                <div style="font-size:12px;color:rgba(0,0,0,0.7);">Уровень ${pkg.level}</div>
                            </div>
                        </div>
                        <div style="text-align:right;">
                            <div style="font-size:20px;font-weight:900;color:#000;">${pkg.stars}</div>
                            <div style="font-size:11px;color:rgba(0,0,0,0.7);">⭐ звезд</div>
                        </div>
                    </div>
                    <div style="background:rgba(0,0,0,0.2);padding:10px;border-radius:8px;margin-bottom:10px;">
                        <div style="font-size:11px;color:rgba(0,0,0,0.8);line-height:1.8;">
                            ${pkg.benefits.map(b => `<div>✓ ${b}</div>`).join('')}
                        </div>
                    </div>
                    <button onclick="window.open('https://t.me/qanexus_bot?start=buy_stars_${pkg.productId}')" style="width:100%;padding:10px;background:#000;color:${pkg.color};border:none;border-radius:8px;font-weight:900;font-size:13px;cursor:pointer;">Купить VIP за ${pkg.stars} ⭐</button>
                </div>
            `).join('');
            
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.style.zIndex = '10000';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 420px; max-height: 90vh; overflow-y: auto;background: linear-gradient(135deg, rgba(10, 14, 39, 0.98), rgba(15, 23, 42, 0.98));border-radius: 24px;border: 2px solid rgba(255,215,0,0.4);box-shadow: 0 10px 40px rgba(255,215,0,0.3);">
                    <div style="background:linear-gradient(135deg,#ffd700,#ffed4e);padding:24px;border-radius:22px 22px 0 0;text-align:center;">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                            <h2 style="font-size: 26px; color: #000; margin: 0; font-weight: 900;">👑 VIP СТАТУСЫ</h2>
                            <button class="close-btn" onclick="this.closest('.modal').remove()">✕</button>
                        </div>
                        <div style="font-size:14px;color:rgba(0,0,0,0.7);">Выберите VIP пакет</div>
                    </div>
                    
                    <div style="padding:20px;">
                        ${vipHTML}
                        
                        <button onclick="this.closest('.modal').remove()" style="width:100%;padding:14px;background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border:none;border-radius:12px;cursor:pointer;font-weight:700;font-size:15px;margin-top:10px;">Закрыть</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            modal.onclick = (e) => {if(e.target === modal) modal.remove();};
        }
        
        function addRainbowEffects() {
            // Apply rainbow border to key elements
            const elements = document.querySelectorAll('.stat-item-compact, .btn');
            elements.forEach(el => {
                el.style.border = '3px solid #ffd700';
                el.style.animation = 'vip-rainbow 3s linear infinite';
            });
        }
        
        function startVIPParticles() {
            // Remove existing particles
            const existing = document.querySelector('.vip-particles');
            if (existing) existing.remove();
            
            const particles = document.createElement('div');
            particles.className = 'vip-particles';
            
            for (let i = 0; i < 15; i++) {
                setTimeout(() => {
                    if (!particles.parentNode) return;
                    const particle = document.createElement('div');
                    particle.style.position = 'absolute';
                    particle.style.width = Math.random() * 6 + 2 + 'px';
                    particle.style.height = particle.style.width;
                    particle.style.background = '#ffd700';
                    particle.style.borderRadius = '50%';
                    particle.style.left = Math.random() * 100 + '%';
                    particle.style.top = '100%';
                    particle.style.boxShadow = '0 0 10px #ffd700, 0 0 20px #ffed4e';
                    particle.style.animation = `vip-float ${10 + Math.random() * 10}s linear infinite`;
                    particles.appendChild(particle);
                }, i * 200);
            }
            
            document.body.appendChild(particles);
        }
        
        const shopItems = {
            boosts: [
                {name: "2x Множитель", emoji: "⚡", price: 1000, desc: "Усиливает ваши тапы и увеличивает количество кликов", type: "multiplier_2x"},
                {name: "5x Множитель", emoji: "🔥", price: 5000, desc: "Мощно усиливает ваши тапы и увеличивает количество кликов", type: "multiplier_5x"},
                {name: "10x Множитель", emoji: "💥", price: 20000, desc: "Максимально усиливает ваши тапы и увеличивает количество кликов", type: "multiplier_10x"},
            ],
            automation: [
                {name: "🤖 Авто-бот тапов", emoji: "🤖", price: 50000, desc: "Автоматически тапает за вас", type: "auto_bot"},
                {name: "⚡ Двойная энергия", emoji: "⚡", price: 30000, desc: "Увеличивает максимальный запас вашей энергии", type: "double_energy"},
                {name: "🔄 Ускорение регенерации", emoji: "🔄", price: 40000, desc: "Ускоряет автоматическое восстановление вашей энергии", type: "regen_boost"},
            ],
            energy: [
                {name: "Энергия +50", emoji: "⚡", price: 1000, amount: 50},
                {name: "Энергия +200", emoji: "⚡⚡", price: 3500, amount: 200},
                {name: "Энергия +500", emoji: "⚡⚡⚡", price: 8000, amount: 500},
            ],
            cards: [
                {name: "Обычная карточка", emoji: "🟢", price: 500, desc: "Пассивный доход: 0.5 🪙/мин", type: "common"},
                {name: "Редкая карточка", emoji: "🔵", price: 2000, desc: "Пассивный доход: 2 🪙/мин", type: "rare"},
                {name: "Эпическая карточка", emoji: "🟣", price: 10000, desc: "Пассивный доход: 10 🪙/мин", type: "epic"},
                {name: "Легендарная карточка", emoji: "🟠", price: 50000, desc: "Пассивный доход: 50 🪙/мин", type: "legendary"},
            ]
        };

        function loadData() {
            fetch('/api/user_data', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({user_id: window.user?.id})
            })
            .then(res => res.json())
            .then(data => {
                // Save user data globally for shop calculations
                window.userData = data;
                
                const coins = Math.floor(data.coins || 0);
                const quanhash = Math.floor(data.quanhash || 0);
                const energy = parseInt(data.energy || 0);
                const maxEnergy = parseInt(data.max_energy || 1000);
                const energyRegenRate = parseFloat(data.energy_regen_rate || 1.0);
                const passiveCoins = Math.floor(data.passive_coins_per_hour || 0);
                const passiveHash = Math.floor(data.passive_hash_per_hour || 0);
                
                document.getElementById('coins').textContent = coins.toLocaleString();
                document.getElementById('quanhash').textContent = quanhash.toLocaleString();
                document.getElementById('energy-text').textContent = `${energy}/${maxEnergy}`;
                document.getElementById('passiveCoins').textContent = `+${passiveCoins.toLocaleString()}/час`;
                document.getElementById('passiveHash').textContent = `+${passiveHash.toLocaleString()}/час`;
                
                const energyPercent = Math.min(100, Math.max(0, (energy / maxEnergy) * 100));
                const fillBar = document.getElementById('energy-bar-fill');
                const percentText = document.getElementById('energy-percent');
                if (fillBar) {
                    fillBar.style.width = energyPercent + '%';
                }
                if (percentText) {
                    percentText.textContent = Math.round(energyPercent) + '%';
                }

                // Update energy regeneration rate display
                const energyRegenText = document.getElementById('energy-regen-text');
                if (energyRegenText) {
                    energyRegenText.textContent = `Восстановление: +${energyRegenRate.toFixed(1)}/сек`;
                }
                
                // Update energy regeneration rate in the running interval
                if (window.energyRegenRate !== undefined) {
                    window.energyRegenRate = energyRegenRate;
                }

                // Load VIP status and display it
                loadVIPStatus(data);
                
                // Update autobot toggle button
                updateAutobotToggle(data);
                
                // Update autobot shop buttons
                updateAutobotShopButtons(data);

                // Show withdraw button if user has 500k+ quanhash
                
                // Load shop levels after user data is loaded
                loadShopLevels();
                
                // Force refresh of current shop category if it's open
                setTimeout(() => {
                    const activeBtn = document.querySelector('.shop-cat-btn[style*="linear-gradient"]');
                    if (activeBtn && activeBtn.dataset.category) {
                        loadShopCategory(activeBtn.dataset.category);
                    }
                }, 100);
            })
            .catch(err => console.error('Error:', err));
        }
        function updateAutobotToggle(data) {
            const autobotStatusSection = document.getElementById('autobotStatusSection');
            const autobotStatusBtn = document.getElementById('autobotStatusBtn');
            
            if (!autobotStatusSection || !autobotStatusBtn) return;
            
            const autobotLevel = data.auto_tap_level || 0;
            const autobotSpeed = data.auto_tap_speed || 2.0;
            const autobotExpiresAt = data.auto_tap_expires_at || 0;
            
            // Show status if user has autobot (level > 0 and not expired)
            if (autobotLevel > 0 && autobotExpiresAt > Date.now()) {
                autobotStatusSection.style.display = 'block';
                
                // Store current state globally
                window.autobotExpiresAt = autobotExpiresAt;
                
                // Calculate remaining time
                const remainingMs = autobotExpiresAt - Date.now();
                const hours = Math.floor(remainingMs / 3600000);
                const minutes = Math.floor((remainingMs % 3600000) / 60000);
                const seconds = Math.floor((remainingMs % 60000) / 1000);
                const timeText = `${String(hours).padStart(2,'0')}:${String(minutes).padStart(2,'0')}:${String(seconds).padStart(2,'0')}`;
                
                // Update status text
                autobotStatusBtn.innerHTML = `🤖 Автобот активен | Уровень ${autobotLevel} | Скорость ${autobotSpeed}/сек | ⏱️ Осталось: ${timeText}`;
                
                // Update countdown
                if (window.autobotInterval) clearInterval(window.autobotInterval);
                window.autobotInterval = setInterval(() => {
                    const now = Date.now();
                    const remainingMs = window.autobotExpiresAt - now;
                    
                    if (remainingMs <= 0) {
                        clearInterval(window.autobotInterval);
                        autobotStatusSection.style.display = 'none';
                        return;
                    }
                    
                    const hours = Math.floor(remainingMs / 3600000);
                    const minutes = Math.floor((remainingMs % 3600000) / 60000);
                    const seconds = Math.floor((remainingMs % 60000) / 1000);
                    const timeText = `${String(hours).padStart(2,'0')}:${String(minutes).padStart(2,'0')}:${String(seconds).padStart(2,'0')}`;
                    
                    autobotStatusBtn.innerHTML = `🤖 Автобот активен | Уровень ${autobotLevel} | Скорость ${autobotSpeed}/сек | ⏱️ Осталось: ${timeText}`;
                }, 1000);
            } else {
                autobotStatusSection.style.display = 'none';
                if (window.autobotInterval) clearInterval(window.autobotInterval);
            }
        }
        
        function updateAutobotShopButtons(data) {
            const autobotExpiresAt = data.auto_tap_expires_at || 0;
            const autobotLevel = data.auto_tap_level || 0;
            const currentTime = Date.now();
            
            // Check if autobot is active
            if (autobotExpiresAt > currentTime && autobotLevel > 0) {
                const remainingMs = autobotExpiresAt - currentTime;
                const hours = Math.floor(remainingMs / 3600000);
                const minutes = Math.floor((remainingMs % 3600000) / 60000);
                const seconds = Math.floor((remainingMs % 60000) / 1000);
                const timeText = `${String(hours).padStart(2,'0')}:${String(minutes).padStart(2,'0')}:${String(seconds).padStart(2,'0')}`;
                
                // Block all autobot buttons
                for (let i = 1; i <= 20; i++) {
                    const btn = document.getElementById(`autobot-btn-${i}`);
                    if (btn) {
                        btn.disabled = true;
                        btn.style.background = 'rgba(148,163,184,0.3)';
                        btn.style.cursor = 'not-allowed';
                        
                        // Show countdown only on the purchased button
                        if (i === autobotLevel) {
                            btn.innerHTML = `⏱️ Осталось: ${timeText}`;
                            btn.style.background = 'rgba(239,68,68,0.6)';
                        } else {
                            btn.innerHTML = '🔒 Недоступно';
                        }
                    }
                }
                
                // Update countdown
                if (window.autobotShopInterval) clearInterval(window.autobotShopInterval);
                window.autobotShopInterval = setInterval(() => {
                    const now = Date.now();
                    const remainingMs = autobotExpiresAt - now;
                    
                    if (remainingMs <= 0) {
                        clearInterval(window.autobotShopInterval);
                        // Unblock all buttons
                        for (let i = 1; i <= 20; i++) {
                            const btn = document.getElementById(`autobot-btn-${i}`);
                            if (btn) {
                                btn.disabled = false;
                                btn.style.background = 'linear-gradient(135deg,#667eea,#764ba2)';
                                btn.style.cursor = 'pointer';
                                btn.innerHTML = `Купить ${window.shopData?.autobot?.items?.[i-1]?.price?.toLocaleString() || 0} 🪙`;
                            }
                        }
                        return;
                    }
                    
                    const hours = Math.floor(remainingMs / 3600000);
                    const minutes = Math.floor((remainingMs % 3600000) / 60000);
                    const seconds = Math.floor((remainingMs % 60000) / 1000);
                    const timeText = `${String(hours).padStart(2,'0')}:${String(minutes).padStart(2,'0')}:${String(seconds).padStart(2,'0')}`;
                    
                    // Update only the purchased button with countdown
                    const purchasedBtn = document.getElementById(`autobot-btn-${autobotLevel}`);
                    if (purchasedBtn) {
                        purchasedBtn.innerHTML = `⏱️ Осталось: ${timeText}`;
                    }
                }, 1000);
            } else {
                // Unblock all buttons
                if (window.autobotShopInterval) clearInterval(window.autobotShopInterval);
                for (let i = 1; i <= 20; i++) {
                    const btn = document.getElementById(`autobot-btn-${i}`);
                    if (btn) {
                        btn.disabled = false;
                        btn.style.background = 'linear-gradient(135deg,#667eea,#764ba2)';
                        btn.style.cursor = 'pointer';
                        btn.innerHTML = `Купить ${window.shopData?.autobot?.items?.[i-1]?.price?.toLocaleString() || 0} 🪙`;
                    }
                }
            }
        }

        function checkOfflineIncome() {
            fetch('/api/offline_income', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({user_id: window.user?.id})
            })
            .then(res => res.json())
            .then(data => {
                if (data.offline_time > 0 && data.offline_income > 0) {
                    const hours = Math.floor(data.offline_time / 3600);
                    const minutes = Math.floor((data.offline_time % 3600) / 60);
                    
                    // Check for offline QuanHash income too
                    const offlineHash = data.offline_hash || 0;
                    
                    const offlineContent = `
                        <div style="text-align: center; padding: 25px 15px;">
                            <div style="margin-bottom: 16px;">
                                <div style="font-size: 50px; filter: drop-shadow(0 0 15px rgba(74,222,128,0.6)); margin-bottom: 10px;">💰</div>
                                <div style="font-size: 16px; font-weight: 700; color: #4ade80; margin-bottom: 8px;">Привет, с возвращением!</div>
                                <div style="font-size: 11px; color: rgba(255,255,255,0.6); padding: 5px 12px; background: rgba(102,126,234,0.12); border-radius: 12px; display: inline-block;">⏱️ ${hours}ч ${minutes}м</div>
                            </div>
                            
                            <div style="display: grid; gap: 10px; margin-bottom: 12px;">
                                ${data.offline_income > 0 ? `
                                <div style="background: linear-gradient(135deg, rgba(102,126,234,0.2), rgba(118,75,162,0.2)); border: 1px solid rgba(102,126,234,0.5); border-radius: 14px; padding: 12px 16px; backdrop-filter: blur(10px);">
                                    <div style="font-size: 12px; color: rgba(255,255,255,0.7); margin-bottom: 4px; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 4px;">
                                        <span>🪙</span> <span>КОИНЫ</span>
                                    </div>
                                    <div style="font-size: 32px; font-weight: 900; color: #4ade80; letter-spacing: -1px;">+${Math.floor(data.offline_income).toLocaleString()}</div>
                                </div>
                                ` : ''}
                                
                                ${offlineHash > 0 ? `
                                <div style="background: linear-gradient(135deg, rgba(118,75,162,0.2), rgba(240,147,251,0.2)); border: 1px solid rgba(118,75,162,0.5); border-radius: 14px; padding: 12px 16px; backdrop-filter: blur(10px);">
                                    <div style="font-size: 12px; color: rgba(255,255,255,0.7); margin-bottom: 4px; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 4px;">
                                        <span>💎</span> <span>QUANHASH</span>
                                    </div>
                                    <div style="font-size: 32px; font-weight: 900; color: #f093fb; letter-spacing: -1px;">+${Math.floor(offlineHash).toLocaleString()}</div>
                                </div>
                                ` : ''}
                            </div>
                            
                            <div style="font-size: 10px; opacity: 0.4; font-style: italic; margin-top: 12px;">✨ Добавлено на баланс</div>
                        </div>
                    `;
                    document.getElementById('offlineContent').innerHTML = offlineContent;
                    document.getElementById('offlinePopup').classList.add('active');
                    
                    // Update user data
                    fetch('/api/user_data', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({user_id: window.user?.id})
                    })
                    .then(res => res.json())
                    .then(data => {
                        const coins = Math.floor(data.coins || 0);
                        document.getElementById('coins').textContent = coins;
                    });
                }
            });
        }

        function startEnergyRegen() {
            if (energyRegenInterval) clearInterval(energyRegenInterval);
            
            let lastEnergy = 0;
            window.energyRegenRate = 1.0; // Default rate, stored globally
            let energyAccumulator = 0; // For fractional energy regeneration
            let lastUpdateTime = Date.now();
            
            // Get current regeneration rate from the display
            const regenText = document.getElementById('energy-regen-text');
            if (regenText) {
                const match = regenText.textContent.match(/\+(\d+\.?\d*)\/сек/);
                if (match) {
                    window.energyRegenRate = parseFloat(match[1]);
                }
            }
            
            energyRegenInterval = setInterval(() => {
                const energyText = document.getElementById('energy-text').textContent;
                const [energy, maxEnergy] = energyText.split('/').map(e => parseInt(e));
                
                if (energy < maxEnergy) {
                    const now = Date.now();
                    const deltaTime = (now - lastUpdateTime) / 1000; // Convert to seconds
                    lastUpdateTime = now;
                    
                    // Accumulate energy based on time passed
                    energyAccumulator += window.energyRegenRate * deltaTime;
                    
                    // Only update when we have at least 1 energy to add
                    if (energyAccumulator >= 1) {
                        const energyToAdd = Math.floor(energyAccumulator);
                        energyAccumulator -= energyToAdd; // Keep the remainder
                        
                        const newEnergy = Math.min(energy + energyToAdd, maxEnergy);
                        if (newEnergy !== lastEnergy) {
                            lastEnergy = newEnergy;
                            document.getElementById('energy-text').textContent = `${newEnergy}/${maxEnergy}`;
                            const energyPercent = Math.min(100, Math.max(0, (newEnergy / maxEnergy) * 100));
                            const fillBar = document.getElementById('energy-bar-fill');
                            const percentText = document.getElementById('energy-percent');
                            if (fillBar) {
                                fillBar.style.width = energyPercent + '%';
                            }
                            if (percentText) {
                                percentText.textContent = Math.round(energyPercent) + '%';
                            }
                            
                            // Update server only when energy actually changes
                            fetch('/api/update_energy', {
                                method: 'POST',
                                headers: {'Content-Type': 'application/json'},
                                body: JSON.stringify({user_id: user?.id, energy: newEnergy})
                            });
                        }
                    }
                }
            }, 100); // Update every 100ms for smoother animation
        }

        function tap() {
            tg.HapticFeedback.impactOccurred('light');
            
            const button = document.querySelector('.tap-button');
            if(button){
                button.classList.add('tap-pressed');
                setTimeout(()=>{if(button)button.classList.remove('tap-pressed');},300);
            }
            
            const energy = parseInt(document.getElementById('energy-text').textContent.split('/')[0]);
            if (energy < 1) {
                tg.showAlert('⚠️ Нет энергии!');
                return;
            }
            
            fetch('/api/tap', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({user_id: window.user?.id})
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    // Only show animation if no modal is open
                    const hasOpenModal = document.querySelector('.modal.active');
                    if (!hasOpenModal) {
                        const button = document.querySelector('.tap-button');
                        if(button){
                            const rect = button.getBoundingClientRect();
                            const centerX = rect.left + rect.width / 2;
                            const centerY = rect.top + rect.height / 2;
                            
                            const coinAnimation = document.createElement('div');
                            coinAnimation.className = 'coin-animation';
                            coinAnimation.textContent = '+' + data.reward;
                            // Position from center of button
                            coinAnimation.style.left = centerX + 'px';
                            coinAnimation.style.top = centerY + 'px';
                            coinAnimation.style.transform = 'translate(-50%, -50%)';
                            coinAnimation.style.zIndex = '1000'; // Lower than modals
                            document.body.appendChild(coinAnimation);
                            setTimeout(() => { 
                                if(document.body.contains(coinAnimation)) {
                                    document.body.removeChild(coinAnimation); 
                                }
                            }, 2000);
                        }
                    }
                    loadData();
                }
            });
        }

        // Функции для расчета цены и эффекта по уровням (1-50)
        function calculateTapBoostEffect(level) {
            return Math.floor(level * Math.pow(1.2, level));
        }
        
        function calculateTapBoostPrice(level) {
            return Math.floor(1000 * Math.pow(1.5, level));
        }
        
        function calculateEnergyEffect(level) {
            return Math.round(level * 0.2 * Math.pow(1.15, level) * 100) / 100;
        }
        
        function calculateEnergyPrice(level) {
            return Math.floor(1000 * Math.pow(1.4, level));
        }
        
        function calculateExpandEffect(level) {
            return Math.floor(level * 50 * Math.pow(1.25, level));
        }
        
        function calculateExpandPrice(level) {
            return Math.floor(2000 * Math.pow(1.6, level));
        }
        
        // Name generation functions - simple names
        function generateTapBoostName(level) {
            return '💪 Усилитель Тапа';
        }
        
        function generateEnergyName(level) {
            return '⚡ Добавление Энергии';
        }
        
        function generateExpandName(level) {
            return '📈 Расширение Энергии';
        }
        function openShop(e) {
            e.preventDefault();
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.id = 'shopModal2';
            
            // Multilevel shop system - EACH item starts at level 0 and grows to 50
            const shopData = {
                'tap_boost': {
                    name: '💪 Усилитель Тапа',
                    emoji: '💪',
                    items: [
                        {level: 0, name: '🔋 Базовый Крипто-Бустер', desc: 'Увеличивает количество коинов за тап. Простая, но эффективная технология для начинающих крипто-энтузиастов.', currency: 'coins', locked: false, basePrice: 1000, baseEffect: 1},
                        {level: 0, name: '⚡ Турбо-Акселератор', desc: 'Ускоряет процесс добычи криптовалюты. Использует передовые алгоритмы оптимизации.', currency: 'coins', locked: false, basePrice: 2500, baseEffect: 3},
                        {level: 0, name: '🚀 Квантовый Ускоритель', desc: 'Мощный бустер, увеличивающий эффективность майнинга. Работает на принципах квантовой механики.', currency: 'coins', locked: false, basePrice: 5000, baseEffect: 6},
                        {level: 0, name: '💎 Алмазный Процессор', desc: 'Элитный чип для майнинга. Создан из нано-алмазов для максимальной производительности.', currency: 'coins', locked: false, basePrice: 10000, baseEffect: 12},
                        {level: 0, name: '🔥 Плазменный Реактор', desc: 'Инновационная технология, увеличивающая добычу. Использует энергию плазмы для сверхбыстрого майнинга.', currency: 'coins', locked: false, basePrice: 20000, baseEffect: 25},
                        {level: 0, name: '🌟 Звездный Двигатель', desc: 'Легендарный бустер космического уровня. Питается энергией далеких звезд.', currency: 'coins', locked: false, basePrice: 40000, baseEffect: 50},
                        {level: 0, name: '🌌 Галактический Усилитель', desc: 'Мифическая технология, увеличивающая майнинг. Использует силу целых галактик.', currency: 'coins', locked: false, basePrice: 80000, baseEffect: 100},
                        {level: 0, name: '⚛️ Атомный Синтезатор', desc: 'Божественная технология синтеза. Работает на принципах ядерного синтеза.', currency: 'coins', locked: false, basePrice: 150000, baseEffect: 200},
                        {level: 0, name: '🌠 Космическая Станция', desc: 'Орбитальная майнинг-станция, увеличивающая добычу. Добывает криптовалюту в космосе.', currency: 'coins', locked: false, basePrice: 300000, baseEffect: 400},
                        {level: 0, name: '🔮 Квантовый Портал', desc: 'Портал в параллельные измерения. Майнит криптовалюту из других вселенных.', currency: 'coins', locked: false, basePrice: 600000, baseEffect: 800}
                    ]
                },
                'energy_buy': {
                    name: '⚡ Восстановление Энергии',
                    emoji: '⚡',
                    items: [
                        {level: 0, name: '🔋 Солнечная Панель', desc: 'Базовый генератор энергии. Использует солнечный свет для подзарядки.', currency: 'coins', locked: false, basePrice: 1500, baseEffect: 0.5},
                        {level: 0, name: '⚡ Ветряная Турбина', desc: 'Улучшенный генератор. Преобразует кинетическую энергию в электрическую.', currency: 'coins', locked: false, basePrice: 3500, baseEffect: 1.2},
                        {level: 0, name: '🔥 Геотермальная Станция', desc: 'Продвинутый генератор. Использует тепло земных недр.', currency: 'coins', locked: false, basePrice: 7000, baseEffect: 2.5},
                        {level: 0, name: '💎 Кристальный Реактор', desc: 'Элитный генератор. Работает на кристаллах с высокой энергоемкостью.', currency: 'coins', locked: false, basePrice: 14000, baseEffect: 5.0},
                        {level: 0, name: '🌟 Звездный Коллектор', desc: 'Мастер-генератор. Собирает энергию далеких звезд.', currency: 'coins', locked: false, basePrice: 28000, baseEffect: 10.0},
                        {level: 0, name: '🌌 Галактический Ускоритель', desc: 'Легендарный генератор. Использует силу вращения галактик.', currency: 'coins', locked: false, basePrice: 55000, baseEffect: 20.0},
                        {level: 0, name: '⚛️ Атомный Синтезатор', desc: 'Мифический генератор. Работает на принципах термоядерного синтеза.', currency: 'coins', locked: false, basePrice: 110000, baseEffect: 40.0},
                        {level: 0, name: '🌠 Космическая Станция', desc: 'Божественный генератор. Орбитальная станция с неограниченными ресурсами.', currency: 'coins', locked: false, basePrice: 220000, baseEffect: 80.0},
                        {level: 0, name: '🔮 Квантовый Конденсатор', desc: 'Космический генератор. Использует квантовые флуктуации вакуума.', currency: 'coins', locked: false, basePrice: 440000, baseEffect: 160.0},
                        {level: 0, name: '🌌 Темная Материя', desc: 'Квантовый генератор. Преобразует темную материю в чистую энергию.', currency: 'coins', locked: false, basePrice: 880000, baseEffect: 320.0}
                    ]
                },
                'energy_expand': {
                    name: '📈 Расширение Энергии',
                    emoji: '📈',
                    items: [
                        {level: 0, name: '🔋 Литий-Ионная Батарея', desc: 'Базовый аккумулятор, увеличивающий максимальную энергию. Современная технология для надежного хранения энергии.', currency: 'coins', locked: false, basePrice: 2000, baseEffect: 50},
                        {level: 0, name: '⚡ Суперконденсатор', desc: 'Улучшенный накопитель, расширяющий энергоемкость. Мгновенная зарядка и разрядка с высокой эффективностью.', currency: 'coins', locked: false, basePrice: 5000, baseEffect: 120},
                        {level: 0, name: '🔥 Термоядерная Батарея', desc: 'Продвинутый накопитель, увеличивающий максимум энергии. Использует энергию термоядерного синтеза.', currency: 'coins', locked: false, basePrice: 10000, baseEffect: 250},
                        {level: 0, name: '💎 Кристальная Матрица', desc: 'Элитный накопитель, расширяющий энергоемкость. Матрица из кристаллов с невероятной энергоемкостью.', currency: 'coins', locked: false, basePrice: 20000, baseEffect: 500},
                        {level: 0, name: '🌟 Звездное Ядро', desc: 'Мастер-накопитель, увеличивающий максимум энергии. Содержит сжатую энергию звезды.', currency: 'coins', locked: false, basePrice: 40000, baseEffect: 1000},
                        {level: 0, name: '🌌 Галактический Резервуар', desc: 'Легендарный накопитель, расширяющий энергоемкость. Хранит энергию целой галактики.', currency: 'coins', locked: false, basePrice: 80000, baseEffect: 2000},
                        {level: 0, name: '⚛️ Квантовая Суперпозиция', desc: 'Мифический накопитель, увеличивающий максимум энергии. Использует квантовую суперпозицию для хранения.', currency: 'coins', locked: false, basePrice: 160000, baseEffect: 4000},
                        {level: 0, name: '🌠 Космический Портал', desc: 'Божественный накопитель, расширяющий энергоемкость. Подключается к энергетическим порталам вселенной.', currency: 'coins', locked: false, basePrice: 320000, baseEffect: 8000},
                        {level: 0, name: '🔮 Темная Энергия', desc: 'Космический накопитель, увеличивающий максимум энергии. Использует загадочную темную энергию.', currency: 'coins', locked: false, basePrice: 640000, baseEffect: 16000},
                        {level: 0, name: '🌌 Мультивселенная', desc: 'Квантовый накопитель, расширяющий энергоемкость. Подключается к энергии параллельных вселенных.', currency: 'coins', locked: false, basePrice: 1280000, baseEffect: 32000}
                    ]
                },
                'autobot': {
                    name: '🤖 Крипто-Боты',
                    emoji: '🤖',
                    items: [
                        // 10 позиций за коины (всегда 1 тап/сек)
                        {level: 1, name: '🤖 Базовый Бот', desc: 'Автотап на 15 минут', speed: 1, duration: 15, price: 2000, currency: 'coins', locked: false},
                        {level: 2, name: '⚡ Улучшенный Бот', desc: 'Автотап на 30 минут', speed: 1, duration: 30, price: 5000, currency: 'coins', locked: false},
                        {level: 3, name: '🌟 Продвинутый Бот', desc: 'Автотап на 1 час', speed: 1, duration: 60, price: 10000, currency: 'coins', locked: false},
                        {level: 4, name: '💎 Элитный Бот', desc: 'Автотап на 2 часа', speed: 1, duration: 120, price: 20000, currency: 'coins', locked: false},
                        {level: 5, name: '👑 Премиум Бот', desc: 'Автотап на 4 часа', speed: 1, duration: 240, price: 40000, currency: 'coins', locked: false},
                        {level: 6, name: '🌌 Мастер Бот', desc: 'Автотап на 6 часов', speed: 1, duration: 360, price: 80000, currency: 'coins', locked: false},
                        {level: 7, name: '💫 Легендарный Бот', desc: 'Автотап на 12 часов', speed: 1, duration: 720, price: 160000, currency: 'coins', locked: false},
                        {level: 8, name: '🔥 Мифический Бот', desc: 'Автотап на 1 день', speed: 1, duration: 1440, price: 320000, currency: 'coins', locked: false},
                        {level: 9, name: '⚡ Божественный Бот', desc: 'Автотап на 2 дня', speed: 1, duration: 2880, price: 640000, currency: 'coins', locked: false},
                        {level: 10, name: '👑 Императорский Бот', desc: 'Автотап на 3 дня', speed: 1, duration: 4320, price: 1280000, currency: 'coins', locked: false},
                    ]
                }
            };
            
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 450px; max-height: 85vh; overflow-y: auto;background: linear-gradient(135deg, rgba(10, 14, 39, 0.98), rgba(15, 23, 42, 0.98));border-radius: 24px;border: 2px solid rgba(167,139,250,0.4);box-shadow: 0 10px 40px rgba(167,139,250,0.3);">
                    <div style="background:linear-gradient(135deg,#a78bfa,#c084fc,#d946ef);padding:20px;border-radius:22px 22px 0 0;text-align:center;position:relative;">
                        <h2 style="font-size: 22px; color: #fff; margin: 0; font-weight: 900;">🛒 МАГАЗИН</h2>
                        <button class="close-btn" onclick="this.closest('.modal').remove()">✕</button>
                    </div>
                    <div style="padding:20px;">
                        <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-bottom:20px;">
                            <button class="shop-cat-btn" data-category="tap_boost" onclick="loadShopCategory('tap_boost')" style="padding:12px;background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border:none;border-radius:12px;cursor:pointer;font-weight:700;font-size:13px;">💪 Усилитель Тапа</button>
                            <button class="shop-cat-btn" data-category="energy_buy" onclick="loadShopCategory('energy_buy')" style="padding:12px;background:rgba(255,255,255,0.1);color:#fff;border:1px solid rgba(255,255,255,0.3);border-radius:12px;cursor:pointer;font-weight:700;font-size:13px;">⚡ Восстановление Энергии</button>
                            <button class="shop-cat-btn" data-category="energy_expand" onclick="loadShopCategory('energy_expand')" style="padding:12px;background:rgba(255,255,255,0.1);color:#fff;border:1px solid rgba(255,255,255,0.3);border-radius:12px;cursor:pointer;font-weight:700;font-size:13px;">📈 Расширение Энергии</button>
                            <button class="shop-cat-btn" data-category="autobot" onclick="loadShopCategory('autobot')" style="padding:12px;background:rgba(255,255,255,0.1);color:#fff;border:1px solid rgba(255,255,255,0.3);border-radius:12px;cursor:pointer;font-weight:700;font-size:13px;">🤖 Автобот</button>
                        </div>
                        <!-- VIP Button Row -->
                        <div id="vipButtonRow" style="margin-bottom:15px;">
                            <div style="padding:6px;background:linear-gradient(135deg,rgba(255,215,0,0.2),rgba(255,237,78,0.2),rgba(255,215,0,0.2));border:2px solid rgba(255,215,0,0.7);border-radius:12px;position:relative;box-shadow:0 4px 15px rgba(255,215,0,0.3);">
                                <!-- Premium Button -->
                                <button id="vipButton" onclick="openVIPModal('tap_boost')" style="width:100%;padding:8px 12px;background:linear-gradient(135deg,#ffd700,#ffed4e,#ffd700);color:#000;border:2px solid #ffd700;border-radius:8px;cursor:pointer;font-weight:800;font-size:14px;transition:all 0.3s;box-shadow:0 3px 10px rgba(255,215,0,0.4);position:relative;display:flex;align-items:center;justify-content:center;" onmousedown="this.style.transform='scale(0.97)'" onmouseup="this.style.transform='scale(1)'" onmouseleave="this.style.transform='scale(1)'">
                                    <span style="font-size:18px;margin-right:8px;text-shadow:0 2px 4px rgba(0,0,0,0.3);filter:drop-shadow(0 0 3px rgba(255,215,0,0.8));">⭐</span>
                                    <span style="flex:1;text-align:center;">Купить VIP функции за Telegram Stars</span>
                                    <div style="background:linear-gradient(135deg,#000,#333);color:#fff;padding:2px 6px;border-radius:4px;font-size:10px;font-weight:900;margin-left:8px;">VIP</div>
                                </button>
                            </div>
                        </div>
                        <div id="shopItemsList" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px;"></div>
                        
                        <!-- Стильная кнопка закрытия -->
                        <button class="category-close-btn" onclick="this.closest('.modal').remove()">
                            ✕ Закрыть магазин
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            // Store regular shop data first, then add VIP data
            window.shopData = shopData; // Store regular shop data
            // Add VIP data for VIP categories only
            window.shopData['tap_boost_vip'] = vipData['tap_boost'];
            window.shopData['energy_buy_vip'] = vipData['energy_buy'];
            window.shopData['energy_expand_vip'] = vipData['energy_expand'];
            window.shopData['autobot_vip'] = vipData['autobot'];
            
            // Load user's shop levels from database
            loadShopLevels();
            
            loadShopCategory('tap_boost');
        }
        
        function showVIPShopSection() {
            fetch('/api/user_data', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({user_id: window.user?.id})
            })
            .then(res => res.json())
            .then(data => {
                const vipLevel = data.vip_level || 0;
                const listDiv = document.getElementById('shopItemsList');
                
                if (vipLevel >= 3 && listDiv && !listDiv.querySelector('.vip-boosts-section')) {
                    const vipSection = document.createElement('div');
                    vipSection.className = 'vip-boosts-section';
                    vipSection.innerHTML = `
                        <div style="background:linear-gradient(135deg,#ffd700,#ffed4e);padding:12px;border-radius:12px;margin-bottom:15px;border:2px solid #ffd700;">
                            <div style="background:rgba(0,0,0,0.3);padding:10px;border-radius:8px;">
                                <div style="font-size:14px;font-weight:700;color:#000;margin-bottom:5px;">👑 VIP BOOST 20x</div>
                                <div style="font-size:11px;color:rgba(0,0,0,0.7);margin-bottom:8px;">x20 доход на 1 час • Только для VIP</div>
                                <div style="font-size:10px;color:#000;margin-bottom:8px;">✅ Требуется Gold VIP+</div>
                                <button onclick="buyVIPBoost('vip_boost_20x', 5000000)" style="width:100%;padding:10px;background:#000;color:#ffd700;border:none;border-radius:8px;font-weight:800;font-size:12px;cursor:pointer;">💰 5M 🪙</button>
                            </div>
                        </div>
                        ${vipLevel >= 5 ? `
                        <div style="background:linear-gradient(135deg,#c084fc,#a78bfa);padding:12px;border-radius:12px;margin-bottom:15px;border:2px solid #c084fc;">
                            <div style="background:rgba(0,0,0,0.3);padding:10px;border-radius:8px;">
                                <div style="font-size:14px;font-weight:700;color:#fff;margin-bottom:5px;">💎 DIAMOND BOOST 50x</div>
                                <div style="font-size:11px;color:rgba(255,255,255,0.8);margin-bottom:8px;">x50 доход на 24 часа</div>
                                <div style="font-size:10px;color:#c084fc;margin-bottom:8px;">✅ Только для Diamond VIP</div>
                                <button onclick="buyVIPBoost('diamond_boost_50x', 20000000)" style="width:100%;padding:10px;background:#fff;color:#a78bfa;border:none;border-radius:8px;font-weight:800;font-size:12px;cursor:pointer;">💰 20M 🪙</button>
                            </div>
                        </div>
                        ` : ''}
                    `;
                    if (listDiv) {
                        listDiv.insertBefore(vipSection, listDiv.firstChild);
                    }
                }
            });
        }
        
        function buyVIPBoost(boostType, price) {
            fetch('/api/buy_vip_boost', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    user_id: user?.id,
                    boost_type: boostType,
                    price: price
                })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    tg.showAlert('✅ VIP буст активирован!');
                    loadData();
                } else {
                    tg.showAlert('❌ ' + data.error);
                }
            })
            .catch(err => tg.showAlert('❌ Ошибка покупки'));
        }
        
        function openVIPModal(category) {
            const vipCategory = category + '_vip';
            const vipItems = window.shopData[vipCategory];
            if (!vipItems) return;
            
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.id = 'vipModal';
            
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 480px; max-height: 80vh; overflow-y: auto; background: linear-gradient(135deg, rgba(0,0,0,0.95), rgba(20,20,30,0.98)); border-radius: 24px; border: 2px solid rgba(255,215,0,0.7); box-shadow: 0 20px 60px rgba(255,215,0,0.3), 0 0 0 1px rgba(255,255,255,0.1); backdrop-filter: blur(20px);">
                    <div style="background: linear-gradient(135deg, #ffd700, #ffed4e, #ffd700); padding: 20px 50px 20px 20px; border-radius: 22px 22px 0 0; text-align: center; position: relative; box-shadow: 0 8px 30px rgba(255,215,0,0.4);">
                        <div style="display: flex; align-items: center; justify-content: center; gap: 12px;">
                            <div style="font-size: 36px; text-shadow: 0 3px 10px rgba(0,0,0,0.3); filter: drop-shadow(0 0 6px rgba(255,215,0,0.8)); animation: pulse 2s infinite;">⭐</div>
                            <div>
                                <h2 style="font-size: 24px; color: #000; margin: 0; font-weight: 900; text-shadow: 0 2px 6px rgba(0,0,0,0.2);">${vipItems.name}</h2>
                                <div style="font-size: 14px; color: rgba(0,0,0,0.7); margin-top: 4px; font-weight: 600;">VIP функции за Telegram Stars</div>
                            </div>
                        </div>
                        <button class="close-btn" onclick="this.closest('.modal').remove()">✕</button>
                    </div>
                    
                    <div style="padding: 20px;">
                        <div style="display: grid; gap: 12px;">
                            ${vipItems.items.map(item => `
                                <div style="background: linear-gradient(135deg, rgba(255,215,0,0.12), rgba(255,237,78,0.18)); padding: 16px; border-radius: 16px; border: 1px solid rgba(255,215,0,0.3); position: relative; backdrop-filter: blur(8px); box-shadow: 0 6px 20px rgba(255,215,0,0.15); transition: all 0.3s ease; overflow: hidden; background-size: 200% 200%; animation: shimmer 3s ease-in-out infinite;" onmouseover="this.style.transform='translateY(-3px) scale(1.02)';this.style.boxShadow='0 10px 30px rgba(255,215,0,0.25)';this.style.background='linear-gradient(135deg, rgba(255,215,0,0.2), rgba(255,237,78,0.25))'" onmouseout="this.style.transform='translateY(0) scale(1)';this.style.boxShadow='0 6px 20px rgba(255,215,0,0.15)';this.style.background='linear-gradient(135deg, rgba(255,215,0,0.12), rgba(255,237,78,0.18))'">
                                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 6px;">
                                        <span style="font-size: 20px; filter: drop-shadow(0 0 4px rgba(255,215,0,0.6));">${item.name.split(' ')[0]}</span>
                                        <div style="flex: 1;">
                                            <div style="font-weight: 800; font-size: 14px; color: #fff; text-shadow: 0 1px 3px rgba(0,0,0,0.3);">${item.name.split(' ').slice(1).join(' ')}</div>
                                            <div style="font-size: 11px; color: rgba(255,255,255,0.8); margin-top: 2px;">${item.desc}</div>
                                        </div>
                                        <div style="background: linear-gradient(135deg, #ffd700, #ffed4e, #ffd700); color: #000; padding: 4px 8px; border-radius: 8px; font-size: 11px; font-weight: 900; text-shadow: 0 1px 3px rgba(0,0,0,0.3); border: 1px solid #ffd700; box-shadow: 0 3px 8px rgba(255,215,0,0.4); position: relative; overflow: hidden;">
                                            <div style="position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent); animation: shimmer 2s infinite;"></div>
                                            <span style="font-size: 12px; font-weight: 900; text-shadow: 0 1px 2px rgba(0,0,0,0.4);">VIP</span>
                                        </div>
                                    </div>
                                    
                                    ${category === 'autobot' || category === 'autobot_vip' ? `
                                        <div style="background: rgba(74,222,128,0.2); padding: 8px; border-radius: 8px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;">
                                            <span style="color: #4ade80; font-size: 12px; font-weight: 700;">⏱️ Длительность:</span>
                                            <span style="color: #fff; font-size: 12px; font-weight: 800;">${item.duration < 60 ? item.duration + ' минут' : Math.floor(item.duration / 60) + ' часов'}</span>
                                        </div>
                                        <div style="background: rgba(74,222,128,0.2); padding: 8px; border-radius: 8px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;">
                                            <span style="color: #4ade80; font-size: 12px; font-weight: 700;">⚡ Скорость:</span>
                                            <span style="color: #4ade80; font-size: 12px; font-weight: 800;">${item.speed} тапов/сек</span>
                                        </div>
                                    ` : ''}
                                    
                                    <button onclick="buyWithStars('${category}', ${item.level}, ${item.basePrice || item.price})" 
                                            style="width: 100%; padding: 10px 12px; background: linear-gradient(135deg, #ffd700, #ffed4e, #ffd700); color: #000; border: 1px solid #ffd700; border-radius: 10px; cursor: pointer; font-weight: 800; font-size: 13px; transition: all 0.3s; position: relative; overflow: hidden; box-shadow: 0 4px 12px rgba(255,215,0,0.3); text-shadow: 0 1px 2px rgba(0,0,0,0.2); display: flex; align-items: center; justify-content: center; gap: 6px;"
                                            onmousedown="this.style.transform='scale(0.98)'; this.style.boxShadow='0 6px 16px rgba(255,215,0,0.4)'"
                                            onmouseup="this.style.transform='scale(1)'; this.style.boxShadow='0 4px 12px rgba(255,215,0,0.3)'"
                                            onmouseleave="this.style.transform='scale(1)'; this.style.boxShadow='0 4px 12px rgba(255,215,0,0.3)'">
                                        <span>Купить за ${item.basePrice || item.price}</span>
                                        <span style="font-size: 16px; filter: drop-shadow(0 0 3px rgba(255,215,0,0.8)); text-shadow: 0 1px 2px rgba(0,0,0,0.3);">⭐</span>
                                        <span>Telegram Stars</span>
                                    </button>
                                </div>
                            `).join('')}
                        </div>
                        
                        <!-- VIP стильная кнопка закрытия -->
                        <button class="vip-close-btn" onclick="this.closest('.modal').remove()">
                            👑 Закрыть VIP функции
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        function buyWithStars(category, level, price) {
            // Map VIP shop items to product IDs
            const productIdMap = {
                'tap_boost': {0: 21, 1: 22, 2: 23, 3: 24, 4: 25},
                'energy_buy': {0: 26, 1: 27, 2: 28, 3: 29, 4: 30},
                'energy_expand': {0: 31, 1: 32, 2: 33, 3: 34, 4: 35},
                'autobot': {0: 36, 1: 37, 2: 38, 3: 39, 4: 40}
            };
            
            const productId = productIdMap[category]?.[level] || 21;
            
            // Open Telegram payment (same as in currency purchase)
            const paymentUrl = `https://t.me/qanexus_bot?start=buy_stars_${productId}`;
            window.open(paymentUrl, '_blank');
            
            // Show beautiful VIP confirmation message
            const anim = document.createElement('div');
            anim.style.cssText='position:fixed;top:20%;left:50%;transform:translate(-50%,-50%);z-index:10000;pointer-events:none;';
            anim.innerHTML='<div style="background:linear-gradient(135deg,rgba(255,215,0,0.95),rgba(255,237,78,0.95));padding:25px 50px;border-radius:25px;font-size:26px;box-shadow:0 15px 50px rgba(255,215,0,0.7);color:#000;font-weight:800;display:flex;align-items:center;gap:20px;border:3px solid rgba(255,215,0,0.8);"><span style="font-size:40px;">⭐</span><div><div style="font-size:28px;margin-bottom:8px;">VIP Покупка</div><div style="font-size:20px;opacity:0.8;">Открывается оплата за ' + price + ' ⭐ Telegram Stars</div></div></div>';
            document.body.appendChild(anim);
            setTimeout(()=>{anim.style.opacity='0';anim.style.transform='translate(-50%,-70%)';setTimeout(()=>{anim.remove();},300);},2000);
        }
        
        // Функция для расчета цены и бонуса на основе уровня
        function calculateItemStats(basePrice, baseBonus, level, userLevel) {
            const priceMultiplier = 1 + (userLevel * 0.1); // +10% за каждый уровень
            const bonusMultiplier = 1 + (userLevel * 0.05); // +5% за каждый уровень
            return {
                price: Math.floor(basePrice * priceMultiplier),
                bonus: Math.floor(baseBonus * bonusMultiplier)
            };
        }
        
        // VIP данные для каждой категории (глобальные)
        const vipData = {
            'tap_boost': {
                name: '⭐ VIP Крипто-Бустеры',
                items: [
                    {level: 0, name: '🌠 Звездный Шторм', desc: 'VIP бустер, увеличивающий майнинг на +51 коин за тап. Использует энергию звездных вспышек для сверхмощного майнинга.', currency: 'stars', locked: false, basePrice: 100, baseEffect: 51},
                    {level: 0, name: '🌑 Черная Дыра', desc: 'Эксклюзивный бустер, дающий +71 коин за тап. Поглощает энергию пространства-времени для невероятной производительности.', currency: 'stars', locked: false, basePrice: 200, baseEffect: 71},
                    {level: 0, name: '✨ Абсолют', desc: 'Легендарный VIP бустер, увеличивающий майнинг на +101 коин за тап. Абсолютная власть над криптовалютными алгоритмами.', currency: 'stars', locked: false, basePrice: 350, baseEffect: 101},
                    {level: 0, name: '👑 Имперский', desc: 'Императорский бустер, дающий +141 коин за тап. Технология, достойная крипто-императоров и блокчейн-королей.', currency: 'stars', locked: false, basePrice: 500, baseEffect: 141},
                    {level: 0, name: '🌟 Легендарный', desc: 'Мифический VIP бустер, увеличивающий майнинг на +201 коин за тап. Легендарная технология из древних крипто-цивилизаций.', currency: 'stars', locked: false, basePrice: 750, baseEffect: 201}
                ]
            },
            'energy_buy': {
                name: '⭐ VIP Энерго-Генераторы',
                items: [
                    {level: 0, name: '☀️ Солнечная Корона', desc: 'VIP генератор, восстанавливающий +3.0 энергии в секунду. Использует энергию солнечной короны для сверхбыстрой подзарядки.', currency: 'stars', locked: false, basePrice: 120, baseEffect: 3.0},
                    {level: 0, name: '🌌 Галактический Ядро', desc: 'Эксклюзивный генератор, дающий +4.5 энергии в секунду. Извлекает энергию из ядра галактики через квантовые туннели.', currency: 'stars', locked: false, basePrice: 200, baseEffect: 4.5},
                    {level: 0, name: '💫 Новая Ера', desc: 'Революционный генератор, восстанавливающий +6.0 энергии в секунду. Технология новой эры криптовалютного будущего.', currency: 'stars', locked: false, basePrice: 300, baseEffect: 6.0},
                    {level: 0, name: '⚛️ Квантовый Реактор', desc: 'Легендарный генератор, дающий +8.0 энергии в секунду. Использует квантовые флуктуации для неограниченной энергии.', currency: 'stars', locked: false, basePrice: 450, baseEffect: 8.0},
                    {level: 0, name: '🌠 Небесный Портал', desc: 'Мифический генератор, восстанавливающий +10.0 энергии в секунду. Подключается к энергетическим порталам небесных сфер.', currency: 'stars', locked: false, basePrice: 600, baseEffect: 10.0}
                ]
            },
            'energy_expand': {
                name: '⭐ VIP Энерго-Батареи',
                items: [
                    {level: 0, name: '🌌 Галактический Резервуар', desc: 'VIP накопитель, увеличивающий максимум энергии на +7500. Хранит энергию целой галактики в компактном кристалле.', currency: 'stars', locked: false, basePrice: 150, baseEffect: 7500},
                    {level: 0, name: '⚛️ Квантовая Суперпозиция', desc: 'Эксклюзивный накопитель, расширяющий энергоемкость на +12500. Использует квантовую суперпозицию для бесконечного хранения.', currency: 'stars', locked: false, basePrice: 250, baseEffect: 12500},
                    {level: 0, name: '🌠 Звездное Созвездие', desc: 'Легендарный накопитель, увеличивающий максимум энергии на +20000. Содержит энергию целого звездного созвездия.', currency: 'stars', locked: false, basePrice: 400, baseEffect: 20000},
                    {level: 0, name: '🌑 Абсолютная Пустота', desc: 'Мифический накопитель, расширяющий энергоемкость на +37500. Использует энергию космической пустоты для хранения.', currency: 'stars', locked: false, basePrice: 600, baseEffect: 37500},
                    {level: 0, name: '👑 Имперская Сокровищница', desc: 'Божественный накопитель, увеличивающий максимум энергии на +75000. Сокровищница крипто-императоров с неограниченной емкостью.', currency: 'stars', locked: false, basePrice: 800, baseEffect: 75000}
                ]
            },
            'autobot': {
                name: '⭐ VIP Крипто-Боты',
                items: [
                    {level: 0, name: '⭐ VIP Базовый Бот', desc: 'VIP автотап на 5 дней', speed: 6, duration: 7200, currency: 'stars', locked: false, basePrice: 100},
                    {level: 0, name: '⭐ VIP Улучшенный Бот', desc: 'VIP автотап на 7 дней', speed: 6.5, duration: 10080, currency: 'stars', locked: false, basePrice: 200},
                    {level: 0, name: '⭐ VIP Продвинутый Бот', desc: 'VIP автотап на 10 дней', speed: 7, duration: 14400, currency: 'stars', locked: false, basePrice: 350},
                    {level: 0, name: '⭐ VIP Элитный Бот', desc: 'VIP автотап на 14 дней', speed: 7.5, duration: 20160, currency: 'stars', locked: false, basePrice: 500},
                    {level: 0, name: '⭐ VIP Премиум Бот', desc: 'VIP автотап на 20 дней', speed: 8, duration: 28800, currency: 'stars', locked: false, basePrice: 750}
                ]
            }
        };
        function loadShopCategory(category) {
            // Update button states
            document.querySelectorAll('.shop-cat-btn').forEach(btn => {
                const btnCategory = btn.getAttribute('data-category');
                if(btnCategory === category) {
                    btn.style.background = 'linear-gradient(135deg,#667eea,#764ba2)';
                    btn.style.border = 'none';
                } else {
                    btn.style.background = 'rgba(255,255,255,0.1)';
                    btn.style.border = '1px solid rgba(255,255,255,0.3)';
                }
            });
            
            const items = window.shopData[category].items;
            const list = document.getElementById('shopItemsList');
            
            // Get user's current level for this category from userData
            let userLevel = 0;
            if (window.userData) {
                if (category === 'tap_boost' || category === 'tap_boost_vip') {
                    userLevel = window.userData.tap_boost_level || 0;
                } else if (category === 'energy_buy' || category === 'energy_buy_vip') {
                    userLevel = window.userData.energy_buy_level || 0;
                } else if (category === 'energy_expand' || category === 'energy_expand_vip') {
                    userLevel = window.userData.energy_expand_level || 0;
            }
            }
            
            // Calculate price and effect for each item based on its current level
            list.innerHTML = items.map((item, index) => {
                const isLocked = false; // Remove locking - all items are available
                
                // Get current level from shopData (updated after purchase)
                const currentLevel = window.shopData && window.shopData[category] && window.shopData[category].items && window.shopData[category].items[index] 
                    ? window.shopData[category].items[index].level 
                    : item.level;
                
                // Calculate current effect and next level price based on current level
                let currentEffect = 0;
                let nextLevelPrice = 0;
                let nextLevelEffect = 0;
                
                if (category === 'tap_boost' || category === 'tap_boost_vip') {
                    const baseEffect = item.baseEffect || 1;
                    const basePrice = item.basePrice || 1000;
                    // Show total tap boosts - active_multiplier is already the number of clicks
                    const userMultiplier = window.userData?.active_multiplier || 1;
                    console.log('Tap boost - userMultiplier:', userMultiplier, 'window.userData:', window.userData);
                    const totalBoost = userMultiplier;
                    nextLevelPrice = Math.floor(basePrice * Math.pow(1.5, currentLevel + 1));
                    
                    // Special handling for first item (base_effect == 1): always gives +1
                    if (baseEffect === 1) {
                        nextLevelEffect = 1;
                        // For first item, show total since it's the base
                        currentEffect = totalBoost;
                    } else {
                        // For other items: use same logic as backend
                        // Backend formula: 
                        //   current_effect = base_effect * (1.2 ** (level - 1)) if level > 1 else 0
                        //   new_effect = base_effect * (1.2 ** level)
                        //   bonus = new_effect - current_effect
                        // When buying, we're at level=currentLevel, buying level=currentLevel+1
                        // So calculate the bonus that will be added when purchasing next level
                        // Backend formula: level is the next level we're buying
                        // So at currentLevel, we're buying level=currentLevel+1
                        // Backend calculates: current_effect = base_effect * (1.2 ** (level - 1))
                        // So for level=currentLevel+1: current_effect = base_effect * (1.2 ** currentLevel)
                        const currentItemEffect = currentLevel >= 1 ? Math.floor(baseEffect * Math.pow(1.2, currentLevel)) : 0;
                        // new_effect = base_effect * (1.2 ** level) = base_effect * (1.2 ** (currentLevel + 1))
                        const newEffect = Math.floor(baseEffect * Math.pow(1.2, currentLevel + 1));
                        nextLevelEffect = newEffect - currentItemEffect;
                        // Show what total would be AFTER buying this item
                        // Total would be current total + nextLevelEffect
                        currentEffect = totalBoost;
                    }
                } else if (category === 'energy_buy' || category === 'energy_buy_vip') {
                    const baseEffect = item.baseEffect || 0.5;
                    const basePrice = item.basePrice || 1500;
                    // Show total energy regen (energy_regen_rate includes base 1)
                    const userRegenRate = window.userData?.energy_regen_rate || 1;
                    console.log('Energy buy - userRegenRate:', userRegenRate, 'window.userData:', window.userData);
                    const totalRegen = Math.max(0, Math.round((userRegenRate - 1) * 10) / 10);
                    nextLevelPrice = Math.floor(basePrice * Math.pow(1.4, currentLevel + 1));
                    // Backend formula: level is the next level we're buying
                    // So at currentLevel, we're buying level=currentLevel+1
                    // Backend calculates: current_effect = base_effect * (1.15 ** (level - 1))
                    // So for level=currentLevel+1: current_effect = base_effect * (1.15 ** currentLevel)
                    const currentItemEffect = currentLevel >= 1 ? Math.round(baseEffect * Math.pow(1.15, currentLevel) * 10) / 10 : 0;
                    // new_effect = base_effect * (1.15 ** level) = base_effect * (1.15 ** (currentLevel + 1))
                    const nextItemEffect = Math.round(baseEffect * Math.pow(1.15, currentLevel + 1) * 10) / 10;
                    // Show the increment (difference)
                    nextLevelEffect = Math.round((nextItemEffect - currentItemEffect) * 10) / 10;
                    currentEffect = totalRegen;
                } else if (category === 'energy_expand' || category === 'energy_expand_vip') {
                    const baseEffect = item.baseEffect || 50;
                    const basePrice = item.basePrice || 2000;
                    // Show total energy expansion (max_energy includes base 1000)
                    const userMaxEnergy = window.userData?.max_energy || 1000;
                    console.log('Energy expand - userMaxEnergy:', userMaxEnergy, 'window.userData:', window.userData);
                    const totalExpansion = Math.max(0, userMaxEnergy - 1000);
                    nextLevelPrice = Math.floor(basePrice * Math.pow(1.6, currentLevel + 1));
                    // Backend formula: level is the next level we're buying
                    // So at currentLevel, we're buying level=currentLevel+1
                    // Backend calculates: current_effect = base_effect * (1.25 ** (level - 1))
                    // So for level=currentLevel+1: current_effect = base_effect * (1.25 ** currentLevel)
                    const currentItemEffect = currentLevel >= 1 ? Math.floor(baseEffect * Math.pow(1.25, currentLevel)) : 0;
                    // new_effect = base_effect * (1.25 ** level) = base_effect * (1.25 ** (currentLevel + 1))
                    const nextItemEffect = Math.floor(baseEffect * Math.pow(1.25, currentLevel + 1));
                    // Show the increment (difference)
                    nextLevelEffect = nextItemEffect - currentItemEffect;
                    currentEffect = totalExpansion;
                }
                
                const rarityColors = {
                    0: 'rgba(148,163,184,0.3)', // gray
                    5: 'rgba(59,130,246,0.3)', // blue
                    10: 'rgba(139,92,246,0.3)', // purple
                    15: 'rgba(236,72,153,0.3)', // pink
                    20: 'rgba(251,191,36,0.3)', // gold
                    25: 'rgba(34,197,94,0.3)', // green
                    30: 'rgba(239,68,68,0.3)', // red
                    35: 'rgba(168,85,247,0.3)', // violet
                    40: 'rgba(245,158,11,0.3)', // amber
                    45: 'rgba(6,182,212,0.3)', // cyan
                    50: 'rgba(255,215,0,0.3)' // gold
                };
                const rarityColor = item.level <= 5 ? rarityColors[0] : 
                                   item.level <= 10 ? rarityColors[5] : 
                                   item.level <= 15 ? rarityColors[10] : 
                                   item.level <= 20 ? rarityColors[15] : 
                                   item.level <= 25 ? rarityColors[20] :
                                   item.level <= 30 ? rarityColors[25] :
                                   item.level <= 35 ? rarityColors[30] :
                                   item.level <= 40 ? rarityColors[35] :
                                   item.level <= 45 ? rarityColors[40] :
                                   item.level <= 50 ? rarityColors[45] : rarityColors[50];
                
                // Use calculated price and bonus for next level
                
                return `
                    <div style="background:${isLocked ? 'rgba(0,0,0,0.5)' : item.premium ? 'linear-gradient(135deg,rgba(255,215,0,0.15),rgba(255,237,78,0.15))' : rarityColor};padding:14px;border-radius:14px;border:2px solid ${isLocked ? 'rgba(239,68,68,0.5)' : item.premium ? 'rgba(255,215,0,0.6)' : 'rgba(102,126,234,0.4)'};position:relative;${isLocked ? 'opacity:0.6;' : ''}">
                        ${isLocked ? `
                            <div style="position:absolute;top:8px;right:8px;background:rgba(239,68,68,0.8);color:#fff;padding:4px 8px;border-radius:6px;font-size:10px;font-weight:700;">🔒</div>
                        ` : item.premium ? `
                            <div style="position:absolute;top:8px;right:8px;background:linear-gradient(135deg,#ffd700,#ffed4e);color:#000;padding:4px 8px;border-radius:6px;font-size:10px;font-weight:700;box-shadow:0 2px 8px rgba(255,215,0,0.4);">⭐ VIP</div>
                        ` : ''}
                        <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
                            <span style="font-size:20px;">${item.name.split(' ')[0]}</span>
                            <div style="flex:1;">
                                <div style="display:flex;align-items:center;gap:8px;margin-bottom:2px;">
                                    <div style="font-weight:800;font-size:14px;color:#fff;">${item.name.split(' ').slice(1).join(' ')} #${index + 1}</div>
                                    <div style="background:linear-gradient(135deg,rgba(102,126,234,0.8),rgba(139,92,246,0.8));color:#fff;padding:2px 6px;border-radius:6px;font-size:10px;font-weight:700;box-shadow:0 2px 4px rgba(102,126,234,0.3);">Ур.${currentLevel}</div>
                                </div>
                                <div style="font-size:11px;color:#94a3b8;">${item.desc}</div>
                            </div>
                        </div>
                        ${category === 'tap_boost' ? `
                            <div style="background:rgba(102,126,234,0.2);padding:8px;border-radius:8px;margin-bottom:8px;">
                                <div style="display:flex;justify-content:space-between;align-items:center;">
                                    <span style="color:#a78bfa;font-size:12px;font-weight:700;">💪 Кликов за тап:</span>
                                    <span style="color:#fff;font-size:13px;font-weight:800;">${currentEffect}</span>
                                </div>
                                <div style="display:flex;justify-content:space-between;align-items:center;margin-top:4px;">
                                    <span style="color:#a78bfa;font-size:12px;font-weight:700;">💪 Прирост:</span>
                                    <span style="color:#4ade80;font-size:13px;font-weight:800;">+${nextLevelEffect} кликов</span>
                                </div>
                            </div>
                        ` : category === 'energy_buy' ? `
                            <div style="background:rgba(251,191,36,0.2);padding:8px;border-radius:8px;margin-bottom:8px;">
                                <div style="display:flex;justify-content:space-between;align-items:center;">
                                    <span style="color:#fbbf24;font-size:12px;font-weight:700;">⚡ Добавить энергии/сек:</span>
                                    <span style="color:#fff;font-size:13px;font-weight:800;">${currentEffect}</span>
                                </div>
                                <div style="display:flex;justify-content:space-between;align-items:center;margin-top:4px;">
                                    <span style="color:#fbbf24;font-size:12px;font-weight:700;">⚡ Прирост:</span>
                                    <span style="color:#4ade80;font-size:13px;font-weight:800;">+${nextLevelEffect} энергии/сек</span>
                                </div>
                            </div>
                        ` : category === 'energy_expand' ? `
                            <div style="background:rgba(236,72,153,0.2);padding:8px;border-radius:8px;margin-bottom:8px;">
                                <div style="display:flex;justify-content:space-between;align-items:center;">
                                    <span style="color:#ec4899;font-size:12px;font-weight:700;">📈 Расширить максимум энергии на:</span>
                                    <span style="color:#fff;font-size:13px;font-weight:800;">${currentEffect > 0 ? currentEffect.toLocaleString() : '0'}</span>
                                </div>
                                <div style="display:flex;justify-content:space-between;align-items:center;margin-top:4px;">
                                    <span style="color:#ec4899;font-size:12px;font-weight:700;">📈 Прирост:</span>
                                    <span style="color:#4ade80;font-size:13px;font-weight:800;">+${nextLevelEffect.toLocaleString()}</span>
                                </div>
                            </div>
                        ` : `
                            <div style="background:rgba(16,185,129,0.2);padding:8px;border-radius:8px;margin-bottom:8px;">
                                <div style="display:flex;justify-content:space-between;align-items:center;">
                                    <span style="color:#10b981;font-size:12px;font-weight:700;">⏱️ Длительность:</span>
                                    <span style="color:#fff;font-size:12px;font-weight:800;">${item.duration < 60 ? item.duration + ' минут' : Math.floor(item.duration / 60) + ' часов'}</span>
                                </div>
                                ${item.speed > 1 ? `
                                <div style="display:flex;justify-content:space-between;align-items:center;margin-top:4px;">
                                    <span style="color:#10b981;font-size:12px;font-weight:700;">⚡ Скорость:</span>
                                    <span style="color:#4ade80;font-size:12px;font-weight:800;">${item.speed} тапов/сек</span>
                                </div>
                                ` : ''}
                            </div>
                        `}
                        ${category === 'autobot' || category === 'autobot_vip' ? `
                            <button id="autobot-btn-${item.level}" onclick="${isLocked ? 'tg.showAlert(\'🔒 Сначала купите предыдущий уровень\')' : item.currency === 'stars' ? `buyWithStars('${category}', ${item.level}, ${item.basePrice || item.price})` : `buyShopItem('${category}', ${item.level}, ${item.price})`}" 
                                    style="width:100%;padding:8px 12px;background:${isLocked ? 'rgba(239,68,68,0.6)' : item.currency === 'stars' ? 'linear-gradient(135deg,#ffd700,#ffed4e,#ffd700)' : 'linear-gradient(135deg,#667eea,#764ba2)'};color:${item.currency === 'stars' ? '#000' : '#fff'};border:${item.currency === 'stars' ? '1px solid #ffd700' : 'none'};border-radius:10px;cursor:${isLocked ? 'not-allowed' : 'pointer'};font-weight:700;font-size:12px;transition:all 0.3s;position:relative;overflow:hidden;box-shadow:${item.currency === 'stars' ? '0 3px 10px rgba(255,215,0,0.3)' : '0 2px 6px rgba(102,126,234,0.3)'};display:flex;align-items:center;justify-content:center;gap:4px;"
                                    onmousedown="if(!${isLocked}){this.style.transform='scale(0.98)';this.style.boxShadow='${item.currency === 'stars' ? '0 4px 12px rgba(255,215,0,0.4)' : '0 3px 8px rgba(102,126,234,0.4)'}'}"
                                    onmouseup="if(!${isLocked}){this.style.transform='scale(1)';this.style.boxShadow='${item.currency === 'stars' ? '0 3px 10px rgba(255,215,0,0.3)' : '0 2px 6px rgba(102,126,234,0.3)'}'}"
                                    onmouseleave="if(!${isLocked}){this.style.transform='scale(1)';this.style.boxShadow='${item.currency === 'stars' ? '0 3px 10px rgba(255,215,0,0.3)' : '0 2px 6px rgba(102,126,234,0.3)'}'}">
                                ${isLocked ? '🔒 Заблокировано' : item.currency === 'stars' ? `<span>Купить за ${item.basePrice || item.price}</span><span style="font-size:14px;">⭐</span><span>Stars</span>` : `<span>Купить за ${item.price.toLocaleString()}</span><span style="font-size:14px;">🪙</span>`}
                            </button>
                        ` : `
                            <button onclick="${isLocked ? 'tg.showAlert(\'🔒 Сначала купите предыдущий уровень\')' : item.currency === 'stars' ? `buyWithStars('${category}', ${currentLevel}, ${item.basePrice || item.price})` : `buyShopItem('${category}', ${currentLevel}, ${nextLevelPrice}, ${index})`}" 
                                    style="width:100%;padding:8px 12px;background:${isLocked ? 'rgba(239,68,68,0.6)' : item.currency === 'stars' ? 'linear-gradient(135deg,#ffd700,#ffed4e,#ffd700)' : 'linear-gradient(135deg,#667eea,#764ba2)'};color:${item.currency === 'stars' ? '#000' : '#fff'};border:${item.currency === 'stars' ? '1px solid #ffd700' : 'none'};border-radius:10px;cursor:${isLocked ? 'not-allowed' : 'pointer'};font-weight:700;font-size:12px;transition:all 0.3s;position:relative;overflow:hidden;box-shadow:${item.currency === 'stars' ? '0 3px 10px rgba(255,215,0,0.3)' : '0 2px 6px rgba(102,126,234,0.3)'};display:flex;align-items:center;justify-content:center;gap:4px;"
                                    onmousedown="if(!${isLocked}){this.style.transform='scale(0.98)';this.style.boxShadow='${item.currency === 'stars' ? '0 4px 12px rgba(255,215,0,0.4)' : '0 3px 8px rgba(102,126,234,0.4)'}'}"
                                    onmouseup="if(!${isLocked}){this.style.transform='scale(1)';this.style.boxShadow='${item.currency === 'stars' ? '0 3px 10px rgba(255,215,0,0.3)' : '0 2px 6px rgba(102,126,234,0.3)'}'}"
                                    onmouseleave="if(!${isLocked}){this.style.transform='scale(1)';this.style.boxShadow='${item.currency === 'stars' ? '0 3px 10px rgba(255,215,0,0.3)' : '0 2px 6px rgba(102,126,234,0.3)'}'}">
                                ${isLocked ? '🔒 Заблокировано' : item.currency === 'stars' ? `<span>Купить за ${item.basePrice || item.price}</span><span style="font-size:14px;">⭐</span><span>Stars</span>` : `<span>Купить за ${nextLevelPrice.toLocaleString()}</span><span style="font-size:14px;">🪙</span>`}
                            </button>
                        `}
                    </div>
                `;
            }).join('');
            
            // Update VIP button for current category
            const vipButton = document.getElementById('vipButton');
            if (vipButton) {
                vipButton.setAttribute('onclick', `openVIPModal('${category}')`);
            }
            
            // Update autobot buttons if autobot category is loaded
            if (category === 'autobot' || category === 'autobot_vip') {
                // Fetch current user data to update autobot buttons
                fetch('/api/user_data', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({user_id: window.user?.id})
                })
                .then(res => res.json())
                .then(data => {
                    updateAutobotShopButtons(data);
                })
                .catch(err => console.error('Error loading user data for autobots:', err));
            }
        }
        
        function loadShopLevels() {
            const userId = window.userData?.id || window.user?.id;
            if (!userId) return;
            
            fetch('/api/get_shop_levels', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({user_id: userId})
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    // Update shopData with levels from database
                    if (window.shopData) {
                        // Update tap_boost levels
                        Object.keys(data.tap_boost_levels).forEach(index => {
                            if (window.shopData.tap_boost && window.shopData.tap_boost.items[index]) {
                                window.shopData.tap_boost.items[index].level = data.tap_boost_levels[index];
                            }
                        });
                        
                        // Update energy_buy levels
                        Object.keys(data.energy_buy_levels).forEach(index => {
                            if (window.shopData.energy_buy && window.shopData.energy_buy.items[index]) {
                                window.shopData.energy_buy.items[index].level = data.energy_buy_levels[index];
                            }
                        });
                        
                        // Update energy_expand levels
                        Object.keys(data.energy_expand_levels).forEach(index => {
                            if (window.shopData.energy_expand && window.shopData.energy_expand.items[index]) {
                                window.shopData.energy_expand.items[index].level = data.energy_expand_levels[index];
                            }
                        });
                        
                        // Refresh current shop category if it's open
                        const activeBtn = document.querySelector('.shop-cat-btn[style*="linear-gradient"]');
                        if (activeBtn && activeBtn.dataset.category) {
                            loadShopCategory(activeBtn.dataset.category);
                        }
                    }
                }
            })
            .catch(err => console.error('Error loading shop levels:', err));
        }
        
        function showNotification(type, message) {
            const anim = document.createElement('div');
            anim.style.cssText = 'position:fixed;top:15%;left:50%;transform:translate(-50%,-50%);z-index:10000;pointer-events:none;';
            const bgColor = type === 'error' ? 'rgba(239,68,68,0.95),rgba(220,38,38,0.95)' : 'rgba(34,197,94,0.95),rgba(16,185,129,0.95)';
            const icon = type === 'error' ? '💰' : '✨';
            anim.innerHTML = `<div style="background:linear-gradient(135deg,${bgColor});padding:8px 16px;border-radius:20px;font-size:14px;box-shadow:0 4px 15px rgba(16,185,129,0.5);color:#fff;font-weight:700;display:flex;align-items:center;gap:6px;border:1px solid rgba(255,255,255,0.2);"><span style="font-size:16px;">${icon}</span> ${message}</div>`;
            document.body.appendChild(anim);
            setTimeout(() => {
                anim.style.opacity = '0';
                anim.style.transform = 'translate(-50%,-60%)';
                setTimeout(() => anim.remove(), 300);
            }, 1500);
        }
        
        function buyShopItem(category, level, price, itemIndex) {
            // Use direct price from the item (calculated by formulas)
            const actualPrice = price;
            const userId = window.userData?.id || window.user?.id;
            
            if (!userId) {
                showNotification('error', 'Ошибка: пользователь не найден');
                return;
            }
            
            // Special handling for cards - use /api/buy endpoint
            if (category === 'card') {
                // Get card data from shopData to find the correct item_type
                if (!window.shopData || !window.shopData.items) {
                    console.error('Shop data not loaded! Loading cards data...');
                    // Force reload cards data
                    fetch('/api/shop', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({user_id: userId, category: 'cards'})
                    })
                    .then(res => res.json())
                    .then(shopData => {
                        window.shopData = window.shopData || {};
                        window.shopData.items = shopData.items || [];
                        console.log('Reloaded shop data:', window.shopData);
                        // Retry the purchase with a small delay to avoid recursion issues
                        setTimeout(() => {
                            buyShopItem(category, level, price, itemIndex);
                        }, 100);
                    })
                    .catch(err => {
                        console.error('Error loading shop data:', err);
                        showNotification('error', 'Ошибка загрузки данных магазина');
                    });
                    return;
                }
                
                const shopData = window.shopData || {};
                const cards = shopData.items || [];
                
                console.log('Shop data for cards:', shopData);
                console.log('Cards array:', cards);
                console.log('Item index or id:', itemIndex);
                console.log('Actual price:', actualPrice);
                console.log('Cards length:', cards.length);
                console.log('Item index valid:', itemIndex >= 0 && itemIndex < cards.length);
                
                // If itemIndex is a string, it's actually the card id -> use directly
                let itemType = (typeof itemIndex === 'string') ? itemIndex : null;
                let card = null;
                if (!itemType) {
                    card = cards[itemIndex];
                    if (!card) {
                        console.error('Card not found at index:', itemIndex, 'cards length:', cards.length);
                        showNotification('error', 'Карточка не найдена');
                        return;
                    }
                    itemType = card.id;
                } else {
                    card = cards.find(c => c.id === itemType) || null;
                }
                
                console.log('Buying card:', {card, itemType, actualPrice, cards: cards.length});
                console.log('Card ID for purchase:', itemType);
                console.log('Item type being sent:', itemType);
                
                fetch('/api/buy', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                        user_id: userId,
                        item_type: itemType,
                    price: actualPrice
                })
            })
            .then(res => res.json())
            .then(data => {
                    console.log('Card purchase response:', data);
                    console.log('Response success:', data.success);
                    console.log('Response error:', data.error);
                if(data.success) {
                        showNotification('success', 'Карточка куплена!');
                    
                        // Reload cards data to update levels and prices
                        fetch('/api/shop', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({user_id: userId, category: 'cards'})
                        })
                        .then(res => res.json())
                        .then(shopData => {
                            console.log('Reloaded cards data after purchase:', shopData);
                            console.log('Cards items:', shopData.items);
                            window.shopData = window.shopData || {};
                            window.shopData.items = shopData.items || [];
                            
                            // Refresh cards display - force reload all cards
                            console.log('Refreshing all cards after purchase');
                            
                            // Find the currently active category and refresh it
                            const activeBtn = document.querySelector('#cardsShopSection .shop-cat-btn[style*="linear-gradient"]');
                            const activeCategory = activeBtn && activeBtn.dataset.category ? activeBtn.dataset.category : 'per_hour';
                            console.log('Active category:', activeCategory);
                            
                            // Log per_hour cards specifically
                            const perHourCards = shopData.items.filter(item => item.type === 'card' && item.income_type === 'per_hour');
                            console.log('Per hour cards after purchase:', perHourCards.map(c => ({
                                id: c.id,
                                level: c.level,
                                price: c.price,
                                income_per_min: c.income_per_min
                            })));
                            
                            // Force refresh the active category
                            loadCardsCategory(activeCategory);
                            
                            // Also refresh the main data to update user stats
                            loadData();
                        });
                    } else {
                        showNotification('error', data.error || 'Ошибка покупки');
                    }
                })
                .catch(err => {
                    console.error('Error buying card:', err);
                    showNotification('error', 'Ошибка покупки');
                });
                return;
            }
            
            // For multilevel items we pass next level; for autobot use exact selected level
            const nextLevel = (category === 'autobot' || category === 'autobot_vip') ? level : (level + 1);
            
            // Get base effect and price from shopData
            const shopData = window.shopData || {};
            const item = shopData[category] && shopData[category].items && shopData[category].items[itemIndex] 
                ? shopData[category].items[itemIndex] 
                : { baseEffect: 1, basePrice: 1000 };
            
            console.log('Buying item:', {userId, category, level, price: actualPrice, itemIndex, item});
            
            fetch('/api/buy_shop_item', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    user_id: userId, 
                    category: category, 
                    level: nextLevel, 
                    price: actualPrice,
                    item_index: itemIndex,
                    base_effect: item.baseEffect || 1,
                    base_price: item.basePrice || 1000
                })
            })
            .then(res => res.json())
            .then(data => {
                if(data.success) {
                    // Update item level locally
                    if (category === 'tap_boost' || category === 'energy_buy' || category === 'energy_expand') {
                        // Find the item in shopData and increase its level
                        const shopData = window.shopData || {};
                        if (shopData[category] && shopData[category].items && shopData[category].items[itemIndex]) {
                            shopData[category].items[itemIndex].level = nextLevel;
                        }
                    }
                    
                    // Compact success notification for Telegram
                    const anim = document.createElement('div');
                    anim.style.cssText='position:fixed;top:15%;left:50%;transform:translate(-50%,-50%);z-index:10000;pointer-events:none;';
                    anim.innerHTML='<div style="background:linear-gradient(135deg,rgba(34,197,94,0.95),rgba(16,185,129,0.95));padding:8px 16px;border-radius:20px;font-size:14px;box-shadow:0 4px 15px rgba(16,185,129,0.5);color:#fff;font-weight:700;display:flex;align-items:center;gap:6px;border:1px solid rgba(255,255,255,0.2);"><span style="font-size:16px;">✨</span> Уровень повышен!</div>';
                    document.body.appendChild(anim);
                    setTimeout(()=>{anim.style.opacity='0';anim.style.transform='translate(-50%,-60%)';setTimeout(()=>{anim.remove();},300);},800);
                    
                    // Reload data and refresh shop display
                    loadData();
                    
                    // Refresh current shop category to show updated levels
                    setTimeout(() => {
                        const activeBtn = document.querySelector('.shop-cat-btn[style*="linear-gradient"]');
                        if (activeBtn && activeBtn.dataset.category) {
                            loadShopCategory(activeBtn.dataset.category);
                            }
                    }, 200);
                    
                    
                    // Update passive income immediately
                    updatePassiveIncome();
                } else {
                    // Compact error notification for Telegram
                    const error = document.createElement('div');
                    error.style.cssText='position:fixed;top:15%;left:50%;transform:translate(-50%,-50%);z-index:10000;pointer-events:none;';
                    const errorText = data.error.includes('Недостаточно') ? 'Недостаточно коинов' : data.error;
                    error.innerHTML='<div style="background:linear-gradient(135deg,rgba(239,68,68,0.95),rgba(220,38,38,0.95));padding:8px 16px;border-radius:20px;font-size:14px;box-shadow:0 4px 15px rgba(239,68,68,0.5);color:#fff;font-weight:700;display:flex;align-items:center;gap:6px;border:1px solid rgba(255,255,255,0.2);"><span style="font-size:16px;">💰</span> ' + errorText + '</div>';
                    document.body.appendChild(error);
                    setTimeout(()=>{error.style.opacity='0';error.style.transform='translate(-50%,-60%)';setTimeout(()=>{error.remove();},300);},1500);
                }
            });
        }

        function renderShop() {
            const boostsHtml = shopItems.boosts.map(item => `
                <div class="item" onclick="buyItem('boost', '${item.type}', ${item.price})">
                    <div class="item-info">
                        <div class="item-emoji">${item.emoji}</div>
                        <div class="item-details">
                            <div class="item-name">${item.name}</div>
                            <div class="item-desc">${item.desc}</div>
                            <div class="item-price">${item.price.toLocaleString()} 🪙</div>
                        </div>
                    </div>
                </div>
            `).join('');
            document.getElementById('boostsList').innerHTML = boostsHtml;

            const automationHtml = shopItems.automation.map(item => `
                <div class="item" onclick="buyItem('automation', '${item.type}', ${item.price})">
                    <div class="item-info">
                        <div class="item-emoji">${item.emoji}</div>
                        <div class="item-details">
                            <div class="item-name">${item.name}</div>
                            <div class="item-desc">${item.desc}</div>
                            <div class="item-price">${item.price.toLocaleString()} 🪙</div>
                        </div>
                    </div>
                </div>
            `).join('');
            document.getElementById('automationList').innerHTML = automationHtml;

            const energyHtml = shopItems.energy.map(item => `
                <div class="item" onclick="buyEnergy(${item.amount}, ${item.price})">
                    <div class="item-info">
                        <div class="item-emoji">${item.emoji}</div>
                        <div class="item-details">
                            <div class="item-name">Энергия +${item.amount}</div>
                            <div class="item-price">${item.price.toLocaleString()} 🪙</div>
                        </div>
                    </div>
                </div>
            `).join('');
            document.getElementById('energyList').innerHTML = energyHtml;

            const cardsHtml = shopItems.cards.map(item => `
                <div class="item" onclick="buyItem('card', '${item.type}', ${item.price})">
                    <div class="item-info">
                        <div class="item-emoji">${item.emoji}</div>
                        <div class="item-details">
                            <div class="item-name">${item.name}</div>
                            <div class="item-desc">${item.desc}</div>
                            <div class="item-price">${item.price.toLocaleString()} 🪙</div>
                        </div>
                    </div>
                </div>
            `).join('');
            document.getElementById('cardsList').innerHTML = cardsHtml;
        }

        function buyItem(type, id, price) {
            fetch('/api/buy', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({user_id: user?.id, item_type: id, price: price})
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    tg.showAlert('✅ Успешно!');
                    loadData();
                    renderShop();
                } else {
                    tg.showAlert('⚠️ ' + data.error);
                }
            })
            .catch(err => {
                tg.showAlert('❌ Ошибка покупки');
            });
        }

        function buyEnergy(amount, price) {
            fetch('/api/buy_energy', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({user_id: user?.id, amount: amount, price: price})
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    tg.showAlert('✅ Энергия куплена!');
                    loadData();
                    renderShop();
                } else {
                    tg.showAlert('⚠️ ' + data.error);
                }
            })
            .catch(err => {
                tg.showAlert('❌ Ошибка покупки');
            });
        }

        function openMining(e) {
            e.preventDefault();
            // Check if modal already exists
            const existingModal = document.getElementById('miningModal2');
            if(existingModal) {
                existingModal.style.display = 'block';
                existingModal.classList.add('active');
                loadMiningCategory('coins');
                return;
            }
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.id = 'miningModal2';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 500px; max-height: 90vh; overflow-y: auto;background: linear-gradient(135deg, rgba(10, 14, 39, 0.98), rgba(15, 23, 42, 0.98));border-radius: 24px;">
                    <div style="background: linear-gradient(135deg, #667eea, #764ba2); padding: 30px 60px 30px 30px; border-radius: 22px 22px 0 0; text-align: center; position: relative; box-shadow: 0 8px 30px rgba(102,126,234,0.4);">
                        <div style="display: flex; align-items: center; justify-content: center; gap: 15px;">
                            <div style="font-size: 45px; text-shadow: 0 3px 10px rgba(0,0,0,0.3); filter: drop-shadow(0 0 8px rgba(102,126,234,0.8)); animation: pulse 2s infinite;">🏭</div>
                            <div>
                                <h2 style="font-size: 28px; color: #fff; margin: 0; font-weight: 900; text-shadow: 0 2px 6px rgba(0,0,0,0.2);">МАЙНИНГ ФЕРМА</h2>
                                <div style="font-size: 15px; color: rgba(255,255,255,0.9); margin-top: 6px; font-weight: 600;">⚡ Добывайте QuanHash автоматически</div>
                            </div>
                        </div>
                        <button class="close-btn" onclick="this.closest('.modal').remove()">✕</button>
                    </div>
                    
                    <div style="padding: 25px;">
                        <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-bottom:20px;">
                            <button class="mining-cat-btn" onclick="loadMiningCategory('coins')" style="padding:14px;background:linear-gradient(135deg,rgba(102,126,234,0.15),rgba(118,75,162,0.15));color:#fff;border:2px solid #667eea;border-radius:12px;cursor:pointer;font-weight:800;font-size:13px;transition:all 0.3s;">
                                🪙 За коины
                            </button>
                            <button class="mining-cat-btn" onclick="loadMiningCategory('quanhash')" style="padding:14px;background:rgba(255,255,255,0.05);color:#fff;border:2px solid rgba(16,185,129,0.2);border-radius:12px;cursor:pointer;font-weight:800;font-size:13px;transition:all 0.3s;">
                                💎 За QuanHash
                            </button>
                        </div>
                        
                        <div style="margin-bottom:15px;">
                            <button onclick="openVIPMiningModal()" style="width:100%;padding:14px;background:linear-gradient(135deg,#ffd700,#ffed4e,#ffd700);color:#000;border:2px solid #ffd700;border-radius:14px;cursor:pointer;font-weight:900;font-size:15px;box-shadow:0 4px 20px rgba(255,215,0,0.4);transition:all 0.3s;display:flex;align-items:center;justify-content:center;gap:10px;" onmousedown="this.style.transform='scale(0.97)'; this.style.boxShadow='0 6px 25px rgba(255,215,0,0.5)'" onmouseup="this.style.transform='scale(1)'; this.style.boxShadow='0 4px 20px rgba(255,215,0,0.4)'" onmouseleave="this.style.transform='scale(1)'; this.style.boxShadow='0 4px 20px rgba(255,215,0,0.4)'">
                                <span style="font-size:20px;text-shadow:0 2px 4px rgba(0,0,0,0.3);filter:drop-shadow(0 0 3px rgba(255,215,0,0.8));">⭐</span>
                                <span>VIP Машины за Telegram Stars</span>
                            </button>
                        </div>
                        
                        <div id="miningShop" style="display:grid;grid-template-columns:repeat(2,1fr);gap:15px;margin-bottom:20px;"></div>
                        
                        <div id="userMachines" style="margin-top:25px;padding-top:25px;border-top:2px solid rgba(102,126,234,0.3);">
                            <h3 style="font-size:16px;margin-bottom:15px;color:#fff;text-align:center;font-weight:800;">🗃️ ВАШИ МАШИНЫ</h3>
                            <div id="machinesList"></div>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            loadMiningCategory('coins');
        }
        const vipMiningCards = [
            {id: 'vip_quantum_prime', name: 'Quantum Prime', emoji: '⚡', basePrice: 50, baseHashPerHour: 120000, rarity: 'vip_prime', productId: 71, description: 'Элитный квантовый майнер'},
            {id: 'vip_solar_core', name: 'Solar Core', emoji: '☀️', basePrice: 100, baseHashPerHour: 300000, rarity: 'vip_solar', productId: 72, description: 'Солнечное ядро энергии'},
            {id: 'vip_black_hole', name: 'Black Hole', emoji: '🕳️', basePrice: 150, baseHashPerHour: 750000, rarity: 'vip_blackhole', productId: 73, description: 'Чёрная дыра энергии'},
            {id: 'vip_nebula', name: 'Nebula Ферма', emoji: '🌫️', basePrice: 250, baseHashPerHour: 2000000, rarity: 'vip_nebula', productId: 74, description: 'Ферма в туманности'},
            {id: 'vip_multiverse', name: 'Multiverse Станция', emoji: '🌐', basePrice: 400, baseHashPerHour: 5000000, rarity: 'vip_multiverse', productId: 75, description: 'Мультивселенная'},
            {id: 'vip_infinity', name: 'Infinity Альянс', emoji: '♾️', basePrice: 750, baseHashPerHour: 12000000, rarity: 'vip_infinity', productId: 76, description: 'Бесконечный альянс'}
        ];
        
        const miningMachinesData = {
            'coins': [
                {id: 'miner_cpu', name: 'CPU Майнер', emoji: '💻', basePrice: 5000, baseHashPerHour: 10, currency: 'coins', description: 'Базовый майнер на CPU'},
                {id: 'miner_gpu', name: 'GPU Майнер', emoji: '🎮', basePrice: 20000, baseHashPerHour: 50, currency: 'coins', description: 'Видеокарта для майнинга'},
                {id: 'miner_asic', name: 'ASIC Риг', emoji: '⚡', basePrice: 80000, baseHashPerHour: 200, currency: 'coins', description: 'Асик-устройство'},
                {id: 'miner_quantum', name: 'Quantum Майнер', emoji: '💎', basePrice: 300000, baseHashPerHour: 800, currency: 'coins', description: 'Квантовый майнер'},
                {id: 'miner_server', name: 'Server Ферма', emoji: '🖥️', basePrice: 1000000, baseHashPerHour: 3000, currency: 'coins', description: 'Серверная ферма'},
                {id: 'miner_cloud', name: 'Cloud Риг', emoji: '☁️', basePrice: 3500000, baseHashPerHour: 12000, currency: 'coins', description: 'Облачная ферма'},
                {id: 'miner_data', name: 'Data Центр', emoji: '🏢', basePrice: 12000000, baseHashPerHour: 50000, currency: 'coins', description: 'Дата-центр'},
                {id: 'miner_quantum_farm', name: 'Quantum Ферма', emoji: '🌌', basePrice: 40000000, baseHashPerHour: 200000, currency: 'coins', description: 'Квантовая ферма'},
                {id: 'miner_neural', name: 'Neural Майнер', emoji: '🧠', basePrice: 150000000, baseHashPerHour: 800000, currency: 'coins', description: 'Нейросетевой майнер'},
                {id: 'miner_cosmic', name: 'Cosmic Станция', emoji: '🚀', basePrice: 500000000, baseHashPerHour: 3200000, currency: 'coins', description: 'Космическая станция'}
            ],
            'quanhash': [
                {id: 'hash_quantum_core', name: 'Quantum Ядро', emoji: '⚛️', basePrice: 10000, baseHashPerHour: 80, currency: 'quanhash', description: 'Квантовое ядро'},
                {id: 'hash_plasma_rig', name: 'Plasma Риг', emoji: '🔥', basePrice: 50000, baseHashPerHour: 400, currency: 'quanhash', description: 'Плазменный майнер'},
                {id: 'hash_stellar', name: 'Stellar Блок', emoji: '⭐', basePrice: 250000, baseHashPerHour: 1800, currency: 'quanhash', description: 'Звёздный блок'},
                {id: 'hash_cosmic_flux', name: 'Cosmic Поток', emoji: '🌊', basePrice: 1000000, baseHashPerHour: 7000, currency: 'quanhash', description: 'Космический поток'},
                {id: 'hash_nova', name: 'Nova Ускоритель', emoji: '🌟', basePrice: 4000000, baseHashPerHour: 28000, currency: 'quanhash', description: 'Новейший ускоритель'},
                {id: 'hash_galaxy', name: 'Galaxy Матрица', emoji: '🌌', basePrice: 15000000, baseHashPerHour: 110000, currency: 'quanhash', description: 'Галактическая матрица'},
                {id: 'hash_void', name: 'Void Порталы', emoji: '🕳️', basePrice: 60000000, baseHashPerHour: 450000, currency: 'quanhash', description: 'Врата в пустоту'},
                {id: 'hash_eternal', name: 'Eternal Движитель', emoji: '∞', basePrice: 250000000, baseHashPerHour: 1800000, currency: 'quanhash', description: 'Вечный движитель'},
                {id: 'hash_divine', name: 'Divine Генератор', emoji: '👑', basePrice: 1000000000, baseHashPerHour: 7200000, currency: 'quanhash', description: 'Божественный генератор'},
                {id: 'hash_absolute', name: 'Absolute Мощь', emoji: '⚡', basePrice: 4000000000, baseHashPerHour: 28800000, currency: 'quanhash', description: 'Абсолютная мощь'}
            ]
        };
        
        function loadMiningCategory(category) {
            // Update button states
            document.querySelectorAll('.mining-cat-btn').forEach(btn => {
                const isCoins = category === 'coins';
                const isActive = btn.textContent.includes(isCoins ? 'коины' : 'QuanHash');
                if(isActive) {
                    btn.style.background = isCoins ? 'linear-gradient(135deg,rgba(102,126,234,0.25),rgba(118,75,162,0.25))' : 'linear-gradient(135deg,rgba(16,185,129,0.25),rgba(34,197,94,0.25))';
                    btn.style.border = isCoins ? '2px solid #667eea' : '2px solid #10b981';
                } else {
                    btn.style.background = 'rgba(255,255,255,0.05)';
                    btn.style.border = '2px solid rgba(102,126,234,0.2)';
                }
            });
            
            const machines = miningMachinesData[category] || [];
            const shop = document.getElementById('miningShop');
            if(shop) {
                const isCoins = category === 'coins';
                const bgGradient = isCoins ? 'linear-gradient(135deg,rgba(102,126,234,0.2),rgba(118,75,162,0.2))' : 'linear-gradient(135deg,rgba(16,185,129,0.2),rgba(34,197,94,0.2))';
                const borderColor = isCoins ? '#667eea' : '#10b981';
                const buttonGradient = isCoins ? 'linear-gradient(135deg,#667eea,#764ba2)' : 'linear-gradient(135deg,#10b981,#059669)';
                
                // Load user machines and levels from API
                fetch('/api/mining', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({user_id: window.user?.id, category: category})
                })
                .then(res => res.json())
                .then(data => {
                    // Update shop with levels
                    const machine_levels = data.machine_levels || {};
                    shop.innerHTML = machines.map((m, index) => {
                        const level = machine_levels[m.id] || 0;
                        const maxLevel = 50;
                        const isMaxLevel = level >= maxLevel;
                        const price = Math.floor(m.basePrice * Math.pow(1.15, level));
                        const hashPerHour = Math.floor(m.baseHashPerHour * Math.pow(1.15, level));
                        
                        return `
                            <div style="background:${bgGradient};padding:16px;border-radius:16px;border:3px solid ${borderColor};position:relative;box-shadow:0 8px 25px rgba(0,0,0,0.3);transition:all 0.3s;" onmouseover="this.style.transform='translateY(-3px)'; this.style.boxShadow='0 12px 35px rgba(0,0,0,0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 8px 25px rgba(0,0,0,0.3)'">
                                <div style="position:absolute;top:8px;right:8px;background:${borderColor};color:#fff;padding:3px 8px;border-radius:6px;font-size:9px;font-weight:900;box-shadow:0 2px 8px rgba(0,0,0,0.3);">⚡</div>
                                <div style="font-size:32px;text-align:center;margin-bottom:8px;filter:drop-shadow(0 4px 8px rgba(0,0,0,0.3));">${m.emoji}</div>
                                <div style="font-weight:900;font-size:13px;color:#fff;text-align:center;margin-bottom:4px;text-shadow:0 2px 4px rgba(0,0,0,0.5);">${m.name}</div>
                                <div style="font-size:9px;color:#94a3b8;text-align:center;margin-bottom:8px;font-weight:600;opacity:0.8;">${m.description || ''}</div>
                                <div style="font-size:10px;color:${isMaxLevel ? '#fbbf24' : '#94a3b8'};text-align:center;margin-bottom:8px;font-weight:600;">Уровень ${level}${isMaxLevel ? ' ⭐ MAX' : ` / ${maxLevel}`}</div>
                                <div style="font-size:12px;color:#4ade80;font-weight:900;text-align:center;margin-bottom:12px;text-shadow:0 0 10px rgba(74,222,128,0.4);">Доход +${hashPerHour.toLocaleString()} QuanHash/ч</div>
                                <button onclick="${isMaxLevel ? 'alert(\'✨ Максимальный уровень достигнут!\')' : `buyMachine('${m.id}', ${price}, '${m.currency}')`}" 
                                        style="width:100%;padding:11px;background:${isMaxLevel ? 'linear-gradient(135deg,#fbbf24,#fcd34d,#fbbf24)' : buttonGradient};color:${isMaxLevel ? '#000' : '#fff'};border:none;border-radius:10px;cursor:${isMaxLevel ? 'not-allowed' : 'pointer'};font-weight:900;font-size:11px;box-shadow:0 4px 15px rgba(0,0,0,0.3);transition:all 0.3s;display:flex;align-items:center;justify-content:center;gap:6px;opacity:${isMaxLevel ? 0.7 : 1};"
                                        onmousedown="${!isMaxLevel ? 'this.style.transform=\'scale(0.96)\'' : ''}" 
                                        onmouseup="${!isMaxLevel ? 'this.style.transform=\'scale(1)\'' : ''}" 
                                        onmouseleave="${!isMaxLevel ? 'this.style.transform=\'scale(1)\'' : ''}">
                                    <span>${isMaxLevel ? '✨ Максимальный уровень' : `Купить за ${m.currency === 'coins' ? '🪙' : '💎'} ${price.toLocaleString()} ${m.currency === 'coins' ? 'коинов' : 'QuanHash'}`}</span>
                                </button>
                            </div>
                        `;
                    }).join('');
                    
                    const machinesList = document.getElementById('machinesList');
                    console.log('machinesList element:', machinesList, 'user_machines:', data.user_machines, 'length:', data.user_machines?.length);
                    if(machinesList && data.user_machines) {
                        console.log('user_machines array:', data.user_machines);
                        if(data.user_machines.length > 0) {
                            machinesList.innerHTML = data.user_machines.map(m => {
                                const count = m.count || 1;
                                const incomePerHour = m.income_per_hour || 0;
                                const totalIncome = m.total_income || (incomePerHour * count);
                                
                                return `
                                <div style="background:rgba(102,126,234,0.15);padding:12px;border-radius:12px;border:2px solid rgba(102,126,234,0.3);margin-bottom:10px;animation:slideIn 0.3s ease-out;box-shadow:0 4px 12px rgba(102,126,234,0.2);">
                                    <div style="display:flex;justify-content:space-between;align-items:center;">
                                        <div style="flex:1;">
                                            <div style="font-weight:900;font-size:14px;margin-bottom:4px;color:#fff;">${m.name} ${count > 1 ? `<span style="background:rgba(102,126,234,0.6);padding:2px 6px;border-radius:4px;font-size:10px;">x${count}</span>` : ''}</div>
                                            <div style="font-size:11px;color:#94a3b8;">Уровень ${m.level} | ${(m.hash_rate || 0).toFixed(6)} Hash/s</div>
                                            <div style="font-size:12px;color:#4ade80;margin-top:4px;font-weight:700;">Доход +${Math.floor(totalIncome).toLocaleString()} QuanHash/час</div>
                                        </div>
                                        <div style="text-align:right;">
                                            <div style="font-size:28px;filter:drop-shadow(0 4px 8px rgba(102,126,234,0.5));">⚡</div>
                                        </div>
                                    </div>
                                </div>
                            `;
                            }).join('');
                        } else {
                            machinesList.innerHTML = '<p style="text-align:center;opacity:0.7;padding:15px;background:rgba(255,255,255,0.05);border-radius:12px;border:2px solid rgba(255,255,255,0.1);">🛒 У вас нет машин. Купите их выше!</p>';
                        }
                    }
                })
                .catch(err => {
                    const machinesList = document.getElementById('machinesList');
                    if(machinesList) {
                        machinesList.innerHTML = '<p style="text-align:center;opacity:0.7;padding:15px;background:rgba(255,255,255,0.05);border-radius:12px;border:2px solid rgba(255,255,255,0.1);">🛒 У вас нет машин. Купите их выше!</p>';
                    }
                });
            }
        }
        
        window.openVIPMiningModal = function() {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.style.zIndex = '10001';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 500px; max-height: 90vh; overflow-y: auto;background: linear-gradient(135deg, rgba(10, 14, 39, 0.98), rgba(15, 23, 42, 0.98));border-radius: 24px;border: 2px solid rgba(255,215,0,0.4);box-shadow: 0 20px 60px rgba(255,215,0,0.3);">
                    <div style="background: linear-gradient(135deg, #ffd700, #ffed4e, #ffd700); padding: 30px 60px 30px 30px; border-radius: 22px 22px 0 0; text-align: center; position: relative; box-shadow: 0 8px 30px rgba(255,215,0,0.4);">
                        <div style="display: flex; align-items: center; justify-content: center; gap: 15px;">
                            <div style="font-size: 45px; text-shadow: 0 3px 10px rgba(0,0,0,0.3); filter: drop-shadow(0 0 8px rgba(255,215,0,0.8)); animation: pulse 2s infinite;">⭐</div>
                            <div>
                                <h2 style="font-size: 28px; color: #000; margin: 0; font-weight: 900; text-shadow: 0 2px 6px rgba(0,0,0,0.2);">VIP МАШИНЫ</h2>
                                <div style="font-size: 15px; color: rgba(0,0,0,0.7); margin-top: 6px; font-weight: 600;">🏭 Эксклюзивная добыча QuanHash</div>
                            </div>
                        </div>
                        <button class="close-btn" onclick="this.closest('.modal').remove()" style="color: #000;">✕</button>
                    </div>
                    
                    <div style="padding: 25px;">
                        <div id="vipMiningContent" style="display:grid;grid-template-columns:repeat(2,1fr);gap:15px;margin-bottom:20px;"></div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Load VIP levels from API
            fetch('/api/mining', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({user_id: user?.id, category: 'vip'})
            })
            .then(res => res.json())
            .then(data => {
                const vip_levels = data.machine_levels || {};
                renderVIPMiningCards(vip_levels);
            })
            .catch(err => {
                console.error('Failed to load VIP levels:', err);
                renderVIPMiningCards({});
            });
        };
        
        function renderVIPMiningCards(vip_levels) {
            const vipMiningContent = document.getElementById('vipMiningContent');
            if (!vipMiningContent) return;
            
            let html = vipMiningCards.map((card, index) => {
                const level = vip_levels[card.id] || 0;
                const maxLevel = 50;
                const isMaxLevel = level >= maxLevel;
                const price = Math.floor(card.basePrice * Math.pow(1.15, level));
                const hashPerHour = Math.floor(card.baseHashPerHour * Math.pow(1.15, level));
                
                return `
                    <div style="background:linear-gradient(135deg,rgba(255,215,0,0.25),rgba(255,237,78,0.25));padding:16px;border-radius:16px;border:3px solid #ffd700;position:relative;box-shadow:0 8px 25px rgba(0,0,0,0.3);transition:all 0.3s;" onmouseover="this.style.transform='translateY(-3px)'; this.style.boxShadow='0 12px 35px rgba(0,0,0,0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 8px 25px rgba(0,0,0,0.3)'">
                        <div style="position:absolute;top:8px;right:8px;background:#ffd700;color:#000;padding:3px 8px;border-radius:6px;font-size:9px;font-weight:900;box-shadow:0 2px 8px rgba(0,0,0,0.3);">VIP</div>
                        <div style="font-size:32px;text-align:center;margin-bottom:8px;filter:drop-shadow(0 4px 8px rgba(0,0,0,0.3));">${card.emoji}</div>
                        <div style="font-weight:900;font-size:14px;color:#fff;text-align:center;margin-bottom:4px;text-shadow:0 2px 4px rgba(0,0,0,0.5);">${card.name}</div>
                        <div style="font-size:9px;color:#94a3b8;text-align:center;margin-bottom:8px;font-weight:600;opacity:0.8;">${card.description || ''}</div>
                        <div style="font-size:10px;color:${isMaxLevel ? '#fbbf24' : '#94a3b8'};text-align:center;margin-bottom:8px;font-weight:600;">Уровень ${level}${isMaxLevel ? ' ⭐ MAX' : ` / ${maxLevel}`}</div>
                        <div style="font-size:12px;color:#4ade80;font-weight:900;text-align:center;margin-bottom:12px;text-shadow:0 0 10px rgba(74,222,128,0.4);">Доход +${hashPerHour.toLocaleString()} QuanHash/ч</div>
                        <button onclick="${isMaxLevel ? 'alert(\'✨ Максимальный уровень достигнут!\')' : `buyVIPMiningMachineWithStars('${card.id}', ${price}, ${card.productId})`}" 
                                style="width:100%;padding:11px;background:${isMaxLevel ? 'linear-gradient(135deg,#fbbf24,#fcd34d,#fbbf24)' : 'linear-gradient(135deg,#ffd700,#ffed4e,#ffd700)'};color:${isMaxLevel ? '#000' : '#000'};border:none;border-radius:10px;cursor:${isMaxLevel ? 'not-allowed' : 'pointer'};font-weight:900;font-size:11px;box-shadow:0 4px 15px rgba(0,0,0,0.3);transition:all 0.3s;display:flex;align-items:center;justify-content:center;gap:6px;opacity:${isMaxLevel ? 0.7 : 1};"
                                onmousedown="${!isMaxLevel ? 'this.style.transform=\'scale(0.96)\'' : ''}" 
                                onmouseup="${!isMaxLevel ? 'this.style.transform=\'scale(1)\'' : ''}" 
                                onmouseleave="${!isMaxLevel ? 'this.style.transform=\'scale(1)\'' : ''}">
                            <span>${isMaxLevel ? '✨ Максимальный уровень' : `Купить за`}</span>
                            <span style="font-size:14px;filter:drop-shadow(0 0 3px rgba(255,215,0,0.8));">${isMaxLevel ? '' : '⭐'}</span>
                            <span>${isMaxLevel ? '' : price}</span>
                        </button>
                    </div>
                `;
            }).join('');
            
            vipMiningContent.innerHTML = html;
        };
        
        window.buyVIPMiningMachineWithStars = function(machineId, price, productId) {
            // Open Telegram payment
            const paymentUrl = `https://t.me/qanexus_bot?start=buy_stars_${productId}`;
            window.open(paymentUrl, '_blank');
            
            // Show beautiful VIP confirmation message
            const anim = document.createElement('div');
            anim.style.cssText = 'position:fixed;top:20%;left:50%;transform:translate(-50%,-50%);z-index:10000;pointer-events:none;';
            anim.innerHTML = '<div style="background:linear-gradient(135deg,rgba(255,215,0,0.95),rgba(255,237,78,0.95));padding:25px 50px;border-radius:25px;font-size:26px;box-shadow:0 15px 50px rgba(255,215,0,0.7);color:#000;font-weight:800;display:flex;align-items:center;gap:20px;border:3px solid rgba(255,215,0,0.8);"><span style="font-size:40px;">⭐</span><div><div style="font-size:28px;margin-bottom:8px;">VIP Покупка</div><div style="font-size:20px;opacity:0.8;">Открывается оплата за ' + price + ' ⭐ Telegram Stars</div></div></div>';
            document.body.appendChild(anim);
            setTimeout(() => {
                anim.style.opacity = '0';
                anim.style.transform = 'translate(-50%,-70%)';
                setTimeout(() => {anim.remove();}, 300);
            }, 2000);
        };
        
        function buyMachine(id, price, currency) {
            console.log('buyMachine called:', {id, price, currency, user_id: window.user?.id});
            const anim = document.createElement('div');
            anim.style.cssText='position:fixed;top:15%;left:50%;transform:translate(-50%,-50%);z-index:10000;pointer-events:none;';
            anim.innerHTML='<div style="background:linear-gradient(135deg,rgba(102,126,234,0.95),rgba(118,75,162,0.95));padding:8px 16px;border-radius:20px;font-size:14px;box-shadow:0 4px 15px rgba(102,126,234,0.5);color:#fff;font-weight:700;display:flex;align-items:center;gap:6px;border:1px solid rgba(255,255,255,0.2);"><span style="font-size:16px;">⚡</span> Покупка...</div>';
            document.body.appendChild(anim);
            setTimeout(()=>{anim.style.opacity='1';},10);
            
            fetch('/api/buy_machine', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                    user_id: window.user?.id,
                    machine_id: id,
                    price: price,
                    currency: currency
                })
            })
            .then(res => res.json())
            .then(data => {
                console.log('buyMachine response:', data);
                if(data.success) {
                    // Success notification - like in shop
                    anim.innerHTML='<div style="background:linear-gradient(135deg,rgba(34,197,94,0.95),rgba(16,185,129,0.95));padding:8px 16px;border-radius:20px;font-size:14px;box-shadow:0 4px 15px rgba(16,185,129,0.5);color:#fff;font-weight:700;display:flex;align-items:center;gap:6px;border:1px solid rgba(255,255,255,0.2);"><span style="font-size:16px;">✨</span> Машина улучшена!</div>';
                    setTimeout(()=>{
                        anim.style.opacity='0';anim.style.transform='translate(-50%,-60%)';
                        setTimeout(()=>{anim.remove();},300);
                    },800);
                    // Reload current category - find active button by checking computed styles
                    let currentCat = 'coins';
                    document.querySelectorAll('.mining-cat-btn').forEach(btn => {
                        const bg = btn.style.background;
                        if(bg.includes('0.25') || bg.includes('linear-gradient')) {
                            if(btn.textContent.includes('коины')) currentCat = 'coins';
                            else if(btn.textContent.includes('QuanHash')) currentCat = 'quanhash';
                        }
                    });
                    console.log('Reloading category:', currentCat);
                    loadMiningCategory(currentCat);
                    loadData();
                } else {
                    // Error notification - like in shop
                    const errorText = data.error.includes('Недостаточно') ? 'Недостаточно ' + (currency === 'coins' ? 'коинов' : 'QuanHash') : data.error;
                    anim.innerHTML='<div style="background:linear-gradient(135deg,rgba(239,68,68,0.95),rgba(220,38,38,0.95));padding:8px 16px;border-radius:20px;font-size:14px;box-shadow:0 4px 15px rgba(239,68,68,0.5);color:#fff;font-weight:700;display:flex;align-items:center;gap:6px;border:1px solid rgba(255,255,255,0.2);"><span style="font-size:16px;">💰</span> ' + errorText + '</div>';
                    setTimeout(()=>{
                        anim.style.opacity='0';anim.style.transform='translate(-50%,-60%)';
                        setTimeout(()=>{anim.remove();},300);
                    },1500);
                }
            });
        }

        function openCards(e) {
            e.preventDefault();
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.id = 'cardsModal2';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 420px; max-height: 85vh; overflow-y: auto;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                        <h2 style="font-size: 24px; color: #fff; font-weight: 800;">💳 Крипто-Карточки</h2>
                        <button class="close-btn" onclick="this.closest('.modal').remove()">✕</button>
                    </div>
                    
                    <div style="background:linear-gradient(135deg,rgba(102,126,234,0.15),rgba(118,75,162,0.15));padding:15px;border-radius:15px;margin-bottom:20px;border:2px solid rgba(102,126,234,0.3);">
                        <div style="font-size:13px;color:#94a3b8;line-height:1.6;">
                            <strong style="color:#fff;">📋 Пассивный доход 24/7:</strong> Крипто-карточки генерируют коины каждую минуту! Разные редкости = разный доход. Зарабатывайте даже оффлайн!
                        </div>
                    </div>
                    
                    <div id="cardsShopSection" style="margin-bottom:25px;">
                        <div style="font-size:16px;font-weight:700;color:#fff;margin-bottom:15px;display:flex;align-items:center;gap:8px;grid-column:1/-1;">
                            <span style="background:linear-gradient(135deg,#667eea,#764ba2);padding:6px 12px;border-radius:8px;width:100%;text-align:center;">🛒 Магазин карточек</span>
                        </div>
                        <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-bottom:15px;">
                            <button class="filter-btn shop-cat-btn" data-category="per_hour" onclick="loadCardsCategory('per_hour')" style="padding:10px;background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border:none;border-radius:10px;cursor:pointer;font-weight:600;font-size:12px;">⚡ В час (Основные)</button>
                            <button class="filter-btn shop-cat-btn" data-category="per_minute" onclick="loadCardsCategory('per_minute')" style="padding:10px;background:rgba(255,255,255,0.1);color:#fff;border:1px solid rgba(255,255,255,0.3);border-radius:10px;cursor:pointer;font-weight:600;font-size:12px;">💎 В минуту (Премиум)</button>
                        </div>
                        <div style="margin-bottom:15px;">
                            <button onclick="openVIPCardsModal()" style="width:100%;padding:14px;background:linear-gradient(135deg,#ffd700,#ffed4e,#ffd700);color:#000;border:2px solid #ffd700;border-radius:14px;cursor:pointer;font-weight:900;font-size:15px;box-shadow:0 4px 20px rgba(255,215,0,0.4);transition:all 0.3s;display:flex;align-items:center;justify-content:center;gap:10px;" onmousedown="this.style.transform='scale(0.97)'; this.style.boxShadow='0 6px 25px rgba(255,215,0,0.5)'" onmouseup="this.style.transform='scale(1)'; this.style.boxShadow='0 4px 20px rgba(255,215,0,0.4)'" onmouseleave="this.style.transform='scale(1)'; this.style.boxShadow='0 4px 20px rgba(255,215,0,0.4)'">
                                <span style="font-size:20px;text-shadow:0 2px 4px rgba(0,0,0,0.3);filter:drop-shadow(0 0 3px rgba(255,215,0,0.8));">⭐</span>
                                <span>VIP Карточки за Telegram Stars</span>
                            </button>
                        </div>
                        <div id="shopCardsList" style="display:grid;grid-template-columns:repeat(2,1fr);gap:12px;"></div>
                        <div id="vipCardsSection" style="display:none;grid-template-columns:repeat(2,1fr);gap:12px;margin-top:20px;"></div>
                    </div>
                    
                    <div id="passiveInfo" style="background:linear-gradient(135deg,rgba(16,185,129,0.2),rgba(34,197,94,0.2));padding:20px;border-radius:15px;border:2px solid rgba(16,185,129,0.4);text-align:center;margin-top:20px;margin-bottom:15px;">
                        <div style="font-size:14px;font-weight:700;margin-bottom:10px;color:#10b981;">💰 Общий пассивный доход</div>
                        <div style="font-size:36px;font-weight:900;color:#10b981;text-shadow:0 0 20px rgba(16,185,129,0.5);">+0 🪙/час</div>
                    </div>
                    
                    <button onclick="this.closest('.modal').remove()" style="width:100%;padding:14px;background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border:none;border-radius:12px;cursor:pointer;font-weight:700;font-size:16px;">Закрыть</button>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Load cards function
            window.loadCardsCategory = function(category) {
                // Handle VIP cards section display
                const shopCardsList = document.getElementById('shopCardsList');
                const vipCardsSection = document.getElementById('vipCardsSection');
                
                shopCardsList.style.display = 'grid';
                if (vipCardsSection) vipCardsSection.style.display = 'none';
                
                document.querySelectorAll('#cardsShopSection .shop-cat-btn').forEach(btn => {
                    if(btn.textContent.toLowerCase().includes(category === 'per_hour' ? 'час' : 'минуту')) {
                        btn.style.background = 'linear-gradient(135deg,#667eea,#764ba2)';
                        btn.style.border = 'none';
                    } else {
                        btn.style.background = 'rgba(255,255,255,0.1)';
                        btn.style.border = '1px solid rgba(255,255,255,0.3)';
                    }
                });
                loadCardsList(category);
            };
            
            window.buyVIPCard = function(cardType) {
                fetch('/api/buy_vip_card', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        user_id: user?.id,
                        card_type: cardType
                    })
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        tg.showAlert('✅ VIP карточка куплена!');
                        loadData();
                    } else {
                        tg.showAlert('❌ ' + data.error);
                    }
                })
                .catch(err => tg.showAlert('❌ Ошибка покупки'));
            };
            
            window.buyVIPCardWithStars = function(cardRarity, price, productId) {
                // Open Telegram payment (same as in VIP shop)
                const paymentUrl = `https://t.me/qanexus_bot?start=buy_stars_${productId}`;
                window.open(paymentUrl, '_blank');
                
                // Show beautiful VIP confirmation message
                const anim = document.createElement('div');
                anim.style.cssText = 'position:fixed;top:20%;left:50%;transform:translate(-50%,-50%);z-index:10000;pointer-events:none;';
                anim.innerHTML = '<div style="background:linear-gradient(135deg,rgba(255,215,0,0.95),rgba(255,237,78,0.95));padding:25px 50px;border-radius:25px;font-size:26px;box-shadow:0 15px 50px rgba(255,215,0,0.7);color:#000;font-weight:800;display:flex;align-items:center;gap:20px;border:3px solid rgba(255,215,0,0.8);"><span style="font-size:40px;">⭐</span><div><div style="font-size:28px;margin-bottom:8px;">VIP Покупка</div><div style="font-size:20px;opacity:0.8;">Открывается оплата за ' + price + ' ⭐ Telegram Stars</div></div></div>';
                document.body.appendChild(anim);
                setTimeout(() => {
                    anim.style.opacity = '0';
                    anim.style.transform = 'translate(-50%,-70%)';
                    setTimeout(() => {anim.remove();}, 300);
                }, 2000);
            };
            
            function loadCardsList(category) {
                fetch('/api/shop', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({user_id: user?.id, category: 'cards'})
                })
                .then(res => res.json())
                .then(shopData => {
                    console.log('Cards shop data:', shopData);
                    // Store cards data globally for buyShopItem function
                    if (!window.shopData) {
                        window.shopData = {};
                    }
                    window.shopData.items = shopData.items || [];
                    
                    const shopList = document.getElementById('shopCardsList');
                    const cards = shopData.items.filter(item => item.type === 'card' && (category === 'all' || item.income_type === category));
                    console.log('Filtered cards:', cards, 'category:', category);
                    console.log('Updating shopList for category:', category);
                    console.log('Cards data sample:', cards.slice(0, 2).map(c => ({
                        id: c.id,
                        name: c.name,
                        level: c.level,
                        price: c.price,
                        income: c.income,
                        income_per_min: c.income_per_min,
                        income_type: c.income_type
                    })));
                    console.log('All cards for category', category, ':', cards.map(c => ({
                        id: c.id,
                        level: c.level,
                        price: c.price,
                        income_per_min: c.income_per_min
                    })));
                    if(cards && cards.length > 0) {
                        shopList.innerHTML = cards.map((card, i) => {
                        // Skip locked cards
                        // Remove locking - all cards are available
                        const rarity = card.rarity || 'common';
                        const rarityInfo = {
                            'common': {emoji:'⚪', name:'Обычная', color:'rgba(255,255,255,0.15)', border:'rgba(255,255,255,0.4)'},
                            'rare': {emoji:'🔵', name:'Редкая', color:'rgba(102,126,234,0.25)', border:'rgba(102,126,234,0.8)'},
                            'epic': {emoji:'🟣', name:'Эпическая', color:'rgba(118,75,162,0.25)', border:'rgba(118,75,162,0.8)'},
                            'legendary': {emoji:'🟡', name:'Легендарная', color:'rgba(234,179,8,0.25)', border:'rgba(234,179,8,0.8)'}
                        };
                        const info = rarityInfo[rarity];
                        const income = card.income_type === 'per_minute' ? (card.income_per_min || 0) : (card.income || 0);
                        const incomeType = card.income_type === 'per_minute' ? '/мин' : '/час';
                        const level = card.level || 1;
                        const nameParts = card.name || 'Карточка';
                        const cardEmoji = nameParts.match(/[\u{1F600}-\u{1F9FF}]/u)?.[0] || '💳';
                        const cardName = nameParts.replace(/[\u{1F600}-\u{1F9FF}]/u, '').trim();
                        return `
                            <div style="background:${info.color};padding:12px;border-radius:12px;border:2px solid ${info.border};">
                                <div style="font-size:24px;text-align:center;margin-bottom:6px;">${cardEmoji}</div>
                                <div style="font-size:10px;font-weight:700;color:#fff;text-align:center;margin-bottom:6px;">${cardName}</div>
                                <div style="font-size:11px;color:#94a3b8;text-align:center;margin-bottom:6px;">${card.description}</div>
                                <div style="font-size:12px;color:#10b981;text-align:center;margin-bottom:6px;font-weight:700;">+${income.toFixed(1)} 🪙${incomeType}</div>
                                <div style="font-size:9px;color:#fbbf24;text-align:center;margin-bottom:8px;font-weight:600;">Lv.${level} ${info.name}</div>
                                <button onclick="buyShopItem('card', ${card.level || 1}, ${card.price || 0}, '${card.id}')" style="width:100%;padding:8px;background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border:none;border-radius:8px;cursor:pointer;font-weight:700;font-size:11px;">
                                    🪙 ${(card.price || 0).toLocaleString()}
                                </button>
                            </div>
                        `;
                    }).join('');
                    } else {
                        shopList.innerHTML = '<div style="grid-column:span 2;text-align:center;padding:20px;color:#94a3b8;background:rgba(255,255,255,0.05);border-radius:12px;">Карточки временно недоступны</div>';
                    }
                });
            }
            
            // Load per_hour cards by default
            loadCardsList('per_hour');
            
            // Update passive income immediately
            updatePassiveIncome();
        }
        
        // VIP Cards Modal - defined globally
        window.openVIPCardsModal = function() {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.style.zIndex = '10000';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 500px; max-height: 90vh; overflow-y: auto;background: linear-gradient(135deg, rgba(10, 14, 39, 0.98), rgba(15, 23, 42, 0.98));border-radius: 24px;border: 2px solid rgba(255,215,0,0.4);box-shadow: 0 20px 60px rgba(255,215,0,0.3);">
                    <div style="background: linear-gradient(135deg, #ffd700, #ffed4e, #ffd700); padding: 30px 60px 30px 30px; border-radius: 22px 22px 0 0; text-align: center; position: relative; box-shadow: 0 8px 30px rgba(255,215,0,0.4);">
                        <div style="display: flex; align-items: center; justify-content: center; gap: 15px;">
                            <div style="font-size: 45px; text-shadow: 0 3px 10px rgba(0,0,0,0.3); filter: drop-shadow(0 0 8px rgba(255,215,0,0.8)); animation: pulse 2s infinite;">⭐</div>
                            <div>
                                <h2 style="font-size: 28px; color: #000; margin: 0; font-weight: 900; text-shadow: 0 2px 6px rgba(0,0,0,0.2);">VIP КАРТОЧКИ</h2>
                                <div style="font-size: 15px; color: rgba(0,0,0,0.7); margin-top: 6px; font-weight: 600;">💎 Эксклюзивный пассивный доход</div>
                            </div>
                        </div>
                        <button class="close-btn" onclick="this.closest('.modal').remove()" style="color: #000;">✕</button>
                    </div>
                    
                    <div style="padding: 25px;">
                        <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:15px;margin-bottom:25px;">
                            <button id="vipCardsBtnHour" onclick="loadVIPCardsCategory('per_hour')" style="padding:14px;background:linear-gradient(135deg,rgba(255,215,0,0.15),rgba(255,237,78,0.15));color:#fff;border:2px solid #ffd700;border-radius:12px;cursor:pointer;font-weight:800;font-size:14px;transition:all 0.3s;">
                                ⚡ В час
                            </button>
                            <button id="vipCardsBtnMin" onclick="loadVIPCardsCategory('per_minute')" style="padding:14px;background:rgba(255,255,255,0.05);color:#fff;border:2px solid rgba(167,139,250,0.3);border-radius:12px;cursor:pointer;font-weight:800;font-size:14px;transition:all 0.3s;">
                                💎 В минуту
                            </button>
                        </div>
                        
                        <div id="vipCardsContent" style="display:grid;grid-template-columns:repeat(2,1fr);gap:15px;"></div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            loadVIPCardsCategory('per_hour');
            
            // Update passive income after modal is opened
            setTimeout(() => {
                if (typeof updatePassiveIncome === 'function') {
                    updatePassiveIncome();
                }
            }, 100);
        };
        
        window.loadVIPCardsCategory = function(category) {
            document.getElementById('vipCardsBtnHour').style.background = category === 'per_hour' ? 'linear-gradient(135deg,rgba(255,215,0,0.15),rgba(255,237,78,0.15))' : 'rgba(255,255,255,0.05)';
            document.getElementById('vipCardsBtnHour').style.border = category === 'per_hour' ? '2px solid #ffd700' : '2px solid rgba(255,215,0,0.2)';
            document.getElementById('vipCardsBtnMin').style.background = category === 'per_minute' ? 'linear-gradient(135deg,rgba(139,92,246,0.15),rgba(167,139,250,0.15))' : 'rgba(255,255,255,0.05)';
            document.getElementById('vipCardsBtnMin').style.border = category === 'per_minute' ? '2px solid #8b5cf6' : '2px solid rgba(167,139,250,0.2)';
            window.showVIPCardsList(category);
        };
        
        window.showVIPCardsList = function(category = 'per_hour') {
            const vipCardsContent = document.getElementById('vipCardsContent');
            const vipCardsSection = document.getElementById('vipCardsSection');
            const targetElement = vipCardsContent || vipCardsSection;
            if (!targetElement) return;
            
            // VIP Card definitions
            const vipCardsPerHour = [
                {name: 'VIP Silver', emoji: '⭐', basePrice: 100, baseIncome: 5000, rarity: 'vip_silver', productId: 51},
                {name: 'VIP Gold', emoji: '💎', basePrice: 250, baseIncome: 15000, rarity: 'vip_gold', productId: 52},
                {name: 'VIP Platinum', emoji: '👑', basePrice: 500, baseIncome: 35000, rarity: 'vip_platinum', productId: 53},
                {name: 'VIP Diamond', emoji: '💍', basePrice: 1000, baseIncome: 100000, rarity: 'vip_diamond', productId: 54},
                {name: 'VIP Elite', emoji: '🌟', basePrice: 2500, baseIncome: 300000, rarity: 'vip_elite', productId: 55},
                {name: 'VIP Ultimate', emoji: '⚡', basePrice: 5000, baseIncome: 750000, rarity: 'vip_ultimate', productId: 56}
            ];
            
            const vipCardsPerMinute = [
                {name: 'VIP Nova', emoji: '✨', basePrice: 500, baseIncome: 300, rarity: 'vip_nova', productId: 61},
                {name: 'VIP Quantum', emoji: '⚡', basePrice: 1250, baseIncome: 900, rarity: 'vip_quantum', productId: 62},
                {name: 'VIP Cosmic', emoji: '🔥', basePrice: 2500, baseIncome: 2000, rarity: 'vip_cosmic', productId: 63},
                {name: 'VIP Stellar', emoji: '🎆', basePrice: 5000, baseIncome: 5000, rarity: 'vip_stellar', productId: 64},
                {name: 'VIP Galaxy', emoji: '🌌', basePrice: 10000, baseIncome: 15000, rarity: 'vip_galaxy', productId: 65},
                {name: 'VIP Infinity', emoji: '🌠', basePrice: 20000, baseIncome: 40000, rarity: 'vip_infinity', productId: 66}
            ];
            
            const cards = category === 'per_hour' ? vipCardsPerHour : vipCardsPerMinute;
            let html = '';
            
            cards.forEach((card, index) => {
                const level = 1;
                const price = category === 'per_hour' 
                    ? Math.floor(card.basePrice * Math.pow(1.2, level - 1))
                    : Math.floor(card.basePrice * Math.pow(1.3, level - 1));
                const income = category === 'per_hour'
                    ? Math.floor(card.baseIncome * Math.pow(1.15, level - 1))
                    : Math.floor(card.baseIncome * Math.pow(1.2, level - 1));
                const incomeText = category === 'per_hour' ? `+${income.toLocaleString()} 🪙/час` : `+${income.toLocaleString()} 🪙/мин`;
                const isHour = category === 'per_hour';
                const borderColor = isHour ? '#ffd700' : '#8b5cf6';
                const bgGradient = isHour ? 'linear-gradient(135deg,rgba(255,215,0,0.25),rgba(255,237,78,0.25))' : 'linear-gradient(135deg,rgba(139,92,246,0.25),rgba(167,139,250,0.25))';
                const badgeBg = isHour ? '#ffd700' : '#8b5cf6';
                const badgeColor = isHour ? '#000' : '#fff';
                const buttonGradient = isHour ? 'linear-gradient(135deg,#ffd700,#ffed4e,#ffd700)' : 'linear-gradient(135deg,#8b5cf6,#a78bfa,#8b5cf6)';
                const buttonColor = isHour ? '#000' : '#fff';
                const incomeColor = isHour ? '#4ade80' : '#a78bfa';
                
                html += `
                    <div style="background:${bgGradient};padding:16px;border-radius:16px;border:3px solid ${borderColor};position:relative;box-shadow:0 8px 25px rgba(0,0,0,0.3);transition:all 0.3s;" onmouseover="this.style.transform='translateY(-3px)'; this.style.boxShadow='0 12px 35px rgba(0,0,0,0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 8px 25px rgba(0,0,0,0.3)'">
                        <div style="position:absolute;top:8px;right:8px;background:${badgeBg};color:${badgeColor};padding:3px 8px;border-radius:6px;font-size:9px;font-weight:900;box-shadow:0 2px 8px rgba(0,0,0,0.3);">VIP</div>
                        <div style="font-size:28px;text-align:center;margin-bottom:8px;filter:drop-shadow(0 4px 8px rgba(0,0,0,0.3));">${card.emoji}</div>
                        <div style="font-weight:900;font-size:14px;color:#fff;text-align:center;margin-bottom:4px;text-shadow:0 2px 4px rgba(0,0,0,0.5);">${card.name}</div>
                        <div style="font-size:10px;color:#94a3b8;text-align:center;margin-bottom:8px;font-weight:600;">Уровень ${level}</div>
                        <div style="font-size:13px;color:${incomeColor};font-weight:900;text-align:center;margin-bottom:12px;text-shadow:0 0 10px ${incomeColor}40;">${incomeText}</div>
                        <button onclick="buyVIPCardWithStars('${card.rarity}', ${price}, ${card.productId})" 
                                style="width:100%;padding:11px;background:${buttonGradient};color:${buttonColor};border:none;border-radius:10px;cursor:pointer;font-weight:900;font-size:12px;box-shadow:0 4px 15px rgba(0,0,0,0.3);transition:all 0.3s;display:flex;align-items:center;justify-content:center;gap:6px;"
                                onmousedown="this.style.transform='scale(0.96)'" 
                                onmouseup="this.style.transform='scale(1)'" 
                                onmouseleave="this.style.transform='scale(1)'">
                            <span>Купить за</span>
                            <span style="font-size:14px;filter:drop-shadow(0 0 3px rgba(255,215,0,0.8));">⭐</span>
                            <span>${price}</span>
                        </button>
                    </div>
                `;
            });
            
            targetElement.innerHTML = html;
        };
        
        function updatePassiveIncome() {
            fetch('/api/cards', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({user_id: window.user?.id})
            })
            .then(res => res.json())
            .then(data => {
                // Update passive info display with rounded whole numbers
                const totalPassive = Math.round(data.total_passive_per_hour || 0);
                const passiveInfo = document.getElementById('passiveInfo');
                if(passiveInfo && passiveInfo.querySelector('div:last-child')) {
                    passiveInfo.querySelector('div:last-child').textContent = `+${totalPassive.toLocaleString()} 🪙/час`;
                }
            })
            .catch(err => console.error('Error updating passive income:', err));
        }
        
        // Update passive income every second when cards modal is open
        let passiveIncomeInterval = null;
        document.addEventListener('click', function(e) {
            if(e.target.textContent && e.target.textContent.includes('Карточки')) {
                if(!passiveIncomeInterval) {
                    updatePassiveIncome();
                    passiveIncomeInterval = setInterval(updatePassiveIncome, 1000);
                }
            }
        });
        function openStats(e) {
            e.preventDefault();
            document.getElementById('statsModal').classList.add('active');
            fetch('/api/stats', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({user_id: window.user?.id})
            })
            .then(res => res.json())
            .then(data => {
                const statsHtml = `
                    <div class="stats-row">
                        <span class="stats-label">👆 Всего тапов</span>
                        <span class="stats-value">${data.total_taps || 0}</span>
                    </div>
                    <div class="stats-row">
                        <span class="stats-label">💰 Заработано</span>
                        <span class="stats-value">${Math.floor(data.total_earned || 0)} 🪙</span>
                    </div>
                    <div class="stats-row">
                        <span class="stats-label">💎 Добыто</span>
                        <span class="stats-value">${Math.floor(data.total_mined || 0)} ⚡</span>
                    </div>
                    <div class="stats-row">
                        <span class="stats-label">💰 Баланс</span>
                        <span class="stats-value">${Math.floor(data.coins || 0)} 🪙</span>
                    </div>
                    <div class="stats-row">
                        <span class="stats-label">💎 QuanHash</span>
                        <span class="stats-value">${Math.floor(data.quanhash || 0)} ⚡</span>
                    </div>
                `;
                document.getElementById('statsContent').innerHTML = statsHtml;
            });
        }

        function openAchievements() {
            fetch('/api/user_data', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({user_id: window.user?.id})
            })
            .then(res => res.json())
            .then(data => {
                const modal = document.createElement('div');
                modal.className = 'modal active';
                modal.style.zIndex = '10000';
                
                const achievements = [
                    {id:'first_tap', title:'👆 Первый тап', desc:'Сделайте первый тап', unlocked:data.total_taps >= 1, icon:'👆'},
                    {id:'hundred_taps', title:'🎯 Мастер тапов', desc:'Сделайте 100 тапов', unlocked:data.total_taps >= 100, icon:'🎯'},
                    {id:'thousand_taps', title:'⚡ Профи тапов', desc:'Сделайте 1000 тапов', unlocked:data.total_taps >= 1000, icon:'⚡'},
                    {id:'million_coins', title:'💰 Миллионер', desc:'Заработайте 1M коинов', unlocked:data.total_earned >= 1000000, icon:'💰'},
                    {id:'first_card', title:'🃏 Первая карта', desc:'Купите первую карту', unlocked:data.cards && data.cards.length > 0, icon:'🃏'},
                    {id:'first_machine', title:'⛏️ Первая машина', desc:'Купите первую майнинг-машину', unlocked:data.machines && data.machines.length > 0, icon:'⛏️'},
                    {id:'level_10', title:'🌟 Уровень 10', desc:'Достигните 10 уровня', unlocked:data.level >= 10, icon:'🌟'},
                    {id:'level_50', title:'⭐ Уровень 50', desc:'Достигните 50 уровня', unlocked:data.level >= 50, icon:'⭐'},
                    {id:'vip_bronze', title:'🥉 VIP бронза', desc:'Покупайте VIP бронза', unlocked:data.vip_level >= 1, icon:'🥉'},
                    {id:'vip_silver', title:'🥈 VIP серебро', desc:'Покупайте VIP серебро', unlocked:data.vip_level >= 2, icon:'🥈'},
                    {id:'vip_gold', title:'🥇 VIP золото', desc:'Покупайте VIP золото', unlocked:data.vip_level >= 3, icon:'🥇'},
                    {id:'referral_master', title:'👥 Мастер рефералов', desc:'Пригласите 10 друзей', unlocked:data.referrals_count >= 10, icon:'👥'}
                ];
                
                const unlockedCount = achievements.filter(a => a.unlocked).length;
                const totalCount = achievements.length;
                const progress = (unlockedCount / totalCount * 100).toFixed(0);
                
                modal.innerHTML = `
                    <div class="modal-content" style="max-width:450px;max-height:85vh;overflow-y:auto;background:linear-gradient(135deg,rgba(10,14,39,0.98),rgba(15,23,42,0.98));border-radius:24px;border:2px solid rgba(167,139,250,0.4);box-shadow:0 10px 40px rgba(167,139,250,0.3);">
                        <div style="background:linear-gradient(135deg,#667eea,#764ba2);padding:24px;border-radius:22px 22px 0 0;text-align:center;">
                            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
                                <h2 style="font-size:24px;color:#fff;margin:0;font-weight:900;">🏆 ДОСТИЖЕНИЯ</h2>
                                <button class="close-btn" onclick="this.closest('.modal').remove()">✕</button>
                            </div>
                            <div style="background:rgba(0,0,0,0.3);padding:12px;border-radius:12px;color:#fff;">
                                <div style="font-size:14px;font-weight:700;margin-bottom:8px;">Прогресс: ${unlockedCount}/${totalCount}</div>
                                <div style="background:rgba(255,255,255,0.2);height:8px;border-radius:10px;overflow:hidden;">
                                    <div style="width:${progress}%;height:100%;background:linear-gradient(90deg,#10b981,#4ade80);transition:width 0.5s;"></div>
                                </div>
                                <div style="font-size:11px;margin-top:6px;opacity:0.8;">${progress}% завершено</div>
                            </div>
                        </div>
                        <div style="padding:20px;">
                            ${achievements.map(ach => `
                                <div style="margin-bottom:12px;background:${ach.unlocked ? 'rgba(16,185,129,0.15)' : 'rgba(0,0,0,0.2)'};padding:14px;border-radius:12px;border:1px solid ${ach.unlocked ? 'rgba(16,185,129,0.3)' : 'rgba(255,255,255,0.1)'};transition:all 0.3s;">
                                    <div style="display:flex;align-items:center;gap:12px;">
                                        <div style="font-size:32px;filter:${ach.unlocked ? 'none' : 'grayscale(100%) opacity(0.5)'};">${ach.icon}</div>
                                        <div style="flex:1;">
                                            <div style="font-size:14px;font-weight:800;color:#fff;margin-bottom:4px;">${ach.title}</div>
                                            <div style="font-size:12px;color:${ach.unlocked ? '#86efac' : '#94a3b8'};">${ach.desc}</div>
                                        </div>
                                        ${ach.unlocked ? `
                                            <div style="font-size:24px;animation:spin 2s linear infinite;">✅</div>
                                        ` : `
                                            <div style="font-size:24px;opacity:0.3;">🔒</div>
                                        `}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                modal.onclick = (e) => {if(e.target === modal) modal.remove();};
            });
        }
        
        function openReferrals(e) {
            e.preventDefault();
            document.getElementById('referralsModal').classList.add('active');
            fetch('/api/referrals', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({user_id: window.user?.id})
            })
            .then(res => res.json())
            .then(data => {
                document.getElementById('refCount').textContent = data.referrals_count || 0;
                document.getElementById('refIncome').textContent = `${Math.floor(data.referral_income || 0)} 🪙`;
                // Generate correct referral link using referral_code
                const botUsername = 'qanexus_bot'; // Correct bot username
                const refCode = data.referral_code || user?.id || 'no_code'; // Use referral_code from API
                const refLink = `https://t.me/${botUsername}?start=${refCode}`;
                document.getElementById('refLink').textContent = refLink;
            });
        }

        function copyRefLink() {
            const link = document.getElementById('refLink').textContent;
            navigator.clipboard.writeText(link);
            tg.showAlert('✅ Ссылка скопирована!');
        }

        function openWithdrawModal(e) {
            if(e && e.preventDefault) e.preventDefault();
            document.getElementById('withdrawModal').classList.add('active');
            
            // Check if user has enough QuanHash
            fetch('/api/user_data', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({user_id: window.user?.id})
            })
            .then(res => res.json())
            .then(data => {
                const quanhash = Math.floor(data.quanhash || 0);
                const hasEnough = quanhash >= 500000;
                const vipLevel = data.vip_level || 0;
                const isVIP = vipLevel >= 3;
                const isDiamond = vipLevel >= 5;
                
                // VIP bonuses
                const feePercent = isDiamond ? 0 : isVIP ? 2 : 5;
                const minWithdraw = isDiamond ? 100000 : isVIP ? 250000 : 500000;
                const withdrawMultiplier = isDiamond ? 2 : isVIP ? 1.5 : 1;
                
                document.getElementById('withdrawContent').innerHTML = `
                    <div style="padding: 15px;">
                        <div style="text-align: center; margin-bottom: 15px;">
                            <div style="font-size: 40px; margin-bottom: 8px;">💎</div>
                            <div style="font-size: 16px; font-weight: bold;">Вывод средств</div>
                            <div style="font-size: 13px; opacity: 0.7; margin-top: 4px;">У вас: ${quanhash.toLocaleString()} 💎</div>
                            ${isVIP ? `
                            <div style="background:linear-gradient(135deg,#ffd700,#ffed4e);padding:8px 12px;border-radius:8px;margin-top:8px;font-size:12px;font-weight:800;color:#000;border:2px solid #ffd700;">
                                👑 VIP БОНУС: ${feePercent === 0 ? '0% комиссия!' : feePercent + '% комиссия • x' + withdrawMultiplier + ' лимит'}
                            </div>
                            ` : ''}
                        </div>
                        <div style="background: rgba(102, 126, 234, 0.1); border: 1px solid rgba(102, 126, 234, 0.3); border-radius: 10px; padding: 12px; margin-bottom: 15px;">
                            <div style="font-size: 13px; opacity: 0.8; margin-bottom: 4px;">Обмен</div>
                            <div style="font-size: 16px; font-weight: bold;">500,000 💎 = $1 USDT</div>
                            ${feePercent === 0 ? `
                            <div style="font-size:12px;color:#ffd700;font-weight:700;margin-top:4px;">✨ НЕТ КОМИССИИ (Diamond VIP)</div>
                            ` : ''}
                        </div>
                        <div style="margin-bottom: 12px;">
                            <div style="margin-bottom: 6px; font-weight: 500; font-size: 13px;">Количество QuanHash (мин. 500,000):</div>
                            <input type="number" id="quanhashAmount" value="${minWithdraw}" min="${minWithdraw}" step="1000" style="width: 100%; padding: 10px; background: rgba(255,255,255,0.1); border: 1px solid rgba(102, 126, 234, 0.3); border-radius: 10px; color: white; font-size: 14px;" oninput="updateUSDTAmount()">
                            <div id="usdtAmount" style="margin-top: 6px; font-size: 13px; font-weight: bold; color: #10b981;">Получите: $1.00 USDT</div>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <div style="margin-bottom: 6px; font-weight: 500; font-size: 13px;">BEP20 адрес:</div>
                            <input type="text" id="usdtAddress" placeholder="0x0000...0000" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(102, 126, 234, 0.3); border-radius: 10px; color: white; font-size: 14px; font-weight: 600;">
                        </div>
                        <button id="withdrawBtn" class="action-btn" onclick="withdraw()" style="width: 100%; margin-bottom: 15px; padding: 12px; ${hasEnough ? '' : 'opacity: 0.5; cursor: not-allowed;'}" ${hasEnough ? '' : 'disabled'}>${hasEnough ? '💸 Вывести' : '⚠️ Нет QuanHash'}</button>
                        <div style="border-top: 2px solid rgba(255,255,255,0.1); padding-top: 15px; margin-top: 15px;">
                            <div style="font-size: 15px; font-weight: bold; margin-bottom: 12px; text-align: center;">📜 История выводов</div>
                            <div id="withdrawHistory" style="max-height: 120px; overflow-y: auto;"></div>
                        </div>
                    </div>
                `;
                    
                    // Load transaction history
                    loadWithdrawHistory();
            });
        }

        function loadWithdrawHistory() {
            fetch('/api/history', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({user_id: window.user?.id})
            })
            .then(res => res.json())
            .then(data => {
                const historyDiv = document.getElementById('withdrawHistory');
                if(!historyDiv) return;
                
                console.log('Withdrawal history data:', data);
                
                const withdrawals = data.history || [];
                console.log('Withdrawals found:', withdrawals.length);
                
                if(withdrawals.length > 0) {
                    historyDiv.innerHTML = withdrawals.map(w => {
                        const date = new Date(w.date);
                        // Status in Russian from server
                        const statusText = w.status || 'В процессе';
                        const statusEmoji = statusText === 'В процессе' ? '⏳' : statusText === 'Выплачено' ? '✅' : statusText === 'Отклонено' ? '❌' : '⏳';
                        const statusColor = statusText === 'В процессе' ? '#f59e0b' : statusText === 'Выплачено' ? '#10b981' : statusText === 'Отклонено' ? '#ef4444' : '#94a3b8';
                        return `
                            <div style="background:rgba(0,0,0,0.2);padding:10px;border-radius:8px;margin-bottom:8px;">
                                <div style="display:flex;justify-content:space-between;margin-bottom:5px;">
                                    <span style="font-size:12px;font-weight:600;">${statusEmoji} $${Math.floor(w.amount || 0)}</span>
                                    <span style="font-size:11px;opacity:0.7;">${date.toLocaleDateString('ru')}</span>
                                </div>
                                <div style="font-size:10px;opacity:0.6;margin-bottom:5px;">${w.address ? (w.address.substring(0,10) + '...') : ''}</div>
                                <div style="font-size:10px;color:${statusColor};font-weight:600;">${statusText}</div>
                            </div>
                        `;
                    }).join('');
                } else {
                    historyDiv.innerHTML = '<div style="text-align:center;opacity:0.5;font-size:12px;padding:10px;">История пуста</div>';
                }
            })
            .catch(err => {
                console.error('Error loading history:', err);
                const historyDiv = document.getElementById('withdrawHistory');
                if(historyDiv) {
                    historyDiv.innerHTML = '<div style="text-align:center;opacity:0.5;font-size:12px;padding:10px;">Ошибка загрузки</div>';
                }
            });
        }

        function updateUSDTAmount() {
            const amount = parseInt(document.getElementById('quanhashAmount').value) || 500000;
            const usdtAmount = amount / 500000;
            document.getElementById('usdtAmount').textContent = `Получите: $${usdtAmount.toFixed(2)} USDT`;
        }
        
        function withdraw() {
            const address = document.getElementById('usdtAddress').value.trim();
            const amount = parseInt(document.getElementById('quanhashAmount').value) || 500000;
            
            if (!address || !address.match(/^0x[a-fA-F0-9]{40}$/)) {
                tg.showAlert('⚠️ Введите правильный BEP20 адрес');
                return;
            }
            
            if (amount < 500000) {
                tg.showAlert('⚠️ Минимум 500,000 QuanHash');
                return;
            }

            fetch('/api/withdraw', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    user_id: user?.id, 
                    address: address,
                    amount: amount
                })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    tg.showAlert('✅ Запрос на вывод отправлен!');
                    loadData();
                    // Reload withdrawal history after successful request
                    setTimeout(() => {
                        openWithdrawModal({preventDefault: () => {}});
                    }, 500);
                } else {
                    tg.showAlert('⚠️ ' + data.error);
                }
            });
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        loadData();
        checkOfflineIncome();
        startEnergyRegen();
        startAutoTap();
        updateSupportBadge();
        
        // Create loadUserDataOnly function to update stats without flickering autobot
        function loadUserDataOnly() {
            fetch('/api/user_data', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({user_id: window.user?.id})
            })
            .then(res => res.json())
            .then(data => {
                // Update only stats, don't touch autobot button
                const coins = Math.floor(data.coins || 0);
                const quanhash = Math.floor(data.quanhash || 0);
                const energy = parseInt(data.energy || 0);
                const maxEnergy = parseInt(data.max_energy || 1000);
                const passiveCoins = Math.floor(data.passive_coins_per_hour || 0);
                const passiveHash = Math.floor(data.passive_hash_per_hour || 0);
                
                document.getElementById('coins').textContent = coins.toLocaleString();
                document.getElementById('quanhash').textContent = quanhash.toLocaleString();
                document.getElementById('energy-text').textContent = `${energy}/${maxEnergy}`;
                document.getElementById('passiveCoins').textContent = `+${passiveCoins.toLocaleString()}/час`;
                document.getElementById('passiveHash').textContent = `+${passiveHash.toLocaleString()}/час`;
                
                const energyPercent = Math.min(100, Math.max(0, (energy / maxEnergy) * 100));
                const fillBar = document.getElementById('energy-bar-fill');
                const percentText = document.getElementById('energy-percent');
                if (fillBar) {
                    fillBar.style.width = energyPercent + '%';
                }
                if (percentText) {
                    percentText.textContent = Math.round(energyPercent) + '%';
                }
            })
            .catch(err => console.error('Error:', err));
        }
        
        // Auto-update data every 2 seconds
        setInterval(() => {
            loadUserDataOnly();
        }, 2000);
        
        // Update support badge every 5 seconds
        setInterval(() => {
            updateSupportBadge();
        }, 5000);
        
        function updateSupportBadge() {
            fetch('/api/user_support', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({user_id: window.user?.id})
            })
            .then(res => res.json())
            .then(data => {
                const answeredTickets = (data.tickets || []).filter(t => t.status === 'answered' && t.answer && !t.is_read).length;
                const badge = document.getElementById('supportBadge');
                if(answeredTickets > 0) {
                    badge.textContent = answeredTickets;
                    badge.style.display = 'inline-block';
                } else {
                    badge.style.display = 'none';
                }
            })
            .catch(() => {});
        }
        
        // Auto-tap function - Constantly running to check status
        function startAutoTap() {
            // Check status every 2 seconds to restart if needed
            setInterval(() => {
                fetch('/api/user_data', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({user_id: window.user?.id})
                })
                .then(res => res.json())
                .then(data => {
                    const isEnabled = data.auto_tap_enabled;
                    const hasMinEnergy = data.energy > 10;
                    const autobotExpiresAt = data.auto_tap_expires_at || 0;
                    const isStillValid = autobotExpiresAt > Date.now();
                    
                    // Start or restart auto-tap interval if conditions are met
                    if(isEnabled && hasMinEnergy && isStillValid && !window.autoTapInterval) {
                        const speed = 1000 / (data.auto_tap_speed || 1); // taps per second
                        window.autoTapInterval = setInterval(() => {
                            fetch('/api/user_data', {
                                method: 'POST',
                                headers: {'Content-Type': 'application/json'},
                                body: JSON.stringify({user_id: window.user?.id})
                            })
                            .then(res => res.json())
                            .then(data => {
                                const isEnabled = data.auto_tap_enabled;
                                const hasMinEnergy = data.energy > 10;
                                const autobotExpiresAt = data.auto_tap_expires_at || 0;
                                const isStillValid = autobotExpiresAt > Date.now();
                                
                                if(isEnabled && hasMinEnergy && isStillValid) {
                                    // Perform tap
                                    fetch('/api/tap', {
                                        method: 'POST',
                                        headers: {'Content-Type': 'application/json'},
                                        body: JSON.stringify({user_id: window.user?.id, is_auto: true})
                                    })
                                    .then(res => res.json())
                                    .then(data => {
                                        if(data.success) {
                                            // Show animation for autobot
                                            const hasOpenModal = document.querySelector('.modal.active');
                                            if (!hasOpenModal) {
                                                const button = document.querySelector('.tap-button');
                                                if(button) {
                                                    const rect = button.getBoundingClientRect();
                                                    const centerX = rect.left + rect.width / 2;
                                                    const centerY = rect.top + rect.height / 2;
                                                    
                                                    const coinAnimation = document.createElement('div');
                                                    coinAnimation.className = 'coin-animation';
                                                    coinAnimation.textContent = '+' + data.reward;
                                                    coinAnimation.style.left = centerX + 'px';
                                                    coinAnimation.style.top = centerY + 'px';
                                                    coinAnimation.style.transform = 'translate(-50%, -50%)';
                                                    coinAnimation.style.zIndex = '999';
                                                    document.body.appendChild(coinAnimation);
                                                    setTimeout(() => {
                                                        if(document.body.contains(coinAnimation)) {
                                                            document.body.removeChild(coinAnimation);
                                                        }
                                                    }, 1000);
                                                }
                                                loadUserDataOnly(); // Silent update
                                            } else {
                                                loadUserDataOnly();
                                            }
                                        }
                                    })
                                    .catch(err => console.error('Auto-tap error:', err));
                                } else {
                                    // Stop auto-tap if conditions not met
                                    clearInterval(window.autoTapInterval);
                                    window.autoTapInterval = null;
                                }
                            })
                            .catch(err => console.error('Status check error:', err));
                        }, speed);
                    } else if((!isEnabled || !hasMinEnergy || !isStillValid) && window.autoTapInterval) {
                        // Stop if conditions no longer met
                        clearInterval(window.autoTapInterval);
                        window.autoTapInterval = null;
                    }
                })
                .catch(err => console.error('Auto-tap status error:', err));
            }, 2000); // Check status every 2 seconds
        }
        
        // Support functions
        function openSupport(event) {
            event.preventDefault();
            tg.HapticFeedback.impactOccurred('light');
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.id = 'supportModal';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 400px;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                        <h2 style="font-size:20px;color:#fff;font-weight:700;">💬 Поддержка</h2>
                        <button class="close-btn" onclick="document.getElementById('supportModal').remove()">✕</button>
                    </div>
                    
                    <div style="margin-bottom:20px;">
                        <label style="display:block;font-size:13px;font-weight:600;margin-bottom:8px;color:#94a3b8;">Тема обращения</label>
                        <select id="supportTopic" style="width:100%;padding:14px 16px;background:rgba(0,0,0,0.4);border:2px solid rgba(102,126,234,0.3);border-radius:14px;color:#fff;font-size:14px;outline:none;transition:all 0.3s;">
                            <option value="Общие вопросы">❓ Общие вопросы</option>
                            <option value="Проблемы с балансом">💳 Проблемы с балансом</option>
                            <option value="Вывод средств">💸 Вывод средств</option>
                            <option value="Майнинг">⚡ Майнинг</option>
                            <option value="Карточки">💳 Карточки</option>
                            <option value="Реферальная программа">👥 Реферальная программа</option>
                            <option value="Технические проблемы">🔧 Технические проблемы</option>
                            <option value="Предложения">💡 Предложения</option>
                            <option value="Жалобы">⚠️ Жалобы</option>
                            <option value="Другое">📝 Другое</option>
                        </select>
                    </div>
                    
                    <div style="margin-bottom:25px;">
                        <label style="display:block;font-size:13px;font-weight:600;margin-bottom:8px;color:#94a3b8;">Сообщение</label>
                        <textarea id="supportMessage" placeholder="Опишите подробно ваш вопрос или проблему..." rows="5" style="width:100%;padding:14px 16px;background:rgba(0,0,0,0.4);border:2px solid rgba(102,126,234,0.3);border-radius:14px;color:#fff;font-size:14px;outline:none;transition:all 0.3s;resize:vertical;font-family:inherit;"></textarea>
                    </div>
                    
                    <div style="display:flex;gap:12px;">
                        <button onclick="sendSupport()" style="flex:1;padding:16px;background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border:none;border-radius:14px;cursor:pointer;font-weight:700;font-size:15px;box-shadow:0 8px 24px rgba(102,126,234,0.4);transition:all 0.3s;">📤 Отправить</button>
                        <button onclick="document.getElementById('supportModal').remove()" style="flex:1;padding:16px;background:rgba(255,255,255,0.1);color:#fff;border:2px solid rgba(255,255,255,0.3);border-radius:14px;cursor:pointer;font-weight:600;font-size:15px;transition:all 0.3s;">Отмена</button>
                    </div>
                    
                    <div style="text-align:center;margin-top:20px;padding-top:20px;border-top:1px solid rgba(255,255,255,0.1);">
                        <p style="font-size:11px;opacity:0.5;">⏱️ Среднее время ответа: 24 часа</p>
                    </div>
                    
                    <button onclick="loadMyTickets()" style="width:100%;margin-top:15px;padding:12px;background:rgba(102,126,234,0.2);color:#667eea;border:1px solid rgba(102,126,234,0.4);border-radius:12px;cursor:pointer;font-weight:600;">📋 Мои обращения</button>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Add focus effects
            const topicSelect = document.getElementById('supportTopic');
            const messageText = document.getElementById('supportMessage');
            
            if(topicSelect) {
                topicSelect.addEventListener('focus', () => {
                    topicSelect.style.borderColor = 'rgba(102,126,234,0.8)';
                    topicSelect.style.boxShadow = '0 0 20px rgba(102,126,234,0.3)';
                });
                topicSelect.addEventListener('blur', () => {
                    topicSelect.style.borderColor = 'rgba(102,126,234,0.3)';
                    topicSelect.style.boxShadow = 'none';
                });
            }
            
            if(messageText) {
                messageText.addEventListener('focus', () => {
                    messageText.style.borderColor = 'rgba(102,126,234,0.8)';
                    messageText.style.boxShadow = '0 0 20px rgba(102,126,234,0.3)';
                });
                messageText.addEventListener('blur', () => {
                    messageText.style.borderColor = 'rgba(102,126,234,0.3)';
                    messageText.style.boxShadow = 'none';
                });
            }
        }
        
        function sendSupport() {
            const topicEl = document.querySelector('[id*="supportTopic"]');
            const messageEl = document.querySelector('[id*="supportMessage"]');
            
            if (!topicEl || !messageEl) {
                console.error('Support form elements not found');
                return;
            }
            
            const topic = topicEl.value;
            const message = messageEl.value;
            
            if (!topic) {
                alert('⚠️ Выберите тему');
                return;
            }
            
            if (!message) {
                alert('⚠️ Введите сообщение');
                return;
            }
            
            fetch('/api/support', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    user_id: user?.id,
                    topic: topic,
                    message: message
                })
            })
            .then(res => {
                console.log('Support response status:', res.status);
                return res.json();
            })
            .then(data => {
                console.log('Support response data:', data);
                if (data.success) {
                    alert('✅ Сообщение отправлено!');
                    const modal = document.querySelector('#supportModal') || document.querySelector('.modal.active');
                    if (modal) modal.remove();
                } else {
                    alert('❌ Ошибка: ' + (data.error || 'неизвестная'));
                }
            })
            .catch(err => {
                console.error('Support send error:', err);
                alert('❌ Ошибка при отправке: ' + err.message);
            });
        }
        
        function loadMyTickets() {
            // Hide badge when opening my tickets
            const badge = document.getElementById('supportBadge');
            badge.style.display = 'none';
            
            // Mark all answered tickets as read
            fetch('/api/mark_tickets_read', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({user_id: window.user?.id})
            });
            
            fetch('/api/user_support', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({user_id: window.user?.id})
            })
            .then(res => res.json())
            .then(data => {
                if(data.tickets && data.tickets.length > 0) {
                    const ticketsList = data.tickets.map(t => `
                        <div style="background:rgba(0,0,0,0.3);padding:15px;border-radius:12px;margin-bottom:10px;border-left:4px solid ${t.status === 'answered' ? '#10b981' : '#f59e0b'};">
                            <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:10px;">
                                <div>
                                    <div style="font-weight:700;font-size:14px;color:#fff;margin-bottom:4px;">${t.topic}</div>
                                    <div style="font-size:11px;color:#94a3b8;">${new Date(t.created_at).toLocaleString()}</div>
                                </div>
                                <div style="padding:4px 10px;background:${t.status === 'answered' ? 'rgba(16,185,129,0.2)' : 'rgba(245,158,11,0.2)'};border-radius:8px;font-size:11px;font-weight:700;color:${t.status === 'answered' ? '#10b981' : '#f59e0b'};">
                                    ${t.status === 'answered' ? '✅ Готово' : '⏳ В процессе'}
                                </div>
                            </div>
                            <div style="font-size:12px;color:#fff;margin-bottom:10px;opacity:0.9;">${t.message}</div>
                            ${t.answer ? `<div style="background:rgba(16,185,129,0.15);padding:10px;border-radius:8px;margin-top:10px;border-left:3px solid #10b981;"><div style="font-size:11px;color:#10b981;font-weight:700;margin-bottom:6px;">📝 Ответ:</div><div style="font-size:12px;color:#fff;">${t.answer}</div></div>` : ''}
                        </div>
                    `).join('');
                    
                    const modal = document.createElement('div');
                    modal.className = 'modal active';
                    modal.innerHTML = `
                        <div class="modal-content" style="max-width: 400px; max-height: 80vh; overflow-y: auto;">
                            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                                <h2 style="font-size: 20px; color: #fff;">📋 Мои обращения</h2>
                                <button class="close-btn" onclick="this.closest('.modal').remove()">✕</button>
                            </div>
                            <div>${ticketsList}</div>
                        </div>
                    `;
                    document.body.appendChild(modal);
                } else {
                    alert('📭 У вас пока нет обращений');
                }
            })
            .catch(() => alert('❌ Ошибка загрузки'));
        }
    </script>
    
    <script>
        function openDailyBonus(e) {
            e.preventDefault();
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.id = 'dailyBonusModal';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 400px; max-height: 80vh; overflow-y: auto;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                        <h2 style="font-size: 24px; color: #fff;">🎁 Ежедневные задания</h2>
                        <button class="close-btn" onclick="this.closest('.modal').remove()">✕</button>
                    </div>
                    <div id="dailyTasksList" style="display:flex;flex-direction:column;gap:15px;"></div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Load daily tasks
            fetch('/api/daily_tasks', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({user_id: window.user?.id})
            })
            .then(res => res.json())
            .then(data => {
                const list = document.getElementById('dailyTasksList');
                if(data.tasks && data.tasks.length > 0) {
                    let html = '';
                    
                    // Add VIP tasks section if VIP
                    const checkVIPTasks = () => {
                        fetch('/api/user_data', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({user_id: window.user?.id})
                        })
                        .then(res => res.json())
                        .then(userData => {
                            const vipLevel = userData.vip_level || 0;
                            if (vipLevel >= 3) {
                                list.innerHTML = `
                                    ${vipLevel >= 4 ? `
                                    <div style="background:linear-gradient(135deg,#ffd700,#ffed4e);padding:15px;border-radius:12px;border:3px solid #ffd700;margin-bottom:15px;">
                                        <div style="font-size:16px;font-weight:800;color:#000;margin-bottom:8px;">🎉 VIP Турнир</div>
                                        <div style="font-size:12px;color:rgba(0,0,0,0.7);margin-bottom:10px;">Соревнование только для VIP! Топ-3 получают эксклюзивные награды.</div>
                                        <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
                                            <span style="font-size:13px;color:#000;font-weight:700;">🏆 Награды:</span>
                                            <span style="font-size:13px;color:#000;font-weight:800;">500M 🪙</span>
                                        </div>
                                        <button onclick="joinVIPTournament()" style="width:100%;padding:10px;background:#000;color:#ffd700;border:none;border-radius:8px;font-weight:800;cursor:pointer;">🎯 Участвовать</button>
                                    </div>
                                    ` : ''}
                                    ${vipLevel >= 5 ? `
                                    <div style="background:linear-gradient(135deg,#c084fc,#a78bfa);padding:15px;border-radius:12px;border:3px solid #c084fc;margin-bottom:15px;">
                                        <div style="font-size:16px;font-weight:800;color:#fff;margin-bottom:8px;">💎 Diamond Challenge</div>
                                        <div style="font-size:12px;color:rgba(255,255,255,0.8);margin-bottom:10px;">Эксклюзивный челлендж для Diamond VIP!</div>
                                        <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
                                            <span style="font-size:13px;color:#fff;font-weight:700;">💎 Бонус:</span>
                                            <span style="font-size:13px;color:#fff;font-weight:800;">x50 на 24ч</span>
                                        </div>
                                        <button onclick="activateDiamondChallenge()" style="width:100%;padding:10px;background:#fff;color:#a78bfa;border:none;border-radius:8px;font-weight:800;cursor:pointer;">⚡ Активировать</button>
                                    </div>
                                    ` : ''}
                                    ` + list.innerHTML;
                            }
                        });
                    };
                    checkVIPTasks();
                    
                    html += data.tasks.map(task => `
                        <div style="background:rgba(0,0,0,0.3);padding:15px;border-radius:12px;border:2px solid ${task.completed ? 'rgba(74,222,128,0.5)' : 'rgba(102,126,234,0.5)'};">
                            <div style="font-size:18px;font-weight:700;margin-bottom:8px;">${task.emoji} ${task.name}</div>
                            <div style="font-size:12px;color:#94a3b8;margin-bottom:8px;">${task.description}</div>
                            <div style="display:flex;justify-content:space-between;align-items:center;">
                                <div style="font-size:14px;color:${task.completed ? '#4ade80' : '#f093fb'};">${task.completed ? '✅ Выполнено' : 'Прогресс: ' + task.progress + '/' + task.target}</div>
                                <div style="font-size:16px;font-weight:700;">💰 +${task.reward}</div>
                            </div>
                            ${task.completed ? '<button onclick="claimReward(' + task.id + ')" style="width:100%;margin-top:10px;padding:10px;background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border:none;border-radius:10px;cursor:pointer;font-weight:600;">🎁 Забрать награду</button>' : ''}
                        </div>
                    `).join('');
                    list.innerHTML = html;
                } else {
                    list.innerHTML = '<p style="text-align:center;opacity:0.7;padding:20px;">Задания загружаются...</p>';
                }
            });
        }
        
        function joinVIPTournament() {
            tg.showAlert('🎉 Вы присоединились к VIP Турниру! Сразитесь за топ-3 места!');
        }
        
        function activateDiamondChallenge() {
            tg.showAlert('⚡ Diamond Challenge активирован! Получайте x50 бонус к доходам на 24 часа!');
        }
        function claimReward(taskId) {
            fetch('/api/claim_task', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({user_id: user?.id, task_id: taskId})
            })
            .then(res => res.json())
            .then(data => {
                if(data.success) {
                    openDailyBonus({preventDefault:()=>{}});
                    loadData();
                }
            });
        }
        
        let currentCategory = 'all';
        
        window.openBuyCurrency = function(e) {
            try {
                e.preventDefault();
            } catch(err) {}
            try {
                tg.HapticFeedback.impactOccurred('light');
            } catch(err) {}
            
            // Debug: Create simple modal
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.id = 'buyCurrencyModal';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 420px; max-height: 90vh; overflow-y: auto;background: linear-gradient(135deg, rgba(10, 14, 39, 0.95), rgba(15, 23, 42, 0.95));border-radius: 20px;">
                    <!-- Simple Header -->
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h2 style="font-size: 20px; color: #fff; margin: 0; font-weight: 700;">⭐ Купить валюту</h2>
                        <button class="close-btn" onclick="this.closest('.modal').remove()">✕</button>
                    </div>
                    
                    <!-- Category Buttons -->
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 15px;">
                        <button onclick="filterCategory('starter')" class="category-btn active" style="background: rgba(102,126,234,0.3); border: 2px solid rgba(102,126,234,0.6); padding: 10px; border-radius: 10px; color: #fff; cursor: pointer; font-weight: 700; font-size: 11px;">🎯 Старт</button>
                        <button onclick="filterCategory('premium')" class="category-btn" style="background: rgba(234,179,8,0.3); border: 2px solid rgba(234,179,8,0.6); padding: 10px; border-radius: 10px; color: #fff; cursor: pointer; font-weight: 700; font-size: 11px;">🚀 Премиум</button>
                        <button onclick="filterCategory('vip')" class="category-btn" style="background: rgba(255,215,0,0.3); border: 2px solid rgba(255,215,0,0.6); padding: 10px; border-radius: 10px; color: #fff; cursor: pointer; font-weight: 700; font-size: 11px;">⭐ Премиум</button>
                        <button onclick="filterCategory('limited')" class="category-btn" style="background: rgba(255,0,0,0.3); border: 2px solid rgba(255,0,0,0.6); padding: 10px; border-radius: 10px; color: #fff; cursor: pointer; font-weight: 700; font-size: 11px;">🔮 QuanHash</button>
                        <button onclick="filterCategory('ultra')" class="category-btn" style="background: rgba(128,0,128,0.3); border: 2px solid rgba(128,0,128,0.6); padding: 10px; border-radius: 10px; color: #fff; cursor: pointer; font-weight: 700; font-size: 11px;">🎁 Комбо</button>
                        <button onclick="filterCategory('mega')" class="category-btn" style="background: rgba(255,215,0,0.3); border: 2px solid rgba(255,215,0,0.6); padding: 10px; border-radius: 10px; color: #fff; cursor: pointer; font-weight: 700; font-size: 11px;">👑 VIP функции</button>
                    </div>
                    
                    <div id="currencyProductsList" style="display:flex;flex-direction:column;gap:8px;max-height:60vh;overflow-y:auto;padding-right:5px;">
                        <div data-category="starter" style="display:block;text-align:center;font-size:13px;font-weight:700;color:#fff;margin:8px 0 4px;">🎯 СТАРТОВЫЕ НАБОРЫ</div>

                        <div data-category="starter" style="background:rgba(102,126,234,0.25);padding:12px;border-radius:10px;border:1px solid rgba(102,126,234,0.5);">
                            <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
                                <div style="font-size:32px;">🌟</div>
                                <div style="flex:1;">
                                    <div style="font-size:15px;font-weight:700;color:#fff;">💫 Первые шаги</div>
                                    <div style="font-size:11px;color:#94a3b8;margin-top:4px;">Получите 200,000 коинов для старта игры</div>
                                    <div style="font-size:10px;color:102,126,234;margin-top:4px;">✅ Отличное начало игры</div>
                                </div>
                            </div>
                            <button onclick="window.open('https://t.me/qanexus_bot?start=buy_stars_1')" style="width:100%;padding:9px;background:linear-gradient(135deg,#667eea,#667eea);color:#fff;border:none;border-radius:8px;cursor:pointer;font-weight:700;font-size:12px;">💰 50 ⭐</button>
                        </div>
                        
                        <div data-category="starter" style="background:rgba(102,126,234,0.25);padding:12px;border-radius:10px;border:1px solid rgba(102,126,234,0.5);">
                            <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
                                <div style="font-size:32px;">✨</div>
                                <div style="flex:1;">
                                    <div style="font-size:15px;font-weight:700;color:#fff;">✨ Базовый старт</div>
                                    <div style="font-size:11px;color:#94a3b8;margin-top:4px;">Получите 500,000 коинов для быстрого роста</div>
                                    <div style="font-size:10px;color:102,126,234;margin-top:4px;">✅ Быстрый старт</div>
                                </div>
                            </div>
                            <button onclick="window.open('https://t.me/qanexus_bot?start=buy_stars_2')" style="width:100%;padding:9px;background:linear-gradient(135deg,#667eea,#667eea);color:#fff;border:none;border-radius:8px;cursor:pointer;font-weight:700;font-size:12px;">💰 120 ⭐</button>
                        </div>
                        
                        <div data-category="starter" style="background:rgba(102,126,234,0.25);padding:12px;border-radius:10px;border:1px solid rgba(102,126,234,0.5);">
                            <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
                                <div style="font-size:32px;">⭐</div>
                                <div style="flex:1;">
                                    <div style="font-size:15px;font-weight:700;color:#fff;">🌟 Начало пути</div>
                                    <div style="font-size:11px;color:#94a3b8;margin-top:4px;">Получите 800,000 коинов чтобы начать прогрессию</div>
                                    <div style="font-size:10px;color:102,126,234;margin-top:4px;">✅ Твёрдый фундамент</div>
                                </div>
                            </div>
                            <button onclick="window.open('https://t.me/qanexus_bot?start=buy_stars_3')" style="width:100%;padding:9px;background:linear-gradient(135deg,#667eea,#667eea);color:#fff;border:none;border-radius:8px;cursor:pointer;font-weight:700;font-size:12px;">💰 180 ⭐</button>
                        </div>
                        
                        <div data-category="starter" style="background:rgba(102,126,234,0.25);padding:12px;border-radius:10px;border:1px solid rgba(102,126,234,0.5);">
                            <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
                                <div style="font-size:32px;">💎</div>
                                <div style="flex:1;">
                                    <div style="font-size:15px;font-weight:700;color:#fff;">💎 Приветственный</div>
                                    <div style="font-size:11px;color:#94a3b8;margin-top:4px;">Получите 1,000,000 коинов - великолепный старт</div>
                                    <div style="font-size:10px;color:102,126,234;margin-top:4px;">✅ VIP приветствие</div>
                                </div>
                            </div>
                            <button onclick="window.open('https://t.me/qanexus_bot?start=buy_stars_4')" style="width:100%;padding:9px;background:linear-gradient(135deg,#667eea,#667eea);color:#fff;border:none;border-radius:8px;cursor:pointer;font-weight:700;font-size:12px;">💰 240 ⭐</button>
                        </div>
                        
                        <div data-category="starter" style="background:rgba(102,126,234,0.25);padding:12px;border-radius:10px;border:1px solid rgba(102,126,234,0.5);">
                            <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
                                <div style="font-size:32px;">🎁</div>
                                <div style="flex:1;">
                                    <div style="font-size:15px;font-weight:700;color:#fff;">🎁 Добро пожаловать</div>
                                    <div style="font-size:11px;color:#94a3b8;margin-top:4px;">Получите 1,500,000 коинов для мощного старта</div>
                                    <div style="font-size:10px;color:102,126,234;margin-top:4px;">✅ Максимальная выгода</div>
                                </div>
                            </div>
                            <button onclick="window.open('https://t.me/qanexus_bot?start=buy_stars_5')" style="width:100%;padding:9px;background:linear-gradient(135deg,#667eea,#667eea);color:#fff;border:none;border-radius:8px;cursor:pointer;font-weight:700;font-size:12px;">💰 320 ⭐</button>
                        </div>
                        
                        <div data-category="starter" style="background:rgba(102,126,234,0.25);padding:12px;border-radius:10px;border:1px solid rgba(102,126,234,0.5);">
                            <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
                                <div style="font-size:32px;">💰</div>
                                <div style="flex:1;">
                                    <div style="font-size:15px;font-weight:700;color:#fff;">💰 Стартовый пакет</div>
                                    <div style="font-size:11px;color:#94a3b8;margin-top:4px;">Получите 2,000,000 коинов для серьёзной игры</div>
                                    <div style="font-size:10px;color:102,126,234;margin-top:4px;">✅ Серьёзный старт</div>
                                </div>
                            </div>
                            <button onclick="window.open('https://t.me/qanexus_bot?start=buy_stars_6')" style="width:100%;padding:9px;background:linear-gradient(135deg,#667eea,#667eea);color:#fff;border:none;border-radius:8px;cursor:pointer;font-weight:700;font-size:12px;">💰 400 ⭐</button>
                        </div>
                        
                        <div data-category="starter" style="background:rgba(102,126,234,0.25);padding:12px;border-radius:10px;border:1px solid rgba(102,126,234,0.5);">
                            <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
                                <div style="font-size:32px;">⚡</div>
                                <div style="flex:1;">
                                    <div style="font-size:15px;font-weight:700;color:#fff;">⚡ Быстрый старт</div>
                                    <div style="font-size:11px;color:#94a3b8;margin-top:4px;">Получите 2,500,000 коинов для молниеносного роста</div>
                                    <div style="font-size:10px;color:102,126,234;margin-top:4px;">✅ Максимальная скорость</div>
                                </div>
                            </div>
                            <button onclick="window.open('https://t.me/qanexus_bot?start=buy_stars_7')" style="width:100%;padding:9px;background:linear-gradient(135deg,#667eea,#667eea);color:#fff;border:none;border-radius:8px;cursor:pointer;font-weight:700;font-size:12px;">💰 480 ⭐</button>
                        </div>
                        
                        <div data-category="starter" style="background:rgba(102,126,234,0.25);padding:12px;border-radius:10px;border:1px solid rgba(102,126,234,0.5);">
                            <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
                                <div style="font-size:32px;">🎯</div>
                                <div style="flex:1;">
                                    <div style="font-size:15px;font-weight:700;color:#fff;">🎯 Первый шаг</div>
                                    <div style="font-size:11px;color:#94a3b8;margin-top:4px;">Получите 3,000,000 коинов для уверенного начала</div>
                                    <div style="font-size:10px;color:102,126,234;margin-top:4px;">✅ Точное попадание</div>
                                </div>
                            </div>
                            <button onclick="window.open('https://t.me/qanexus_bot?start=buy_stars_8')" style="width:100%;padding:9px;background:linear-gradient(135deg,#667eea,#667eea);color:#fff;border:none;border-radius:8px;cursor:pointer;font-weight:700;font-size:12px;">💰 560 ⭐</button>
                        </div>
                        
                        <div data-category="starter" style="background:rgba(102,126,234,0.25);padding:12px;border-radius:10px;border:1px solid rgba(102,126,234,0.5);">
                            <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
                                <div style="font-size:32px;">🌈</div>
                                <div style="flex:1;">
                                    <div style="font-size:15px;font-weight:700;color:#fff;">🌈 Радужный набор</div>
                                    <div style="font-size:11px;color:#94a3b8;margin-top:4px;">Получите 3,500,000 коинов для яркого старта</div>
                                    <div style="font-size:10px;color:102,126,234;margin-top:4px;">✅ Разноцветные возможности</div>
                                </div>
                            </div>
                            <button onclick="window.open('https://t.me/qanexus_bot?start=buy_stars_9')" style="width:100%;padding:9px;background:linear-gradient(135deg,#667eea,#667eea);color:#fff;border:none;border-radius:8px;cursor:pointer;font-weight:700;font-size:12px;">💰 640 ⭐</button>
                        </div>
                        
                        <div data-category="starter" style="background:rgba(102,126,234,0.25);padding:12px;border-radius:10px;border:1px solid rgba(102,126,234,0.5);">
                            <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
                                <div style="font-size:32px;">💫</div>
                                <div style="flex:1;">
                                    <div style="font-size:15px;font-weight:700;color:#fff;">💫 Волшебный старт</div>
                                    <div style="font-size:11px;color:#94a3b8;margin-top:4px;">Получите 4,000,000 коинов для магического начала</div>
                                    <div style="font-size:10px;color:102,126,234;margin-top:4px;">✅ Волшебная сила</div>
                                </div>
                            </div>
                            <button onclick="window.open('https://t.me/qanexus_bot?start=buy_stars_10')" style="width:100%;padding:9px;background:linear-gradient(135deg,#667eea,#667eea);color:#fff;border:none;border-radius:8px;cursor:pointer;font-weight:700;font-size:12px;">💰 720 ⭐</button>
                        </div>
                        
                        <div data-category="premium" style="display:block;text-align:center;font-size:13px;font-weight:700;color:#fff;margin:8px 0 4px;">🚀 ПРЕМИУМ НАБОРЫ</div>

                        <div data-category="premium" style="background:rgba(234,179,8,0.25);padding:12px;border-radius:10px;border:1px solid rgba(234,179,8,0.5);">
                            <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
                                <div style="font-size:32px;">⚡</div>
                                <div style="flex:1;">
                                    <div style="font-size:15px;font-weight:700;color:#fff;">⚡ Световой пакет</div>
                                    <div style="font-size:11px;color:#94a3b8;margin-top:4px;">Получите 1,500,000 коинов для яркого прогресса</div>
                                    <div style="font-size:10px;color:234,179,8;margin-top:4px;">✅ Световая скорость</div>
                                </div>
                            </div>
                            <button onclick="window.open('https://t.me/qanexus_bot?start=buy_stars_11')" style="width:100%;padding:9px;background:linear-gradient(135deg,#f59e0b,#f59e0b);color:#fff;border:none;border-radius:8px;cursor:pointer;font-weight:700;font-size:12px;">💰 300 ⭐</button>
                        </div>
                        
                        <div data-category="premium" style="background:rgba(234,179,8,0.25);padding:12px;border-radius:10px;border:1px solid rgba(234,179,8,0.5);">
                            <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
                                <div style="font-size:32px;">🎯</div>
                                <div style="flex:1;">
                                    <div style="font-size:15px;font-weight:700;color:#fff;">🎯 Профессионал</div>
                                    <div style="font-size:11px;color:#94a3b8;margin-top:4px;">Получите 3,000,000 коинов для профессиональной игры</div>
                                    <div style="font-size:10px;color:234,179,8;margin-top:4px;">✅ Точность мастера</div>
                                </div>
                            </div>
                            <button onclick="window.open('https://t.me/qanexus_bot?start=buy_stars_12')" style="width:100%;padding:9px;background:linear-gradient(135deg,#f59e0b,#f59e0b);color:#fff;border:none;border-radius:8px;cursor:pointer;font-weight:700;font-size:12px;">💰 600 ⭐</button>
                        </div>
                        
                        <div data-category="premium" style="background:rgba(234,179,8,0.25);padding:12px;border-radius:10px;border:1px solid rgba(234,179,8,0.5);">
                            <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
                                <div style="font-size:32px;">🚀</div>
                                <div style="flex:1;">
                                    <div style="font-size:15px;font-weight:700;color:#fff;">🚀 Мощный набор</div>
                                    <div style="font-size:11px;color:#94a3b8;margin-top:4px;">Получите 4,500,000 коинов для мощного рывка</div>
                                    <div style="font-size:10px;color:234,179,8;margin-top:4px;">✅ Ракетный старт</div>
                                </div>
                            </div>
                            <button onclick="window.open('https://t.me/qanexus_bot?start=buy_stars_13')" style="width:100%;padding:9px;background:linear-gradient(135deg,#f59e0b,#f59e0b);color:#fff;border:none;border-radius:8px;cursor:pointer;font-weight:700;font-size:12px;">💰 900 ⭐</button>
                        </div>
                        
                        <div data-category="premium" style="background:rgba(234,179,8,0.25);padding:12px;border-radius:10px;border:1px solid rgba(234,179,8,0.5);">
                            <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
                                <div style="font-size:32px;">💎</div>
                                <div style="flex:1;">
                                    <div style="font-size:15px;font-weight:700;color:#fff;">💎 Алмазный пакет</div>
                                    <div style="font-size:11px;color:#94a3b8;margin-top:4px;">Получите 6,000,000 коинов для алмазного прогресса</div>
                                    <div style="font-size:10px;color:234,179,8;margin-top:4px;">✅ Алмазная прочность</div>
                                </div>
                            </div>
                            <button onclick="window.open('https://t.me/qanexus_bot?start=buy_stars_14')" style="width:100%;padding:9px;background:linear-gradient(135deg,#f59e0b,#f59e0b);color:#fff;border:none;border-radius:8px;cursor:pointer;font-weight:700;font-size:12px;">💰 1200 ⭐</button>
                        </div>
                        
                        <div data-category="premium" style="background:rgba(234,179,8,0.25);padding:12px;border-radius:10px;border:1px solid rgba(234,179,8,0.5);">
                            <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
                                <div style="font-size:32px;">🔥</div>
                                <div style="flex:1;">
                                    <div style="font-size:15px;font-weight:700;color:#fff;">🔥 Огненный набор</div>
                                    <div style="font-size:11px;color:#94a3b8;margin-top:4px;">Получите 7,500,000 коинов для огненной мощи</div>
                                    <div style="font-size:10px;color:234,179,8;margin-top:4px;">✅ Пылающая энергия</div>
                                </div>
                            </div>
                            <button onclick="window.open('https://t.me/qanexus_bot?start=buy_stars_15')" style="width:100%;padding:9px;background:linear-gradient(135deg,#f59e0b,#f59e0b);color:#fff;border:none;border-radius:8px;cursor:pointer;font-weight:700;font-size:12px;">💰 1500 ⭐</button>
                        </div>
                        
                        <div data-category="premium" style="background:rgba(234,179,8,0.25);padding:12px;border-radius:10px;border:1px solid rgba(234,179,8,0.5);">
                            <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
                                <div style="font-size:32px;">⚡</div>
                                <div style="flex:1;">
                                    <div style="font-size:15px;font-weight:700;color:#fff;">⚡ Электронный</div>
                                    <div style="font-size:11px;color:#94a3b8;margin-top:4px;">Получите 9,000,000 коинов для электронного буста</div>
                                    <div style="font-size:10px;color:234,179,8;margin-top:4px;">✅ Электрическая мощь</div>
                                </div>
                            </div>
                            <button onclick="window.open('https://t.me/qanexus_bot?start=buy_stars_16')" style="width:100%;padding:9px;background:linear-gradient(135deg,#f59e0b,#f59e0b);color:#fff;border:none;border-radius:8px;cursor:pointer;font-weight:700;font-size:12px;">💰 1800 ⭐</button>
                        </div>
                        
                        <div data-category="premium" style="background:rgba(234,179,8,0.25);padding:12px;border-radius:10px;border:1px solid rgba(234,179,8,0.5);">
                            <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
                                <div style="font-size:32px;">🌟</div>
                                <div style="flex:1;">
                                    <div style="font-size:15px;font-weight:700;color:#fff;">🌟 Звёздный пакет</div>
                                    <div style="font-size:11px;color:#94a3b8;margin-top:4px;">Получите 10,500,000 коинов для звёздного уровня</div>
                                    <div style="font-size:10px;color:234,179,8;margin-top:4px;">✅ Звёздная слава</div>
                                </div>
                            </div>
                            <button onclick="window.open('https://t.me/qanexus_bot?start=buy_stars_17')" style="width:100%;padding:9px;background:linear-gradient(135deg,#f59e0b,#f59e0b);color:#fff;border:none;border-radius:8px;cursor:pointer;font-weight:700;font-size:12px;">💰 2100 ⭐</button>
                        </div>
                        
                        <div data-category="premium" style="background:rgba(234,179,8,0.25);padding:12px;border-radius:10px;border:1px solid rgba(234,179,8,0.5);">
                            <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
                                <div style="font-size:32px;">💫</div>
                                <div style="flex:1;">
                                    <div style="font-size:15px;font-weight:700;color:#fff;">💫 Космический</div>
                                    <div style="font-size:11px;color:#94a3b8;margin-top:4px;">Получите 12,000,000 коинов для космического прогресса</div>
                                    <div style="font-size:10px;color:234,179,8;margin-top:4px;">✅ Космическая скорость</div>
                                </div>
                            </div>
                            <button onclick="window.open('https://t.me/qanexus_bot?start=buy_stars_18')" style="width:100%;padding:9px;background:linear-gradient(135deg,#f59e0b,#f59e0b);color:#fff;border:none;border-radius:8px;cursor:pointer;font-weight:700;font-size:12px;">💰 2400 ⭐</button>
                        </div>
                        
                        <div data-category="premium" style="background:rgba(234,179,8,0.25);padding:12px;border-radius:10px;border:1px solid rgba(234,179,8,0.5);">
                            <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
                                <div style="font-size:32px;">🎁</div>
                                <div style="flex:1;">
                                    <div style="font-size:15px;font-weight:700;color:#fff;">🎁 Подарочный VIP</div>
                                    <div style="font-size:11px;color:#94a3b8;margin-top:4px;">Получите 13,500,000 коинов для VIP статуса</div>
                                    <div style="font-size:10px;color:234,179,8;margin-top:4px;">✅ VIP подарок</div>
                                </div>
                            </div>
                            <button onclick="window.open('https://t.me/qanexus_bot?start=buy_stars_19')" style="width:100%;padding:9px;background:linear-gradient(135deg,#f59e0b,#f59e0b);color:#fff;border:none;border-radius:8px;cursor:pointer;font-weight:700;font-size:12px;">💰 2700 ⭐</button>
                        </div>
                        
                        <div data-category="premium" style="background:rgba(234,179,8,0.25);padding:12px;border-radius:10px;border:1px solid rgba(234,179,8,0.5);">
                            <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
                                <div style="font-size:32px;">🔮</div>
                                <div style="flex:1;">
                                    <div style="font-size:15px;font-weight:700;color:#fff;">🔮 Магический</div>
                                    <div style="font-size:11px;color:#94a3b8;margin-top:4px;">Получите 15,000,000 коинов для магического роста</div>
                                    <div style="font-size:10px;color:234,179,8;margin-top:4px;">✅ Магическая сила</div>
                                </div>
                            </div>
                            <button onclick="window.open('https://t.me/qanexus_bot?start=buy_stars_20')" style="width:100%;padding:9px;background:linear-gradient(135deg,#f59e0b,#f59e0b);color:#fff;border:none;border-radius:8px;cursor:pointer;font-weight:700;font-size:12px;">💰 3000 ⭐</button>
                        </div>
                        
                        <div data-category="vip" style="display:block;text-align:center;font-size:13px;font-weight:700;color:#fff;margin:8px 0 4px;">⭐ ПРЕМИУМ ФУНКЦИИ</div>

                        <div data-category="vip" style="background:rgba(255,215,0,0.25);padding:12px;border-radius:10px;border:1px solid rgba(255,215,0,0.5);">
                            <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
                                <div style="font-size:32px;">💎</div>
                                <div style="flex:1;">
                                    <div style="font-size:15px;font-weight:700;color:#fff;">💎 VIP стартовый</div>
                                    <div style="font-size:11px;color:#94a3b8;margin-top:4px;">Получите 5,000,000 коинов для начала VIP пути</div>
                                    <div style="font-size:10px;color:255,215,0;margin-top:4px;">✅ Стартовый бонус включён</div>
                                </div>
                            </div>
                            <button onclick="window.open('https://t.me/qanexus_bot?start=buy_stars_21')" style="width:100%;padding:9px;background:linear-gradient(135deg,#ffd700,#ffd700);color:#000;border:none;border-radius:8px;cursor:pointer;font-weight:700;font-size:12px;">💰 1000 ⭐</button>
                        </div>
                        
                        <div data-category="vip" style="background:rgba(255,215,0,0.25);padding:12px;border-radius:10px;border:1px solid rgba(255,215,0,0.5);">
                            <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
                                <div style="font-size:32px;">🚀</div>
                                <div style="flex:1;">
                                    <div style="font-size:15px;font-weight:700;color:#fff;">🚀 VIP ускорение</div>
                                    <div style="font-size:11px;color:#94a3b8;margin-top:4px;">Получите 8,000,000 коинов + приоритетная обработка</div>
                                    <div style="font-size:10px;color:255,215,0;margin-top:4px;">✅ Ускоренное начисление</div>
                                </div>
                            </div>
                            <button onclick="window.open('https://t.me/qanexus_bot?start=buy_stars_22')" style="width:100%;padding:9px;background:linear-gradient(135deg,#ffd700,#ffd700);color:#000;border:none;border-radius:8px;cursor:pointer;font-weight:700;font-size:12px;">💰 1600 ⭐</button>
                        </div>
                        
                        <div data-category="vip" style="background:rgba(255,215,0,0.25);padding:12px;border-radius:10px;border:1px solid rgba(255,215,0,0.5);">
                            <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
                                <div style="font-size:32px;">👑</div>
                                <div style="flex:1;">
                                    <div style="font-size:15px;font-weight:700;color:#fff;">👑 VIP статус</div>
                                    <div style="font-size:11px;color:#94a3b8;margin-top:4px;">Получите 12,000,000 коинов + эксклюзивный бонус</div>
                                    <div style="font-size:10px;color:255,215,0;margin-top:4px;">✅ Официальный VIP статус</div>
                                </div>
                            </div>
                            <button onclick="window.open('https://t.me/qanexus_bot?start=buy_stars_23')" style="width:100%;padding:9px;background:linear-gradient(135deg,#ffd700,#ffd700);color:#000;border:none;border-radius:8px;cursor:pointer;font-weight:700;font-size:12px;">💰 2400 ⭐</button>
                        </div>
                        
                        <div data-category="vip" style="background:rgba(255,215,0,0.25);padding:12px;border-radius:10px;border:1px solid rgba(255,215,0,0.5);">
                            <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
                                <div style="font-size:32px;">⚡</div>
                                <div style="flex:1;">
                                    <div style="font-size:15px;font-weight:700;color:#fff;">⚡ VIP турбо</div>
                                    <div style="font-size:11px;color:#94a3b8;margin-top:4px;">Получите 16,000,000 коинов для турбо ускорения</div>
                                    <div style="font-size:10px;color:255,215,0;margin-top:4px;">✅ Турбо режим активен</div>
                                </div>
                            </div>
                            <button onclick="window.open('https://t.me/qanexus_bot?start=buy_stars_24')" style="width:100%;padding:9px;background:linear-gradient(135deg,#ffd700,#ffd700);color:#000;border:none;border-radius:8px;cursor:pointer;font-weight:700;font-size:12px;">💰 3200 ⭐</button>
                        </div>
                        <div data-category="vip" style="background:rgba(255,215,0,0.25);padding:12px;border-radius:10px;border:1px solid rgba(255,215,0,0.5);">
                            <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
                                <div style="font-size:32px;">💎</div>
                                <div style="flex:1;">
                                    <div style="font-size:15px;font-weight:700;color:#fff;">💎 VIP королевство</div>
                                    <div style="font-size:11px;color:#94a3b8;margin-top:4px;">Получите 20,000,000 коинов для королевского статуса</div>
                                    <div style="font-size:10px;color:255,215,0;margin-top:4px;">✅ Королевская привилегия</div>
                                </div>
                            </div>
                            <button onclick="window.open('https://t.me/qanexus_bot?start=buy_stars_25')" style="width:100%;padding:9px;background:linear-gradient(135deg,#ffd700,#ffd700);color:#000;border:none;border-radius:8px;cursor:pointer;font-weight:700;font-size:12px;">💰 4000 ⭐</button>
                        </div>
                        
                        <div data-category="vip" style="background:rgba(255,215,0,0.25);padding:12px;border-radius:10px;border:1px solid rgba(255,215,0,0.5);">
                            <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
                                <div style="font-size:32px;">🔓</div>
                                <div style="flex:1;">
                                    <div style="font-size:15px;font-weight:700;color:#fff;">🔓 VIP безлимит</div>
                                    <div style="font-size:11px;color:#94a3b8;margin-top:4px;">Получите 25,000,000 коинов + максимальный бонус</div>
                                    <div style="font-size:10px;color:255,215,0;margin-top:4px;">✅ Безлимитные возможности</div>
                                </div>
                            </div>
                            <button onclick="window.open('https://t.me/qanexus_bot?start=buy_stars_26')" style="width:100%;padding:9px;background:linear-gradient(135deg,#ffd700,#ffd700);color:#000;border:none;border-radius:8px;cursor:pointer;font-weight:700;font-size:12px;">💰 5000 ⭐</button>
                        </div>
                        
                        <div data-category="vip" style="background:rgba(255,215,0,0.25);padding:12px;border-radius:10px;border:1px solid rgba(255,215,0,0.5);">
                            <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
                                <div style="font-size:32px;">🏆</div>
                                <div style="flex:1;">
                                    <div style="font-size:15px;font-weight:700;color:#fff;">🏆 VIP чемпион</div>
                                    <div style="font-size:11px;color:#94a3b8;margin-top:4px;">Получите 30,000,000 коинов для чемпионского статуса</div>
                                    <div style="font-size:10px;color:255,215,0;margin-top:4px;">✅ Чемпионский уровень</div>
                                </div>
                            </div>
                            <button onclick="window.open('https://t.me/qanexus_bot?start=buy_stars_27')" style="width:100%;padding:9px;background:linear-gradient(135deg,#ffd700,#ffd700);color:#000;border:none;border-radius:8px;cursor:pointer;font-weight:700;font-size:12px;">💰 6000 ⭐</button>
                        </div>
                        
                        <div data-category="vip" style="background:rgba(255,215,0,0.25);padding:12px;border-radius:10px;border:1px solid rgba(255,215,0,0.5);">
                            <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
                                <div style="font-size:32px;">🌟</div>
                                <div style="flex:1;">
                                    <div style="font-size:15px;font-weight:700;color:#fff;">🌟 VIP легенда</div>
                                    <div style="font-size:11px;color:#94a3b8;margin-top:4px;">Получите 35,000,000 коинов для легендарного статуса</div>
                                    <div style="font-size:10px;color:255,215,0;margin-top:4px;">✅ Легендарная мощь</div>
                                </div>
                            </div>
                            <button onclick="window.open('https://t.me/qanexus_bot?start=buy_stars_28')" style="width:100%;padding:9px;background:linear-gradient(135deg,#ffd700,#ffd700);color:#000;border:none;border-radius:8px;cursor:pointer;font-weight:700;font-size:12px;">💰 7000 ⭐</button>
                        </div>
                        
                        <div data-category="vip" style="background:rgba(255,215,0,0.25);padding:12px;border-radius:10px;border:1px solid rgba(255,215,0,0.5);">
                            <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
                                <div style="font-size:32px;">💎</div>
                                <div style="flex:1;">
                                    <div style="font-size:15px;font-weight:700;color:#fff;">💎 VIP алмаз</div>
                                    <div style="font-size:11px;color:#94a3b8;margin-top:4px;">Получите 40,000,000 коинов + все VIP бонусы</div>
                                    <div style="font-size:10px;color:255,215,0;margin-top:4px;">✅ Алмазная привилегия</div>
                                </div>
                            </div>
                            <button onclick="window.open('https://t.me/qanexus_bot?start=buy_stars_29')" style="width:100%;padding:9px;background:linear-gradient(135deg,#ffd700,#ffd700);color:#000;border:none;border-radius:8px;cursor:pointer;font-weight:700;font-size:12px;">💰 8000 ⭐</button>
                        </div>
                        
                        <div data-category="vip" style="background:rgba(255,215,0,0.25);padding:12px;border-radius:10px;border:1px solid rgba(255,215,0,0.5);">
                            <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
                                <div style="font-size:32px;">👑</div>
                                <div style="flex:1;">
                                    <div style="font-size:15px;font-weight:700;color:#fff;">👑 VIP император</div>
                                    <div style="font-size:11px;color:#94a3b8;margin-top:4px;">Получите 45,000,000 коинов + максимальные премиум бонусы</div>
                                    <div style="font-size:10px;color:255,215,0;margin-top:4px;">✅ Императорский доступ</div>
                                </div>
                            </div>
                            <button onclick="window.open('https://t.me/qanexus_bot?start=buy_stars_30')" style="width:100%;padding:9px;background:linear-gradient(135deg,#ffd700,#ffd700);color:#000;border:none;border-radius:8px;cursor:pointer;font-weight:700;font-size:12px;">💰 9000 ⭐</button>
                        </div>
                        
                        <div data-category="limited" style="display:block;text-align:center;font-size:13px;font-weight:700;color:#fff;margin:8px 0 4px;">🔮 QUANHASH НАБОРЫ</div>

                        <div data-category="limited" style="background:rgba(255,0,0,0.25);padding:12px;border-radius:10px;border:1px solid rgba(255,0,0,0.5);">
                            <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
                                <div style="font-size:32px;">🔮</div>
                                <div style="flex:1;">
                                    <div style="font-size:15px;font-weight:700;color:#fff;">🔮 Starter Hash</div>
                                    <div style="font-size:11px;color:#94a3b8;margin-top:4px;">Получите 1,000 QuanHash для начала майнинга</div>
                                    <div style="font-size:10px;color:255,0,0;margin-top:4px;">✅ Стартовый майнинг</div>
                                </div>
                            </div>
                            <button onclick="window.open('https://t.me/qanexus_bot?start=buy_stars_31')" style="width:100%;padding:9px;background:linear-gradient(135deg,#ff0000,#ff0000);color:#fff;border:none;border-radius:8px;cursor:pointer;font-weight:700;font-size:12px;">💰 2500 ⭐</button>
                        </div>
                        
                        <div data-category="limited" style="background:rgba(255,0,0,0.25);padding:12px;border-radius:10px;border:1px solid rgba(255,0,0,0.5);">
                            <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
                                <div style="font-size:32px;">💎</div>
                                <div style="flex:1;">
                                    <div style="font-size:15px;font-weight:700;color:#fff;">💎 Basic Hash</div>
                                    <div style="font-size:11px;color:#94a3b8;margin-top:4px;">Получите 5,000 QuanHash для базового майнинга</div>
                                    <div style="font-size:10px;color:255,0,0;margin-top:4px;">✅ Базовый хэш</div>
                                </div>
                            </div>
                            <button onclick="window.open('https://t.me/qanexus_bot?start=buy_stars_32')" style="width:100%;padding:9px;background:linear-gradient(135deg,#ff0000,#ff0000);color:#fff;border:none;border-radius:8px;cursor:pointer;font-weight:700;font-size:12px;">💰 3200 ⭐</button>
                        </div>
                        
                        <div data-category="limited" style="background:rgba(255,0,0,0.25);padding:12px;border-radius:10px;border:1px solid rgba(255,0,0,0.5);">
                            <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
                                <div style="font-size:32px;">⚡</div>
                                <div style="flex:1;">
                                    <div style="font-size:15px;font-weight:700;color:#fff;">⚡ Power Hash</div>
                                    <div style="font-size:11px;color:#94a3b8;margin-top:4px;">Получите 10,000 QuanHash для мощного майнинга</div>
                                    <div style="font-size:10px;color:255,0,0;margin-top:4px;">✅ Мощный хэш</div>
                                </div>
                            </div>
                            <button onclick="window.open('https://t.me/qanexus_bot?start=buy_stars_33')" style="width:100%;padding:9px;background:linear-gradient(135deg,#ff0000,#ff0000);color:#fff;border:none;border-radius:8px;cursor:pointer;font-weight:700;font-size:12px;">💰 3900 ⭐</button>
                        </div>
                        
                        <div data-category="limited" style="background:rgba(255,0,0,0.25);padding:12px;border-radius:10px;border:1px solid rgba(255,0,0,0.5);">
                            <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
                                <div style="font-size:32px;">🔥</div>
                                <div style="flex:1;">
                                    <div style="font-size:15px;font-weight:700;color:#fff;">🔥 Fire Hash</div>
                                    <div style="font-size:11px;color:#94a3b8;margin-top:4px;">Получите 15,000 QuanHash для огненного майнинга</div>
                                    <div style="font-size:10px;color:255,0,0;margin-top:4px;">✅ Огненная мощность</div>
                                </div>
                            </div>
                            <button onclick="window.open('https://t.me/qanexus_bot?start=buy_stars_34')" style="width:100%;padding:9px;background:linear-gradient(135deg,#ff0000,#ff0000);color:#fff;border:none;border-radius:8px;cursor:pointer;font-weight:700;font-size:12px;">💰 4600 ⭐</button>
                        </div>
                        
                        <div data-category="limited" style="background:rgba(255,0,0,0.25);padding:12px;border-radius:10px;border:1px solid rgba(255,0,0,0.5);">
                            <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
                                <div style="font-size:32px;">💥</div>
                                <div style="flex:1;">
                                    <div style="font-size:15px;font-weight:700;color:#fff;">💥 Blast Hash</div>
                                    <div style="font-size:11px;color:#94a3b8;margin-top:4px;">Получите 25,000 QuanHash для взрывного майнинга</div>
                                    <div style="font-size:10px;color:255,0,0;margin-top:4px;">✅ Взрывной потенциал</div>
                                </div>
                            </div>
                            <button onclick="window.open('https://t.me/qanexus_bot?start=buy_stars_35')" style="width:100%;padding:9px;background:linear-gradient(135deg,#ff0000,#ff0000);color:#fff;border:none;border-radius:8px;cursor:pointer;font-weight:700;font-size:12px;">💰 5300 ⭐</button>
                        </div>
                        
                        <div data-category="limited" style="background:rgba(255,0,0,0.25);padding:12px;border-radius:10px;border:1px solid rgba(255,0,0,0.5);">
                            <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
                                <div style="font-size:32px;">🌟</div>
                                <div style="flex:1;">
                                    <div style="font-size:15px;font-weight:700;color:#fff;">🌟 Stellar Hash</div>
                                    <div style="font-size:11px;color:#94a3b8;margin-top:4px;">Получите 50,000 QuanHash для звёздного майнинга</div>
                                    <div style="font-size:10px;color:255,0,0;margin-top:4px;">✅ Звёздная скорость</div>
                                </div>
                            </div>
                            <button onclick="window.open('https://t.me/qanexus_bot?start=buy_stars_36')" style="width:100%;padding:9px;background:linear-gradient(135deg,#ff0000,#ff0000);color:#fff;border:none;border-radius:8px;cursor:pointer;font-weight:700;font-size:12px;">💰 6000 ⭐</button>
                        </div>
                        
                        <div data-category="limited" style="background:rgba(255,0,0,0.25);padding:12px;border-radius:10px;border:1px solid rgba(255,0,0,0.5);">
                            <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
                                <div style="font-size:32px;">💎</div>
                                <div style="flex:1;">
                                    <div style="font-size:15px;font-weight:700;color:#fff;">💎 Diamond Hash</div>
                                    <div style="font-size:11px;color:#94a3b8;margin-top:4px;">Получите 100,000 QuanHash для алмазного майнинга</div>
                                    <div style="font-size:10px;color:255,0,0;margin-top:4px;">✅ Алмазная прочность</div>
                                </div>
                            </div>
                            <button onclick="window.open('https://t.me/qanexus_bot?start=buy_stars_37')" style="width:100%;padding:9px;background:linear-gradient(135deg,#ff0000,#ff0000);color:#fff;border:none;border-radius:8px;cursor:pointer;font-weight:700;font-size:12px;">💰 6700 ⭐</button>
                        </div>
                        
                        <div data-category="limited" style="background:rgba(255,0,0,0.25);padding:12px;border-radius:10px;border:1px solid rgba(255,0,0,0.5);">
                            <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
                                <div style="font-size:32px;">🚀</div>
                                <div style="flex:1;">
                                    <div style="font-size:15px;font-weight:700;color:#fff;">🚀 Rocket Hash</div>
                                    <div style="font-size:11px;color:#94a3b8;margin-top:4px;">Получите 250,000 QuanHash для ракетного майнинга</div>
                                    <div style="font-size:10px;color:255,0,0;margin-top:4px;">✅ Ракетная мощь</div>
                                </div>
                            </div>
                            <button onclick="window.open('https://t.me/qanexus_bot?start=buy_stars_38')" style="width:100%;padding:9px;background:linear-gradient(135deg,#ff0000,#ff0000);color:#fff;border:none;border-radius:8px;cursor:pointer;font-weight:700;font-size:12px;">💰 7400 ⭐</button>
                        </div>
                        
                        <div data-category="limited" style="background:rgba(255,0,0,0.25);padding:12px;border-radius:10px;border:1px solid rgba(255,0,0,0.5);">
                            <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
                                <div style="font-size:32px;">👑</div>
                                <div style="flex:1;">
                                    <div style="font-size:15px;font-weight:700;color:#fff;">👑 Crown Hash</div>
                                    <div style="font-size:11px;color:#94a3b8;margin-top:4px;">Получите 500,000 QuanHash для королевского майнинга</div>
                                    <div style="font-size:10px;color:255,0,0;margin-top:4px;">✅ Королевский хэш</div>
                                </div>
                            </div>
                            <button onclick="window.open('https://t.me/qanexus_bot?start=buy_stars_39')" style="width:100%;padding:9px;background:linear-gradient(135deg,#ff0000,#ff0000);color:#fff;border:none;border-radius:8px;cursor:pointer;font-weight:700;font-size:12px;">💰 8100 ⭐</button>
                        </div>
                        
                        <div data-category="limited" style="background:rgba(255,0,0,0.25);padding:12px;border-radius:10px;border:1px solid rgba(255,0,0,0.5);">
                            <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
                                <div style="font-size:32px;">💫</div>
                                <div style="flex:1;">
                                    <div style="font-size:15px;font-weight:700;color:#fff;">💫 Ultimate Hash</div>
                                    <div style="font-size:11px;color:#94a3b8;margin-top:4px;">Получите 1,000,000 QuanHash для абсолютного майнинга</div>
                                    <div style="font-size:10px;color:255,0,0;margin-top:4px;">✅ Ультимейт мощь</div>
                                </div>
                            </div>
                            <button onclick="window.open('https://t.me/qanexus_bot?start=buy_stars_40')" style="width:100%;padding:9px;background:linear-gradient(135deg,#ff0000,#ff0000);color:#fff;border:none;border-radius:8px;cursor:pointer;font-weight:700;font-size:12px;">💰 9000 ⭐</button>
                        </div>
                        
                        <div data-category="ultra" style="display:block;text-align:center;font-size:13px;font-weight:700;color:#fff;margin:8px 0 4px;">🎁 КОМБО СЕТЫ</div>

                        <div data-category="ultra" style="background:rgba(128,0,128,0.25);padding:12px;border-radius:10px;border:1px solid rgba(128,0,128,0.5);">
                            <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
                                <div style="font-size:32px;">🎁</div>
                                <div style="flex:1;">
                                    <div style="font-size:15px;font-weight:700;color:#fff;">🎁 Стартовый мегасет</div>
                                    <div style="font-size:11px;color:#94a3b8;margin-top:4px;">Получите 10 карточек + 1,000,000 коинов</div>
                                    <div style="font-size:10px;color:128,0,128;margin-top:4px;">✅ Стартовый комбо</div>
                                </div>
                            </div>
                            <button onclick="window.open('https://t.me/qanexus_bot?start=buy_stars_41')" style="width:100%;padding:9px;background:linear-gradient(135deg,#800080,#800080);color:#fff;border:none;border-radius:8px;cursor:pointer;font-weight:700;font-size:12px;">💰 5000 ⭐</button>
                        </div>
                        
                        <div data-category="ultra" style="background:rgba(128,0,128,0.25);padding:12px;border-radius:10px;border:1px solid rgba(128,0,128,0.5);">
                            <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
                                <div style="font-size:32px;">🔥</div>
                                <div style="flex:1;">
                                    <div style="font-size:15px;font-weight:700;color:#fff;">🔥 Горячий комбо</div>
                                    <div style="font-size:11px;color:#94a3b8;margin-top:4px;">Получите 20 карточек + 10,000,000 коинов</div>
                                    <div style="font-size:10px;color:128,0,128;margin-top:4px;">✅ Горячая связка</div>
                                </div>
                            </div>
                            <button onclick="window.open('https://t.me/qanexus_bot?start=buy_stars_42')" style="width:100%;padding:9px;background:linear-gradient(135deg,#800080,#800080);color:#fff;border:none;border-radius:8px;cursor:pointer;font-weight:700;font-size:12px;">💰 7000 ⭐</button>
                        </div>
                        
                        <div data-category="ultra" style="background:rgba(128,0,128,0.25);padding:12px;border-radius:10px;border:1px solid rgba(128,0,128,0.5);">
                            <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
                                <div style="font-size:32px;">💎</div>
                                <div style="flex:1;">
                                    <div style="font-size:15px;font-weight:700;color:#fff;">💎 Элитный набор</div>
                                    <div style="font-size:11px;color:#94a3b8;margin-top:4px;">Получите 50 карточек + 50,000,000 коинов</div>
                                    <div style="font-size:10px;color:128,0,128;margin-top:4px;">✅ Элитная комбинация</div>
                                </div>
                            </div>
                            <button onclick="window.open('https://t.me/qanexus_bot?start=buy_stars_43')" style="width:100%;padding:9px;background:linear-gradient(135deg,#800080,#800080);color:#fff;border:none;border-radius:8px;cursor:pointer;font-weight:700;font-size:12px;">💰 9000 ⭐</button>
                        </div>
                        
                        <div data-category="ultra" style="background:rgba(128,0,128,0.25);padding:12px;border-radius:10px;border:1px solid rgba(128,0,128,0.5);">
                            <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
                                <div style="font-size:32px;">🚀</div>
                                <div style="flex:1;">
                                    <div style="font-size:15px;font-weight:700;color:#fff;">🚀 Мега связка</div>
                                    <div style="font-size:11px;color:#94a3b8;margin-top:4px;">Получите 100 карточек + 100,000,000 коинов</div>
                                    <div style="font-size:10px;color:128,0,128;margin-top:4px;">✅ Мега сила</div>
                                </div>
                            </div>
                            <button onclick="window.open('https://t.me/qanexus_bot?start=buy_stars_44')" style="width:100%;padding:9px;background:linear-gradient(135deg,#800080,#800080);color:#fff;border:none;border-radius:8px;cursor:pointer;font-weight:700;font-size:12px;">💰 11000 ⭐</button>
                        </div>
                        
                        <div data-category="ultra" style="background:rgba(128,0,128,0.25);padding:12px;border-radius:10px;border:1px solid rgba(128,0,128,0.5);">
                            <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
                                <div style="font-size:32px;">🌟</div>
                                <div style="flex:1;">
                                    <div style="font-size:15px;font-weight:700;color:#fff;">🌟 Легендарный мегасет</div>
                                    <div style="font-size:11px;color:#94a3b8;margin-top:4px;">Получите 200 карточек + 200,000,000 коинов</div>
                                    <div style="font-size:10px;color:128,0,128;margin-top:4px;">✅ Легендарная мощь</div>
                                </div>
                            </div>
                            <button onclick="window.open('https://t.me/qanexus_bot?start=buy_stars_45')" style="width:100%;padding:9px;background:linear-gradient(135deg,#800080,#800080);color:#fff;border:none;border-radius:8px;cursor:pointer;font-weight:700;font-size:12px;">💰 13000 ⭐</button>
                        </div>
                        
                        <div data-category="ultra" style="background:rgba(128,0,128,0.25);padding:12px;border-radius:10px;border:1px solid rgba(128,0,128,0.5);">
                            <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
                                <div style="font-size:32px;">💎</div>
                                <div style="flex:1;">
                                    <div style="font-size:15px;font-weight:700;color:#fff;">💎 Бриллиантовая связка</div>
                                    <div style="font-size:11px;color:#94a3b8;margin-top:4px;">VIP карты + безлимитные бонусы + 75M коинов</div>
                                    <div style="font-size:10px;color:128,0,128;margin-top:4px;">✅ Бриллиантовый пакет</div>
                                </div>
                            </div>
                            <button onclick="window.open('https://t.me/qanexus_bot?start=buy_stars_46')" style="width:100%;padding:9px;background:linear-gradient(135deg,#800080,#800080);color:#fff;border:none;border-radius:8px;cursor:pointer;font-weight:700;font-size:12px;">💰 15000 ⭐</button>
                        </div>
                        
                        <div data-category="ultra" style="background:rgba(128,0,128,0.25);padding:12px;border-radius:10px;border:1px solid rgba(128,0,128,0.5);">
                            <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
                                <div style="font-size:32px;">👑</div>
                                <div style="flex:1;">
                                    <div style="font-size:15px;font-weight:700;color:#fff;">👑 Королевский комбо</div>
                                    <div style="font-size:11px;color:#94a3b8;margin-top:4px;">300 карточек + VIP доступ + 85M коинов</div>
                                    <div style="font-size:10px;color:128,0,128;margin-top:4px;">✅ Королевская мощь</div>
                                </div>
                            </div>
                            <button onclick="window.open('https://t.me/qanexus_bot?start=buy_stars_47')" style="width:100%;padding:9px;background:linear-gradient(135deg,#800080,#800080);color:#fff;border:none;border-radius:8px;cursor:pointer;font-weight:700;font-size:12px;">💰 17000 ⭐</button>
                        </div>
                        
                        <div data-category="ultra" style="background:rgba(128,0,128,0.25);padding:12px;border-radius:10px;border:1px solid rgba(128,0,128,0.5);">
                            <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
                                <div style="font-size:32px;">🔥</div>
                                <div style="flex:1;">
                                    <div style="font-size:15px;font-weight:700;color:#fff;">🔥 Огненный мегасет</div>
                                    <div style="font-size:11px;color:#94a3b8;margin-top:4px;">500 карточек + 500,000,000 коинов</div>
                                    <div style="font-size:10px;color:128,0,128;margin-top:4px;">✅ Огненная мощь</div>
                                </div>
                            </div>
                            <button onclick="window.open('https://t.me/qanexus_bot?start=buy_stars_48')" style="width:100%;padding:9px;background:linear-gradient(135deg,#800080,#800080);color:#fff;border:none;border-radius:8px;cursor:pointer;font-weight:700;font-size:12px;">💰 19000 ⭐</button>
                        </div>
                        
                        <div data-category="ultra" style="background:rgba(128,0,128,0.25);padding:12px;border-radius:10px;border:1px solid rgba(128,0,128,0.5);">
                            <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
                                <div style="font-size:32px;">💫</div>
                                <div style="flex:1;">
                                    <div style="font-size:15px;font-weight:700;color:#fff;">💫 Космический комбо</div>
                                    <div style="font-size:11px;color:#94a3b8;margin-top:4px;">1000 карточек + всё VIP + 105M коинов</div>
                                    <div style="font-size:10px;color:128,0,128;margin-top:4px;">✅ Космическая сила</div>
                                </div>
                            </div>
                            <button onclick="window.open('https://t.me/qanexus_bot?start=buy_stars_49')" style="width:100%;padding:9px;background:linear-gradient(135deg,#800080,#800080);color:#fff;border:none;border-radius:8px;cursor:pointer;font-weight:700;font-size:12px;">💰 21000 ⭐</button>
                        </div>
                        
                        <div data-category="ultra" style="background:rgba(128,0,128,0.25);padding:12px;border-radius:10px;border:1px solid rgba(128,0,128,0.5);">
                            <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
                                <div style="font-size:32px;">🎯</div>
                                <div style="flex:1;">
                                    <div style="font-size:15px;font-weight:700;color:#fff;">🎯 АБСОЛЮТ ВСЁ</div>
                                    <div style="font-size:11px;color:#94a3b8;margin-top:4px;">ВСЁ что есть в игре! Абсолютный пакет</div>
                                    <div style="font-size:10px;color:128,0,128;margin-top:4px;">✅ Абсолютная мощь</div>
                                </div>
                            </div>
                            <button onclick="window.open('https://t.me/qanexus_bot?start=buy_stars_50')" style="width:100%;padding:9px;background:linear-gradient(135deg,#800080,#800080);color:#fff;border:none;border-radius:8px;cursor:pointer;font-weight:700;font-size:12px;">💰 24000 ⭐</button>
                        </div>
                        
                        <div data-category="mega" style="display:block;text-align:center;font-size:13px;font-weight:700;color:#fff;margin:8px 0 4px;">👑 VIP ФУНКЦИИ</div>

                        <div data-category="mega" style="background:rgba(255,215,0,0.25);padding:12px;border-radius:10px;border:1px solid rgba(255,215,0,0.5);">
                            <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
                                <div style="font-size:32px;">👑</div>
                                <div style="flex:1;">
                                    <div style="font-size:15px;font-weight:700;color:#fff;">👑 VIP Всё включено</div>
                                    <div style="font-size:11px;color:#94a3b8;margin-top:4px;">Все функции + эксклюзив + 50M коинов</div>
                                    <div style="font-size:10px;color:255,215,0;margin-top:4px;">✅ Скидка 50%</div>
                                </div>
                            </div>
                            <button onclick="window.open('https://t.me/qanexus_bot?start=buy_stars_51')" style="width:100%;padding:9px;background:linear-gradient(135deg,#ffd700,#ffd700);color:#000;border:none;border-radius:8px;cursor:pointer;font-weight:700;font-size:12px;">💰 5000 ⭐</button>
                        </div>
                        
                        <div data-category="mega" style="background:rgba(255,215,0,0.25);padding:12px;border-radius:10px;border:1px solid rgba(255,215,0,0.5);">
                            <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
                                <div style="font-size:32px;">⭐</div>
                                <div style="flex:1;">
                                    <div style="font-size:15px;font-weight:700;color:#fff;">⭐ Эксклюзивный бейдж</div>
                                    <div style="font-size:11px;color:#94a3b8;margin-top:4px;">Уникальная метка профиля + 100M коинов</div>
                                    <div style="font-size:10px;color:255,215,0;margin-top:4px;">✅ Выделяйся</div>
                                </div>
                            </div>
                            <button onclick="window.open('https://t.me/qanexus_bot?start=buy_stars_52')" style="width:100%;padding:9px;background:linear-gradient(135deg,#ffd700,#ffd700);color:#000;border:none;border-radius:8px;cursor:pointer;font-weight:700;font-size:12px;">💰 2500 ⭐</button>
                        </div>
                        <div data-category="mega" style="background:rgba(255,215,0,0.25);padding:12px;border-radius:10px;border:1px solid rgba(255,215,0,0.5);">
                            <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
                                <div style="font-size:32px;">🏆</div>
                                <div style="flex:1;">
                                    <div style="font-size:15px;font-weight:700;color:#fff;">🏆 Гарантирован топ</div>
                                    <div style="font-size:11px;color:#94a3b8;margin-top:4px;">Место в топ-100 игроков + 150M коинов</div>
                                    <div style="font-size:10px;color:255,215,0;margin-top:4px;">✅ Навсегда</div>
                                </div>
                            </div>
                            <button onclick="window.open('https://t.me/qanexus_bot?start=buy_stars_53')" style="width:100%;padding:9px;background:linear-gradient(135deg,#ffd700,#ffd700);color:#000;border:none;border-radius:8px;cursor:pointer;font-weight:700;font-size:12px;">💰 4000 ⭐</button>
                        </div>
                        
                        <div data-category="mega" style="background:rgba(255,215,0,0.25);padding:12px;border-radius:10px;border:1px solid rgba(255,215,0,0.5);">
                            <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
                                <div style="font-size:32px;">⚡</div>
                                <div style="flex:1;">
                                    <div style="font-size:15px;font-weight:700;color:#fff;">⚡ Мгновенный доход</div>
                                    <div style="font-size:11px;color:#94a3b8;margin-top:4px;">Ускорение x100 + 200M коинов</div>
                                    <div style="font-size:10px;color:255,215,0;margin-top:4px;">✅ Максимум выгода</div>
                                </div>
                            </div>
                            <button onclick="window.open('https://t.me/qanexus_bot?start=buy_stars_54')" style="width:100%;padding:9px;background:linear-gradient(135deg,#ffd700,#ffd700);color:#000;border:none;border-radius:8px;cursor:pointer;font-weight:700;font-size:12px;">💰 6000 ⭐</button>
                        </div>
                        
                        <div data-category="mega" style="background:rgba(255,215,0,0.25);padding:12px;border-radius:10px;border:1px solid rgba(255,215,0,0.5);">
                            <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
                                <div style="font-size:32px;">🔓</div>
                                <div style="flex:1;">
                                    <div style="font-size:15px;font-weight:700;color:#fff;">🔓 Снять лимиты</div>
                                    <div style="font-size:11px;color:#94a3b8;margin-top:4px;">Никаких ограничений + 250M коинов</div>
                                    <div style="font-size:10px;color:255,215,0;margin-top:4px;">✅ Бесконечные возможности</div>
                                </div>
                            </div>
                            <button onclick="window.open('https://t.me/qanexus_bot?start=buy_stars_55')" style="width:100%;padding:9px;background:linear-gradient(135deg,#ffd700,#ffd700);color:#000;border:none;border-radius:8px;cursor:pointer;font-weight:700;font-size:12px;">💰 8000 ⭐</button>
                        </div>
                        
                        <div data-category="mega" style="background:rgba(255,215,0,0.25);padding:12px;border-radius:10px;border:1px solid rgba(255,215,0,0.5);">
                            <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
                                <div style="font-size:32px;">🚀</div>
                                <div style="flex:1;">
                                    <div style="font-size:15px;font-weight:700;color:#fff;">🚀 Автопрокачка</div>
                                    <div style="font-size:11px;color:#94a3b8;margin-top:4px;">Всё автоматически + 300M коинов</div>
                                    <div style="font-size:10px;color:255,215,0;margin-top:4px;">✅ Без участия</div>
                                </div>
                            </div>
                            <button onclick="window.open('https://t.me/qanexus_bot?start=buy_stars_56')" style="width:100%;padding:9px;background:linear-gradient(135deg,#ffd700,#ffd700);color:#000;border:none;border-radius:8px;cursor:pointer;font-weight:700;font-size:12px;">💰 10000 ⭐</button>
                        </div>
                        
                        <div data-category="mega" style="background:rgba(255,215,0,0.25);padding:12px;border-radius:10px;border:1px solid rgba(255,215,0,0.5);">
                            <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
                                <div style="font-size:32px;">💎</div>
                                <div style="flex:1;">
                                    <div style="font-size:15px;font-weight:700;color:#fff;">💎 Приоритет помощь</div>
                                    <div style="font-size:11px;color:#94a3b8;margin-top:4px;">VIP поддержка 24/7 + 350M коинов</div>
                                    <div style="font-size:10px;color:255,215,0;margin-top:4px;">✅ Первым отвечаем</div>
                                </div>
                            </div>
                            <button onclick="window.open('https://t.me/qanexus_bot?start=buy_stars_57')" style="width:100%;padding:9px;background:linear-gradient(135deg,#ffd700,#ffd700);color:#000;border:none;border-radius:8px;cursor:pointer;font-weight:700;font-size:12px;">💰 3500 ⭐</button>
                        </div>
                        
                        <div data-category="mega" style="background:rgba(255,215,0,0.25);padding:12px;border-radius:10px;border:1px solid rgba(255,215,0,0.5);">
                            <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
                                <div style="font-size:32px;">👑</div>
                                <div style="flex:1;">
                                    <div style="font-size:15px;font-weight:700;color:#fff;">👑 Золотой профиль</div>
                                    <div style="font-size:11px;color:#94a3b8;margin-top:4px;">Уникальный дизайн профиля + 400M коинов</div>
                                    <div style="font-size:10px;color:255,215,0;margin-top:4px;">✅ Императорский стиль</div>
                                </div>
                            </div>
                            <button onclick="window.open('https://t.me/qanexus_bot?start=buy_stars_58')" style="width:100%;padding:9px;background:linear-gradient(135deg,#ffd700,#ffd700);color:#000;border:none;border-radius:8px;cursor:pointer;font-weight:700;font-size:12px;">💰 4500 ⭐</button>
                        </div>
                        
                        <div data-category="mega" style="background:rgba(255,215,0,0.25);padding:12px;border-radius:10px;border:1px solid rgba(255,215,0,0.5);">
                            <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
                                <div style="font-size:32px;">🌟</div>
                                <div style="flex:1;">
                                    <div style="font-size:15px;font-weight:700;color:#fff;">🌟 Супер статус</div>
                                    <div style="font-size:11px;color:#94a3b8;margin-top:4px;">Премиум права везде + 450M коинов</div>
                                    <div style="font-size:10px;color:255,215,0;margin-top:4px;">✅ Всё разблокировано</div>
                                </div>
                            </div>
                            <button onclick="window.open('https://t.me/qanexus_bot?start=buy_stars_59')" style="width:100%;padding:9px;background:linear-gradient(135deg,#ffd700,#ffd700);color:#000;border:none;border-radius:8px;cursor:pointer;font-weight:700;font-size:12px;">💰 7000 ⭐</button>
                        </div>
                        
                        <div data-category="mega" style="background:rgba(255,215,0,0.25);padding:12px;border-radius:10px;border:1px solid rgba(255,215,0,0.5);">
                            <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
                                <div style="font-size:32px;">🎯</div>
                                <div style="flex:1;">
                                    <div style="font-size:15px;font-weight:700;color:#fff;">🎯 АБСОЛЮТ ВСЁ VIP</div>
                                    <div style="font-size:11px;color:#94a3b8;margin-top:4px;">Все премиум сразу + 500M коинов</div>
                                    <div style="font-size:10px;color:255,215,0;margin-top:4px;">✅ Максимальная скидка</div>
                                </div>
                            </div>
                            <button onclick="window.open('https://t.me/qanexus_bot?start=buy_stars_60')" style="width:100%;padding:9px;background:linear-gradient(135deg,#ffd700,#ffd700);color:#000;border:none;border-radius:8px;cursor:pointer;font-weight:700;font-size:12px;">💰 15000 ⭐</button>
                        </div>
                        
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Set initial active category after modal is attached
            setTimeout(() => window.filterCategory('starter'), 100);
        }
        
        window.filterCategory = function(category) {
            try {
                // Update button states
                document.querySelectorAll('#buyCurrencyModal .category-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                if(event?.target) {
                    event.target.classList.add('active');
                }
                
                // Filter and show products
                const products = document.querySelectorAll('#currencyProductsList [data-category]');
                products.forEach(product => {
                    if(product.dataset.category === category) {
                        product.style.display = 'block';
                    } else {
                        product.style.display = 'none';
                    }
                });
            } catch(err) {
                console.error('filterCategory error:', err);
            }
        }

    </script>


</body>
</html>